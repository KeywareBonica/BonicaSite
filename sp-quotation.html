<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Quotation</title>
  <link rel="stylesheet" href="sp-quotation.css">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Additional CSS to ensure content is visible -->
  <style>
    .job-cart-details-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }
    
    .job-cart-info h3 {
      color: #0d6efd;
      margin-bottom: 15px;
    }
    
    .job-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .detail-item {
      display: flex;
      flex-direction: column;
    }
    
    .detail-item.full-width {
      grid-column: 1 / -1;
    }
    
    .detail-item label {
      font-weight: bold;
      color: #495057;
      margin-bottom: 5px;
    }
    
    .detail-item span {
      color: #212529;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #495057;
    }
    
    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    
    .upload-btn {
      background-color: #0d6efd;
      color: white;
    }
    
    .confirm-btn {
      background-color: #198754;
      color: white;
    }
    
    .confirm-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    #message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

    <!-- Navbar -->
  <nav class="navbar">
    <a href="index.html" class="logo">
      <img src="logo.jpeg" alt="Logo" />
      Bonica
    </a>
    <ul class="nav-links" id="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="service-provider-dashboard.html">Dashboard</a></li>
      <li><a href="#">About</a></li>
      <li><a href="#">Bookings</a></li>
      <li><a href="#">Help</a></li>
      <li><a href="#">Contact</a></li>
    </ul>
    <div class="hamburger" id="hamburger">
      <div></div><div></div><div></div>
    </div>
  </nav>

<main>
  <div class="quotation-container">
    <div style="margin-bottom: 1rem;">
      <a href="service-provider-dashboard.html" style="color: #0d6efd; text-decoration: none;">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
    <h2> Upload Quotation</h2>

    <form id="quotationForm">
    <!-- Job Cart Dropdown -->
     <div class="form-group">
    <label for="job_cart_select">Select Accepted Job Cart:</label>
    <select id="job_cart_select" name="job_cart_id" required>
    <option value="">-- Select Job Cart --</option>
    <!-- Job carts will be loaded dynamically from database -->
    </select>
    <small class="form-text text-muted">Only accepted job carts are available for quotation submission.</small>
  </div>

      <div class="form-group">
        <label for="quotation_price">Quotation Price</label>
        <input type="number" id="quotation_price" name="quotation_price" placeholder="R 0.00" required>
      </div>

      <div class="form-group">
        <label for="quotation_details">Quotation Details</label>
        <textarea id="quotation_details" name="quotation_details" placeholder="e.g., Catering for 50 guests" required></textarea>
      </div>

      <div class="form-group">
        <label for="quotation_file">Select Quotation File</label>
        <input type="file" id="quotation_file" name="quotation_file" accept=".pdf,.docx,.jpg,.png" required>
        <small>Accepted: PDF, DOCX, JPG, PNG (Max 10MB)</small>
      </div>

      <button type="button" class="btn upload-btn" onclick="submitQuotation()"> Upload</button>
    </form>

    <p id="message"></p>
  </div>
</main>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- IMMEDIATE CONTENT DISPLAY SCRIPT -->
  <script>
    // Ensure content shows immediately - no JavaScript dependencies
    console.log('‚ö° QUOTATION PAGE: Ensuring content displays immediately...');
    
    // Initialize Supabase client for real-time functionality
    const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Real-time subscription for job cart updates
    let jobCartChannel = null;
    
    // Show job cart details for first option immediately
    document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ QUOTATION PAGE: DOM ready, loading job carts for service provider...');
    
    // First, load accepted job carts from database, then from localStorage
    loadAllJobCartsForServiceProvider();
    
    // Set up real-time subscription for updates
    setupRealtimeSubscription();
      // Check if job_cart_id is provided in URL
      const urlParams = new URLSearchParams(window.location.search);
      const jobCartId = urlParams.get('job_cart_id');
      
      if (jobCartId) {
        console.log('üéØ Found job_cart_id in URL:', jobCartId);
        // Pre-select the job cart if it exists in the dropdown
        const jobCartSelect = document.getElementById('job_cart_select');
        if (jobCartSelect) {
          const option = jobCartSelect.querySelector(`option[value="${jobCartId}"]`);
          if (option) {
            jobCartSelect.value = jobCartId;
            console.log('‚úÖ Pre-selected job cart:', jobCartId);
            
            // Show details for selected job cart
            if (option.dataset.jobDetails) {
              const jobDetails = JSON.parse(option.dataset.jobDetails);
              showJobCartDetailsImmediate(jobDetails);
            }
          } else {
            console.log('‚ö†Ô∏è Job cart not found in dropdown, will load dynamically');
            // Load job cart details from database
            loadJobCartDetailsFromDB(jobCartId);
          }
        }
      } else {
        console.log('üìã No job_cart_id provided, showing first option...');
        // Default behavior - show first job cart
      const jobCartSelect = document.getElementById('job_cart_select');
      if (jobCartSelect && jobCartSelect.options.length > 1) {
        jobCartSelect.selectedIndex = 1;
        
        const firstOption = jobCartSelect.options[1];
        if (firstOption && firstOption.dataset.jobDetails) {
          const jobDetails = JSON.parse(firstOption.dataset.jobDetails);
          showJobCartDetailsImmediate(jobDetails);
        }
      }
      }
    });
      
    console.log('‚úÖ QUOTATION PAGE: Content should now be visible!');
    
    // Simple function to show job cart details immediately
    function showJobCartDetailsImmediate(jobDetails) {
      console.log('üìã Showing job details:', jobDetails);
      
      // Remove existing details if any
      const existingDetails = document.getElementById('job-cart-details');
      if (existingDetails) {
        existingDetails.remove();
      }
      
      // Create job cart details section
      const detailsSection = document.createElement('div');
      detailsSection.id = 'job-cart-details';
      detailsSection.className = 'job-cart-details-section';
      detailsSection.innerHTML = `
        <div class="job-cart-info">
          <h3><i class="fas fa-info-circle"></i> Job Details</h3>
          <div class="job-details-grid">
            <div class="detail-item">
              <label>Event:</label>
              <span>${jobDetails.eventName}</span>
            </div>
            <div class="detail-item">
              <label>Date:</label>
              <span>${new Date(jobDetails.eventDate).toLocaleDateString()}</span>
            </div>
            <div class="detail-item">
              <label>Time:</label>
              <span>${jobDetails.startTime && jobDetails.endTime ? 
                `${jobDetails.startTime} - ${jobDetails.endTime}` : 
                (jobDetails.startTime || jobDetails.endTime || 'Time not specified')}</span>
            </div>
            <div class="detail-item">
              <label>Location:</label>
              <span>${jobDetails.eventLocation}</span>
            </div>
            <div class="detail-item">
              <label>Client:</label>
              <span>${jobDetails.clientName}</span>
            </div>
            <div class="detail-item full-width">
              <label>Requirements:</label>
              <span>${jobDetails.jobDetails}</span>
            </div>
          </div>
        </div>
      `;
      
      // Insert after the job cart select dropdown
      const formGroup = document.getElementById('job_cart_select').closest('.form-group');
      if (formGroup) {
        formGroup.parentNode.insertBefore(detailsSection, formGroup.nextSibling);
      }
      
      console.log('‚úÖ Job details displayed!');
    }
    
    // Function to load job cart details from database
    async function loadJobCartDetailsFromDB(jobCartId) {
      try {
        console.log('üîç Loading job cart details from database for:', jobCartId);
        
        // Initialize Supabase client
        const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Load job cart details with related data
        const { data: jobCart, error } = await supabase
          .from('job_cart')
          .select(`
            job_cart_id,
            client_id,
            event_id,
            service_id,
            job_cart_status,
            event:event_id (
              event_type,
              event_date,
              event_location,
              event_start_time,
              event_end_time
            ),
            client:client_id (
              client_name,
              client_surname,
              client_email
            ),
            service:service_id (
              service_name,
              service_type
            )
          `)
          .eq('job_cart_id', jobCartId)
          .single();

        if (error) {
          console.error('Error loading job cart:', error);
          return;
        }

        if (jobCart) {
          // Create job details object
          const jobDetails = {
            eventName: jobCart.event?.event_type || 'Event',
            eventDate: jobCart.event?.event_date || 'Date not specified',
            eventLocation: jobCart.event?.event_location || 'Location not specified',
            clientName: `${jobCart.client?.client_name || 'Unknown'} ${jobCart.client?.client_surname || ''}`,
            jobDetails: `${jobCart.service?.service_name || 'Service'} for ${jobCart.event?.event_type || 'event'} on ${jobCart.event?.event_date || 'date'} at ${jobCart.event?.event_location || 'location'}`,
            status: jobCart.job_cart_status || 'pending'
          };

          // Show the job cart details
          showJobCartDetailsImmediate(jobDetails);
          
          // Add option to dropdown if it doesn't exist
          const jobCartSelect = document.getElementById('job_cart_select');
          if (jobCartSelect) {
            const existingOption = jobCartSelect.querySelector(`option[value="${jobCartId}"]`);
            if (!existingOption) {
              const newOption = document.createElement('option');
              newOption.value = jobCartId;
              newOption.textContent = `${jobCart.service?.service_name || 'Service'} - ${jobDetails.eventName} (${jobDetails.eventDate}) - ${jobDetails.clientName}`;
              newOption.dataset.jobDetails = JSON.stringify(jobDetails);
              jobCartSelect.appendChild(newOption);
              jobCartSelect.value = jobCartId;
            }
          }
          
          console.log('‚úÖ Job cart details loaded from database');
        }
      } catch (error) {
        console.error('Error loading job cart details from database:', error);
      }
    }

    // Function to load all job carts for service provider (simple version)
    async function loadAllJobCartsForServiceProvider() {
      try {
        console.log('üîç Loading all job carts for service provider...');
        
        // Just reload from localStorage - the accepted job carts are already stored there
        // This function is called when we need to refresh the data
        loadAcceptedJobCartsFromLocalStorage();
        
        console.log('‚úÖ Job carts reloaded from localStorage');

      } catch (error) {
        console.error('‚ùå Error in loadAllJobCartsForServiceProvider:', error);
      }
    }

    // Function to load accepted job carts from localStorage
    function loadAcceptedJobCartsFromLocalStorage() {
      try {
        console.log('üîç Loading accepted job carts from localStorage...');
        
        // Get accepted job carts from localStorage
        const acceptedJobCarts = JSON.parse(localStorage.getItem('acceptedJobCarts') || '[]');
        
        console.log('üìä Found', acceptedJobCarts.length, 'accepted job carts in localStorage');
        
        // Populate the dropdown with accepted job carts
        const jobCartSelect = document.getElementById('job_cart_select');
        if (jobCartSelect) {
          // Clear existing options
          jobCartSelect.innerHTML = '<option value="">-- Select Job Cart --</option>';
          
          if (acceptedJobCarts && acceptedJobCarts.length > 0) {
            acceptedJobCarts.forEach(jobCart => {
              const option = document.createElement('option');
              option.value = jobCart.job_cart_id;
              
              const eventName = jobCart.event?.event_type || 'Event';
              const eventDate = jobCart.event?.event_date || 'Date not specified';
              const clientName = `${jobCart.client?.client_name || 'Unknown'} ${jobCart.client?.client_surname || ''}`;
              
              option.textContent = `${jobCart.service?.service_name || 'Service'} - ${eventName} (${eventDate}) - ${clientName}`;
              
              // Store job details in dataset
              const jobDetails = {
                eventName: eventName,
                eventDate: eventDate,
                eventLocation: jobCart.event?.event_location || 'Location not specified',
                clientName: clientName,
                jobDetails: `${jobCart.service?.service_name || 'Service'} for ${eventName} on ${eventDate} at ${jobCart.event?.event_location || 'location'}`,
                startTime: jobCart.event?.event_start_time || 'Time not specified',
                endTime: jobCart.event?.event_end_time || 'Time not specified',
                status: jobCart.job_cart_status || 'accepted'
              };
              
              option.dataset.jobDetails = JSON.stringify(jobDetails);
              jobCartSelect.appendChild(option);
            });
            
            console.log('‚úÖ Loaded', acceptedJobCarts.length, 'accepted job carts from localStorage');
          } else {
            console.log('üì≠ No accepted job carts found in localStorage');
            jobCartSelect.innerHTML = '<option value="">No accepted job carts found</option>';
          }
        }
      } catch (error) {
        console.error('Error loading accepted job carts from localStorage:', error);
      }
    }
    
    // Set up real-time subscription for job cart updates
    function setupRealtimeSubscription() {
      try {
        console.log('üîÑ Setting up real-time subscription for job cart updates...');
        
        // Subscribe to job_cart table changes
        jobCartChannel = supabase
          .channel('job_cart_changes')
          .on(
            'postgres_changes',
            {
              event: '*', // Listen to all changes (INSERT, UPDATE, DELETE)
              schema: 'public',
              table: 'job_cart'
            },
            (payload) => {
              console.log('üì° Real-time job cart update received:', payload);
              
              // Reload job carts when there are changes
              loadAllJobCartsForServiceProvider();
            }
          )
          .subscribe((status) => {
            console.log('üì° Real-time subscription status:', status);
          });
          
        console.log('‚úÖ Real-time subscription established');
      } catch (error) {
        console.error('‚ùå Error setting up real-time subscription:', error);
      }
    }
    
    // Clean up subscription when page is unloaded
    window.addEventListener('beforeunload', function() {
      if (jobCartChannel) {
        console.log('üßπ Cleaning up real-time subscription...');
        supabase.removeChannel(jobCartChannel);
      }
    });
    
    // Handle quotation submission with real-time updates
    async function submitQuotation() {
      try {
        const jobCartId = document.getElementById('job_cart_select').value;
        const price = document.getElementById('quotation_price').value;
        const details = document.getElementById('quotation_details').value;
        
        if (!jobCartId || !price || !details) {
          alert('Please fill in all fields');
          return;
        }
        
        // Get current service provider from individual localStorage fields
        const serviceProviderId = localStorage.getItem('serviceProviderId');
        if (!serviceProviderId) {
          alert('Service provider not found. Please log in again.');
          return;
        }
        
        const currentServiceProvider = {
          service_provider_id: serviceProviderId,
          service_provider_name: localStorage.getItem('serviceProviderName') || 'Service Provider',
          service_provider_surname: localStorage.getItem('serviceProviderSurname') || '',
          service_provider_email: localStorage.getItem('serviceProviderEmail') || '',
          service_provider_contact: localStorage.getItem('serviceProviderContact') || '',
          service_provider_location: localStorage.getItem('serviceProviderLocation') || '',
          service_provider_type: localStorage.getItem('serviceProviderType') || ''
        };
        
        console.log('üì§ Submitting quotation...', { jobCartId, price, details });
        
        // Submit quotation to database
        const { data, error } = await supabase
          .from('quotation')
          .insert([
            {
              service_provider_id: currentServiceProvider.service_provider_id,
              job_cart_id: jobCartId,
              quotation_price: parseFloat(price),
              quotation_details: details,
              quotation_file_path: `/quotations/${currentServiceProvider.service_provider_id}_${jobCartId}_${Date.now()}.pdf`,
              quotation_file_name: `Quotation_${jobCartId}.pdf`,
              quotation_submission_date: new Date().toISOString().split('T')[0],
              quotation_submission_time: new Date().toTimeString().split(' ')[0],
              quotation_status: 'submitted'
            }
          ])
          .select();
        
        if (error) {
          console.error('‚ùå Error submitting quotation:', error);
          alert('Error submitting quotation: ' + error.message);
          return;
        }
        
        console.log('‚úÖ Quotation submitted successfully:', data);
        alert('Quotation submitted successfully! Redirecting to dashboard...');
        
        // Clear form
        document.getElementById('quotation_price').value = '';
        document.getElementById('quotation_details').value = '';
        
        // Redirect to service provider dashboard
        setTimeout(() => {
          window.location.href = 'service-provider-dashboard.html';
        }, 1500);
        
      } catch (error) {
        console.error('‚ùå Error submitting quotation:', error);
        alert('Error submitting quotation: ' + error.message);
      }
    }
    
    // Make functions globally available
    window.showJobCartDetailsImmediate = showJobCartDetailsImmediate;
    window.submitQuotation = submitQuotation;
  </script>

  <!-- Footer -->
  <footer id="footer">
    <section>
      <h2>Get In Touch</h2>
      <dl class="alt">
        <dt>Address</dt><dd>Joriseen Street, Johannesburg</dd>
        <dt>Phone</dt><dd>076 244 9990</dd>
        <dt>Email</dt><dd><a href="mailto:Bonica@gmail.com">Bonica@gmail.com</a></dd>
      </dl>
    </section>

    <section>
      <h2>Quick Links</h2>
      <ul class="divided">
        <li><a href="#">About Us</a></li>
        <li><a href="#">Contact Us</a></li>
        <li><a href="#">Our Services</a></li>
        <li><a href="#">Terms & Conditions</a></li>
      </ul>
    </section>

    <section>
      <h2>Follow Us</h2>
      <ul class="icons">
        <li><a href="#"><i class="fab fa-facebook-f"></i></a></li>
        <li><a href="#"><i class="fab fa-twitter"></i></a></li>
        <li><a href="#"><i class="fab fa-youtube"></i></a></li>
      </ul>
    </section>

    <p class="copyright">&copy; 2025 Bonica Event Booking System</p>
  </footer>

    <!-- JavaScript -->
  <script>
    // Navbar toggle
    const hamburger = document.getElementById("hamburger");
    const navLinks = document.getElementById("nav-links");
    hamburger.addEventListener("click", () => {
      navLinks.classList.toggle("active");
    });
    </script>
</body>
</html>