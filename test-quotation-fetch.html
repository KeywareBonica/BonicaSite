<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Quotation Fetch from Database</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .quotation-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .quotation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .price {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c5aa0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Quotation Fetch from Database</h1>
        <p>This page tests the new quotation fetching system that uses the <code>quotation_with_files</code> view and filters by <code>service_id</code>.</p>
        
        <div class="test-section info">
            <h3>üìã Test Information</h3>
            <p><strong>New Approach:</strong> Instead of waiting for service providers to upload quotations, we now fetch them directly from the database using the <code>quotation_with_files</code> view.</p>
            <p><strong>Filtering:</strong> Quotations are filtered by <code>service_id</code> based on the client's job carts.</p>
            <p><strong>Status Filter:</strong> Only quotations with status 'confirmed' are shown.</p>
        </div>

        <div class="test-section">
            <h3>üîç Test Controls</h3>
            <button onclick="testQuotationFetch()">Test Quotation Fetch</button>
            <button onclick="testWithSampleData()">Test with Sample Data</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div id="loading-indicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading quotations from database...</p>
        </div>

        <div id="test-results"></div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Test client ID (you can change this to test with different clients)
        const testClientId = 'ff33d598-3d94-4fc1-9287-8760290651d3';

        async function testQuotationFetch() {
            showLoading(true);
            clearResults();
            
            try {
                console.log('üß™ Starting quotation fetch test...');
                
                // Step 1: Get client's job carts
                const { data: jobCarts, error: jobCartError } = await supabase
                    .from('job_cart')
                    .select(`
                        job_cart_id,
                        job_cart_item,
                        job_cart_details,
                        service_id,
                        event:event_id (
                            event_id,
                            event_name,
                            event_date,
                            event_location
                        )
                    `)
                    .eq('client_id', testClientId)
                    .in('job_cart_status', ['pending', 'in_progress', 'available', 'accepted']);

                if (jobCartError) throw jobCartError;

                addTestResult('info', 'Job Carts Found', `Found ${jobCarts?.length || 0} job carts for client`);

                if (!jobCarts || jobCarts.length === 0) {
                    addTestResult('error', 'No Job Carts', 'No job carts found for this client. Please create some job carts first.');
                    return;
                }

                // Step 2: Extract service IDs
                const serviceIds = [...new Set(jobCarts.map(cart => cart.service_id).filter(Boolean))];
                addTestResult('info', 'Service IDs', `Found service IDs: ${serviceIds.join(', ')}`);

                if (serviceIds.length === 0) {
                    addTestResult('error', 'No Service IDs', 'No service IDs found in job carts.');
                    return;
                }

                // Step 3: Fetch quotations from quotation_with_files view
                const { data: quotations, error: quotationError } = await supabase
                    .from('quotation_with_files')
                    .select(`
                        quotation_id,
                        service_id,
                        quotation_price,
                        quotation_details,
                        quotation_file_path,
                        quotation_file_name,
                        quotation_submission_date,
                        quotation_submission_time,
                        quotation_status,
                        service_provider_name,
                        service_provider_surname,
                        service_name,
                        service_type,
                        quotation_file_url
                    `)
                    .in('service_id', serviceIds)
                    .eq('quotation_status', 'confirmed')
                    .order('quotation_submission_date', { ascending: false });

                if (quotationError) throw quotationError;

                addTestResult('success', 'Quotations Fetched', `Successfully fetched ${quotations?.length || 0} quotations from quotation_with_files view`);

                if (!quotations || quotations.length === 0) {
                    addTestResult('error', 'No Quotations', 'No confirmed quotations found for these services.');
                    return;
                }

                // Step 4: Display quotations
                displayQuotations(quotations);

            } catch (error) {
                console.error('Test error:', error);
                addTestResult('error', 'Test Failed', `Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function displayQuotations(quotations) {
            const resultsDiv = document.getElementById('test-results');
            
            // Group quotations by service
            const quotationsByService = {};
            quotations.forEach(quotation => {
                const serviceName = quotation.service_name || 'Unknown Service';
                if (!quotationsByService[serviceName]) {
                    quotationsByService[serviceName] = [];
                }
                quotationsByService[serviceName].push(quotation);
            });

            // Display each service group
            Object.entries(quotationsByService).forEach(([serviceName, serviceQuotations]) => {
                const serviceDiv = document.createElement('div');
                serviceDiv.className = 'test-section';
                serviceDiv.innerHTML = `
                    <h3>üìã ${serviceName} (${serviceQuotations.length} quotations)</h3>
                    <div class="quotations-list">
                        ${serviceQuotations.map(quotation => createQuotationCard(quotation)).join('')}
                    </div>
                `;
                resultsDiv.appendChild(serviceDiv);
            });

            addTestResult('success', 'Display Complete', `Displayed quotations for ${Object.keys(quotationsByService).length} services`);
        }

        function createQuotationCard(quotation) {
            const providerName = `${quotation.service_provider_name} ${quotation.service_provider_surname}`;
            
            return `
                <div class="quotation-card">
                    <div class="quotation-header">
                        <h4>${providerName}</h4>
                        <div class="price">R ${quotation.quotation_price.toLocaleString()}</div>
                    </div>
                    <p><strong>Service:</strong> ${quotation.service_name}</p>
                    <p><strong>Details:</strong> ${quotation.quotation_details}</p>
                    <p><strong>Submitted:</strong> ${new Date(quotation.quotation_submission_date).toLocaleDateString()}</p>
                    <p><strong>Status:</strong> ${quotation.quotation_status}</p>
                    ${quotation.quotation_file_url ? `<p><strong>File:</strong> <a href="${quotation.quotation_file_url}" target="_blank">View File</a></p>` : ''}
                </div>
            `;
        }

        function addTestResult(type, title, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-section ${type}`;
            resultDiv.innerHTML = `
                <h4>${title}</h4>
                <p>${message}</p>
            `;
            resultsDiv.appendChild(resultDiv);
        }

        function showLoading(show) {
            document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        async function testWithSampleData() {
            showLoading(true);
            clearResults();
            
            addTestResult('info', 'Sample Data Test', 'Testing with sample quotations...');
            
            // Simulate sample data
            const sampleQuotations = [
                {
                    quotation_id: 'sample-1',
                    service_id: 'service-1',
                    quotation_price: 2500,
                    quotation_details: 'Professional photography services',
                    quotation_submission_date: new Date().toISOString().split('T')[0],
                    quotation_status: 'confirmed',
                    service_provider_name: 'John',
                    service_provider_surname: 'Doe',
                    service_name: 'Photography',
                    service_type: 'Entertainment'
                },
                {
                    quotation_id: 'sample-2',
                    service_id: 'service-2',
                    quotation_price: 1500,
                    quotation_details: 'Catering services for 50 guests',
                    quotation_submission_date: new Date().toISOString().split('T')[0],
                    quotation_status: 'confirmed',
                    service_provider_name: 'Jane',
                    service_provider_surname: 'Smith',
                    service_name: 'Catering',
                    service_type: 'Food & Beverage'
                }
            ];
            
            displayQuotations(sampleQuotations);
            addTestResult('success', 'Sample Test Complete', 'Sample data test completed successfully!');
            
            showLoading(false);
        }

        // Auto-run test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Test page loaded. Ready to test quotation fetching.');
        });
    </script>
</body>
</html>
