<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bonica Event Booking</title>
<link rel="stylesheet" href="css/bookings.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<header class="navbar">
  <a href="index.html" class="logo">
    <img src="img/logo.jpeg" alt="Bonica Logo"> Bonica
  </a>
  <nav class="nav-links">
    <a href="index.html">Home</a>
    <a href="#">About</a>
    <a href="#">Services</a>
    <a href="#">Contact</a>
    <div class="job-cart">
      <button onclick="toggleCartDropdown()">🛒 Job Cart (<span id="cart-count">0</span>)</button>
      <div id="cart-dropdown" class="cart-dropdown" style="display:none;">
        <ul id="cart-items"></ul>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button style="flex:1;" onclick="openCartModal()">View Cart</button>
          <button style="flex:1; background:#198754;" onclick="goToStep(3)">Edit</button>
        </div>
      </div>
    </div>
  </nav>
</header>

<div class="container">
  <!-- Step 1 -->
  <div class="step active" id="step-1">
    <h2>Welcome!</h2>
    <p>Do you want to make a booking?</p>
    <div class="booking-choice-buttons">
      <button class="primary-btn" onclick="startBooking()">Yes</button>
      <button class="primary-btn" onclick="cancelBooking()">No</button>
    </div>
  </div>

  <!-- Step 2 -->
  <div class="step" id="step-2">
    <h2>Event Details</h2>
    <label>Event Type
      <select id="event_type" onchange="toggleOtherEventInput()">
        <option value="">-- Select Event Type --</option>
        <option value="birthday">Birthday</option>
        <option value="graduation">Graduation</option>
        <option value="corporate_event">Corporate Event</option>
        <option value="concert">Concert</option>
        <option value="baby_shower">Baby Shower</option>
        <option value="anniversary">Anniversary</option>
        <option value="engagement_party">Engagement Party</option>
        <option value="conference">Conference</option>
        <option value="other">Other</option>
      </select>
    </label>
    <div id="other-event-wrapper" style="display:none; margin-top:8px;">
      <input type="text" id="other_event_type" placeholder="Enter your event type here" />
    </div>
    <label>Date <input type="date" id="event_date"></label>
    <label>Start Time <input type="time" id="start_time"></label>
    <label>End Time <input type="time" id="end_time"></label>
    <label>Location <input type="text" id="location" placeholder="Enter city/area"></label>
    <label>Special Requests (optional)
      <textarea id="special_requests"></textarea>
    </label>
    <label>Budget Range</label>
    <input type="number" id="min_price" placeholder="Minimum Price">
    <input type="number" id="max_price" placeholder="Maximum Price">
  </div>

  <!-- Step 3 -->
  <div class="step" id="step-3">
    <h2>Select Services</h2>
    <input type="text" id="service-search" placeholder="Search services..." oninput="filterServices()">
    <div id="services-grid" class="services-grid"></div>
  </div>

  <!-- Step 4 -->
  <div class="step" id="step-4">
    <h2>Quotations</h2>
    <p id="quotation-wait-message" style="display:none;"></p>
    <div id="quotations-container"></div>
  </div>

  <!-- Step 5 -->
  <div class="step" id="step-5">
    <h2>Review Summary</h2>
    <div id="summary-container"></div>
    <p id="redirect-message" style="display:none; color:#0d6efd; font-weight:bold; margin-top:15px;"></p>
    <button id="confirm-booking" class="primary-btn" onclick="confirmBooking()">Confirm Booking</button>
  </div>

  <div class="buttons">
    <button id="prevBtn" onclick="prevStep()">Previous</button>
    <button id="nextBtn" onclick="nextStep()">Next</button>
  </div>
</div>

<!-- Job Cart Modal -->
<div id="cart-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center;">
  <div style="background:#fff; width:min(900px,95vw); max-height:90vh; overflow:auto; border-radius:12px; padding:20px; position:relative;">
    <button onclick="closeCartModal()" style="position:absolute; top:10px; right:10px; background:#6c757d;">Close</button>
    <h2>Jobcart_ID: <span id="cart-id"></span></h2>
    <div id="cart-list"></div>
    <hr>
    <div style="display:flex; justify-content:flex-end; gap:20px; align-items:center;">
      <strong id="cart-accepted-total">Accepted quotations total: R0.00</strong>
      <h3 id="cart-total" style="margin:0;">Total: R0.00</h3>
    </div>
    <div style="margin-top:18px; color:#555;">
      <div>Create Time: <span id="cart-time"></span></div>
      <div>Create Date: <span id="cart-date"></span></div>
    </div>
  </div>
</div>

<script>
// Supabase setup
const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Authentication
const clientId = localStorage.getItem("clientId");
if (!clientId) { 
    alert("You must be logged in!"); 
    window.location.href = "login.html"; 
}
localStorage.removeItem("totalAmount");

// Step navigation
let currentStep = 1;
let jobCart = [];
let selectedQuotations = {};
const steps = document.querySelectorAll('.step');
showStep(currentStep);

function showStep(n){
    steps.forEach((s,i)=>s.classList.toggle('active', i===n-1));
    document.getElementById('prevBtn').style.display = n===1?'none':'inline-block';
    document.getElementById('nextBtn').style.display = n>=steps.length?'none':'inline-block';
    if(n===3) loadServicesGrid();
    if(n===4) loadQuotations();
    if(n===5) loadSummary();
    validateStep(n);
}

function startBooking(){ currentStep=2; showStep(currentStep); }
function cancelBooking(){ window.location.href="index.html"; }
function prevStep(){ if(currentStep>1){ currentStep--; showStep(currentStep); } }
function nextStep(){ if(validateStep(currentStep)){ currentStep++; showStep(currentStep); } }
function goToStep(n){ currentStep=n; showStep(n); }
function toggleOtherEventInput(){ 
    document.getElementById("other-event-wrapper").style.display = document.getElementById("event_type").value==="other"?"block":"none"; 
}

// Step validation
function validateStep(step){
    let valid = true;
    if(step===2){
        const type=document.getElementById("event_type").value,
              date=document.getElementById("event_date").value,
              start=document.getElementById("start_time").value,
              end=document.getElementById("end_time").value,
              location=document.getElementById("location").value;
        if(!type||!date||!start||!end||!location) valid=false;
    }
    if(step===3) if(jobCart.length===0) valid=false;
    if(step===4) if(Object.keys(selectedQuotations).length===0) valid=false;
    document.getElementById('nextBtn').disabled = !valid;
    return valid;
}
document.querySelectorAll('#step-2 input, #step-2 select').forEach(el=>el.addEventListener('input', ()=>validateStep(2)));
document.getElementById('services-grid').addEventListener('change', ()=>validateStep(3));
document.getElementById('quotations-container').addEventListener('click', ()=>validateStep(4));

// Services list
const servicesList = [
  { service_id:"s1", service_name:"MC", icon:"fa-microphone" },
  { service_id:"s2", service_name:"DJ", icon:"fa-music" },
  { service_id:"s3", service_name:"Makeup Artist", icon:"fa-face-smile" },
  { service_id:"s4", service_name:"Catering", icon:"fa-utensils" },
  { service_id:"s5", service_name:"Photography", icon:"fa-camera" },
  { service_id:"s6", service_name:"Decoration", icon:"fa-paint-roller" },
  { service_id:"s7", service_name:"Live Band", icon:"fa-guitar" },
  { service_id:"s8", service_name:"Venue", icon:"fa-building" },
  { service_id:"s9", service_name:"Florist", icon:"fa-seedling" },
  { service_id:"s10", service_name:"Lighting", icon:"fa-lightbulb" },
  { service_id:"s11", service_name:"Sound System", icon:"fa-volume-high" },
  { service_id:"s12", service_name:"Security", icon:"fa-shield" },
  { service_id:"s13", service_name:"Transport", icon:"fa-car" },
  { service_id:"s14", service_name:"Event Planner", icon:"fa-calendar-check" },
  { service_id:"s15", service_name:"Videography", icon:"fa-video" },
  { service_id:"s16", service_name:"Bartender", icon:"fa-glass-martini" },
  { service_id:"s17", service_name:"Host/Presenter", icon:"fa-user-tie" },
  { service_id:"s18", service_name:"Cake Designer", icon:"fa-birthday-cake" },
  { service_id:"s19", service_name:"Invitation Design", icon:"fa-envelope" },
  { service_id:"s20", service_name:"Furniture Rental", icon:"fa-couch" }
];

// Render services grid
function loadServicesGrid(){ renderServicesGrid(servicesList); }
function renderServicesGrid(list){
    const container = document.getElementById("services-grid"); 
    container.innerHTML = "";
    list.forEach(s=>{
        const card = document.createElement("div"); 
        card.className = "service-card text-center";
        card.innerHTML = `
            <i class="fa ${s.icon} fa-3x text-primary mb-3"></i>
            <h5>${s.service_name}</h5>
            <label><input type="checkbox" value="${s.service_id}" onchange="previewCart()"> Select</label>
        `;
        container.appendChild(card);
    });
    const selectedIds = new Set(jobCart.map(i=>i.service_id));
    container.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(selectedIds.has(cb.value)) cb.checked=true; });
}

// Services search and cart preview
function filterServices(){ 
    const q = document.getElementById("service-search").value.toLowerCase(); 
    renderServicesGrid(servicesList.filter(s=>s.service_name.toLowerCase().includes(q))); 
}
function previewCart(){
    const checked = new Set(Array.from(document.querySelectorAll('#services-grid input:checked')).map(cb=>cb.value));
    servicesList.forEach(s=>{
        if(checked.has(s.service_id) && !jobCart.find(i=>i.service_id===s.service_id)) jobCart.push({service_id:s.service_id, service_name:s.service_name});
    });
    jobCart = jobCart.filter(i=>checked.has(i.service_id));
    updateCartUI();
    validateStep(3);
}
function updateCartUI(){
    document.getElementById("cart-count").innerText = jobCart.length;
    const list = document.getElementById("cart-items"); list.innerHTML = "";
    if(jobCart.length===0){ 
        const li=document.createElement("li"); li.innerText="Cart is empty"; list.appendChild(li);
    } else { 
        jobCart.forEach(item=>{
            const li=document.createElement("li"); li.innerText=item.service_name; list.appendChild(li);
        });
    }
}

// Sample providers
const sampleProviders = [
    {name:"Alice", surname:"Mokoena", city:"Johannesburg", province:"Gauteng", street:"Rose Street", houseNo:"12", postalCode:"2001", contact:"0821234567", email:"alice@example.com"},
    {name:"Thabo", surname:"Dlamini", city:"Johannesburg", province:"Gauteng", street:"Oak Avenue", houseNo:"34", postalCode:"2002", contact:"0822345678", email:"thabo@example.com"},
    {name:"Sipho", surname:"Nkosi", city:"Johannesburg", province:"Gauteng", street:"Maple Lane", houseNo:"56", postalCode:"2003", contact:"sipho@example.com"},
    {name:"Lindiwe", surname:"Mthembu", city:"Johannesburg", province:"Gauteng", street:"King Road", houseNo:"78", postalCode:"2004", contact:"lindiwe@example.com", email:"lindiwe@example.com"}
];

// Load quotations with wait timer
function loadQuotations(){
    const container = document.getElementById("quotations-container");
    const waitMessage = document.getElementById("quotation-wait-message");
    if(jobCart.length===0){ container.innerHTML="<p>No services selected.</p>"; waitMessage.style.display="none"; return; }
    let countdown = 30;
    waitMessage.style.display="block"; waitMessage.innerText = `Please wait while we filter quotations... (${countdown}s)`;
    const interval = setInterval(()=>{
        countdown--; waitMessage.innerText = `Please wait while we filter quotations... (${countdown}s)`;
        if(countdown<=0){ clearInterval(interval); waitMessage.style.display="none"; showQuotations(container); }
    },1000);
}

// Display quotations
function showQuotations(container){
    container.innerHTML="";
    jobCart.forEach(item=>{
        const min = parseInt(document.getElementById("min_price").value) || 500;
        const max = parseInt(document.getElementById("max_price").value) || 5000;
        const usedProviders = new Set();
        for(let i=0;i<3;i++){
            let provider;
            do { provider = sampleProviders[Math.floor(Math.random()*sampleProviders.length)]; } while(usedProviders.has(provider.name));
            usedProviders.add(provider.name);
            const price = Math.floor(Math.random()*(max-min+1))+min;
            const quotationID = `Q${Math.floor(Math.random()*10000)}`;
            const jobCartID = `JC${Math.floor(Math.random()*1000)}`;
            const submissionDate = new Date();
            const card = document.createElement("div"); card.className = "quotation-card"; 
            card.innerHTML = `<span>${item.service_name} - R${price}</span>`;
            const acceptBtn = document.createElement("button"); acceptBtn.innerText="Accept";
            const rejectBtn = document.createElement("button"); rejectBtn.innerText="Reject";
            const viewBtn = document.createElement("button"); viewBtn.innerText="View";

            acceptBtn.onclick = () => {
                selectedQuotations[item.service_id] = {service_name:item.service_name, price, provider, quotationID, jobCartID, submissionDate};
                calculateTotal();
                const allCards = Array.from(container.querySelectorAll('.quotation-card'));
                allCards.forEach(c=>{
                    const span=c.querySelector('span'); const btns=c.querySelectorAll('button');
                    if(span.innerText.startsWith(item.service_name)){
                        if(c===card){ c.classList.add("accepted"); rejectBtn.disabled=false; } 
                        else { c.classList.add("rejected"); btns.forEach(b=>b.disabled=true); }
                    }
                });
                validateStep(4);
            };
            rejectBtn.onclick = () => { card.classList.add("rejected"); acceptBtn.disabled=true; rejectBtn.disabled=true; validateStep(4); };
            viewBtn.onclick = () => generatePDF({service_name:item.service_name, price, provider, quotationID, jobCartID, submissionDate});

            card.appendChild(acceptBtn); card.appendChild(rejectBtn); card.appendChild(viewBtn);
            container.appendChild(card);
        }
    });
}

// Calculate totals
function calculateTotal(){
    let total = 0;
    for(const key in selectedQuotations) total += selectedQuotations[key].price;
    document.getElementById("cart-total").innerText = `Total: R${total}`;
    document.getElementById("cart-accepted-total").innerText = `Accepted quotations total: R${total}`;
}

// Load summary
function loadSummary(){
    const container=document.getElementById("summary-container"); container.innerHTML="";
    if(Object.keys(selectedQuotations).length===0){ container.innerHTML="<p>No quotations accepted yet.</p>"; return; }
    const totalAmount=Object.values(selectedQuotations).reduce((sum,q)=>sum+q.price,0);
    Object.values(selectedQuotations).forEach(q=>{
        const div=document.createElement("div"); div.className="summary-card"; 
        div.innerHTML=`
            <p><strong>Service:</strong> ${q.service_name}</p>
            <p><strong>Price:</strong> R${q.price}</p>
            <p><strong>Provider Name:</strong> ${q.provider.name} ${q.provider.surname}</p>
            <p><strong>Contact:</strong> ${q.provider.contact}</p>
            <p><strong>Email:</strong> ${q.provider.email||''}</p>
            <p><strong>Address:</strong> ${q.provider.houseNo}, ${q.provider.street}, ${q.provider.city}, ${q.provider.province}, ${q.provider.postalCode}</p>
            <button class="pdf-btn">View PDF</button>
        `;
        container.appendChild(div);
        div.querySelector(".pdf-btn").onclick=()=>generatePDF(q);
    });
    const totalEl=document.createElement("p"); totalEl.innerHTML=`<strong>Total: R${totalAmount}</strong>`; container.appendChild(totalEl);
}

// Generate PDF
function generatePDF(quotation){
    const { service_name, price, provider, quotationID, jobCartID, submissionDate }=quotation;
    const doc = new jspdf.jsPDF();
    doc.setFontSize(18); doc.text("Quotation Details",14,20);
    doc.setFontSize(12);
    doc.text(`Quotation ID: ${quotationID}`,14,30);
    doc.text(`Job Cart ID: ${jobCartID}`,14,37);
    doc.text(`Submission Date: ${submissionDate.toLocaleString()}`,14,44);
    doc.text(`Service: ${service_name}`,14,55);
    doc.text(`Price: R${price}`,14,62);
    doc.text("Provider Information:",14,74);
    doc.text(`Name: ${provider.name} ${provider.surname}`,14,81);
    doc.text(`Contact: ${provider.contact}`,14,88);
    doc.text(`Email: ${provider.email||''}`,14,95);
    doc.text(`Address: ${provider.houseNo}, ${provider.street}, ${provider.city}, ${provider.province}, ${provider.postalCode}`,14,102);
    doc.save(`${service_name}_Quotation.pdf`);
}

// Confirm booking
async function confirmBooking() {
    if (Object.keys(selectedQuotations).length === 0) {
        alert("Please accept at least one quotation before continuing.");
        return;
    }

    const totalAmount = Object.values(selectedQuotations).reduce((sum, q) => sum + q.price, 0);
    localStorage.setItem("totalAmount", totalAmount);

    try {
        // 1️⃣ Insert event first
        const { data: eventData, error: eventError } = await sb.from('event').insert({
            event_type: document.getElementById('event_type').value,
            event_date: document.getElementById('event_date').value,
            event_start_time: document.getElementById('start_time').value,
            event_end_time: document.getElementById('end_time').value,
            event_location: document.getElementById('location').value
        }).select();

        if (eventError) throw new Error(eventError.message);
        const eventId = eventData[0].event_id;

        // 2️⃣ Insert booking linked to the event
        const { data: bookingData, error: bookingError } = await sb.from('booking').insert({
            client_id: clientId,
            event_id: eventId, // now valid
            booking_min_price: parseFloat(document.getElementById('min_price').value) || 0,
            booking_max_price: parseFloat(document.getElementById('max_price').value) || 0,
            booking_special_requests: document.getElementById('special_requests').value,
            booking_date: new Date().toISOString()
        }).select();

        if (bookingError) throw new Error(bookingError.message);

        // ✅ Show confirmation and redirect
        const msg = document.getElementById('redirect-message');
        msg.innerText = "Booking confirmed! Redirecting to payment...";
        msg.style.display = 'block';
        document.getElementById("confirm-booking").disabled = true;

        setTimeout(() => {
            window.location.href = 'payment.html';
        }, 2000);

    } catch (error) {
        alert("Booking failed: " + error.message);
    }
}

// Job cart dropdown
function toggleCartDropdown(){
    const dropdown = document.getElementById("cart-dropdown");
    dropdown.style.display = dropdown.style.display==='block'?'none':'block';
}
function openCartModal(){ document.getElementById('cart-modal').style.display='flex'; }
function closeCartModal(){ document.getElementById('cart-modal').style.display='none'; }

</script>
</body>
</html>
