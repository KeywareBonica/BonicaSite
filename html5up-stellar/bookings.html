<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bonica Event Booking</title>
<link rel="stylesheet" href="css/bookings.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<header class="navbar">
  <a href="index.html" class="logo">
    <img src="img/logo.jpeg" alt="Bonica Logo"> Bonica
  </a>
  <nav class="nav-links">
    <a href="index.html">Home</a>
    <a href="#">About</a>
    <a href="#">Services</a>
    <div class="dropdown">
      <button class="dropbtn">Help ▼</button>
      <div class="dropdown-menu">
        <a href="#">Pricing Plan</a>
        <a href="#">Our Team</a>
        <a href="#">Working Hours</a>
        <a href="#">404 Page</a>
      </div>
    </div>
    <a href="#">Contact</a>
    <a href="profile.html" class="profile-btn">Profile</a>
  </nav>
</header>

<div class="container">

  <!-- Step 1: Welcome -->
  <div class="step active" id="step-1">
    <h2>Welcome!</h2>
    <p>Do you want to make a booking?</p>
    <div class="booking-choice-buttons">
      <button onclick="startBooking()">Yes</button>
      <button onclick="cancelBooking()">No</button>
    </div>
  </div>

  <!-- Step 2: Event Details -->
  <div class="step" id="step-2">
    <h2>Event Details</h2>
    <label>Event Type
      <select id="event_type" onchange="toggleOtherEventInput()">
        <option value="">-- Select Event Type --</option>
        <option value="wedding">Wedding</option>
        <option value="birthday">Birthday</option>
        <option value="graduation">Graduation</option>
        <option value="corporate_event">Corporate Event</option>
        <option value="concert">Concert</option>
        <option value="baby_shower">Baby Shower</option>
        <option value="anniversary">Anniversary</option>
        <option value="engagement_party">Engagement Party</option>
        <option value="conference">Conference</option>
        <option value="other">Other</option>
      </select>
    </label>
    <div id="other-event-wrapper" style="display:none; margin-top:8px;">
      <input type="text" id="other_event_type" placeholder="Enter your event type here" />
    </div>
    <label>Date <input type="date" id="event_date"></label>
    <label>Start Time <input type="time" id="start_time"></label>
    <label>End Time <input type="time" id="end_time"></label>
    <label>Location <input type="text" id="location" placeholder="Enter city/area"></label>
    <label>Special Requests (optional)
      <textarea id="special_requests"></textarea>
    </label>
    <label>Budget Range</label>
    <input type="number" id="min_price" placeholder="Minimum Price">
    <input type="number" id="max_price" placeholder="Maximum Price">
  </div>

  <!-- Step 3: Select Services -->
  <div class="step" id="step-3">
    <h2>Select Services</h2>
    <input type="text" id="service-search" placeholder="Search services..." oninput="filterServices()">
    <div id="services-grid" class="services-grid"></div>
  </div>

  <!-- Step 4: Quotations -->
  <div class="step" id="step-4">
    <h2>Quotations</h2>
    <p id="quotation-wait-message">Please wait while we upload your quotations…</p>
    <div id="quotations-container"></div>
  </div>

  <!-- Step 5: Review Summary -->
  <div class="step" id="step-5">
    <h2>Review Summary</h2>
    <div id="summary-container"></div>
    <button id="confirm-booking" onclick="confirmBooking()">Confirm Booking</button>
  </div>

  <div class="buttons">
    <button id="prevBtn" onclick="prevStep()">Previous</button>
    <button id="nextBtn" onclick="nextStep()">Next</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const clientId = localStorage.getItem("clientId");
if(!clientId){ alert("You must be logged in to make a booking!"); window.location.href="login.html"; }

let currentStep = 1;
let booking_id = null;
let servicesList = [];
let selectedQuotations = {}; // { serviceName: { provider, price } }

// -------- Navigation --------
function startBooking(){ currentStep=2; showStep(currentStep); }
function cancelBooking(){ window.location.href='index.html'; }
function prevStep(){ if(currentStep>1){ currentStep--; showStep(currentStep); } }

function showStep(n){
  const steps = document.querySelectorAll('.step');
  steps.forEach((s,i)=> s.classList.toggle('active', i===n-1));
  document.getElementById('prevBtn').style.display = (n===1)?'none':'inline-block';
  document.getElementById('nextBtn').style.display = (n===5)?'none':'inline-block';
  if(n===3) loadServicesGrid();
  if(n===4) loadQuotations();
}

// -------- Event Type --------
function toggleOtherEventInput(){
  document.getElementById("other-event-wrapper").style.display = document.getElementById("event_type").value==="other" ? "block" : "none";
}

// -------- Services Grid --------
async function loadServicesGrid(){
  const {data,error} = await sb.from("service").select("service_id, service_name");
  if(error) return console.error(error.message);
  servicesList = data;
  renderServicesGrid(servicesList);
}

function renderServicesGrid(list){
  const container = document.getElementById("services-grid");
  container.innerHTML="";
  list.forEach(s=>{
    const card = document.createElement("div");
    card.className="service-card";
    card.innerHTML = `<label><input type="checkbox" value="${s.service_id}" onchange="updateJobCartPopup(this)"> ${s.service_name}</label>`;
    container.appendChild(card);
  });
}

function filterServices(){
  const q=document.getElementById("service-search").value.toLowerCase();
  renderServicesGrid(servicesList.filter(s=>s.service_name.toLowerCase().includes(q)));
}

// -------- Job Cart Popup --------
function updateJobCartPopup(cb){
  const serviceName = servicesList.find(s=>s.service_id===cb.value).service_name;
  alert(`Job cart updated: ${serviceName} ${cb.checked ? "added" : "removed"}.`);
}

// -------- Save Event & Booking --------
async function saveEventAndBooking(){
  const event_type = document.getElementById("event_type").value==="other" ? document.getElementById("other_event_type").value : document.getElementById("event_type").value;
  const event_date = document.getElementById("event_date").value;
  const startTime = document.getElementById("start_time").value;
  const endTime = document.getElementById("end_time").value;
  const location = document.getElementById("location").value;
  const special = document.getElementById("special_requests").value;
  const minPrice = parseFloat(document.getElementById("min_price").value);
  const maxPrice = parseFloat(document.getElementById("max_price").value);

  const {data:eventData,error:eventError} = await sb.from("event").insert([{event_type,event_date,event_start_time:startTime,event_end_time:endTime,event_location:location}]).select().single();
  if(eventError){ alert("Error saving event: "+eventError.message); return; }

  const {data:bookingData,error:bookingError} = await sb.from("booking").insert([{
    client_id: clientId, event_id:eventData.event_id, booking_special_requests:special,
    booking_min_price:minPrice, booking_max_price:maxPrice, booking_date:new Date().toISOString()
  }]).select().single();
  if(bookingError){ alert("Error saving booking: "+bookingError.message); return; }
  booking_id = bookingData.booking_id;

  const selectedServiceIDs = Array.from(document.querySelectorAll('#services-grid input:checked')).map(cb=>cb.value);
  for(const service_id of selectedServiceIDs){
    await sb.from("event_service").insert([{event_id:eventData.event_id, service_id}]);
  }
}

// -------- Next Step --------
async function nextStep(){
  if(currentStep===2) await saveEventAndBooking();
  if(currentStep < 5){ currentStep++; showStep(currentStep); }
}

// -------- Load & Show Quotations --------
async function loadQuotations(){
  const container = document.getElementById("quotations-container");
  container.innerHTML = "";
  const waitMessage = document.getElementById("quotation-wait-message");
  waitMessage.style.display = "block";

  const selectedServices = Array.from(document.querySelectorAll('#services-grid input:checked')).map(cb=>cb.value);
  if(selectedServices.length === 0) {
    container.innerHTML = "<p>No services selected. Please go back.</p>";
    waitMessage.style.display = "none";
    return;
  }

  // fake wait
  let waitSeconds = 3;
  const countdown = setInterval(() => {
    waitSeconds--;
    waitMessage.innerText = `Please wait while we upload your quotations… (${waitSeconds}s)`;
    if(waitSeconds <= 0){
      clearInterval(countdown);
      waitMessage.style.display="none";
      showQuotations(selectedServices, container);
    }
  },1000);
}

function showQuotations(selectedServices, container){
  container.innerHTML = "";
  selectedServices.forEach(service_id=>{
    const serviceName = servicesList.find(s=>s.service_id===service_id).service_name;
    const groupDiv = document.createElement("div");
    groupDiv.className="quotation-group";
    groupDiv.innerHTML = `<h4>${serviceName}</h4>`;

    for(let i=1;i<=3;i++){
      const price = Math.floor(Math.random()*500 + 100);
      const minPrice = parseFloat(document.getElementById("min_price").value);
      const maxPrice = parseFloat(document.getElementById("max_price").value);
      const disabled = price<minPrice || price>maxPrice ? "disabled" : "";

      const div = document.createElement("div");
      div.className="quotation-card";
      div.innerHTML = `
        <label>
          <input type="radio" name="service-${service_id}" value="${i}" ${disabled} onchange="selectQuotation('${serviceName}','Provider ${i}',${price},this)">
          Provider ${i} - R${price}
        </label>
      `;
      groupDiv.appendChild(div);
    }
    container.appendChild(groupDiv);
  });
}

// -------- Select & Highlight Quotation --------
function selectQuotation(serviceName, provider, price, input){
  // Deselect previously selected card
  const radios = document.getElementsByName(`service-${input.name.split('-')[1]}`);
  radios.forEach(r => r.closest('.quotation-card')?.classList.remove('accepted'));

  // Highlight this card
  input.closest('.quotation-card').classList.add('accepted');
  selectedQuotations[serviceName] = { provider, price };
  updateSummary();
}

// -------- Summary --------
function updateSummary(){
  const container = document.getElementById("summary-container");
  container.innerHTML = "";
  Object.keys(selectedQuotations).forEach(service=>{
    const q = selectedQuotations[service];
    const div = document.createElement("div");
    div.innerHTML = `<h4>${service}</h4><p>Provider: ${q.provider}</p><p>Price: R${q.price}</p>`;
    container.appendChild(div);
  });
}

// -------- Confirm Booking --------
function confirmBooking(){
  if(Object.keys(selectedQuotations).length===0){ alert("Please select at least one quotation."); return; }
  alert("Booking confirmed! Redirecting to payment...");
  setTimeout(()=>{ window.location.href='payment.html'; },1500);
}
</script>

</body>
</html>
