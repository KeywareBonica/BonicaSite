<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bonica Event Booking</title>
<link rel="stylesheet" href="css/bookings.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<header class="navbar">
  <a href="index.html" class="logo">
    <img src="img/logo.jpeg" alt="Bonica Logo"> Bonica
  </a>
  <nav class="nav-links">
    <a href="index.html">Home</a>
    <a href="#">About</a>
    <a href="#">Services</a>
    <div class="dropdown">
      <button class="dropbtn">Help ▼</button>
      <div class="dropdown-menu">
        <a href="#">Pricing Plan</a>
        <a href="#">Our Team</a>
        <a href="#">Working Hours</a>
        <a href="#">404 Page</a>
      </div>
    </div>
    <a href="#">Contact</a>
    <a href="profile.html" class="profile-btn">Profile</a>
  </nav>
</header>

<div class="container">

  <!-- Step 1: Welcome -->
  <div class="step active" id="step-1">
    <h2>Welcome!</h2>
    <p>Do you want to make a booking?</p>
    <div class="booking-choice-buttons">
      <button onclick="startBooking()">Yes</button>
      <button onclick="cancelBooking()">No</button>
    </div>
  </div>

  <!-- Step 2: Event Details -->
  <div class="step" id="step-2">
    <h2>Event Details</h2>
    <label>Event Type
      <select id="event_type" onchange="toggleOtherEventInput()">
        <option value="">-- Select Event Type --</option>
        <option value="wedding">Wedding</option>
        <option value="birthday">Birthday</option>
        <option value="graduation">Graduation</option>
        <option value="corporate_event">Corporate Event</option>
        <option value="concert">Concert</option>
        <option value="baby_shower">Baby Shower</option>
        <option value="anniversary">Anniversary</option>
        <option value="engagement_party">Engagement Party</option>
        <option value="conference">Conference</option>
        <option value="other">Other</option>
      </select>
    </label>
    <div id="other-event-wrapper" style="display:none; margin-top:8px;">
      <input type="text" id="other_event_type" placeholder="Enter your event type here" />
    </div>
    <label>Date <input type="date" id="event_date"></label>
    <label>Start Time <input type="time" id="start_time"></label>
    <label>End Time <input type="time" id="end_time"></label>
    <label>Location <input type="text" id="location" placeholder="Enter city/area"></label>
    <label>Special Requests (optional)
      <textarea id="special_requests"></textarea>
    </label>
    <label>Budget Range</label>
    <input type="number" id="min_price" placeholder="Minimum Price">
    <input type="number" id="max_price" placeholder="Maximum Price">
  </div>

  <!-- Step 3: Select Services -->
  <div class="step" id="step-3">
    <h2>Select Services</h2>
    <p id="jobcart-message" style="display:none; color:green; font-weight:bold; margin-bottom:10px;"></p>
    <input type="text" id="service-search" placeholder="Search services..." oninput="filterServices()">
    <div id="services-grid" class="services-grid"></div>
  </div>

  <!-- Step 4: Quotations -->
  <div class="step" id="step-4">
    <h2>Quotations</h2>
    <p id="quotation-wait-message">Please wait while we upload your quotations…</p>
    <div id="quotations-container"></div>
  </div>

  <!-- Step 5: Review Summary -->
  <div class="step" id="step-5">
    <h2>Review Summary</h2>
    <div id="summary-container"></div>
    <p id="redirect-message" style="display:none; color:#0d6efd; font-weight:bold; margin-top:15px;"></p>
    <button id="confirm-booking" onclick="confirmBooking()">Confirm Booking</button>
  </div>

  <div class="buttons">
    <button id="prevBtn" onclick="prevStep()">Previous</button>
    <button id="nextBtn" onclick="nextStep()">Next</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
const SUPABASE_KEY = "YOUR_SUPABASE_KEY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const clientId = localStorage.getItem("clientId");
if(!clientId){ alert("You must be logged in to make a booking!"); window.location.href="login.html"; }

let currentStep = 1;
let booking_id = null;
let servicesList = [];
let selectedQuotations = {};

// --------- Navigation ---------
function startBooking(){ currentStep=2; showStep(currentStep); }
function cancelBooking(){ window.location.href='index.html'; }
function prevStep(){ if(currentStep>1){ currentStep--; showStep(currentStep); } }

function showStep(n){
  const steps=document.querySelectorAll('.step');
  steps.forEach((s,i)=> s.classList.toggle('active', i===n-1));
  document.getElementById('prevBtn').style.display = (n===1)?'none':'inline-block';
  document.getElementById('nextBtn').style.display = (n>=steps.length)?'none':'inline-block';
  if(n===3) loadServicesGrid();
  if(n===4) loadQuotations();
}

// --------- Event Type ---------
function toggleOtherEventInput(){
  document.getElementById("other-event-wrapper").style.display = document.getElementById("event_type").value==="other" ? "block" : "none";
}

// --------- Services Grid ---------
async function loadServicesGrid(){
  // Mock services for now
  servicesList = [
    {service_id:"s1", service_name:"Catering"},
    {service_id:"s2", service_name:"Photography"},
    {service_id:"s3", service_name:"Decoration"},
    {service_id:"s4", service_name:"Music/DJ"},
    {service_id:"s5", service_name:"Venue"}
  ];
  renderServicesGrid(servicesList);
}

function renderServicesGrid(list){
  const container = document.getElementById("services-grid");
  container.innerHTML="";
  list.forEach(s=>{
    const card = document.createElement("div");
    card.className="service-card";
    card.innerHTML = `<label><input type="checkbox" value="${s.service_id}" onchange="updateJobCart()"> ${s.service_name}</label>`;
    container.appendChild(card);
  });
}

function filterServices(){
  const q=document.getElementById("service-search").value.toLowerCase();
  const filtered = servicesList.filter(s=>s.service_name.toLowerCase().includes(q));
  renderServicesGrid(filtered);
}

function updateJobCart(){
  const selected = Array.from(document.querySelectorAll('#services-grid input:checked')).map(cb=>cb.value);
  const msg = document.getElementById("jobcart-message");
  if(selected.length>0){
    const now=new Date();
    const selectedNames = servicesList.filter(s=>selected.includes(s.service_id)).map(s=>s.service_name);
    msg.style.display="block";
    msg.innerText=`Job cart created on ${now.toLocaleDateString()} at ${now.toLocaleTimeString()} with: ${selectedNames.join(", ")}`;
  } else msg.style.display="none";
}

// --------- Save Event & Booking (mock) ---------
async function saveEventAndBooking(){ /* skipping Supabase for mock */ }

// --------- Next Step ---------
async function nextStep(){
  if(currentStep===2) await saveEventAndBooking();
  if(currentStep < document.querySelectorAll('.step').length){ currentStep++; showStep(currentStep); }
}

// --------- Confirm Booking ---------
function confirmBooking() {
  const msg = document.getElementById('redirect-message');
  const providers = Object.values(selectedQuotations).map(q => q.provider);
  msg.innerHTML = `Booking confirmed!<br>You selected services from: ${[...new Set(providers)].join(", ")}.<br>Redirecting to payment...`;
  msg.style.display = 'block';
  document.getElementById("confirm-booking").disabled = true;
  setTimeout(() => { window.location.href = 'payment.html'; }, 3500);
}

// --------- Load & Show Quotations (Mock) ---------
function loadQuotations(){
  const container = document.getElementById("quotations-container");
  container.innerHTML = "";
  const waitMessage = document.getElementById("quotation-wait-message");
  waitMessage.style.display = "block";

  const selectedServices = Array.from(document.querySelectorAll('#services-grid input:checked')).map(cb=>cb.value);
  if(selectedServices.length===0){
    container.innerHTML="<p>No services selected. Please go back.</p>";
    waitMessage.style.display="none";
    return;
  }

  let waitSeconds = 3;
  waitMessage.innerText = `Please wait while we upload your quotations… (${waitSeconds}s)`;
  const countdown = setInterval(()=>{
    waitSeconds--;
    waitMessage.innerText = `Please wait while we upload your quotations… (${waitSeconds}s)`;
    if(waitSeconds<=0){
      clearInterval(countdown);
      waitMessage.style.display="none";
      showQuotations(selectedServices, container);
    }
  },1000);
}

function showQuotations(selectedServices, container){
  const quotations = [];
  selectedServices.forEach(service_id=>{
    const serviceName = servicesList.find(s=>s.service_id===service_id).service_name;
    for(let i=1;i<=3;i++){
      quotations.push({
        quotation_id: `q-${service_id}-${i}-${Date.now()}`,
        service_name: serviceName,
        provider_name: `Provider ${i}`,
        price: (Math.random()*500 + 100).toFixed(2)
      });
    }
  });

  container.innerHTML="";
  quotations.forEach(q=>{
    const div = document.createElement("div");
    div.classList.add("quotation-card");
    div.id = q.quotation_id;
    div.innerHTML = `
      <p><strong>${q.service_name}</strong> by ${q.provider_name}</p>
      <p>Price: R${q.price}</p>
      <div>
        <button class="accept-btn" onclick="acceptQuotation('${q.quotation_id}', ${q.price}, '${q.service_name}', '${q.provider_name}', this)">Accept</button>
        <button class="unavailable-btn" onclick="rejectQuotation('${q.quotation_id}')">Reject</button>
        <button class="view-btn" onclick="downloadQuotationPDF('${q.quotation_id}')">View</button>
      </div>
    `;
    container.appendChild(div);
  });
}

// --------- Accept Quotation ---------
function acceptQuotation(id, price, service, provider, btn){
  const alreadyAccepted = Object.values(selectedQuotations).some(q => q.service === service);
  if(alreadyAccepted){ alert(`You already accepted a quotation for ${service}.`); return; }
  selectedQuotations[id] = {service, provider, price};
  btn.innerText = "Accepted ✓";
  btn.classList.add("accepted-btn");
  btn.disabled = true;
  document.querySelectorAll('.quotation-card').forEach(card=>{
    if(card.innerText.includes(service) && card.id !== id){
      const acceptBtn = card.querySelector("button:first-child");
      if(acceptBtn){ acceptBtn.disabled=true; acceptBtn.innerText="Unavailable"; acceptBtn.style.opacity="0.5"; }
    }
  });
  updateSummary();
}

// --------- Reject Quotation ---------
function rejectQuotation(id){
  const card = document.getElementById(id);
  if(card) card.remove();
  if(selectedQuotations[id]){ delete selectedQuotations[id]; updateSummary(); }
}

// --------- Update Summary ---------
function updateSummary(){
  const container=document.getElementById("summary-container");
  container.innerHTML="";
  if(Object.keys(selectedQuotations).length===0){
    container.innerHTML="<p>No quotations accepted yet.</p>";
    return;
  }
  Object.values(selectedQuotations).forEach(q=>{
    const div=document.createElement("div");
    div.className="summary-card";
    div.innerHTML=`
      <h4>${q.service} <span class="accepted-label">✔ Accepted</span></h4>
      <p>Provider: ${q.provider}</p>
      <p>Price: R${q.price}</p>
    `;
    container.appendChild(div);
  });
}

// --------- Download PDF ---------
function downloadQuotationPDF(id){
  const { jsPDF } = window.jspdf;
  const div = document.getElementById(id);
  if(!div) return;
  const serviceName = div.querySelector("p:nth-child(1)").innerText;
  const price = div.querySelector("p:nth-child(2)").innerText;
  const eventType = document.getElementById('event_type').value==="other"?document.getElementById('other_event_type').value:document.getElementById('event_type').value;
  const eventDate = document.getElementById('event_date').value;
  const startTime = document.getElementById('start_time').value;
  const endTime = document.getElementById('end_time').value;
  const location = document.getElementById('location').value;

  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Bonica Event Quotation", 20, 20);
  doc.setFontSize(12);
  doc.text(`Event Type: ${eventType}`, 20, 30);
  doc.text(`Event Date: ${eventDate}`, 20, 38);
  doc.text(`Time: ${startTime} - ${endTime}`, 20, 46);
  doc.text(`Location: ${location}`, 20, 54);
  const [service, provider] = serviceName.split(" by ");
  doc.text(`Service: ${service}`, 20, 70);
  doc.text(`Provider: ${provider}`, 20, 78);
  doc.text(`Price: ${price.replace("Price: ","")}`, 20, 86);
  doc.save(`${id}.pdf`);
}
</script>
</body>
</html>
