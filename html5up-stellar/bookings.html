<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bonica Event Booking</title>
<link rel="stylesheet" href="css/bookings.css">
<style>
/* Enhanced Quotation Cards */
.quotation-card {
  background: white;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  transition: var(--transition-fast);
  box-shadow: var(--shadow-md);
}

.quotation-card:hover {
  border-color: var(--primary-blue);
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Responsive Bookings Styles */
@media (max-width: 768px) {
  .quotation-card {
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    border-radius: var(--radius-md);
  }
  
  .quotation-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .service-name {
    font-size: var(--font-size-mobile);
    font-weight: 600;
  }
  
  .provider-info {
    font-size: var(--font-size-mobile);
  }
  
  .quotation-details {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .rating {
    font-size: var(--font-size-mobile);
  }
  
  .location-info {
    font-size: var(--font-size-mobile);
  }
  
  .quotation-buttons {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    width: 100%;
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-mobile);
  }
  
  .container {
    padding: var(--spacing-sm);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-mobile);
    padding: var(--spacing-sm);
  }
  
  .btn {
    font-size: var(--font-size-mobile);
    padding: var(--spacing-sm) var(--spacing-md);
  }
  
  h1 {
    font-size: var(--heading-size-mobile);
  }
  
  h2 {
    font-size: var(--heading-size-mobile);
  }
  
  .form-group {
    margin-bottom: var(--spacing-md);
  }
}

@media (min-width: 768px) and (max-width: 1024px) {
  .quotation-card {
    padding: var(--spacing-lg);
  }
  
  .service-name {
    font-size: var(--font-size-tablet);
  }
  
  .provider-info {
    font-size: var(--font-size-tablet);
  }
  
  .rating,
  .location-info {
    font-size: var(--font-size-tablet);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    font-size: var(--font-size-tablet);
    padding: var(--spacing-sm) var(--spacing-md);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-tablet);
  }
  
  .btn {
    font-size: var(--font-size-tablet);
  }
  
  h1 {
    font-size: var(--heading-size-tablet);
  }
  
  h2 {
    font-size: var(--heading-size-tablet);
  }
}

@media (min-width: 1024px) {
  .quotation-card {
    padding: var(--spacing-xl);
  }
  
  .service-name {
    font-size: var(--font-size-desktop);
  }
  
  .provider-info {
    font-size: var(--font-size-desktop);
  }
  
  .rating,
  .location-info {
    font-size: var(--font-size-desktop);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    font-size: var(--font-size-desktop);
    padding: var(--spacing-md) var(--spacing-lg);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-desktop);
  }
  
  .btn {
    font-size: var(--font-size-desktop);
  }
  
  h1 {
    font-size: var(--heading-size-desktop);
  }
  
  h2 {
    font-size: var(--heading-size-desktop);
  }
}

@media (min-width: 1920px) {
  .quotation-card {
    padding: var(--spacing-tv);
    margin-bottom: var(--spacing-xl);
    border-radius: var(--radius-xl);
  }
  
  .quotation-header {
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }
  
  .service-name {
    font-size: var(--font-size-tv);
  }
  
  .provider-info {
    font-size: var(--font-size-tv);
  }
  
  .quotation-details {
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }
  
  .rating,
  .location-info {
    font-size: var(--font-size-tv);
  }
  
  .quotation-buttons {
    gap: var(--spacing-lg);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    font-size: var(--font-size-tv);
    padding: var(--spacing-lg) var(--spacing-xl);
  }
  
  .container {
    max-width: var(--container-tv);
    padding: var(--spacing-xl);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-tv);
    padding: var(--spacing-lg);
  }
  
  .btn {
    font-size: var(--font-size-tv);
    padding: var(--spacing-lg) var(--spacing-xl);
  }
  
  h1 {
    font-size: var(--heading-size-tv);
    margin-bottom: var(--spacing-xl);
  }
  
  h2 {
    font-size: var(--heading-size-tv);
    margin-bottom: var(--spacing-lg);
  }
  
  .form-group {
    margin-bottom: var(--spacing-xl);
  }
}

.quotation-card.accepted {
  border-color: #10b981;
  background: #f0fdf4;
}

.quotation-card.rejected {
  border-color: #ef4444;
  background: #fef2f2;
  opacity: 0.7;
}

.quotation-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.service-name {
  font-weight: 600;
  font-size: 1.1rem;
  color: #1f2937;
}

.provider-info {
  font-size: 0.9rem;
  color: #6b7280;
  font-weight: 500;
}

.quotation-details {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.rating {
  font-size: 0.9rem;
  color: #f59e0b;
  font-weight: 500;
}

.location-info {
  font-size: 0.85rem;
  color: #6b7280;
}

.quotation-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.quotation-buttons button {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.btn-accept {
  background: #10b981;
  color: white;
}

.btn-accept:hover:not(:disabled) {
  background: #059669;
  transform: translateY(-1px);
}

.btn-reject {
  background: #ef4444;
  color: white;
}

.btn-reject:hover:not(:disabled) {
  background: #dc2626;
  transform: translateY(-1px);
}

.btn-view {
  background: #3b82f6;
  color: white;
}

.btn-view:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.quotation-buttons button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

@media (max-width: 768px) {
  .quotation-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .quotation-details {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .quotation-buttons {
    width: 100%;
  }
  
  .quotation-buttons button {
    flex: 1;
    min-width: 80px;
  }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="js/location-service.js"></script>
<script src="js/location-input.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<header class="navbar">
  <a href="index.html" class="logo">
    <img src="img/logo.jpeg" alt="Bonica Logo"> Bonica
  </a>
  <nav class="nav-links">
    <a href="index.html">Home</a>
    <a href="#">About</a>
    <a href="#">Services</a>
    <a href="#">Contact</a>
    <div class="job-cart">
      <button onclick="toggleCartDropdown()">🛒 Job Cart (<span id="cart-count">0</span>)</button>
      <div id="cart-dropdown" class="cart-dropdown" style="display:none;">
        <ul id="cart-items"></ul>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button style="flex:1;" onclick="openCartModal()">View Cart</button>
          <button style="flex:1; background:#198754;" onclick="goToStep(3)">Edit</button>
        </div>
      </div>
    </div>
  </nav>
</header>

<div class="container">
  <!-- Step 1 -->
  <div class="step active" id="step-1">
    <h2>Welcome!</h2>
    <p>Do you want to make a booking?</p>
    <div class="booking-choice-buttons">
      <button class="primary-btn" onclick="startBooking()">Yes</button>
      <button class="primary-btn" onclick="cancelBooking()">No</button>
    </div>
  </div>

  <!-- Step 2 -->
  <div class="step" id="step-2">
    <h2>Event Details</h2>
    <label>Event Type
      <select id="event_type" onchange="toggleOtherEventInput()">
        <option value="">-- Select Event Type --</option>
        <option value="birthday">Birthday</option>
        <option value="graduation">Graduation</option>
        <option value="corporate_event">Corporate Event</option>
        <option value="concert">Concert</option>
        <option value="baby_shower">Baby Shower</option>
        <option value="anniversary">Anniversary</option>
        <option value="engagement_party">Engagement Party</option>
        <option value="conference">Conference</option>
        <option value="other">Other</option>
      </select>
    </label>
    <div id="other-event-wrapper" style="display:none; margin-top:8px;">
      <input type="text" id="other_event_type" placeholder="Enter your event type here" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" />
    </div>
    <label>Date <input type="date" id="event_date" autocomplete="off"></label>
    <label>Start Time <input type="time" id="start_time" autocomplete="off"></label>
    <label>End Time <input type="time" id="end_time" autocomplete="off"></label>
    <label>Location <input type="text" id="location" placeholder="Enter your event address" 
                           data-location-input="true"
                           data-placeholder="Enter your event address"
                           data-validation="true"
                           data-autocomplete="true"
                           autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off"></label>
    <small class="form-text text-muted" style="margin-top: 0.25rem; font-size: 0.875rem;">
      <i class="fas fa-map-marker-alt me-1"></i>
      Enter the event location to find nearby service providers
    </small>
    <label>Special Requests (optional)
      <textarea id="special_requests" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
    </label>
    <label>Budget Range</label>
    <input type="number" id="min_price" placeholder="Minimum Price" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off">
    <input type="number" id="max_price" placeholder="Maximum Price" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off">
  </div>

  <!-- Step 3 -->
  <div class="step" id="step-3">
    <h2>Select Services</h2>
    <input type="text" id="service-search" placeholder="Search services..." oninput="filterServices()" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off">
    <div id="services-grid" class="services-grid"></div>
  </div>

  <!-- Step 4 -->
  <div class="step" id="step-4">
    <h2>Quotations</h2>
    <p id="quotation-wait-message" style="display:none;"></p>
    <div id="quotations-container"></div>
  </div>

  <!-- Step 5 -->
  <div class="step" id="step-5">
    <h2>Review Summary</h2>
    <div id="summary-container"></div>
    <p id="redirect-message" style="display:none; color:#0d6efd; font-weight:bold; margin-top:15px;"></p>
    <button id="confirm-booking" class="primary-btn" onclick="confirmBooking()">Confirm Booking</button>
  </div>

  <div class="buttons">
    <button id="prevBtn" onclick="prevStep()">Previous</button>
    <button id="nextBtn" onclick="nextStep()">Next</button>
  </div>
</div>

<!-- Job Cart Modal -->
<div id="cart-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center;">
  <div style="background:#fff; width:min(900px,95vw); max-height:90vh; overflow:auto; border-radius:12px; padding:20px; position:relative;">
    <button onclick="closeCartModal()" style="position:absolute; top:10px; right:10px; background:#6c757d;">Close</button>
    <h2>Jobcart_ID: <span id="cart-id"></span></h2>
    <div id="cart-list"></div>
    <hr>
    <div style="display:flex; justify-content:flex-end; gap:20px; align-items:center;">
      <strong id="cart-accepted-total">Accepted quotations total: R0.00</strong>
      <h3 id="cart-total" style="margin:0;">Total: R0.00</h3>
    </div>
    <div style="margin-top:18px; color:#555;">
      <div>Create Time: <span id="cart-time"></span></div>
      <div>Create Date: <span id="cart-date"></span></div>
    </div>
  </div>
</div>

<script>
// Supabase setup
const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Authentication
const clientId = localStorage.getItem("clientId");
if (!clientId) { 
    alert("You must be logged in!"); 
    window.location.href = "login.html"; 
}
localStorage.removeItem("totalAmount");

// Step navigation
let currentStep = 1;
let jobCart = [];
let selectedQuotations = {};
const steps = document.querySelectorAll('.step');
showStep(currentStep);

function showStep(n){
    steps.forEach((s,i)=>s.classList.toggle('active', i===n-1));
    document.getElementById('prevBtn').style.display = n===1?'none':'inline-block';
    document.getElementById('nextBtn').style.display = n>=steps.length?'none':'inline-block';
    if(n===3) loadServicesGrid();
    if(n===4) loadQuotations();
    if(n===5) loadSummary();
    validateStep(n);
}

function startBooking(){ currentStep=2; showStep(currentStep); }
function cancelBooking(){ window.location.href="index.html"; }
function prevStep(){ if(currentStep>1){ currentStep--; showStep(currentStep); } }
function nextStep(){ if(validateStep(currentStep)){ currentStep++; showStep(currentStep); } }
function goToStep(n){ currentStep=n; showStep(n); }
function toggleOtherEventInput(){ 
    document.getElementById("other-event-wrapper").style.display = document.getElementById("event_type").value==="other"?"block":"none"; 
}

// Step validation
function validateStep(step){
    let valid = true;
    if(step===2){
        const type=document.getElementById("event_type").value,
              date=document.getElementById("event_date").value,
              start=document.getElementById("start_time").value,
              end=document.getElementById("end_time").value,
              location=document.getElementById("location").value;
        if(!type||!date||!start||!end||!location) valid=false;
    }
    if(step===3) if(jobCart.length===0) valid=false;
    if(step===4) if(Object.keys(selectedQuotations).length===0) valid=false;
    document.getElementById('nextBtn').disabled = !valid;
    return valid;
}
document.querySelectorAll('#step-2 input, #step-2 select').forEach(el=>el.addEventListener('input', ()=>validateStep(2)));
document.getElementById('services-grid').addEventListener('change', ()=>validateStep(3));
document.getElementById('quotations-container').addEventListener('click', ()=>validateStep(4));

// Services list
const servicesList = [
  { service_id:"s1", service_name:"MC", icon:"fa-microphone" },
  { service_id:"s2", service_name:"DJ", icon:"fa-music" },
  { service_id:"s3", service_name:"Makeup Artist", icon:"fa-face-smile" },
  { service_id:"s4", service_name:"Catering", icon:"fa-utensils" },
  { service_id:"s5", service_name:"Photography", icon:"fa-camera" },
  { service_id:"s6", service_name:"Decoration", icon:"fa-paint-roller" },
  { service_id:"s7", service_name:"Live Band", icon:"fa-guitar" },
  { service_id:"s8", service_name:"Venue", icon:"fa-building" },
  { service_id:"s9", service_name:"Florist", icon:"fa-seedling" },
  { service_id:"s10", service_name:"Lighting", icon:"fa-lightbulb" },
  { service_id:"s11", service_name:"Sound System", icon:"fa-volume-high" },
  { service_id:"s12", service_name:"Security", icon:"fa-shield" },
  { service_id:"s13", service_name:"Transport", icon:"fa-car" },
  { service_id:"s14", service_name:"Event Planner", icon:"fa-calendar-check" },
  { service_id:"s15", service_name:"Videography", icon:"fa-video" },
  { service_id:"s16", service_name:"Bartender", icon:"fa-glass-martini" },
  { service_id:"s17", service_name:"Host/Presenter", icon:"fa-user-tie" },
  { service_id:"s18", service_name:"Cake Designer", icon:"fa-birthday-cake" },
  { service_id:"s19", service_name:"Invitation Design", icon:"fa-envelope" },
  { service_id:"s20", service_name:"Furniture Rental", icon:"fa-couch" }
];

// Render services grid
function loadServicesGrid(){ renderServicesGrid(servicesList); }
function renderServicesGrid(list){
    const container = document.getElementById("services-grid"); 
    container.innerHTML = "";
    list.forEach(s=>{
        const card = document.createElement("div"); 
        card.className = "service-card text-center";
        card.innerHTML = `
            <i class="fa ${s.icon} fa-3x text-primary mb-3"></i>
            <h5>${s.service_name}</h5>
            <label><input type="checkbox" value="${s.service_id}" onchange="previewCart()"> Select</label>
        `;
        container.appendChild(card);
    });
    const selectedIds = new Set(jobCart.map(i=>i.service_id));
    container.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(selectedIds.has(cb.value)) cb.checked=true; });
}

// Services search and cart preview
function filterServices(){ 
    const q = document.getElementById("service-search").value.toLowerCase(); 
    renderServicesGrid(servicesList.filter(s=>s.service_name.toLowerCase().includes(q))); 
}
function previewCart(){
    const checked = new Set(Array.from(document.querySelectorAll('#services-grid input:checked')).map(cb=>cb.value));
    servicesList.forEach(s=>{
        if(checked.has(s.service_id) && !jobCart.find(i=>i.service_id===s.service_id)) jobCart.push({service_id:s.service_id, service_name:s.service_name});
    });
    jobCart = jobCart.filter(i=>checked.has(i.service_id));
    updateCartUI();
    validateStep(3);
}
function updateCartUI(){
    document.getElementById("cart-count").innerText = jobCart.length;
    const list = document.getElementById("cart-items"); list.innerHTML = "";
    if(jobCart.length===0){ 
        const li=document.createElement("li"); li.innerText="Cart is empty"; list.appendChild(li);
    } else { 
        jobCart.forEach(item=>{
            const li=document.createElement("li"); li.innerText=item.service_name; list.appendChild(li);
        });
    }
}

// Sample providers with location information
const sampleProviders = [
    {
        name:"Alice", 
        surname:"Mokoena", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"Rose Street", 
        houseNo:"12", 
        postalCode:"2001", 
        contact:"0821234567", 
        email:"alice@example.com",
        location:"12 Rose Street, Johannesburg, Gauteng, 2001",
        rating: 4.8
    },
    {
        name:"Thabo", 
        surname:"Dlamini", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"Oak Avenue", 
        houseNo:"34", 
        postalCode:"2002", 
        contact:"0822345678", 
        email:"thabo@example.com",
        location:"34 Oak Avenue, Johannesburg, Gauteng, 2002",
        rating: 4.6
    },
    {
        name:"Sipho", 
        surname:"Nkosi", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"Maple Lane", 
        houseNo:"56", 
        postalCode:"2003", 
        contact:"0833456789", 
        email:"sipho@example.com",
        location:"56 Maple Lane, Johannesburg, Gauteng, 2003",
        rating: 4.9
    },
    {
        name:"Lindiwe", 
        surname:"Mthembu", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"King Road", 
        houseNo:"78", 
        postalCode:"2004", 
        contact:"0844567890", 
        email:"lindiwe@example.com",
        location:"78 King Road, Johannesburg, Gauteng, 2004",
        rating: 4.7
    },
    {
        name:"Mandla", 
        surname:"Khumalo", 
        city:"Pretoria", 
        province:"Gauteng", 
        street:"Church Street", 
        houseNo:"45", 
        postalCode:"0002", 
        contact:"0855678901", 
        email:"mandla@example.com",
        location:"45 Church Street, Pretoria, Gauteng, 0002",
        rating: 4.5
    },
    {
        name:"Nomsa", 
        surname:"Mthembu", 
        city:"Sandton", 
        province:"Gauteng", 
        street:"Rivonia Road", 
        houseNo:"123", 
        postalCode:"2196", 
        contact:"0866789012", 
        email:"nomsa@example.com",
        location:"123 Rivonia Road, Sandton, Gauteng, 2196",
        rating: 4.8
    }
];

// Load quotations with wait timer
function loadQuotations(){
    const container = document.getElementById("quotations-container");
    const waitMessage = document.getElementById("quotation-wait-message");
    if(jobCart.length===0){ container.innerHTML="<p>No services selected.</p>"; waitMessage.style.display="none"; return; }
    let countdown = 30;
    waitMessage.style.display="block"; waitMessage.innerText = `Please wait while we filter quotations... (${countdown}s)`;
    const interval = setInterval(()=>{
        countdown--; waitMessage.innerText = `Please wait while we filter quotations... (${countdown}s)`;
        if(countdown<=0){ clearInterval(interval); waitMessage.style.display="none"; showQuotations(container); }
    },1000);
}

// Display quotations with location-based matching
async function showQuotations(container){
    container.innerHTML="";
    
    // Get client location
    const clientLocation = document.getElementById("location").value.trim();
    let locationInfo = "";
    
    if (clientLocation && window.locationService) {
        try {
            // Initialize location service if not already done
            if (!window.locationService.geocoder) {
                await window.locationService.initialize();
            }
            
            // Try to geocode the client location for distance calculations
            const clientCoords = await window.locationService.geocodeAddress(clientLocation);
            locationInfo = `📍 ${clientCoords.address}`;
        } catch (error) {
            console.warn("Could not geocode client location:", error);
            locationInfo = `📍 ${clientLocation}`;
        }
    }

    jobCart.forEach(item=>{
        const min = parseInt(document.getElementById("min_price").value) || 500;
        const max = parseInt(document.getElementById("max_price").value) || 5000;
        const usedProviders = new Set();
        
        for(let i=0;i<3;i++){
            let provider;
            do { provider = sampleProviders[Math.floor(Math.random()*sampleProviders.length)]; } while(usedProviders.has(provider.name));
            usedProviders.add(provider.name);
            
            const price = Math.floor(Math.random()*(max-min+1))+min;
            const quotationID = `Q${Math.floor(Math.random()*10000)}`;
            const jobCartID = `JC${Math.floor(Math.random()*1000)}`;
            const submissionDate = new Date();
            
            // Calculate distance if location is available
            let distanceInfo = "";
            if (clientLocation && provider.location) {
                // Simulate distance calculation (in real implementation, use locationService.calculateDistance)
                const distance = Math.floor(Math.random() * 25) + 1; // 1-25 km
                distanceInfo = ` | 📍 ${distance}km away`;
            }
            
            const card = document.createElement("div"); 
            card.className = "quotation-card"; 
            card.innerHTML = `
                <div class="quotation-header">
                    <span class="service-name">${item.service_name} - R${price}</span>
                    <span class="provider-info">${provider.name} ${provider.surname}${distanceInfo}</span>
                </div>
                <div class="quotation-details">
                    <div class="rating">⭐ ${provider.rating || 5}/5</div>
                    <div class="location-info">${locationInfo}</div>
                </div>
            `;
            
            const acceptBtn = document.createElement("button"); 
            acceptBtn.innerText="Accept";
            acceptBtn.className = "btn-accept";
            
            const rejectBtn = document.createElement("button"); 
            rejectBtn.innerText="Reject";
            rejectBtn.className = "btn-reject";
            
            const viewBtn = document.createElement("button"); 
            viewBtn.innerText="View Details";
            viewBtn.className = "btn-view";

            acceptBtn.onclick = () => {
                selectedQuotations[item.service_id] = {
                    service_name:item.service_name, 
                    price, 
                    provider, 
                    quotationID, 
                    jobCartID, 
                    submissionDate,
                    distance: distanceInfo
                };
                calculateTotal();
                const allCards = Array.from(container.querySelectorAll('.quotation-card'));
                allCards.forEach(c=>{
                    const serviceName = c.querySelector('.service-name');
                    const btns = c.querySelectorAll('button');
                    if(serviceName && serviceName.innerText.startsWith(item.service_name)){
                        if(c===card){ 
                            c.classList.add("accepted"); 
                            rejectBtn.disabled=true; 
                            viewBtn.disabled=true;
                        } else { 
                            c.classList.add("rejected"); 
                            btns.forEach(b=>b.disabled=true); 
                        }
                    }
                });
                validateStep(4);
            };
            
            rejectBtn.onclick = () => { 
                card.classList.add("rejected"); 
                acceptBtn.disabled=true; 
                viewBtn.disabled=true;
                validateStep(4); 
            };
            
            viewBtn.onclick = () => generatePDF({
                service_name:item.service_name, 
                price, 
                provider, 
                quotationID, 
                jobCartID, 
                submissionDate,
                distance: distanceInfo
            });

            const buttonContainer = document.createElement("div");
            buttonContainer.className = "quotation-buttons";
            buttonContainer.appendChild(acceptBtn); 
            buttonContainer.appendChild(rejectBtn); 
            buttonContainer.appendChild(viewBtn);
            
            card.appendChild(buttonContainer);
            container.appendChild(card);
        }
    });
}

// Calculate totals
function calculateTotal(){
    let total = 0;
    for(const key in selectedQuotations) total += selectedQuotations[key].price;
    document.getElementById("cart-total").innerText = `Total: R${total}`;
    document.getElementById("cart-accepted-total").innerText = `Accepted quotations total: R${total}`;
}

// Load summary
function loadSummary(){
    const container=document.getElementById("summary-container"); container.innerHTML="";
    if(Object.keys(selectedQuotations).length===0){ container.innerHTML="<p>No quotations accepted yet.</p>"; return; }
    const totalAmount=Object.values(selectedQuotations).reduce((sum,q)=>sum+q.price,0);
    Object.values(selectedQuotations).forEach(q=>{
        const div=document.createElement("div"); div.className="summary-card"; 
        div.innerHTML=`
            <p><strong>Service:</strong> ${q.service_name}</p>
            <p><strong>Price:</strong> R${q.price}</p>
            <p><strong>Provider Name:</strong> ${q.provider.name} ${q.provider.surname}</p>
            <p><strong>Contact:</strong> ${q.provider.contact}</p>
            <p><strong>Email:</strong> ${q.provider.email||''}</p>
            <p><strong>Address:</strong> ${q.provider.houseNo}, ${q.provider.street}, ${q.provider.city}, ${q.provider.province}, ${q.provider.postalCode}</p>
            <button class="pdf-btn">View PDF</button>
        `;
        container.appendChild(div);
        div.querySelector(".pdf-btn").onclick=()=>generatePDF(q);
    });
    const totalEl=document.createElement("p"); totalEl.innerHTML=`<strong>Total: R${totalAmount}</strong>`; container.appendChild(totalEl);
}

// Generate PDF
function generatePDF(quotation){
    const { service_name, price, provider, quotationID, jobCartID, submissionDate }=quotation;
    const doc = new jspdf.jsPDF();
    doc.setFontSize(18); doc.text("Quotation Details",14,20);
    doc.setFontSize(12);
    doc.text(`Quotation ID: ${quotationID}`,14,30);
    doc.text(`Job Cart ID: ${jobCartID}`,14,37);
    doc.text(`Submission Date: ${submissionDate.toLocaleString()}`,14,44);
    doc.text(`Service: ${service_name}`,14,55);
    doc.text(`Price: R${price}`,14,62);
    doc.text("Provider Information:",14,74);
    doc.text(`Name: ${provider.name} ${provider.surname}`,14,81);
    doc.text(`Contact: ${provider.contact}`,14,88);
    doc.text(`Email: ${provider.email||''}`,14,95);
    doc.text(`Address: ${provider.houseNo}, ${provider.street}, ${provider.city}, ${provider.province}, ${provider.postalCode}`,14,102);
    doc.save(`${service_name}_Quotation.pdf`);
}

// Confirm booking
async function confirmBooking() {
    if (Object.keys(selectedQuotations).length === 0) {
        alert("Please accept at least one quotation before continuing.");
        return;
    }

    const totalAmount = Object.values(selectedQuotations).reduce((sum, q) => sum + q.price, 0);
    localStorage.setItem("totalAmount", totalAmount);

    try {
        // 1️⃣ Insert event first
        const { data: eventData, error: eventError } = await sb.from('event').insert({
            event_type: document.getElementById('event_type').value,
            event_date: document.getElementById('event_date').value,
            event_start_time: document.getElementById('start_time').value,
            event_end_time: document.getElementById('end_time').value,
            event_location: document.getElementById('location').value
        }).select();

        if (eventError) throw new Error(eventError.message);
        const eventId = eventData[0].event_id;

        // 2️⃣ Insert booking linked to the event
        const { data: bookingData, error: bookingError } = await sb.from('booking').insert({
            client_id: clientId,
            event_id: eventId, // now valid
            booking_min_price: parseFloat(document.getElementById('min_price').value) || 0,
            booking_max_price: parseFloat(document.getElementById('max_price').value) || 0,
            booking_special_requests: document.getElementById('special_requests').value,
            booking_date: new Date().toISOString()
        }).select();

        if (bookingError) throw new Error(bookingError.message);

        // ✅ Show confirmation and redirect
        const msg = document.getElementById('redirect-message');
        msg.innerText = "Booking confirmed! Redirecting to payment...";
        msg.style.display = 'block';
        document.getElementById("confirm-booking").disabled = true;

        setTimeout(() => {
            window.location.href = 'payment.html';
        }, 2000);

    } catch (error) {
        alert("Booking failed: " + error.message);
    }
}

// Job cart dropdown
function toggleCartDropdown(){
    const dropdown = document.getElementById("cart-dropdown");
    dropdown.style.display = dropdown.style.display==='block'?'none':'block';
}
function openCartModal(){ document.getElementById('cart-modal').style.display='flex'; }
function closeCartModal(){ document.getElementById('cart-modal').style.display='none'; }

</script>
</body>
</html>
