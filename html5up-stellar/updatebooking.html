<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Booking</title>
  <link rel="stylesheet" href="css/updatebooking.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <a href="index.html" class="logo">
      <img src="logo.jpeg" alt="Logo" />
      Bonica
    </a>
    <ul class="nav-links" id="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="bookings.html">Bookings</a></li>
      <li><a href="#">Update Booking</a></li>
      <li><a href="#">Help</a></li>
      <li><a href="#">Contact</a></li>
    </ul>
    <div class="hamburger" id="hamburger">
      <div></div><div></div><div></div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <h1>Update Booking</h1>

    <!-- Step 1: Fetch booking by email -->
    <div id="lookup-step">
      <p>Welcome, <span id="user-email"></span></p>
      <button onclick="findBookingByEmail()">Load My Booking</button>
      <div class="error" id="lookup-error"></div>
    </div>

    <!-- Step 2: Update Form -->
    <div id="update-form" style="display:none;">
      <h2>Edit Booking Details</h2>
      <form id="bookingUpdateForm">

        <label>Date 
          <input type="date" id="date">
        </label>
        <div class="error" id="date-error"></div>

        <label>Start Time 
          <input type="time" id="start-time">
        </label>
        <div class="error" id="start-time-error"></div>

        <label>End Time 
          <input type="time" id="end-time">
        </label>
        <div class="error" id="end-time-error"></div>

        <label>Location 
          <input type="text" id="location">
        </label>
        <div class="error" id="location-error"></div>

        <label>Budget Range</label>
        <input type="number" id="min-price" placeholder="Minimum Price">
        <input type="number" id="max-price" placeholder="Maximum Price">
        <div class="error" id="price-error"></div>

        <label>Special Requests</label>
        <textarea id="special-requests" placeholder="Enter any special requests"></textarea>
        <div class="error" id="requests-error"></div>

        <h3>Services</h3>
        <div id="services-list"></div>
        
        <button type="button" id="update-btn">Update Booking</button>
      </form>
    </div>

    <div id="message" class="mt-3 text-center"></div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="close-modal">&times;</span>
      <p>Are you sure you want to update this booking?</p>
      <div class="modal-buttons">
        <button id="confirm-yes">Yes</button>
        <button id="confirm-no">No</button>
      </div>
    </div>
  </div>

  <script>
    // Navbar toggle
    const hamburger = document.getElementById("hamburger");
    const navLinks = document.getElementById("nav-links");
    hamburger.addEventListener("click", () => navLinks.classList.toggle("active"));

    // Supabase setup
    const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let selectedBooking = null;
    const lookupError = document.getElementById("lookup-error");
    const message = document.getElementById("message");
    const updateForm = document.getElementById("update-form");
    const updateBtn = document.getElementById("update-btn");
    const modal = document.getElementById("confirm-modal");
    const closeModal = document.getElementById("close-modal");
    const confirmYes = document.getElementById("confirm-yes");
    const confirmNo = document.getElementById("confirm-no");
    const userEmailEl = document.getElementById("user-email");

    let currentUser = null;

    document.addEventListener("DOMContentLoaded", async () => {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        userEmailEl.textContent = "Not logged in";
        lookupError.textContent = "Please login to update your booking.";
        return;
      }
      currentUser = user;
      userEmailEl.textContent = user.email;
    });

    // Fetch booking using client_email
    async function findBookingByEmail() {
      lookupError.textContent = "";
      if (!currentUser) return;

      // Get client_id from email
      const { data: clientData, error: clientError } = await sb
        .from("client")
        .select("client_id")
        .eq("client_email", currentUser.email)
        .single();

      if (clientError || !clientData) {
        lookupError.textContent = "No client found with your email.";
        return;
      }

      const clientId = clientData.client_id;

      // Fetch latest booking for this client
      const { data: bookings, error: bookingError } = await sb
        .from("booking")
        .select("*")
        .eq("client_id", clientId)
        .order("created_at", { ascending: false })
        .limit(1);

      if (bookingError || !bookings || bookings.length === 0) {
        lookupError.textContent = "No booking found for your account.";
        return;
      }

      selectedBooking = bookings[0];

      // Fill form
      document.getElementById("date").value = selectedBooking.booking_date;
      document.getElementById("start-time").value = selectedBooking.booking_start_time;
      document.getElementById("end-time").value = selectedBooking.booking_end_time;
      document.getElementById("location").value = selectedBooking.booking_location || "";
      document.getElementById("min-price").value = selectedBooking.booking_min_price || "";
      document.getElementById("max-price").value = selectedBooking.booking_max_price || "";
      document.getElementById("special-requests").value = selectedBooking.booking_special_requests || "";

      // Fill services from 'service' table
      const { data: services } = await sb.from("service").select("service_id, service_name");
      const container = document.getElementById("services-list");
      container.innerHTML = "";
      services.forEach(s => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" name="services" value="${s.service_name}"> ${s.service_name}`;
        if (selectedBooking.booking_services && selectedBooking.booking_services.includes(s.service_name)) {
          label.querySelector("input").checked = true;
        }
        container.appendChild(label);
      });

      updateForm.style.display = "block";
    }

    // Validation
    function validateForm() {
      let valid = true;
      ["date-error","start-time-error","end-time-error","location-error","price-error"].forEach(id => {
        document.getElementById(id).textContent = "";
      });

      const date = document.getElementById("date").value;
      const start = document.getElementById("start-time").value;
      const end = document.getElementById("end-time").value;
      const location = document.getElementById("location").value.trim();
      const minPrice = document.getElementById("min-price").value;
      const maxPrice = document.getElementById("max-price").value;

      if (!date) { document.getElementById("date-error").textContent = "Booking date is required."; valid = false; }
      if (!start) { document.getElementById("start-time-error").textContent = "Start time is required."; valid = false; }
      if (!end) { document.getElementById("end-time-error").textContent = "End time is required."; valid = false; }
      if (start && end && end <= start) { document.getElementById("end-time-error").textContent = "End time must be after start time."; valid = false; }
      if (!location) { document.getElementById("location-error").textContent = "Location is required."; valid = false; }
      if (minPrice && maxPrice && parseFloat(minPrice) > parseFloat(maxPrice)) {
        document.getElementById("price-error").textContent = "Minimum price cannot be greater than maximum price."; valid = false;
      }

      return valid;
    }

    // Modal logic
    updateBtn.addEventListener("click", () => { if (validateForm()) modal.style.display = "block"; });
    closeModal.addEventListener("click", () => modal.style.display = "none");
    confirmNo.addEventListener("click", () => modal.style.display = "none");

    confirmYes.addEventListener("click", async () => {
      modal.style.display = "none";
      if (!selectedBooking) return;

      const updatedData = {
        booking_date: document.getElementById("date").value,
        booking_start_time: document.getElementById("start-time").value,
        booking_end_time: document.getElementById("end-time").value,
        booking_location: document.getElementById("location").value,
        booking_min_price: document.getElementById("min-price").value,
        booking_max_price: document.getElementById("max-price").value,
        booking_special_requests: document.getElementById("special-requests").value,
        booking_services: Array.from(document.querySelectorAll('input[name="services"]:checked')).map(s => s.value),
      };

      const { error } = await sb
        .from("booking")
        .update(updatedData)
        .eq("booking_id", selectedBooking.booking_id);

      if (error) {
        message.textContent = "Failed to update booking: " + error.message;
        message.className = "text-danger";
      } else {
        message.textContent = "Booking updated successfully!";
        message.className = "text-success";
      }
    });

  </script>
</body>
</html>
