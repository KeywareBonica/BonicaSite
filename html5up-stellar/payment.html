<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonica Payment Page</title>
  <meta name="description" content="Secure payment processing for your Bonica event booking">
  <meta name="keywords" content="payment, event booking, secure payment, Bonica">
  <meta name="author" content="Keyware Development Company">

  <!-- Professional Theme CSS -->
  <link rel="stylesheet" href="css/professional-theme.css">
  <link rel="stylesheet" href="css/payment.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>

  <!-- Professional Navigation -->
  <nav class="professional-nav">
    <div class="nav-container">
      <a href="index.html" class="logo">
        <img src="img/logo.jpeg" alt="Bonica Logo">
        <span>Bonica</span>
      </a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="index.html#about">About</a></li>
        <li><a href="bookings.html">Bookings</a></li>
        <li><a href="index.html#contact">Contact</a></li>
      </ul>
      <div class="nav-actions">
        <a href="Login.html" class="btn btn-outline">Login</a>
      </div>
    </div>
  </nav>

  <!-- Main Page -->
  <main class="container-fluid py-5">
    <div class="container">
      <!-- Initial Pay Button -->
      <div id="start-payment" class="text-center">
        <div class="card shadow-lg border-0">
          <div class="card-body p-5">
            <i class="fas fa-credit-card fa-3x text-primary mb-4"></i>
            <h1 class="card-title">Payment Processing</h1>
            <p class="card-text text-muted">Click the button below to proceed with your payment for the booking.</p>
            <button id="payBtn" class="btn btn-primary btn-lg">
              <i class="fas fa-lock me-2"></i>Pay for Your Booking
            </button>
          </div>
        </div>
      </div>

      <!-- Payment Sections (hidden initially) -->
      <div id="payment-sections" style="display:none;">
        <div class="row g-4">
          <!-- Banking Details -->
          <div class="col-lg-6">
            <section class="card shadow-lg border-0 h-100">
              <div class="card-header bg-primary text-white">
                <h2 class="card-title mb-0"><i class="fas fa-university me-2"></i>Banking Details</h2>
              </div>
              <div class="card-body">
                <div class="banking-details">
                  <div class="row g-3">
                    <div class="col-6">
                      <strong>Bank:</strong>
                      <p class="text-muted">Standard Bank</p>
                    </div>
                    <div class="col-6">
                      <strong>Account Number:</strong>
                      <p class="text-muted">123 4567 890</p>
                    </div>
                    <div class="col-6">
                      <strong>Account Name:</strong>
                      <p class="text-muted">Bonica Plc</p>
                    </div>
                    <div class="col-6">
                      <strong>Branch:</strong>
                      <p class="text-muted">Braamfontein</p>
                    </div>
                    <div class="col-12">
                      <strong>Reference:</strong>
                      <p class="text-muted">Your Booking ID</p>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <a href="banking-details.pdf" target="_blank" class="btn btn-outline-primary">
                    <i class="fas fa-download me-2"></i>Download PDF
                  </a>
                </div>
              </div>
            </section>
          </div>

          <!-- Payment Summary -->
          <div class="col-lg-6">
            <section class="card shadow-lg border-0 h-100">
              <div class="card-header bg-success text-white">
                <h2 class="card-title mb-0"><i class="fas fa-receipt me-2"></i>Payment Summary</h2>
              </div>
              <div class="card-body">
                <div class="payment-summary">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="subtotal">Loading...</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Service Fee (15%):</span>
                    <span id="service-fee">Loading...</span>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between fw-bold fs-5">
                    <span>Total:</span>
                    <span id="total-to-pay" class="text-primary">Loading...</span>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <!-- Upload Proof -->
          <div class="col-12">
            <section class="card shadow-lg border-0">
              <div class="card-header bg-warning text-dark">
                <h2 class="card-title mb-0"><i class="fas fa-upload me-2"></i>Upload Proof of Payment</h2>
              </div>
              <div class="card-body">
                <form id="proof-form" class="mb-4">
                  <div class="mb-3">
                    <label for="proof-file" class="form-label">Select Payment Proof</label>
                    <input type="file" id="proof-file" class="form-control" accept="image/*,.pdf" required />
                    <div class="form-text">Accepted formats: JPG, PNG, PDF (Max 10MB)</div>
                  </div>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>Upload
                  </button>
                </form>
                <div id="message" class="alert" style="display:none;"></div>
                <div class="text-center">
                  <button id="continueBtn" class="btn btn-success btn-lg" disabled>
                    <i class="fas fa-check me-2"></i>Continue
                  </button>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Professional Footer -->
  <footer class="professional-footer">
    <div class="footer-content">
      <div class="footer-grid">
        <div class="footer-section">
          <h3>Bonica</h3>
          <p>Your trusted partner for weddings, parties, graduations, and special events. Professional event management services.</p>
          <div class="d-flex gap-3">
            <a href="#"><i class="fab fa-github"></i></a>
            <a href="#"><i class="fab fa-linkedin-in"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
          </div>
        </div>
        <div class="footer-section">
          <h3>Quick Links</h3>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="index.html#about">About</a></li>
            <li><a href="bookings.html">Bookings</a></li>
            <li><a href="Login.html">Login</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3>Services</h3>
          <ul>
            <li><a href="#">Wedding Planning</a></li>
            <li><a href="#">Party Events</a></li>
            <li><a href="#">Matric Dance</a></li>
            <li><a href="#">Graduation</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3>Contact Information</h3>
          <p><i class="fas fa-map-marker-alt me-2"></i> Joriseen Street, Johannesburg</p>
          <p><i class="fas fa-phone me-2"></i> +27 76 244 9990</p>
          <p><i class="fas fa-envelope me-2"></i> <a href="mailto:Bonica@gmail.com">Bonica@gmail.com</a></p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Bonica. All rights reserved. | Designed by Keyware Development Company</p>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Navbar toggle
    const hamburger = document.getElementById("hamburger");
    const navLinks = document.getElementById("nav-links");
    hamburger.addEventListener("click", () => navLinks.classList.toggle("active"));

    // Supabase client
    const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM elements
    const payBtn = document.getElementById("payBtn");
    const startPayment = document.getElementById("start-payment");
    const paymentSections = document.getElementById("payment-sections");
    const subtotalEl = document.getElementById("subtotal");
    const serviceFeeEl = document.getElementById("service-fee");
    const totalEl = document.getElementById("total-to-pay");
    const proofForm = document.getElementById("proof-form");
    const proofFile = document.getElementById("proof-file");
    const message = document.getElementById("message");
    const continueBtn = document.getElementById("continueBtn");

    // Get clientId from localStorage
    const clientId = localStorage.getItem("clientId");
    if (!clientId) {
      alert("You must be logged in to make a payment!");
      window.location.href = "login.html";
    }

    let subtotal = 0;
    let serviceFee = 0;
    let total = 0;

    // Show payment sections
    payBtn.addEventListener("click", () => {
      startPayment.style.display = "none";
      paymentSections.style.display = "block";
      loadPaymentSummary();
    });

    // Load payment summary from localStorage
    function loadPaymentSummary() {
      const storedTotal = localStorage.getItem("totalAmount");
      if (!storedTotal) {
        subtotalEl.textContent = "R0.00";
        serviceFeeEl.textContent = "R0.00";
        totalEl.textContent = "R0.00";
        total = 0;
        return;
      }
      subtotal = parseFloat(storedTotal);
      serviceFee = subtotal * 0.15;
      total = subtotal + serviceFee;

      subtotalEl.textContent = `R${subtotal.toFixed(2)}`;
      serviceFeeEl.textContent = `R${serviceFee.toFixed(2)}`;
      totalEl.textContent = `R${total.toFixed(2)}`;
    }

    // Upload proof of payment
    proofForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = proofFile.files[0];
      if (!file) {
        message.textContent = "⚠️ Please select a file.";
        message.style.color = "red";
        return;
      }

      try {
        const filePath = `payment-proofs/${clientId}_${Date.now()}_${file.name}`;
        const { error: uploadError } = await supabase.storage.from("payment-proofs").upload(filePath, file);
        if (uploadError) throw uploadError;

        // Insert payment record
        const { error: insertError } = await supabase.from("payments").insert([{
          client_id: clientId,
          payment_amount: total,
          payment_method: "EFT",
          payment_proof: filePath,
          payment_status: "pending"
        }]);
        if (insertError) throw insertError;

        message.textContent = `✅ Proof uploaded successfully! Amount: R${total.toFixed(2)}`;
        message.style.color = "green";
        continueBtn.disabled = false;
        proofForm.reset();

      } catch (err) {
        console.error(err);
        message.textContent = "❌ " + err.message;
        message.style.color = "red";
      }
    });

    // Continue button
    continueBtn.addEventListener("click", () => {
      window.location.href = "confirmation.html";
    });
  </script>

</body>
</html>
