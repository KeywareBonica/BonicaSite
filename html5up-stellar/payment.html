<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonica Payment Page</title>
  <link rel="stylesheet" href="css/payment.css" />
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <a href="index.html" class="logo">
      <img src="logo.jpeg" alt="Logo" />
      Bonica
    </a>
    <ul class="nav-links" id="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="#">About</a></li>
      <li><a href="#">Bookings</a></li>
      <li><a href="#">Help</a></li>
      <li><a href="#">Contact</a></li>
    </ul>
    <div class="hamburger" id="hamburger">
      <div></div><div></div><div></div>
    </div>
  </nav>

  <!-- Main Page -->
  <main class="payment-container">

    <!-- Initial Pay Button -->
    <div id="start-payment" class="start-payment">
      <h1>Payment Page</h1>
      <p>Click the button below to pay for your booking.</p>
      <button id="payBtn">Pay for Your Booking</button>
    </div>

    <!-- Payment Sections (hidden initially) -->
    <div id="payment-sections" style="display:none;">

      <!-- Banking Details -->
      <section class="banking-details card">
        <h2>Banking Details</h2>
        <div class="details-box">
          <p><strong>Bank:</strong> Standard Bank</p>
          <p><strong>Account Number:</strong> 123 4567 890</p>
          <p><strong>Account Name:</strong> Bonica Plc</p>
          <p><strong>Branch:</strong> Braamfontein</p>
          <p><strong>Reference:</strong> Your Booking ID</p>
        </div>
        <a href="banking-details.pdf" target="_blank" class="download-link">Download PDF</a>
      </section>

      <!-- Payment Summary -->
      <section class="payment-summary card">
        <h2>Payment Summary</h2>
        <div class="summary-box">
          <p>Subtotal: <span id="subtotal">Loading...</span></p>
          <p>Service Fee (15%): <span id="service-fee">Loading...</span></p>
          <p class="total">Total: <span id="total-to-pay">Loading...</span></p>
        </div>
      </section>

      <!-- Upload Proof -->
      <section class="upload-section card">
        <h2>Upload Proof of Payment</h2>
        <form id="proof-form">
          <input type="file" id="proof-file" accept="image/*,.pdf" required />
          <button type="submit">Upload</button>
        </form>
        <p id="message"></p>
        <button id="continueBtn" class="continue-btn" disabled>Continue</button>
      </section>

    </div>

  </main>

  <!-- Footer -->
  <footer id="footer">
    <section>
      <h2>Get In Touch</h2>
      <dl class="alt">
        <dt>Address</dt><dd>Joriseen Street, Johannesburg</dd>
        <dt>Phone</dt><dd>076 244 9990</dd>
        <dt>Email</dt><dd><a href="mailto:Bonica@gmail.com">Bonica@gmail.com</a></dd>
      </dl>
    </section>

    <section>
      <h2>Quick Links</h2>
      <ul class="divided">
        <li><a href="#">About Us</a></li>
        <li><a href="#">Contact Us</a></li>
        <li><a href="#">Our Services</a></li>
        <li><a href="#">Terms & Conditions</a></li>
      </ul>
    </section>

    <section>
      <h2>Follow Us</h2>
      <ul class="icons">
        <li><a href="#"><i class="fab fa-facebook-f"></i></a></li>
        <li><a href="#"><i class="fab fa-twitter"></i></a></li>
        <li><a href="#"><i class="fab fa-youtube"></i></a></li>
      </ul>
    </section>

    <p class="copyright">&copy; 2025 Bonica Event Booking System</p>
  </footer>

  <script>
    // Navbar toggle
    const hamburger = document.getElementById("hamburger");
    const navLinks = document.getElementById("nav-links");
    hamburger.addEventListener("click", () => navLinks.classList.toggle("active"));

    // Supabase client
    const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM elements
    const payBtn = document.getElementById("payBtn");
    const startPayment = document.getElementById("start-payment");
    const paymentSections = document.getElementById("payment-sections");
    const subtotalEl = document.getElementById("subtotal");
    const serviceFeeEl = document.getElementById("service-fee");
    const totalEl = document.getElementById("total-to-pay");
    const proofForm = document.getElementById("proof-form");
    const proofFile = document.getElementById("proof-file");
    const message = document.getElementById("message");
    const continueBtn = document.getElementById("continueBtn");

    // Get clientId from localStorage
    const clientId = localStorage.getItem("clientId");
    if (!clientId) {
      alert("You must be logged in to make a payment!");
      window.location.href = "login.html";
    }

    let subtotal = 0;
    let serviceFee = 0;
    let total = 0;

    // Show payment sections
    payBtn.addEventListener("click", () => {
      startPayment.style.display = "none";
      paymentSections.style.display = "block";
      loadPaymentSummary();
    });

    // Load payment summary from localStorage
    function loadPaymentSummary() {
      const storedTotal = localStorage.getItem("totalAmount");
      if (!storedTotal) {
        subtotalEl.textContent = "R0.00";
        serviceFeeEl.textContent = "R0.00";
        totalEl.textContent = "R0.00";
        total = 0;
        return;
      }
      subtotal = parseFloat(storedTotal);
      serviceFee = subtotal * 0.15;
      total = subtotal + serviceFee;

      subtotalEl.textContent = `R${subtotal.toFixed(2)}`;
      serviceFeeEl.textContent = `R${serviceFee.toFixed(2)}`;
      totalEl.textContent = `R${total.toFixed(2)}`;
    }

    // Upload proof of payment
    proofForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = proofFile.files[0];
      if (!file) {
        message.textContent = "⚠️ Please select a file.";
        message.style.color = "red";
        return;
      }

      try {
        const filePath = `payment-proofs/${clientId}_${Date.now()}_${file.name}`;
        const { error: uploadError } = await supabase.storage.from("payment-proofs").upload(filePath, file);
        if (uploadError) throw uploadError;

        // Insert payment record
        const { error: insertError } = await supabase.from("payments").insert([{
          client_id: clientId,
          payment_amount: total,
          payment_method: "EFT",
          payment_proof: filePath,
          payment_status: "pending"
        }]);
        if (insertError) throw insertError;

        message.textContent = `✅ Proof uploaded successfully! Amount: R${total.toFixed(2)}`;
        message.style.color = "green";
        continueBtn.disabled = false;
        proofForm.reset();

      } catch (err) {
        console.error(err);
        message.textContent = "❌ " + err.message;
        message.style.color = "red";
      }
    });

    // Continue button
    continueBtn.addEventListener("click", () => {
      window.location.href = "confirmation.html";
    });
  </script>

</body>
</html>
