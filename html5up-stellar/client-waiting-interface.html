<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting for Quotations - Bonica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        
        .waiting-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .waiting-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .waiting-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .waiting-content {
            padding: 40px;
        }
        
        .progress-section {
            margin-bottom: 30px;
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .quotation-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .quotation-item.uploaded {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .quotation-item.pending {
            border-color: #ffc107;
            background: #fff3cd;
        }
        
        .quotation-item.expired {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .countdown-timer {
            font-size: 2rem;
            font-weight: bold;
            color: #dc3545;
            text-align: center;
            margin: 20px 0;
        }
        
        .countdown-timer.warning {
            color: #ffc107;
        }
        
        .countdown-timer.safe {
            color: #28a745;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-uploaded {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="waiting-container">
        <div class="waiting-card">
            <!-- Header -->
            <div class="waiting-header">
                <h1><i class="fas fa-clock me-3"></i>Waiting for Quotations</h1>
                <p class="mb-0">Service providers have 6 hours to upload their quotations</p>
            </div>
            
            <!-- Content -->
            <div class="waiting-content">
                <!-- Progress Section -->
                <div class="progress-section">
                    <h4><i class="fas fa-chart-line me-2"></i>Progress</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h5 text-success" id="uploaded-count">0</div>
                            <small class="text-muted">Uploaded</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 text-warning" id="pending-count">0</div>
                            <small class="text-muted">Pending</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 text-info" id="total-count">0</div>
                            <small class="text-muted">Total</small>
                        </div>
                    </div>
                </div>
                
                <!-- Countdown Timer -->
                <div class="text-center mb-4">
                    <h5><i class="fas fa-hourglass-half me-2"></i>Next Quotation Deadline</h5>
                    <div class="countdown-timer" id="countdown-timer">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
                
                <!-- Status Message -->
                <div class="alert alert-info text-center" id="status-message">
                    <i class="fas fa-info-circle me-2"></i>
                    Waiting for service providers to upload their quotations...
                </div>
                
                <!-- Quotations List -->
                <div class="quotations-section">
                    <h4><i class="fas fa-file-invoice me-2"></i>Quotation Status</h4>
                    <div id="quotations-list">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Loading quotation status...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="text-center mt-4" id="action-buttons" style="display: none;">
                    <button class="btn btn-success btn-lg me-3" id="view-quotations-btn" onclick="viewQuotations()">
                        <i class="fas fa-eye me-2"></i>View All Quotations
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" onclick="goBack()">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Refresh Button -->
    <button class="refresh-btn" id="refresh-btn" onclick="refreshStatus()" title="Refresh Status">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/realtime-service.js"></script>

    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentClient = null;
        let currentJobCartId = null;
        let countdownInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeClient();
            if (currentClient && currentJobCartId) {
                await loadQuotationStatus();
                setupRealtimeUpdates();
                startCountdown();
            }
        });

        async function initializeClient() {
            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    alert('You must be logged in to view quotations.');
                    window.location.href = 'Login.html';
                    return;
                }

                const { data: clientData, error: clientError } = await supabase
                    .from('client')
                    .select('client_id')
                    .eq('user_id', user.id)
                    .single();

                if (clientError || !clientData) {
                    alert('Client profile not found.');
                    window.location.href = 'Login.html';
                    return;
                }
                
                currentClient = clientData;
                
                // Get job cart ID from URL or localStorage
                const urlParams = new URLSearchParams(window.location.search);
                currentJobCartId = urlParams.get('job_cart_id') || localStorage.getItem('currentJobCartId');
                
                if (!currentJobCartId) {
                    alert('No job cart specified.');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
            } catch (error) {
                console.error('Error initializing client:', error);
                alert('Failed to load client data.');
                window.location.href = 'Login.html';
            }
        }

        async function loadQuotationStatus() {
            try {
                // Get quotation status from database function
                const { data, error } = await supabase.rpc('get_job_cart_quotation_status', {
                    p_job_cart_id: currentJobCartId
                });

                if (error) throw error;

                updateProgressDisplay(data);
                updateQuotationsList(data);
                updateStatusMessage(data);
                
            } catch (error) {
                console.error('Error loading quotation status:', error);
                showError('Failed to load quotation status');
            }
        }

        function updateProgressDisplay(status) {
            const total = status.total_acceptances;
            const uploaded = status.uploaded_quotations;
            const pending = status.pending_quotations;
            
            // Update counts
            document.getElementById('uploaded-count').textContent = uploaded;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('total-count').textContent = total;
            
            // Update progress bar
            const progressPercent = total > 0 ? (uploaded / total) * 100 : 0;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            
            // Show action buttons if we have sufficient quotations
            if (status.quotations_sufficient) {
                document.getElementById('action-buttons').style.display = 'block';
            }
        }

        async function updateQuotationsList(status) {
            try {
                // Get detailed acceptance information
                const { data: acceptances, error } = await supabase
                    .from('job_cart_acceptance')
                    .select(`
                        *,
                        service_provider:service_provider_id (
                            service_provider_name,
                            service_provider_surname,
                            service_provider_service_type
                        )
                    `)
                    .eq('job_cart_id', currentJobCartId)
                    .eq('acceptance_status', 'accepted');

                if (error) throw error;

                const quotationsList = document.getElementById('quotations-list');
                quotationsList.innerHTML = '';

                if (acceptances.length === 0) {
                    quotationsList.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <h5>No Acceptances Yet</h5>
                            <p>Service providers are still reviewing your job cart.</p>
                        </div>
                    `;
                    return;
                }

                acceptances.forEach(acceptance => {
                    const quotationItem = createQuotationItem(acceptance);
                    quotationsList.appendChild(quotationItem);
                });

            } catch (error) {
                console.error('Error updating quotations list:', error);
            }
        }

        function createQuotationItem(acceptance) {
            const item = document.createElement('div');
            const isUploaded = acceptance.quotation_uploaded_at !== null;
            const isExpired = acceptance.quotation_deadline && new Date(acceptance.quotation_deadline) < new Date();
            
            let statusClass, statusIcon, statusText, statusColor;
            
            if (isUploaded) {
                statusClass = 'uploaded';
                statusIcon = 'fas fa-check-circle';
                statusText = 'Quotation Uploaded';
                statusColor = 'status-uploaded';
            } else if (isExpired) {
                statusClass = 'expired';
                statusIcon = 'fas fa-times-circle';
                statusText = 'Deadline Expired';
                statusColor = 'status-expired';
            } else {
                statusClass = 'pending';
                statusIcon = 'fas fa-clock';
                statusText = 'Pending Upload';
                statusColor = 'status-pending';
            }

            item.className = `quotation-item ${statusClass}`;
            item.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-1">${acceptance.service_provider?.service_provider_name || 'Unknown'} ${acceptance.service_provider?.service_provider_surname || ''}</h6>
                        <p class="text-muted mb-1">${acceptance.service_provider?.service_provider_service_type || 'Service Provider'}</p>
                        <p class="text-muted mb-0">
                            <small>
                                Accepted: ${new Date(acceptance.accepted_at).toLocaleString()}
                                ${acceptance.quotation_deadline ? ` | Deadline: ${new Date(acceptance.quotation_deadline).toLocaleString()}` : ''}
                            </small>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="status-indicator ${statusColor}">
                            <i class="${statusIcon}"></i>
                            ${statusText}
                        </span>
                    </div>
                </div>
            `;
            
            return item;
        }

        function updateStatusMessage(status) {
            const statusMessage = document.getElementById('status-message');
            let message, alertClass;
            
            if (status.quotations_sufficient) {
                message = `🎉 Great! You have received ${status.uploaded_quotations} quotations. You can now review and choose the best option!`;
                alertClass = 'alert-success';
            } else if (status.still_waiting) {
                message = `⏳ Waiting for ${status.pending_quotations} more quotation${status.pending_quotations > 1 ? 's' : ''}. Service providers have 6 hours to upload their quotes.`;
                alertClass = 'alert-warning';
            } else if (status.status === 'insufficient_quotations') {
                message = `⚠️ Unfortunately, we didn't receive enough quotations (${status.uploaded_quotations}/${status.minimum_required}). You may want to create a new job cart.`;
                alertClass = 'alert-danger';
            } else {
                message = '📋 Your job cart is being reviewed by service providers. They will upload quotations within 6 hours.';
                alertClass = 'alert-info';
            }
            
            statusMessage.className = `alert ${alertClass} text-center`;
            statusMessage.innerHTML = `<i class="fas fa-info-circle me-2"></i>${message}`;
        }

        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(async () => {
                try {
                    // Get the next deadline
                    const { data: nextDeadline, error } = await supabase
                        .from('job_cart_acceptance')
                        .select('quotation_deadline')
                        .eq('job_cart_id', currentJobCartId)
                        .eq('acceptance_status', 'accepted')
                        .is('quotation_uploaded_at', null)
                        .order('quotation_deadline', { ascending: true })
                        .limit(1);

                    if (error) throw error;

                    const countdownTimer = document.getElementById('countdown-timer');
                    
                    if (!nextDeadline || nextDeadline.length === 0) {
                        countdownTimer.innerHTML = '<i class="fas fa-check-circle text-success"></i><br>All quotations received!';
                        countdownTimer.className = 'countdown-timer safe';
                        return;
                    }

                    const deadline = new Date(nextDeadline[0].quotation_deadline);
                    const now = new Date();
                    const timeLeft = deadline - now;

                    if (timeLeft <= 0) {
                        countdownTimer.innerHTML = '<i class="fas fa-exclamation-triangle"></i><br>Deadline Passed';
                        countdownTimer.className = 'countdown-timer';
                        return;
                    }

                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    countdownTimer.innerHTML = `<i class="fas fa-hourglass-half"></i><br>${timeString}`;
                    
                    if (hours < 1) {
                        countdownTimer.className = 'countdown-timer';
                    } else if (hours < 6) {
                        countdownTimer.className = 'countdown-timer warning';
                    } else {
                        countdownTimer.className = 'countdown-timer safe';
                    }

                } catch (error) {
                    console.error('Countdown error:', error);
                }
            }, 1000);
        }

        function setupRealtimeUpdates() {
            // Initialize real-time service
            window.RealtimeService.initialize(supabase);
            
            // Subscribe to quotation updates
            window.RealtimeService.subscribeToQuotations((payload) => {
                console.log('📄 Quotation update received:', payload);
                if (payload.new && payload.new.job_cart_id === currentJobCartId) {
                    showNotification('🎉 New quotation uploaded!', 'success');
                    loadQuotationStatus();
                }
            });
            
            // Subscribe to acceptance updates
            window.RealtimeService.subscribeToTable('job_cart_acceptance', {}, (payload) => {
                console.log('✅ Acceptance update received:', payload);
                if (payload.new && payload.new.job_cart_id === currentJobCartId) {
                    showNotification('📝 Service provider accepted your job cart', 'info');
                    loadQuotationStatus();
                }
            });
        }

        async function refreshStatus() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.classList.add('spinning');
            
            await loadQuotationStatus();
            
            setTimeout(() => {
                refreshBtn.classList.remove('spinning');
            }, 1000);
        }

        function viewQuotations() {
            window.location.href = `quotation.html?job_cart_id=${currentJobCartId}`;
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (countdownInterval) clearInterval(countdownInterval);
        });
    </script>
</body>
</html>
