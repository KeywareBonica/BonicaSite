<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Event Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="logo.jpeg" alt="Logo">
                <h2>Admin Panel</h2>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item active" data-section="overview">
                    <a href="#overview">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Overview</span>
                    </a>
                </li>
                <li class="nav-item" data-section="bookings">
                    <a href="#bookings">
                        <i class="fas fa-calendar-check"></i>
                        <span>Bookings</span>
                        <span class="badge" id="bookingBadge">0</span>
                    </a>
                </li>
                <li class="nav-item" data-section="clients">
                    <a href="#clients">
                        <i class="fas fa-users"></i>
                        <span>Clients</span>
                        <span class="badge" id="clientBadge">0</span>
                    </a>
                </li>
                <li class="nav-item" data-section="service-providers">
                    <a href="#service-providers">
                        <i class="fas fa-user-tie"></i>
                        <span>Service Providers</span>
                        <span class="badge" id="providerBadge">0</span>
                    </a>
                </li>
                <li class="nav-item" data-section="reports">
                    <a href="#reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a>
                </li>
                <li class="nav-item" data-section="powerbi-reports">
                    <a href="#powerbi-reports">
                        <i class="fas fa-chart-line"></i>
                        <span>Power BI Reports</span>
                    </a>
                </li>
                <li class="nav-item" data-section="payments">
                    <a href="#payments">
                        <i class="fas fa-credit-card"></i>
                        <span>Payments</span>
                    </a>
                </li>
                <li class="nav-item" data-section="settings">
                    <a href="#settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="user-details">
                    <span class="user-name">Admin User</span>
                    <span class="user-role">Administrator</span>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 id="pageTitle">Dashboard Overview</h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search..." id="globalSearch">
                </div>
                <div class="notifications">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count">3</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Sections -->
        <main class="content">
            <!-- Overview Section -->
            <section id="overview" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalBookings">0</h3>
                            <p>Total Bookings</p>
                            <span class="stat-change positive">+12% this month</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalClients">0</h3>
                            <p>Active Clients</p>
                            <span class="stat-change positive">+8% this month</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalProviders">0</h3>
                            <p>Service Providers</p>
                            <span class="stat-change positive">+5% this month</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalRevenue">R0</h3>
                            <p>Total Revenue</p>
                            <span class="stat-change positive">+15% this month</span>
                        </div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Booking Trends</h3>
                            <div class="chart-controls">
                                <select id="bookingTimeframe">
                                    <option value="7">Last 7 days</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="bookingChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Revenue by Event Type</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Bookings by Location</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="overviewBookingsByLocationChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="recent-activity">
                    <div class="activity-header">
                        <h3>Recent Activity</h3>
                        <button class="btn btn-outline">View All</button>
                    </div>
                    <div class="activity-list" id="recentActivity">
                        <!-- Activity items will be populated by JavaScript -->
                    </div>
                </div>
            </section>

            <!-- Bookings Section -->
            <section id="bookings" class="content-section">
                <div class="section-header">
                    <h2>Booking Management</h2>
                    <div class="section-controls">
                        <div class="filter-group">
                            <select id="bookingStatusFilter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="completed">Completed</option>
                            </select>
                            <input type="date" id="bookingDateFilter" placeholder="Filter by date">
                        </div>
                        <button class="btn btn-primary" id="addBookingBtn">
                            <i class="fas fa-plus"></i> Add Booking
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="bookingsTable">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Client</th>
                                <th>Event Type</th>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Total Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Clients Section -->
            <section id="clients" class="content-section">
                <div class="section-header">
                    <h2>Client Management</h2>
                    <div class="section-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="clientSearch" placeholder="Search clients...">
                        </div>
                        <button class="btn btn-primary" id="addClientBtn">
                            <i class="fas fa-plus"></i> Add Client
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="clientsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Contact</th>
                                <th>Location</th>
                                <th>Join Date</th>
                                <th>Bookings</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Service Providers Section -->
            <section id="service-providers" class="content-section">
                <div class="section-header">
                    <h2>Service Provider Management</h2>
                    <div class="section-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="providerSearch" placeholder="Search providers...">
                        </div>
                        <button class="btn btn-primary" id="addProviderBtn">
                            <i class="fas fa-plus"></i> Add Provider
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="providersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Service Type</th>
                                <th>Rating</th>
                                <th>Base Rate</th>
                                <th>Verification</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="providersTableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="content-section">
                <div class="section-header">
                    <h2>Reports & Analytics</h2>
                    <div class="section-controls">
                        <div class="report-tabs">
                            <button class="tab-btn active" data-tab="powerbi">PowerBI Reports</button>
                            <button class="tab-btn" data-tab="custom">Custom Analytics</button>
                            <button class="tab-btn" data-tab="export">Export Data</button>
                        </div>
                        <div class="date-range-picker">
                            <input type="date" id="reportStartDate">
                            <span>to</span>
                            <input type="date" id="reportEndDate">
                        </div>
                        <button class="btn btn-primary" id="generateReportBtn">
                            <i class="fas fa-download"></i> Generate Report
                        </button>
                    </div>
                </div>

                <!-- PowerBI Reports Tab -->
                <div id="powerbi-tab" class="tab-content active">
                    <div class="powerbi-container" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 2rem; border-radius: 20px;">
                        <!-- Enhanced Header with Stats Preview -->
                        <div class="powerbi-header" style="margin-bottom: 2rem; background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <div>
                                    <h2 style="color: #2c3e50; margin-bottom: 0.5rem; font-size: 2rem; font-weight: 700;">
                                        <i class="fas fa-chart-line" style="color: #3498db; margin-right: 1rem;"></i>
                                        Power BI Analytics Dashboard
                                    </h2>
                                    <p style="color: #7f8c8d; font-size: 1.1rem; margin: 0;">Real-time business intelligence and data insights</p>
                                </div>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div id="live-indicator" style="display: flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 25px; font-weight: 600;">
                                        <div style="width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse 2s infinite;"></div>
                                        <span>LIVE</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Enhanced Navigation -->
                            <div class="report-navigation" style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                                <button class="btn btn-primary enhanced-nav-btn" onclick="loadReportsTab('analytics')" id="analytics-tab-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 1rem 2rem; border-radius: 12px; font-weight: 600; font-size: 1rem; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
                                    <i class="fas fa-chart-area" style="margin-right: 0.75rem; font-size: 1.2rem;"></i>
                                    Business Analytics
                                    <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 0.25rem;">Live Data</div>
                                </button>
                                <button class="btn btn-outline enhanced-nav-btn" onclick="loadReportsTab('system')" id="system-tab-btn" style="border: 2px solid #667eea; color: #667eea; background: white; padding: 1rem 2rem; border-radius: 12px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease;">
                                    <i class="fas fa-cogs" style="margin-right: 0.75rem; font-size: 1.2rem;"></i>
                                    System Report
                                    <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.25rem;">Performance</div>
                                </button>
                                <button class="btn btn-outline enhanced-nav-btn" onclick="loadReportsTab('bower')" id="bower-tab-btn" style="border: 2px solid #667eea; color: #667eea; background: white; padding: 1rem 2rem; border-radius: 12px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease;">
                                    <i class="fas fa-chart-pie" style="margin-right: 0.75rem; font-size: 1.2rem;"></i>
                                    Bower BI Report
                                    <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.25rem;">Business Intelligence</div>
                                </button>
                                <button class="btn btn-outline enhanced-nav-btn" onclick="loadReportsTab('general')" id="general-tab-btn" style="border: 2px solid #667eea; color: #667eea; background: white; padding: 1rem 2rem; border-radius: 12px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease;">
                                    <i class="fas fa-file-alt" style="margin-right: 0.75rem; font-size: 1.2rem;"></i>
                                    General Reports
                                    <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.25rem;">Standard Views</div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Business Analytics Report (Default Active) -->
                        <div id="analytics-report-section" class="report-section active enhanced-report-section">
                            <!-- Enhanced Report Header -->
                            <div class="report-header enhanced-header">
                                <div class="header-left">
                                    <div class="report-icon enhanced-icon">
                                        <i class="fas fa-chart-area"></i>
                                    </div>
                                    <div class="report-info">
                                        <h3>Business Analytics Dashboard</h3>
                                        <p>Real-time insights and comprehensive business metrics</p>
                                        <div class="report-stats">
                                            <span class="stat-item">
                                                <i class="fas fa-database"></i>
                                                Live Data
                                            </span>
                                            <span class="stat-item">
                                                <i class="fas fa-clock"></i>
                                                Auto-refresh: 5min
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="header-controls">
                                    <button class="enhanced-btn primary-btn" onclick="refreshReport('analytics')">
                                        <i class="fas fa-sync-alt"></i>
                                        <span>Refresh Report</span>
                                    </button>
                                    <button class="enhanced-btn success-btn" onclick="loadLiveDatabaseData()">
                                        <i class="fas fa-database"></i>
                                        <span>Update Data</span>
                                    </button>
                                    <div id="data-status-indicator" class="status-indicator">
                                        <i class="fas fa-circle"></i>
                                        <span>Connecting...</span>
                                </div>
                                </div>
                            </div>

                            <!-- Enhanced Loading State -->
                            <div id="analytics-loading-state" class="loading-state" style="display: none;">
                                <div class="loading-content">
                                    <div class="loading-spinner">
                                        <div class="spinner-ring"></div>
                                        <div class="spinner-ring"></div>
                                        <div class="spinner-ring"></div>
                                    </div>
                                    <h4>Loading Power BI Report</h4>
                                    <p>Connecting to live database and preparing analytics...</p>
                                    <div class="loading-progress">
                                        <div class="progress-bar"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Iframe Container -->
                            <div id="analytics-iframe-container" class="iframe-container enhanced-container">
                                <iframe 
                                    id="analytics-iframe"
                                    frameborder="0" 
                                    allowfullscreen="true"
                                    allow="fullscreen"
                                    sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-downloads"
                                    loading="lazy">
                                </iframe>
                                
                                <!-- Overlay for better UX -->
                                <div class="iframe-overlay" id="analytics-overlay">
                                    <div class="overlay-content">
                                        <i class="fas fa-expand-arrows-alt"></i>
                                        <p>Click to interact with the report</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Report -->
                        <div id="system-report-section" class="report-section" style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 2rem; display: none;">
                            <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="report-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                        <div>
                                        <h3 style="color: #333; margin-bottom: 0.25rem;">System Report</h3>
                                        <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">System performance and analytics</p>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshReport('system')" style="border: 2px solid #667eea; color: #667eea; padding: 0.5rem 1rem; border-radius: 6px;">
                                                <i class="fas fa-sync-alt me-1"></i>Refresh
                                            </button>
                                        </div>
                            <div id="system-iframe-container" style="position: relative; width: 100%; height: 800px; border-radius: 10px; overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                <div style="text-align: center; color: #6c757d;">
                                    <i class="fas fa-cogs fa-3x mb-3"></i>
                                    <h4>System Report Not Configured</h4>
                                    <p>Contact administrator to configure the system report embed URL.</p>
                                    </div>
                                    </div>
                                </div>

                        <!-- Bower BI Report -->
                        <div id="bower-report-section" class="report-section" style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 2rem; display: none;">
                            <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="report-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                        <i class="fas fa-chart-pie"></i>
                                    </div>
                                    <div>
                                        <h3 style="color: #333; margin-bottom: 0.25rem;">Bower BI Report</h3>
                                        <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">Business intelligence dashboard</p>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshReport('bower')" style="border: 2px solid #667eea; color: #667eea; padding: 0.5rem 1rem; border-radius: 6px;">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                            <div id="bower-iframe-container" style="position: relative; width: 100%; height: 800px; border-radius: 10px; overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                <div style="text-align: center; color: #6c757d;">
                                    <i class="fas fa-chart-pie fa-3x mb-3"></i>
                                    <h4>Bower BI Report Not Configured</h4>
                                    <p>Contact administrator to configure the Bower BI report embed URL.</p>
                                </div>
                            </div>
                        </div>

                        <!-- General Reports -->
                        <div id="general-report-section" class="report-section" style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 2rem; display: none;">
                            <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="report-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                        <i class="fas fa-file-alt"></i>
                                            </div>
                                    <div>
                                        <h3 style="color: #333; margin-bottom: 0.25rem;">General Reports</h3>
                                        <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">Standard reporting and data visualization</p>
                                        </div>
                                    </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshReport('general')" style="border: 2px solid #667eea; color: #667eea; padding: 0.5rem 1rem; border-radius: 6px;">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                                </div>
                            <div id="general-iframe-container" style="position: relative; width: 100%; height: 800px; border-radius: 10px; overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                <div style="text-align: center; color: #6c757d;">
                                    <i class="fas fa-file-alt fa-3x mb-3"></i>
                                    <h4>General Reports Not Configured</h4>
                                    <p>Contact administrator to configure the general reports embed URL.</p>
                                            </div>
                                        </div>
                                    </div>

                        <!-- Analytics Summary Cards - Individual Metric Cards -->
                        <div class="analytics-summary" style="margin-top: 2rem;">
                            <div class="metrics-grid">
                                <!-- Individual metric cards will be populated here -->
                                <div class="metric-card" id="totalBookingsCard">
                                    <div class="metric-value" id="totalBookingsValue">0</div>
                                    <div class="metric-label">Total Bookings</div>
                                </div>
                                <div class="metric-card" id="confirmedBookingsCard">
                                    <div class="metric-value" id="confirmedBookingsValue">0</div>
                                    <div class="metric-label">Confirmed</div>
                                            </div>
                                <div class="metric-card" id="cancelledBookingsCard">
                                    <div class="metric-value" id="cancelledBookingsValue">0</div>
                                    <div class="metric-label">Cancelled</div>
                                        </div>
                                <div class="metric-card" id="completionRateCard">
                                    <div class="metric-value" id="completionRateValue">0%</div>
                                    <div class="metric-label">Completion Rate</div>
                                    </div>
                                <div class="metric-card" id="totalClientsCard">
                                    <div class="metric-value" id="totalClientsValue">0</div>
                                    <div class="metric-label">Total Clients</div>
                                </div>
                                <div class="metric-card" id="activeClientsCard">
                                    <div class="metric-value" id="activeClientsValue">0</div>
                                    <div class="metric-label">Active Clients</div>
                                            </div>
                                <div class="metric-card" id="newClientsCard">
                                    <div class="metric-value" id="newClientsValue">0</div>
                                    <div class="metric-label">New This Month</div>
                                        </div>
                                <div class="metric-card" id="totalProvidersCard">
                                    <div class="metric-value" id="totalProvidersValue">0</div>
                                    <div class="metric-label">Total Service Providers</div>
                                    </div>
                                <div class="metric-card" id="verifiedProvidersCard">
                                    <div class="metric-value" id="verifiedProvidersValue">0</div>
                                    <div class="metric-label">Verified Providers</div>
                                </div>
                                <div class="metric-card" id="avgRatingCard">
                                    <div class="metric-value" id="avgRatingValue">0/5</div>
                                    <div class="metric-label">Average Rating</div>
                            </div>
                                <div class="metric-card" id="totalRevenueCard">
                                    <div class="metric-value" id="totalRevenueValue">R0</div>
                                    <div class="metric-label">Total Revenue</div>
                                </div>
                                <div class="metric-card" id="completedPaymentsCard">
                                    <div class="metric-value" id="completedPaymentsValue">0</div>
                                    <div class="metric-label">Completed Payments</div>
                                </div>
                            </div>
                            
                            <!-- Legacy sections for backward compatibility -->
                            <div id="bookingPerformance" style="display: none;"></div>
                            <div id="clientAnalytics" style="display: none;"></div>
                            <div id="providerPerformance" style="display: none;"></div>
                            <div id="financialSummary" style="display: none;"></div>
                        </div>

                        <!-- PowerBI Charts with Real Data (Fallback) -->
                        <div class="powerbi-charts-container" style="margin-top: 2rem;">
                            <!-- KPI Cards -->
                            <div class="kpi-grid">
                                <div class="kpi-card">
                                    <div class="kpi-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <h3 id="completedPaymentsKPI">9</h3>
                                        <p>Completed Payments</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <h3 id="totalEventsKPI">94</h3>
                                        <p>Total Events</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <h3 id="totalClientsKPI">66</h3>
                                        <p>Total Clients</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon">
                                        <i class="fas fa-user-tie"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <h3 id="totalProvidersKPI">58</h3>
                                        <p>Total Service Providers</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Analytics Charts -->
                            <div class="analytics-grid">
                                <div class="chart-card">
                                    <h3>Event Distribution</h3>
                                    <div class="chart-container">
                                        <canvas id="eventDistributionChart"></canvas>
                                    </div>
                                    <div class="chart-actions">
                                        <button class="btn btn-sm btn-outline" onclick="drillDownEventDistribution()">
                                            <i class="fas fa-search-plus"></i> Drill Down
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="chart-card">
                                    <h3>Service Count by Type and Name</h3>
                                    <div class="chart-container">
                                        <canvas id="serviceCountChart"></canvas>
                                    </div>
                                    <div class="chart-actions">
                                        <button class="btn btn-sm btn-outline" onclick="drillDownServiceCount()">
                                            <i class="fas fa-search-plus"></i> Drill Down
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="chart-card">
                                    <h3>Client Distribution</h3>
                                    <div class="chart-container">
                                        <canvas id="clientDistributionChart"></canvas>
                                    </div>
                                    <div class="chart-actions">
                                        <button class="btn btn-sm btn-outline" onclick="drillDownClientDistribution()">
                                            <i class="fas fa-search-plus"></i> Drill Down
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Trend Charts -->
                            <div class="trend-charts-section">
                                <h3>Profile Creation Trends</h3>
                                <div class="trend-charts-grid">
                                    <div class="chart-card">
                                        <h3>Client Profile Creation Trend</h3>
                                        <div class="chart-container">
                                            <canvas id="clientTrendChart"></canvas>
                                        </div>
                                        <div class="chart-actions">
                                            <button class="btn btn-sm btn-outline" onclick="drillDownClientTrend()">
                                                <i class="fas fa-search-plus"></i> Drill Down
                                            </button>
                                        </div>
                                    </div>
                                    <div class="chart-card">
                                        <h3>Service Provider Profile Creation Trend</h3>
                                        <div class="chart-container">
                                            <canvas id="serviceProviderTrendChart"></canvas>
                                        </div>
                                        <div class="chart-actions">
                                            <button class="btn btn-sm btn-outline" onclick="drillDownServiceProviderTrend()">
                                                <i class="fas fa-search-plus"></i> Drill Down
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PowerBI Configuration Modal -->
                        <div class="modal" id="powerbiConfigModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>PowerBI Configuration</h3>
                                    <button class="modal-close" id="powerbiConfigClose">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <form id="powerbiConfigForm">
                                        <div class="form-group">
                                            <label for="powerbiWorkspaceId">Workspace ID</label>
                                            <input type="text" id="powerbiWorkspaceId" placeholder="Enter PowerBI Workspace ID">
                                        </div>
                                        <div class="form-group">
                                            <label for="powerbiReportId">Report ID</label>
                                            <input type="text" id="powerbiReportId" placeholder="Enter PowerBI Report ID">
                                        </div>
                                        <div class="form-group">
                                            <label for="powerbiAccessToken">Access Token</label>
                                            <input type="password" id="powerbiAccessToken" placeholder="Enter PowerBI Access Token">
                                        </div>
                                        <div class="form-group">
                                            <label for="powerbiEmbedUrl">Embed URL</label>
                                            <input type="url" id="powerbiEmbedUrl" placeholder="Enter PowerBI Embed URL">
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" id="powerbiConfigCancel">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="powerbiConfigSave">Save Configuration</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Revenue Analytics Section (Disabled) -->
                    <div class="revenue-charts-section" style="display: none; opacity: 0.5;">
                        <h3>Revenue Analytics (Disabled)</h3>
                        <div class="revenue-charts-grid">
                            <div class="chart-card">
                                <h3>Monthly Revenue Trend</h3>
                                <div class="chart-container">
                                    <canvas id="revenueTrendChart"></canvas>
                                </div>
                                <div class="chart-actions">
                                    <button class="btn btn-sm btn-outline" onclick="drillDownRevenueTrend()">
                                        <i class="fas fa-search-plus"></i> Drill Down
                                    </button>
                                </div>
                            </div>
                            <div class="chart-card">
                                <h3>Payment Status Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="paymentStatusChart"></canvas>
                                </div>
                                <div class="chart-actions">
                                    <button class="btn btn-sm btn-outline" onclick="drillDownPaymentStatus()">
                                        <i class="fas fa-search-plus"></i> Drill Down
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Analytics Tab -->
                <div id="custom-tab" class="tab-content">
                    <!-- PowerBI Dashboard KPIs -->
                    <div class="kpi-section">
                        <h3>Key Performance Indicators</h3>
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="kpi-content">
                                    <h4 id="completedPaymentsKPI">66.67%</h4>
                                    <p>Completed Payments</p>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="kpi-content">
                                    <h4 id="totalClientsKPI">4</h4>
                                    <p>Total Clients</p>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div class="kpi-content">
                                    <h4 id="totalProvidersKPI">3</h4>
                                    <p>Total Service Providers</p>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="kpi-content">
                                    <h4 id="totalEventsKPI">4</h4>
                                    <p>Total Events</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="reports-grid">
                        <div class="report-card">
                            <h3>Revenue by Event Type</h3>
                            <div class="chart-container">
                                <canvas id="revenueByEventTypeChart"></canvas>
                            </div>
                        </div>
                        <div class="report-card">
                            <h3>Bookings by Location</h3>
                            <div class="chart-container">
                                <canvas id="bookingsByLocationChart"></canvas>
                            </div>
                        </div>
                        <div class="report-card">
                            <h3>Total Hours per Service</h3>
                            <div class="chart-container">
                                <canvas id="serviceHoursChart"></canvas>
                            </div>
                        </div>
                        <div class="report-card">
                            <h3>Client by City</h3>
                            <div class="chart-container">
                                <canvas id="clientCityChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="chart-card full-width">
                            <div class="chart-header">
                                <h3>Revenue Trends</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="revenueTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Data Tab -->
                <div id="export-tab" class="tab-content">
                    <div class="export-container">
                        <h3>Data Export & PowerBI Integration</h3>
                        <div class="export-options">
                            <div class="export-card">
                                <h4>Export to PowerBI</h4>
                                <p>Export current data to PowerBI format for analysis</p>
                                <button class="btn btn-primary" id="exportToPowerBI">
                                    <i class="fas fa-upload"></i> Export to PowerBI
                                </button>
                            </div>
                            <div class="export-card">
                                <h4>Export to Excel</h4>
                                <p>Export data to Excel format for offline analysis</p>
                                <button class="btn btn-primary" id="exportToExcel">
                                    <i class="fas fa-file-excel"></i> Export to Excel
                                </button>
                            </div>
                            <div class="export-card">
                                <h4>Export to CSV</h4>
                                <p>Export data to CSV format for data analysis tools</p>
                                <button class="btn btn-primary" id="exportToCSV">
                                    <i class="fas fa-file-csv"></i> Export to CSV
                                </button>
                            </div>
                            <div class="export-card">
                                <h4>Export to JSON</h4>
                                <p>Export data to JSON format for API integration</p>
                                <button class="btn btn-primary" id="exportToJSON">
                                    <i class="fas fa-file-code"></i> Export to JSON
                                </button>
                            </div>
                        </div>
                        
                        <div class="export-preview">
                            <h4>Export Preview</h4>
                            <div class="preview-container" id="exportPreview">
                                <!-- Export preview will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Power BI Reports Section -->
            <section id="powerbi-reports" class="content-section">
                <div class="section-header">
                    <h2>Power BI Reports</h2>
                    <div class="section-controls">
                        <a href="powerbi-reports.html" class="btn btn-outline" target="_blank">
                            <i class="fas fa-external-link-alt me-2"></i>Open Full Reports Page
                        </a>
                    </div>
                </div>

                <!-- Info Alert -->
                <div class="alert alert-info" style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); border: 2px solid #667eea; border-radius: 10px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h5 style="color: #667eea; margin-bottom: 0.5rem;"><i class="fas fa-info-circle me-2"></i>How to View Reports</h5>
                    <p style="margin-bottom: 1rem;">
                        <strong>Option 1:</strong> Download the .pbix file and open it in Power BI Desktop.<br>
                        <strong>Option 2:</strong> View embedded reports directly in your browser (Business Analytics Report is ready to view!).
                    </p>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary btn-sm" onclick="loadAdminReport('analytics')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            <i class="fas fa-chart-area me-2"></i>View Live Analytics Report
                                </button>
                    </div>
                </div>

                <!-- System Report -->
                <div class="report-card" style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;">
                    <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="report-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div>
                                <h3 style="color: #333; margin-bottom: 0;">System Report</h3>
                                <p style="color: #6c757d; margin-bottom: 0;">Comprehensive system analytics and performance metrics</p>
                            </div>
                        </div>
                        <div class="report-actions" style="display: flex; gap: 0.5rem;">
                            <button class="btn-view-report" onclick="loadAdminReport('system')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-eye me-2"></i>View Report
                                </button>
                            <button class="btn-download" onclick="downloadAdminReport('System Report.pbix')" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-download me-2"></i>Download
                                </button>
                        </div>
                    </div>
                    <div class="report-metadata" style="display: flex; gap: 2rem; flex-wrap: wrap;">
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-file" style="color: #667eea;"></i>
                            <span>System Report.pbix</span>
                        </div>
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-chart-bar" style="color: #667eea;"></i>
                            <span>System Analytics</span>
                        </div>
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-database" style="color: #667eea;"></i>
                            <span>Real-time Data</span>
                        </div>
                            </div>
                        </div>
                        
                <!-- Bower BI Report -->
                <div class="report-card" style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;">
                    <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="report-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                                <div>
                                <h3 style="color: #333; margin-bottom: 0;">Bower BI Report</h3>
                                <p style="color: #6c757d; margin-bottom: 0;">Business insights and operational analytics</p>
                            </div>
                        </div>
                        <div class="report-actions" style="display: flex; gap: 0.5rem;">
                            <button class="btn-view-report" onclick="loadAdminReport('bower')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-eye me-2"></i>View Report
                                    </button>
                            <button class="btn-download" onclick="downloadAdminReport('Bower Bi report.pbix')" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-download me-2"></i>Download
                                    </button>
                        </div>
                    </div>
                    <div class="report-metadata" style="display: flex; gap: 2rem; flex-wrap: wrap;">
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-file" style="color: #667eea;"></i>
                            <span>Bower Bi report.pbix</span>
                        </div>
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-briefcase" style="color: #667eea;"></i>
                            <span>Business Intelligence</span>
                        </div>
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-sync" style="color: #667eea;"></i>
                            <span>Auto-refresh</span>
                        </div>
                    </div>
                </div>

                <!-- Business Analytics Report -->
                <div class="report-card" style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;">
                    <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="report-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="fas fa-chart-area"></i>
                            </div>
                            <div>
                                <h3 style="color: #333; margin-bottom: 0;">Business Analytics Report</h3>
                                <p style="color: #6c757d; margin-bottom: 0;">Advanced business analytics and insights</p>
                            </div>
                        </div>
                        <div class="report-actions" style="display: flex; gap: 0.5rem;">
                            <button class="btn-view-report" onclick="loadAdminReport('analytics')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-eye me-2"></i>View Report
                            </button>
                            <button class="btn-download" onclick="downloadAdminReport('Business Analytics.pbix')" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-download me-2"></i>Download
                                    </button>
                                </div>
                            </div>
                    <div class="report-metadata" style="display: flex; gap: 2rem; flex-wrap: wrap;">
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-file" style="color: #667eea;"></i>
                            <span>Business Analytics.pbix</span>
                            </div>
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-chart-line" style="color: #667eea;"></i>
                            <span>Advanced Analytics</span>
                        </div>
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-cloud" style="color: #667eea;"></i>
                            <span>Live Data</span>
                        </div>
                    </div>
                </div>

                <!-- General Reports -->
                <div class="report-card" style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;">
                    <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="report-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div>
                                <h3 style="color: #333; margin-bottom: 0;">General Reports</h3>
                                <p style="color: #6c757d; margin-bottom: 0;">Standard reporting and data visualization</p>
                            </div>
                        </div>
                        <div class="report-actions" style="display: flex; gap: 0.5rem;">
                            <button class="btn-view-report" onclick="loadAdminReport('general')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-eye me-2"></i>View Report
                            </button>
                            <button class="btn-download" onclick="downloadAdminReport('reports.pbix')" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-download me-2"></i>Download
                            </button>
                        </div>
                    </div>
                    <div class="report-metadata" style="display: flex; gap: 2rem; flex-wrap: wrap;">
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-file" style="color: #667eea;"></i>
                            <span>reports.pbix</span>
                        </div>
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-table" style="color: #667eea;"></i>
                            <span>General Reports</span>
                        </div>
                        <div class="metadata-item" style="display: flex; align-items: center; gap: 0.5rem; color: #6c757d;">
                            <i class="fas fa-users" style="color: #667eea;"></i>
                            <span>Multi-user</span>
                        </div>
                    </div>
                </div>

                <!-- Embed Container (Hidden by default) -->
                <div class="embed-container" id="adminEmbedContainer" style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 2rem; display: none;">
                    <div class="embed-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 id="adminEmbedTitle" style="margin-bottom: 0; color: #333;">Loading Report...</h3>
                        <button class="btn-close-embed" onclick="closeAdminEmbed()" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;">
                            <i class="fas fa-times me-2"></i>Close
                        </button>
                    </div>
                    <div id="adminEmbedContent">
                        <!-- Report will be embedded here -->
                    </div>
                </div>
            </section>

            <!-- Payments Section -->
            <section id="payments" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-money-check-alt me-2"></i>Payment Verification & Management</h2>
                    <div class="section-controls">
                        <button class="btn btn-outline" onclick="loadPayments('pending')">
                            <i class="fas fa-clock me-2"></i>Pending Only
                        </button>
                        <button class="btn btn-outline" onclick="loadPayments('verified')">
                            <i class="fas fa-check me-2"></i>Verified
                        </button>
                        <button class="btn btn-outline" onclick="loadPayments('rejected')">
                            <i class="fas fa-times me-2"></i>Rejected
                        </button>
                        <button class="btn btn-outline" onclick="loadPayments('all')">
                            <i class="fas fa-list me-2"></i>All Payments
                        </button>
                        <button class="btn btn-primary" id="refreshPaymentsBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Payment Statistics -->
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);">
                        <div class="stat-icon" style="color: #856404;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="pendingPaymentsCount">0</h3>
                            <p>Pending Verification</p>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                        <div class="stat-icon" style="color: #155724;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="verifiedPaymentsCount">0</h3>
                            <p>Verified Today</p>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f8d7da 0%, #f1c2c7 100%);">
                        <div class="stat-icon" style="color: #721c24;">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="rejectedPaymentsCount">0</h3>
                            <p>Rejected Today</p>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #e7f3ff 0%, #cce5ff 100%);">
                        <div class="stat-icon" style="color: #004085;">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalPendingAmount">R0</h3>
                            <p>Total Pending Amount</p>
                        </div>
                    </div>
                </div>

                <!-- Payments Container -->
                <div id="paymentsContainer" style="min-height: 400px;">
                    <div class="text-center" style="padding: 4rem 2rem;">
                        <i class="fas fa-spinner fa-spin fa-3x" style="color: #667eea;"></i>
                        <p class="mt-3" style="color: #6c757d;">Loading payments...</p>
                    </div>
                </div>

                <!-- Payment Approval Modal -->
                <div id="paymentApprovalModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h3><i class="fas fa-check-circle me-2"></i>Verify Payment</h3>
                            <span class="close">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="payment-details">
                                <h4 style="color: #667eea; margin-bottom: 1rem;"><i class="fas fa-info-circle me-2"></i>Payment Information</h4>
                                <div class="detail-row" style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                    <span class="label" style="font-weight: 600; color: #6c757d; min-width: 150px;">Payment ID:</span>
                                    <span id="modalPaymentId">-</span>
                                </div>
                                <div class="detail-row" style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                    <span class="label" style="font-weight: 600; color: #6c757d; min-width: 150px;">Client:</span>
                                    <span id="modalClientName">-</span>
                                </div>
                                <div class="detail-row" style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                    <span class="label" style="font-weight: 600; color: #6c757d; min-width: 150px;">Amount:</span>
                                    <span id="modalAmount">-</span>
                                </div>
                                <div class="detail-row" style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                    <span class="label" style="font-weight: 600; color: #6c757d; min-width: 150px;">Payment Method:</span>
                                    <span id="modalPaymentMethod">-</span>
                                </div>
                                <div class="detail-row" style="display: flex; padding: 0.75rem 0;">
                                    <span class="label" style="font-weight: 600; color: #6c757d; min-width: 150px;">Date:</span>
                                    <span id="modalPaymentDate">-</span>
                                </div>
                            </div>
                            
                            <div class="proof-of-payment" style="margin-top: 2rem;">
                                <h4 style="color: #667eea; margin-bottom: 1rem;"><i class="fas fa-image me-2"></i>Proof of Payment</h4>
                                <div id="proofImageContainer" style="text-align: center; background: #f8f9fa; padding: 2rem; border-radius: 10px;">
                                    <img id="proofImage" src="" alt="Proof of Payment" style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer;">
                                </div>
                            </div>

                            <div class="approval-actions" style="margin-top: 2rem;">
                                <h4 style="color: #667eea; margin-bottom: 1rem;"><i class="fas fa-gavel me-2"></i>Admin Decision</h4>
                                <div class="action-buttons" style="display: flex; gap: 1rem;">
                                    <button class="btn btn-success" id="approvePaymentBtn" style="flex: 1; padding: 1rem; font-weight: 600; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                        <i class="fas fa-check me-2"></i> Approve Payment
                                    </button>
                                    <button class="btn btn-danger" id="rejectPaymentBtn" style="flex: 1; padding: 1rem; font-weight: 600; background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);">
                                        <i class="fas fa-times me-2"></i> Reject Payment
                                    </button>
                                </div>
                                <div class="rejection-reason" id="rejectionReasonSection" style="display: none; margin-top: 1.5rem;">
                                    <label for="rejectionReason" style="font-weight: 600; color: #dc3545; display: block; margin-bottom: 0.5rem;">Reason for Rejection *</label>
                                    <textarea id="rejectionReason" placeholder="Please provide a clear reason for rejection..." style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid #dc3545; min-height: 100px;"></textarea>
                                    <small style="color: #6c757d;">The client will receive this message.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Preview Modal -->
                <div id="imageModal" class="modal">
                    <div class="modal-content" style="max-width: 90vw;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h3><i class="fas fa-image me-2"></i>Proof of Payment</h3>
                            <span class="close">&times;</span>
                        </div>
                        <div class="modal-body" style="text-align: center; background: #f8f9fa;">
                            <img id="modalImage" src="" alt="Proof of Payment" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="section-header">
                    <h2>System Settings</h2>
                </div>
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>General Settings</h3>
                        <form class="settings-form">
                            <div class="form-group">
                                <label for="siteName">Site Name</label>
                                <input type="text" id="siteName" value="Event Management System">
                            </div>
                            <div class="form-group">
                                <label for="adminEmail">Admin Email</label>
                                <input type="email" id="adminEmail" value="admin@example.com">
                            </div>
                            <div class="form-group">
                                <label for="timezone">Timezone</label>
                                <select id="timezone">
                                    <option value="Africa/Johannesburg">Africa/Johannesburg</option>
                                    <option value="UTC">UTC</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>
                    <div class="settings-card">
                        <h3>Notification Settings</h3>
                        <form class="settings-form">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="emailNotifications" checked>
                                    <span>Email Notifications</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="smsNotifications">
                                    <span>SMS Notifications</span>
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Booking Modal -->
    <div class="modal" id="bookingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="bookingModalTitle">Add New Booking</h3>
                <button class="modal-close" id="bookingModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookingClient">Client</label>
                            <select id="bookingClient" required>
                                <option value="">Select Client</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bookingEvent">Event Type</label>
                            <select id="bookingEvent" required>
                                <option value="">Select Event</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookingDate">Date</label>
                            <input type="date" id="bookingDate" required>
                        </div>
                        <div class="form-group">
                            <label for="bookingStartTime">Start Time</label>
                            <input type="time" id="bookingStartTime" required>
                        </div>
                        <div class="form-group">
                            <label for="bookingEndTime">End Time</label>
                            <input type="time" id="bookingEndTime" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bookingPrice">Total Price</label>
                        <input type="number" id="bookingPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="bookingSpecialRequest">Special Requests</label>
                        <textarea id="bookingSpecialRequest" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="bookingModalCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="bookingModalSave">Save Booking</button>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="clientModalTitle">Add New Client</h3>
                <button class="modal-close" id="clientModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientName">First Name</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label for="clientSurname">Last Name</label>
                            <input type="text" id="clientSurname" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientEmail">Email</label>
                            <input type="email" id="clientEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="clientContact">Contact</label>
                            <input type="tel" id="clientContact" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="clientCity">City</label>
                        <input type="text" id="clientCity">
                    </div>
                    <div class="form-group">
                        <label for="clientAddress">Address</label>
                        <textarea id="clientAddress" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="clientModalCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="clientModalSave">Save Client</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Initialize Supabase Client -->
    <script>
        // Supabase credentials
        const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A";
        
        // Initialize Supabase client
        window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('✅ Supabase client initialized:', window.supabase);
    </script>
    
    <!-- Admin Authentication -->
    <script src="js/admin-auth.js"></script>
    
    <!-- Database Service -->
    <script src="js/database-service.js"></script>
    
    <!-- Power BI Data API -->
    <script src="api/powerbi-data.js"></script>
    
    <script src="js/admin-dashboard.js"></script>

    <!-- Power BI Reports Integration -->
    <script>
        // Power BI Report Configurations - Embedded Reports
        const embeddedReportConfigs = {
            analytics: {
                title: 'Business Analytics Report',
                embedUrl: 'https://app.powerbi.com/view?r=eyJrIjoiNTUzNTNhMmUtODA1OS00NzhhLWJlMDMtNjg2OGM4MDk0OTA0IiwidCI6IjRiMWI5MDhjLTU1ODItNDM3Ny1iYTA3LWEzNmQ2NWUzNDkzNCIsImMiOjh9',
                description: 'Advanced business analytics and insights'
            },
            system: {
                title: 'System Report',
                embedUrl: localStorage.getItem('system_report_embed_url') || '',
                description: 'System performance and analytics'
            },
            bower: {
                title: 'Bower BI Report',
                embedUrl: localStorage.getItem('bower_report_embed_url') || '',
                description: 'Business intelligence dashboard'
            },
            general: {
                title: 'General Reports',
                embedUrl: localStorage.getItem('general_reports_embed_url') || '',
                description: 'Standard reporting and data visualization'
            }
        };

        // Load specific report tab
        function loadReportsTab(reportType) {
            // Hide all report sections
            const reportSections = document.querySelectorAll('.report-section');
            reportSections.forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });

            // Reset all tab buttons
            const tabButtons = document.querySelectorAll('[id$="-tab-btn"]');
            tabButtons.forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
                btn.style.background = 'white';
                btn.style.color = '#667eea';
            });

            // Show selected report section
            const selectedSection = document.getElementById(`${reportType}-report-section`);
            const selectedButton = document.getElementById(`${reportType}-tab-btn`);
            
            if (selectedSection) {
                selectedSection.style.display = 'block';
                selectedSection.classList.add('active');
            }

            // Update selected button styling
            if (selectedButton) {
                selectedButton.classList.remove('btn-outline');
                selectedButton.classList.add('btn-primary');
                selectedButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                selectedButton.style.color = 'white';
                selectedButton.style.border = 'none';
            }

            // Load embed URL if available
            const config = embeddedReportConfigs[reportType];
            if (config && config.embedUrl) {
                loadEmbeddedReport(reportType, config.embedUrl);
            }
        }

        // Load embedded report in iframe with live database data
        function loadEmbeddedReport(reportType, embedUrl) {
            const container = document.getElementById(`${reportType}-iframe-container`);
            const loadingState = document.getElementById(`${reportType}-loading-state`);
            if (!container) return;

            // Show loading state for analytics report
            if (reportType === 'analytics' && loadingState) {
                loadingState.style.display = 'flex';
            }

            // Create or update iframe
            let iframe = container.querySelector('iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('allowfullscreen', 'true');
                iframe.setAttribute('allow', 'fullscreen');
                iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-popups allow-forms allow-downloads');
                iframe.setAttribute('loading', 'lazy');
                iframe.style.cssText = 'width: 100%; height: 100%; border: none; border-radius: 20px; transition: all 0.3s ease;';
                container.innerHTML = '';
                container.appendChild(iframe);
            }

            // Add iframe load event to hide loading state
            iframe.onload = () => {
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
                console.log(`✅ ${reportType} report loaded successfully`);
            };

            // For analytics report, update with live database data first
            if (reportType === 'analytics') {
                loadLiveDatabaseData().then(() => {
                    if (embedUrl) {
                        iframe.src = embedUrl;
                    }
                }).catch(() => {
                    if (loadingState) loadingState.style.display = 'none';
                    if (embedUrl) iframe.src = embedUrl;
                });
            } else {
                if (embedUrl) {
                    iframe.src = embedUrl;
                }
            }
        }

        // Update data status indicator
        function updateDataStatusIndicator(status, message) {
            const indicator = document.getElementById('data-status-indicator');
            if (!indicator) return;

            const icon = indicator.querySelector('i');
            const text = indicator.querySelector('span');

            const statusConfig = {
                loading: { 
                    color: '#ffc107', 
                    icon: 'fas fa-spinner fa-spin',
                    bgColor: 'rgba(255, 193, 7, 0.1)',
                    textColor: '#856404'
                },
                success: { 
                    color: '#28a745', 
                    icon: 'fas fa-check-circle',
                    bgColor: 'rgba(40, 167, 69, 0.1)',
                    textColor: '#155724'
                },
                error: { 
                    color: '#dc3545', 
                    icon: 'fas fa-exclamation-circle',
                    bgColor: 'rgba(220, 53, 69, 0.1)',
                    textColor: '#721c24'
                },
                warning: { 
                    color: '#ffc107', 
                    icon: 'fas fa-exclamation-triangle',
                    bgColor: 'rgba(255, 193, 7, 0.1)',
                    textColor: '#856404'
                }
            };

            const config = statusConfig[status] || statusConfig.warning;
            icon.className = config.icon;
            icon.style.color = config.color;
            text.textContent = message;
            indicator.style.backgroundColor = config.bgColor;
            indicator.style.color = config.textColor;
        }

        // Fetch live database data for Power BI reports
        async function loadLiveDatabaseData() {
            updateDataStatusIndicator('loading', 'Updating data...');
            
            try {
                // Use Power BI Data API if available
                if (window.powerBIDataAPI) {
                    const reportData = await window.powerBIDataAPI.getData();
                    
                    // Store data for Power BI access and local display
                    localStorage.setItem('powerbi_live_data', JSON.stringify(reportData));
                    
                    // Update dashboard stats display with live data
                    updateDashboardStatsDisplays(reportData.stats);
                    
                    // Update the iframe URL to include data refresh parameter
                    const iframe = document.querySelector('#analytics-iframe-container iframe');
                    if (iframe) {
                        const url = new URL(iframe.src);
                        url.searchParams.set('refresh', Date.now());
                        iframe.src = url.toString();
                    }

                    console.log('✅ Live database data loaded for Power BI reports via API', reportData);
                    showReportMessage('Report updated with latest database data!', 'success');
                    updateDataStatusIndicator('success', 'Data updated');
                    
                    // Reset status after 3 seconds
                    setTimeout(() => {
                        updateDataStatusIndicator('success', 'Live data connected');
                    }, 3000);
                    return;
                }

                // Fallback to direct database service if Power BI API not available
                if (!window.dbService) {
                    console.log('Database service not available');
                    showReportMessage('Database connection not available', 'warning');
                    updateDataStatusIndicator('error', 'Connection failed');
                    return;
                }

                // Fetch all relevant data from database using existing service
                const [stats, clients, providers, bookings, payments, events, quotations] = await Promise.all([
                    window.dbService.getDashboardStats(),
                    window.dbService.getAllClients(),
                    window.dbService.getAllServiceProviders(),
                    window.dbService.getAllBookings(),
                    window.dbService.getAllPayments(),
                    window.dbService.getAllEvents(),
                    window.dbService.getAllQuotations()
                ]);

                // Prepare comprehensive data for Power BI
                const reportData = {
                    timestamp: new Date().toISOString(),
                    stats: stats,
                    clients: clients.map(c => ({
                        id: c.client_id,
                        name: `${c.client_name} ${c.client_surname}`,
                        email: c.client_email,
                        city: c.client_city,
                        joinDate: c.created_at,
                        totalBookings: bookings.filter(b => b.client_id === c.client_id).length
                    })),
                    serviceProviders: providers.map(p => ({
                        id: p.service_provider_id,
                        name: `${p.service_provider_name} ${p.service_provider_surname}`,
                        email: p.service_provider_email,
                        location: p.service_provider_location,
                        rating: p.service_provider_rating,
                        baseRate: p.service_provider_base_rate,
                        verificationStatus: p.service_provider_verification,
                        joinDate: p.created_at
                    })),
                    events: events.map(e => ({
                        id: e.event_id,
                        type: e.event_type,
                        date: e.event_date,
                        time: e.event_time,
                        location: e.event_location,
                        createdAt: e.created_at,
                        clientName: e.client ? `${e.client.client_name} ${e.client.client_surname}` : 'Unknown'
                    })),
                    bookings: bookings.map(b => ({
                        id: b.booking_id,
                        date: b.booking_date,
                        startTime: b.booking_start_time,
                        endTime: b.booking_end_time,
                        status: b.booking_status,
                        totalPrice: b.booking_total_price,
                        specialRequest: b.booking_special_request,
                        createdAt: b.created_at,
                        clientName: b.client ? `${b.client.client_name} ${b.client.client_surname}` : 'Unknown',
                        eventName: b.event ? b.event.event_name : 'Unknown Event'
                    })),
                    payments: payments.map(p => ({
                        id: p.payment_id,
                        amount: p.payment_amount,
                        status: p.payment_status,
                        proof: p.payment_proof,
                        invoice: p.payment_invoice,
                        createdAt: p.created_at
                    })),
                    quotations: quotations.map(q => ({
                        id: q.quotation_id,
                        amount: q.quotation_amount,
                        status: q.quotation_status,
                        submissionDate: q.quotation_submission_date,
                        createdAt: q.created_at,
                        providerName: q.service_provider ? `${q.service_provider.service_provider_name} ${q.service_provider.service_provider_surname}` : 'Unknown',
                        jobCartItem: q.job_cart ? q.job_cart.job_cart_item : 'Unknown Item'
                    }))
                };

                // Store data for Power BI access
                localStorage.setItem('powerbi_live_data', JSON.stringify(reportData));
                
                // Update dashboard stats display with live data
                updateDashboardStatsDisplays(reportData.stats);

                console.log('✅ Live database data loaded for Power BI reports via fallback', reportData);
                showReportMessage('Report updated with latest database data!', 'success');
                updateDataStatusIndicator('success', 'Data updated');
                
                // Reset status after 3 seconds
                setTimeout(() => {
                    updateDataStatusIndicator('success', 'Live data connected');
                }, 3000);

            } catch (error) {
                console.error('Error loading live database data:', error);
                showReportMessage('Failed to load latest data. Using cached data.', 'warning');
                updateDataStatusIndicator('error', 'Update failed');
            }
        }

        // Update dashboard stats displays with live data
        function updateDashboardStatsDisplays(stats) {
            try {
                // Update overview stats if elements exist
                const elements = {
                    totalClients: document.getElementById('totalClients'),
                    totalProviders: document.getElementById('totalProviders'),
                    totalBookings: document.getElementById('totalBookings'),
                    totalRevenue: document.getElementById('totalRevenue')
                };

                if (elements.totalClients) elements.totalClients.textContent = stats.total_clients;
                if (elements.totalProviders) elements.totalProviders.textContent = stats.total_providers;
                if (elements.totalBookings) elements.totalBookings.textContent = stats.total_bookings;
                if (elements.totalRevenue) {
                    elements.totalRevenue.textContent = `R${stats.total_revenue.toLocaleString()}`;
                }

                console.log('📊 Dashboard stats updated with live data:', stats);
            } catch (error) {
                console.error('Error updating dashboard stats displays:', error);
            }
        }

        // Refresh report
        function refreshReport(reportType) {
            const config = embeddedReportConfigs[reportType];
            if (config && config.embedUrl) {
                if (reportType === 'analytics') {
                    // Force reload with fresh database data
                    loadLiveDatabaseData().then(() => {
                        loadEmbeddedReport(reportType, config.embedUrl);
                        showReportMessage(`${config.title} refreshed with latest database data!`, 'success');
                    });
                } else {
                    loadEmbeddedReport(reportType, config.embedUrl);
                    showReportMessage(`${config.title} refreshed successfully!`, 'success');
                }
            } else {
                showReportMessage(`${reportType} report not configured`, 'warning');
            }
        }

        // Show notification message
        function showReportMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'error' ? 'danger' : 'info'}`;
            alertDiv.style.cssText = 'position: fixed; top: 100px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}" style="color: ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : type === 'error' ? '#dc3545' : '#17a2b8'};"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Initialize reports on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for database service to be available
            setTimeout(() => {
                // Ensure database service is available for live data
                if (typeof DatabaseService !== 'undefined' && window.supabase) {
                    window.dbService = new DatabaseService(window.supabase);
                    window.dbService.initialize().then(() => {
                        console.log('✅ Database service ready for Power BI reports');
                    });
                }

                // Initialize Power BI Data API
                if (typeof PowerBIDataAPI !== 'undefined' && window.supabase) {
                    window.powerBIDataAPI = new PowerBIDataAPI(window.supabase);
                    console.log('✅ Power BI Data API initialized');
                }
                
                // Initialize with analytics report (default active)
                loadReportsTab('analytics');
                
                // Set initial data status
                setTimeout(() => {
                    updateDataStatusIndicator('success', 'Live data connected');
                }, 2000);

                // Setup iframe overlay interactions
                setupIframeInteractions();
            }, 1000);
            
            // Set up hover effects for report sections
            const reportSections = document.querySelectorAll('.report-section');
            reportSections.forEach(section => {
                section.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
                });
                
                section.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 5px 20px rgba(0,0,0,0.1)';
                });
            });

            // Set up tab button hover effects
            const tabButtons = document.querySelectorAll('[id$="-tab-btn"]');
            tabButtons.forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('btn-primary')) {
                        this.style.background = '#f8f9fa';
                        this.style.border = '2px solid #667eea';
                    }
                });
                
                btn.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('btn-primary')) {
                        this.style.background = 'white';
                    }
                });
            });

            // Add auto-refresh for analytics report every 5 minutes
            setInterval(() => {
                if (document.getElementById('analytics-report-section') && 
                    document.getElementById('analytics-report-section').style.display !== 'none') {
                    console.log('🔄 Auto-refreshing Power BI data...');
                    loadLiveDatabaseData();
                }
            }, 300000); // 5 minutes
        });

        // Setup iframe overlay interactions and enhancements
        function setupIframeInteractions() {
            // Hide overlay once iframe starts loading
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                iframe.addEventListener('load', () => {
                    const overlay = iframe.parentElement.querySelector('.iframe-overlay');
                    if (overlay) {
                        overlay.style.opacity = '0';
                        setTimeout(() => {
                            overlay.style.display = 'none';
                        }, 300);
                    }
                });
            });

            // Enhanced tab switching with smooth transitions
            const tabButtons = document.querySelectorAll('.enhanced-nav-btn');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Add click animation
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });

            // Add live indicator animation
            const liveIndicator = document.getElementById('live-indicator');
            if (liveIndicator) {
                setInterval(() => {
                    const dot = liveIndicator.querySelector('div');
                    if (dot) {
                        dot.style.animation = 'none';
                        setTimeout(() => {
                            dot.style.animation = 'pulse 2s infinite';
                        }, 10);
                    }
                }, 5000);
            }
        }
    </script>

    <!-- Enhanced Power BI Styling -->
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Navigation Buttons */
        .enhanced-nav-btn {
            position: relative;
            overflow: hidden;
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .enhanced-nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .enhanced-nav-btn:active {
            transform: translateY(-1px);
        }

        /* Enhanced Report Section */
        .enhanced-report-section {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: 1px solid rgba(102, 126, 234, 0.1);
            animation: fadeInUp 0.6s ease-out;
        }

        /* Enhanced Header */
        .enhanced-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #f8f9fa;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 2rem;
            border-radius: 15px;
            margin: -1.5rem -1.5rem 2rem -1.5rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .enhanced-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .report-info h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .report-info p {
            color: #6c757d;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
        }

        .report-stats {
            display: flex;
            gap: 1.5rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }

        .enhanced-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .success-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .success-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 20px;
            color: #856404;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-indicator i {
            animation: pulse 2s infinite;
        }

        /* Loading State */
        .loading-state {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 20px;
        }

        .loading-content {
            text-align: center;
            max-width: 400px;
            padding: 2rem;
        }

        .loading-spinner {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            border-top-color: #764ba2;
            animation-delay: 0.5s;
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
        }

        .spinner-ring:nth-child(3) {
            border-top-color: #28a745;
            animation-delay: 1s;
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
        }

        .loading-content h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .loading-content p {
            color: #6c757d;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .loading-progress {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            animation: progress 3s ease-in-out infinite;
        }

        /* Enhanced Iframe Container */
        .enhanced-container {
            position: relative;
            width: 100%;
            height: 900px;
            border-radius: 20px;
            overflow: hidden;
            background: #f8f9fa;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .enhanced-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .iframe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .enhanced-container:hover .iframe-overlay {
            opacity: 1;
        }

        .overlay-content {
            text-align: center;
            color: #667eea;
        }

        .overlay-content i {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .overlay-content p {
            font-weight: 600;
            margin: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .enhanced-header {
                flex-direction: column;
                gap: 1.5rem;
                align-items: stretch;
            }

            .header-controls {
                align-items: stretch;
                flex-direction: row;
                justify-content: space-between;
            }

            .report-stats {
                flex-direction: column;
                gap: 0.75rem;
            }

            .enhanced-container {
                height: 600px;
            }
        }

        /* Smooth transitions */
        .report-section {
            transition: all 0.3s ease;
        }

        .report-section.active {
            display: block !important;
            animation: fadeInUp 0.5s ease-out;
        }

        /* Enhanced tab button states */
        .enhanced-nav-btn.btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4) !important;
        }

        .enhanced-nav-btn.btn-outline {
            background: white !important;
            border: 2px solid #667eea !important;
            color: #667eea !important;
        }

        .enhanced-nav-btn.btn-outline:hover {
            background: #667eea !important;
            color: white !important;
            transform: translateY(-2px);
        }

        /* Individual Metric Cards Styling */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.75rem;
            line-height: 1;
        }

        .metric-label {
            font-size: 1rem;
            color: #6c757d;
            font-weight: 500;
            margin: 0;
            line-height: 1.3;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }

            .metric-card {
                padding: 1.5rem;
            }

            .metric-value {
                font-size: 2rem;
            }

            .metric-label {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Special styling for different metric types */
        .metric-card#totalBookingsCard::before,
        .metric-card#confirmedBookingsCard::before,
        .metric-card#cancelledBookingsCard::before,
        .metric-card#completionRateCard::before {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .metric-card#totalClientsCard::before,
        .metric-card#activeClientsCard::before,
        .metric-card#newClientsCard::before {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .metric-card#totalProvidersCard::before,
        .metric-card#verifiedProvidersCard::before,
        .metric-card#avgRatingCard::before {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .metric-card#totalRevenueCard::before,
        .metric-card#completedPaymentsCard::before {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
    </style>

    <!-- Payment Verification Script -->
    <script>
        // Payment Verification Functions
        let currentBookingId = null;

        // Load payments based on filter
        async function loadPayments(filter = 'pending') {
            const container = document.getElementById('paymentsContainer');
            container.innerHTML = '<div class="text-center" style="padding: 4rem 2rem;"><i class="fas fa-spinner fa-spin fa-3x" style="color: #667eea;"></i><p class="mt-3" style="color: #6c757d;">Loading payments...</p></div>';

            try {
                // Load bookings with payment information from Supabase
                const { data: bookings, error } = await window.supabase
                    .from('booking')
                    .select(`
                        booking_id,
                        booking_date,
                        booking_status,
                        booking_total_price,
                        booking_special_requests,
                        booking_location,
                        client:client_id (
                            client_name,
                            client_surname,
                            client_email,
                            client_contact
                        ),
                        event:event_id (
                            event_type,
                            event_date,
                            event_start_time,
                            event_end_time,
                            event_location
                        ),
                        payment!payment_booking_id_fkey (
                            payment_id,
                            payment_amount,
                            payment_status,
                            proof_of_payment_file_path,
                            proof_of_payment_file_name,
                            uploaded_at,
                            verification_date,
                            verification_notes
                        )
                    `)
                    .order('booking_date', { ascending: false });

                if (error) throw error;

                // Filter bookings based on payment status
                let filteredBookings = bookings || [];
                
                if (filter === 'pending') {
                    filteredBookings = bookings.filter(booking => {
                        if (!booking.payment || booking.payment.length === 0) {
                            return booking.booking_status !== 'cancelled';
                        }
                        return booking.payment.some(p => p.payment_status === 'unpaid' || p.payment_status === 'pending');
                    });
                } else if (filter === 'verified') {
                    filteredBookings = bookings.filter(booking => 
                        booking.payment && booking.payment.some(p => p.payment_status === 'completed' || p.payment_status === 'verified')
                    );
                } else if (filter === 'rejected') {
                    filteredBookings = bookings.filter(booking => 
                        booking.payment && booking.payment.some(p => p.payment_status === 'rejected')
                    );
                }

                displayPayments(filteredBookings);
                updateStatistics(filteredBookings);

            } catch (error) {
                console.error('Error loading payments:', error);
                container.innerHTML = `
                    <div class="alert alert-danger" style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; margin: 2rem;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading payments: ${error.message}
                    </div>
                `;
            }
        }

        // Display payments
        function displayPayments(bookings) {
            const container = document.getElementById('paymentsContainer');

            if (!bookings || bookings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: 12px;">
                        <i class="fas fa-inbox" style="font-size: 5rem; color: #dee2e6; margin-bottom: 1rem;"></i>
                        <h3 style="color: #6c757d;">No Bookings Found</h3>
                        <p class="text-muted">There are no bookings matching your filter criteria</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = bookings.map(booking => {
                const clientName = `${booking.client?.client_name || ''} ${booking.client?.client_surname || ''}`.trim();
                const eventType = booking.event?.event_type || 'Event';
                const eventDate = booking.event?.event_date || booking.booking_date || 'TBD';
                const eventLocation = booking.event?.event_location || booking.booking_location || 'TBD';
                const totalPrice = parseFloat(booking.booking_total_price) || 0;
                const bookingDate = new Date(booking.booking_date).toLocaleDateString();
                const startTime = booking.event?.event_start_time || 'TBD';
                const endTime = booking.event?.event_end_time || 'TBD';
                
                const latestPayment = booking.payment && booking.payment.length > 0 ? booking.payment[0] : null;
                const paymentStatus = latestPayment?.payment_status || 'unpaid';
                const paymentAmount = latestPayment ? parseFloat(latestPayment.payment_amount) : totalPrice;
                
                const statusClass = paymentStatus === 'completed' || paymentStatus === 'verified' ? 'status-verified' : paymentStatus === 'rejected' ? 'status-rejected' : 'status-pending';
                
                return `
                    <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 1.5rem; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 2px solid #667eea; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600; font-size: 1.1rem; color: #495057;">
                                <i class="fas fa-calendar-check me-2" style="color: #667eea;"></i>
                                Booking #${booking.booking_id.substring(0, 8).toUpperCase()}
                            </div>
                            <span class="${statusClass}" style="padding: 0.5rem 1rem; border-radius: 50px; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; background: ${statusClass === 'status-verified' ? '#d4edda' : statusClass === 'status-rejected' ? '#f8d7da' : '#fff3cd'}; color: ${statusClass === 'status-verified' ? '#155724' : statusClass === 'status-rejected' ? '#721c24' : '#856404'};">${paymentStatus}</span>
                        </div>
                        
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                                <div>
                                    <div style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                        <span style="font-weight: 600; color: #6c757d; min-width: 150px;"><i class="fas fa-user me-2"></i>Client:</span>
                                        <span>${clientName}</span>
                                    </div>
                                    <div style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                        <span style="font-weight: 600; color: #6c757d; min-width: 150px;"><i class="fas fa-envelope me-2"></i>Email:</span>
                                        <span>${booking.client?.client_email || 'N/A'}</span>
                                    </div>
                                    <div style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                        <span style="font-weight: 600; color: #6c757d; min-width: 150px;"><i class="fas fa-calendar me-2"></i>Event Type:</span>
                                        <span>${eventType}</span>
                                    </div>
                                    <div style="display: flex; padding: 0.75rem 0;">
                                        <span style="font-weight: 600; color: #6c757d; min-width: 150px;"><i class="fas fa-map-marker-alt me-2"></i>Location:</span>
                                        <span>${eventLocation}</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                        <span style="font-weight: 600; color: #6c757d; min-width: 150px;"><i class="fas fa-calendar-alt me-2"></i>Event Date:</span>
                                        <span>${eventDate}</span>
                                    </div>
                                    <div style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                        <span style="font-weight: 600; color: #6c757d; min-width: 150px;"><i class="fas fa-clock me-2"></i>Time:</span>
                                        <span>${startTime} - ${endTime}</span>
                                    </div>
                                    <div style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                                        <span style="font-weight: 600; color: #6c757d; min-width: 150px;"><i class="fas fa-money-bill-wave me-2"></i>Amount:</span>
                                        <span style="font-size: 1.5rem; font-weight: 700; color: #667eea;">R ${totalPrice.toLocaleString('en-ZA', { minimumFractionDigits: 2 })}</span>
                                    </div>
                                    ${latestPayment ? `
                                    <div style="display: flex; padding: 0.75rem 0;">
                                        <span style="font-weight: 600; color: #6c757d; min-width: 150px;"><i class="fas fa-check me-2"></i>Verification Date:</span>
                                        <span>${latestPayment.verification_date ? new Date(latestPayment.verification_date).toLocaleDateString() : 'Pending'}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        ${paymentStatus === 'pending' || paymentStatus === 'unpaid' ? `
                            <div style="display: flex; gap: 1rem; padding: 1.5rem; border-top: 2px solid #e9ecef; background: #f8f9fa;">
                                <button onclick="markAsReceived('${booking.booking_id}')" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; color: white; padding: 1rem; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                                    <i class="fas fa-check-circle me-2"></i>Mark as Received
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Mark payment as received
        async function markAsReceived(bookingId) {
            if (!confirm('Mark payment for this booking as received?')) {
                return;
            }

            try {
                // First, check if a payment exists for this booking
                const { data: existingPayment, error: checkError } = await window.supabase
                    .from('payment')
                    .select('payment_id, payment_status')
                    .eq('booking_id', bookingId)
                    .maybeSingle();

                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }

                // Get booking total price
                const { data: booking, error: bookingError } = await window.supabase
                    .from('booking')
                    .select('booking_total_price, client_id, payment_id')
                    .eq('booking_id', bookingId)
                    .single();

                if (bookingError) throw bookingError;

                const totalPrice = parseFloat(booking.booking_total_price) || 0;

                // Update or create payment record
                if (existingPayment) {
                    const { error } = await window.supabase
                        .from('payment')
                        .update({
                            payment_status: 'completed',
                            verification_date: new Date().toISOString(),
                            verification_notes: 'Marked as received by admin'
                        })
                        .eq('payment_id', existingPayment.payment_id);

                    if (error) throw error;
                } else {
                    const { error } = await window.supabase
                        .from('payment')
                        .insert({
                            booking_id: bookingId,
                            client_id: booking.client_id,
                            payment_amount: totalPrice,
                            payment_status: 'completed',
                            verification_date: new Date().toISOString(),
                            verification_notes: 'Marked as received by admin'
                        });

                    if (error) throw error;
                }

                alert('Payment marked as received successfully!');
                await loadPayments('pending');

            } catch (error) {
                alert('Error updating payment: ' + error.message);
            }
        }

        // Update statistics
        function updateStatistics(bookings) {
            const today = new Date().toISOString().split('T')[0];
            
            const pending = bookings.filter(booking => {
                const paymentStatus = booking.payment && booking.payment.length > 0 
                    ? booking.payment[0].payment_status 
                    : 'unpaid';
                return paymentStatus === 'pending' || paymentStatus === 'unpaid';
            });
            
            const verifiedToday = bookings.filter(booking => {
                if (!booking.payment || booking.payment.length === 0) return false;
                const latestPayment = booking.payment[0];
                return (latestPayment.payment_status === 'completed' || latestPayment.payment_status === 'verified') 
                    && latestPayment.verification_date 
                    && latestPayment.verification_date.startsWith(today);
            });
            
            const rejectedToday = bookings.filter(booking => {
                if (!booking.payment || booking.payment.length === 0) return false;
                const latestPayment = booking.payment[0];
                return latestPayment.payment_status === 'rejected' 
                    && latestPayment.verification_date 
                    && latestPayment.verification_date.startsWith(today);
            });
            
            const totalPending = pending.reduce((sum, booking) => {
                const amount = parseFloat(booking.booking_total_price) || 0;
                return sum + amount;
            }, 0);

            document.getElementById('pendingPaymentsCount').textContent = pending.length;
            document.getElementById('verifiedPaymentsCount').textContent = verifiedToday.length;
            document.getElementById('rejectedPaymentsCount').textContent = rejectedToday.length;
            document.getElementById('totalPendingAmount').textContent = `R ${totalPending.toLocaleString('en-ZA', { minimumFractionDigits: 0 })}`;
        }

        // Initialize payments on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load payments when payments section is active
            const paymentsLink = document.querySelector('[data-section="payments"]');
            if (paymentsLink) {
                paymentsLink.addEventListener('click', () => {
                    setTimeout(() => loadPayments('pending'), 100);
                });
            }

            // Refresh button
            const refreshBtn = document.getElementById('refreshPaymentsBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => loadPayments('pending'));
            }
        });

        // Show full image in modal
        function showFullImage(url) {
            document.getElementById('modalImage').src = url;
            document.getElementById('imageModal').style.display = 'block';
        }

        // Close modal
        window.onclick = function(event) {
            const imageModal = document.getElementById('imageModal');
            if (event.target === imageModal) {
                imageModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>


