<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bonica Event Booking</title>
<link rel="stylesheet" href="css/bookings.css">
<!-- Professional Theme CSS -->
<link href="css/professional-theme.css" rel="stylesheet">
  <!-- Navigation CSS -->
  <link href="css/navigation.css" rel="stylesheet">
<!-- Using simple location autocomplete with SA cities/towns -->
<style>
/* Enhanced Quotation Real-time Styles */
.quotation-notifications-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1050;
    max-width: 350px;
}

.quotation-notification {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    margin-bottom: 10px;
    padding: 0;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s ease;
    border-left: 4px solid #28a745;
}

.quotation-notification.show {
    transform: translateX(0);
    opacity: 1;
}

.quotation-notification.new {
    border-left-color: #28a745;
}

.quotation-notification.status_change {
    border-left-color: #ffc107;
}

.quotation-notification.price_change {
    border-left-color: #17a2b8;
}

.quotation-notification.deleted {
    border-left-color: #dc3545;
}

.notification-content {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.notification-icon {
    font-size: 18px;
}

.notification-message {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.notification-close {
    background: none;
    border: none;
    font-size: 18px;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.notification-close:hover {
    color: #333;
}

.quotation-counter {
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    margin-left: 5px;
    transition: all 0.3s ease;
}

.quotation-counter.updated {
    transform: scale(1.2);
    background: #28a745;
}


.new-quotation {
    animation: slideInRight 0.5s ease-out;
}

.updated-quotation {
    animation: pulseUpdate 1s ease-out;
}

.removing-quotation {
    animation: slideOutRight 0.5s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulseUpdate {
    0% { background-color: #fff3cd; }
    50% { background-color: #ffeaa7; }
    100% { background-color: transparent; }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Location Input Styles */
.location-input {
  position: relative;
}

.location-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-top: none;
  border-radius: 0 0 4px 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.suggestion-item {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
  transition: background-color 0.2s;
}

.suggestion-item:hover {
  background-color: #f5f5f5;
}

.suggestion-item:last-child {
  border-bottom: none;
}

/* Fallback Location Dropdown Styles */
.location-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-top: none;
  border-radius: 0 0 4px 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.location-item {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
  transition: background-color 0.2s;
}

.location-item:hover {
  background-color: #f5f5f5;
}

.location-item:last-child {
  border-bottom: none;
}

/* Message System Styles */
#messages-container {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  width: 90%;
  max-width: 500px;
}

.message {
  padding: 1rem 1.5rem;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  display: none;
  animation: slideIn 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.message.success {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
}

.message.error {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
}

.message.info {
  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
  color: white;
}

.message.warning {
  background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
  color: #000;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Loading Spinner */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Enhanced Quotation Cards */
.quotation-card {
  background: white;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  transition: var(--transition-fast);
  box-shadow: var(--shadow-md);
}

.quotation-card:hover {
  border-color: var(--primary-blue);
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Responsive Bookings Styles */
@media (max-width: 768px) {
  .quotation-card {
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    border-radius: var(--radius-md);
  }
  
  .quotation-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .service-name {
    font-size: var(--font-size-mobile);
    font-weight: 600;
  }
  
  .provider-info {
    font-size: var(--font-size-mobile);
  }
  
  .quotation-details {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .rating {
    font-size: var(--font-size-mobile);
  }
  
  .location-info {
    font-size: var(--font-size-mobile);
  }
  
  .quotation-buttons {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    width: 100%;
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-mobile);
  }
  
  .container {
    padding: var(--spacing-sm);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-mobile);
    padding: var(--spacing-sm);
  }
  
  .btn {
    font-size: var(--font-size-mobile);
    padding: var(--spacing-sm) var(--spacing-md);
  }
  
  h1 {
    font-size: var(--heading-size-mobile);
  }
  
  h2 {
    font-size: var(--heading-size-mobile);
  }
  
  .form-group {
    margin-bottom: var(--spacing-md);
  }
}

@media (min-width: 768px) and (max-width: 1024px) {
  .quotation-card {
    padding: var(--spacing-lg);
  }
  
  .service-name {
    font-size: var(--font-size-tablet);
  }
  
  .provider-info {
    font-size: var(--font-size-tablet);
  }
  
  .rating,
  .location-info {
    font-size: var(--font-size-tablet);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    font-size: var(--font-size-tablet);
    padding: var(--spacing-sm) var(--spacing-md);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-tablet);
  }
  
  .btn {
    font-size: var(--font-size-tablet);
  }
  
  h1 {
    font-size: var(--heading-size-tablet);
  }
  
  h2 {
    font-size: var(--heading-size-tablet);
  }
}

@media (min-width: 1024px) {
  .quotation-card {
    padding: var(--spacing-xl);
  }
  
  .service-name {
    font-size: var(--font-size-desktop);
  }
  
  .provider-info {
    font-size: var(--font-size-desktop);
  }
  
  .rating,
  .location-info {
    font-size: var(--font-size-desktop);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    font-size: var(--font-size-desktop);
    padding: var(--spacing-md) var(--spacing-lg);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-desktop);
  }
  
  .btn {
    font-size: var(--font-size-desktop);
  }
  
  h1 {
    font-size: var(--heading-size-desktop);
  }
  
  h2 {
    font-size: var(--heading-size-desktop);
  }
}

@media (min-width: 1920px) {
  .quotation-card {
    padding: var(--spacing-tv);
    margin-bottom: var(--spacing-xl);
    border-radius: var(--radius-xl);
  }
  
  .quotation-header {
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }
  
  .service-name {
    font-size: var(--font-size-tv);
  }
  
  .provider-info {
    font-size: var(--font-size-tv);
  }
  
  .quotation-details {
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }
  
  .rating,
  .location-info {
    font-size: var(--font-size-tv);
  }
  
  .quotation-buttons {
    gap: var(--spacing-lg);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    font-size: var(--font-size-tv);
    padding: var(--spacing-lg) var(--spacing-xl);
  }
  
  .container {
    max-width: var(--container-tv);
    padding: var(--spacing-xl);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-tv);
    padding: var(--spacing-lg);
  }
  
  .btn {
    font-size: var(--font-size-tv);
    padding: var(--spacing-lg) var(--spacing-xl);
  }
  
  h1 {
    font-size: var(--heading-size-tv);
    margin-bottom: var(--spacing-xl);
  }
  
  h2 {
    font-size: var(--heading-size-tv);
    margin-bottom: var(--spacing-lg);
  }
  
  .form-group {
    margin-bottom: var(--spacing-xl);
  }
}

.quotation-card.accepted {
  border-color: #10b981;
  background: #f0fdf4;
}

.quotation-card.rejected {
  border-color: #ef4444;
  background: #fef2f2;
  opacity: 0.7;
}

.quotation-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.service-name {
  font-weight: 600;
  font-size: 1.1rem;
  color: #1f2937;
}

.provider-info {
  font-size: 0.9rem;
  color: #6b7280;
  font-weight: 500;
}

.quotation-details {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.rating {
  font-size: 0.9rem;
  color: #f59e0b;
  font-weight: 500;
}

.location-info {
  font-size: 0.85rem;
  color: #6b7280;
}

.quotation-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.quotation-buttons button {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.btn-accept {
  background: #10b981;
  color: white;
}

.btn-accept:hover:not(:disabled) {
  background: #059669;
  transform: translateY(-1px);
}

.btn-reject {
  background: #ef4444;
  color: white;
}

.btn-reject:hover:not(:disabled) {
  background: #dc2626;
  transform: translateY(-1px);
}

.btn-view {
  background: #3b82f6;
  color: white;
}

.btn-view:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.quotation-buttons button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

@media (max-width: 768px) {
  .quotation-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .quotation-details {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .quotation-buttons {
    width: 100%;
  }
  
  .quotation-buttons button {
    flex: 1;
    min-width: 80px;
  }
}

/* Professional Navigation Styling */
.professional-nav {
  background: var(--background-primary);
  box-shadow: var(--shadow-sm);
  padding: var(--spacing-md);
  position: sticky;
  top: 0;
  z-index: 1000;
  width: 100%;
}

.nav-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
}

/* Mobile menu toggle button */
.mobile-menu-toggle {
  display: none;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-primary);
  cursor: pointer;
  padding: var(--spacing-sm);
}

/* Responsive navigation */
@media (max-width: 768px) {
  .nav-container {
    padding: 0 var(--spacing-md);
    flex-wrap: wrap;
  }
  
  .mobile-menu-toggle {
    display: block;
    order: 2;
  }
  
  .professional-nav .nav-links {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--background-white);
    flex-direction: column;
    padding: var(--spacing-lg);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transform: translateY(-100%);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
    display: none;
  }
  
  .professional-nav .nav-links.active {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
    display: flex;
  }
  
  .professional-nav .nav-links li {
    margin: var(--spacing-sm) 0;
    width: 100%;
  }
  
  .professional-nav .nav-links li a {
    display: block;
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
    transition: background-color 0.3s ease;
    text-align: center;
    font-size: 1rem;
  }
  
  .professional-nav .nav-links li a:hover {
    background-color: var(--background-light);
    transform: none;
  }
  
  /* Mobile navigation styling handled by navigation.css */
}

@media (max-width: 480px) {
  .nav-container {
    padding: 0 var(--spacing-sm);
  }
  
  .logo {
    font-size: 1.2rem;
  }
  
  .logo img {
    width: 30px;
    height: 30px;
  }
  
  /* Small mobile navigation styling handled by navigation.css */
}

/* Responsive booking steps */
@media (max-width: 768px) {
  .booking-container {
    padding: var(--spacing-sm);
  }
  
  .step {
    padding: var(--spacing-md);
  }
  
  .step h2 {
    font-size: 1.5rem;
  }
  
  .form-group {
    margin-bottom: var(--spacing-md);
  }
  
  .form-group label {
    font-size: 0.9rem;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    font-size: 1rem;
    padding: var(--spacing-sm);
  }
  
  .buttons {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .buttons button {
    width: 100%;
    padding: var(--spacing-md);
    font-size: 1rem;
  }
  
  .services-grid {
    grid-template-columns: 1fr;
    gap: var(--spacing-sm);
  }
  
  .service-card {
    padding: var(--spacing-md);
  }
  
  .quotation-card {
    margin-bottom: var(--spacing-md);
  }
}

@media (max-width: 480px) {
  .booking-container {
    padding: var(--spacing-xs);
  }
  
  .step {
    padding: var(--spacing-sm);
  }
  
  .step h2 {
    font-size: 1.3rem;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    font-size: 0.9rem;
    padding: var(--spacing-xs) var(--spacing-sm);
  }
  
  .buttons button {
    padding: var(--spacing-sm);
    font-size: 0.9rem;
  }
  
  .service-card h3 {
    font-size: 1rem;
  }
  
  .service-card p {
    font-size: 0.8rem;
  }
}

.professional-nav .logo {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  text-decoration: none;
  color: var(--text-primary);
  font-weight: 700;
  font-size: var(--font-size-lg);
}

.professional-nav .logo img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.professional-nav .nav-links {
  display: flex;
  list-style: none;
  margin: 0;
  padding: 0;
  gap: var(--spacing-lg);
}

.professional-nav .nav-links li a {
  color: var(--text-secondary);
  text-decoration: none;
  font-weight: 500;
  transition: var(--transition-fast);
  padding: var(--spacing-sm) var(--spacing-md);
}

.professional-nav .nav-links li a:hover {
  color: var(--primary-blue);
  transform: translateY(-2px);
}

/* Navigation styling now handled by navigation.css - removed inline overrides */

/* Location dropdown styling */
.location-dropdown {
  position: absolute !important;
  top: 100% !important;
  left: 0 !important;
  right: 0 !important;
  background: white !important;
  border: 1px solid #ddd !important;
  border-top: none !important;
  border-radius: 0 0 4px 4px !important;
  max-height: 200px !important;
  overflow-y: auto !important;
  z-index: 9999 !important;
  display: none !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

.location-item {
  padding: 12px 16px !important;
  cursor: pointer !important;
  border-bottom: 1px solid #eee !important;
  transition: background-color 0.2s !important;
  font-size: 0.9rem !important;
}

.location-item:hover {
  background-color: #f5f5f5 !important;
}

.location-item.selected {
  background-color: #e3f2fd !important;
  color: #1976d2 !important;
}

/* New step styling */
.service-group {
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  background: #fff;
}

.service-header {
  border-bottom: 1px solid #e0e0e0;
  padding-bottom: 15px;
  margin-bottom: 20px;
}

.service-header h4 {
  color: #333;
  margin: 0;
}

/* Enhanced Service Cards Styling */
.services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.service-card {
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 25px 15px;
    text-align: center;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.service-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 123, 255, 0.15);
}

.service-card.selected {
    border-color: #28a745;
    background: #f8fff9;
}

.service-icon {
    margin-bottom: 15px;
    color: #007bff;
}

.service-title {
    margin: 15px 0;
    color: #333;
    font-weight: 600;
    font-size: 1.1rem;
}

.service-select {
    margin-top: 15px;
}

.service-checkbox {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #007bff;
    font-weight: 500;
    gap: 8px;
}

.service-checkbox input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #007bff;
    border-radius: 4px;
    display: inline-block;
    position: relative;
    transition: all 0.3s ease;
}

.service-checkbox input[type="checkbox"]:checked + .checkmark {
    background-color: #007bff;
    border-color: #007bff;
}

.service-checkbox input[type="checkbox"]:checked + .checkmark::after {
    content: 'âœ“';
    position: absolute;
    color: white;
    font-size: 14px;
    font-weight: bold;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Additional CSS for JavaScript-controlled checkmarks */
.checkmark.checked {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
}

/* Budget validation error styling */
.form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.form-control.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.checkmark.checked::after {
    content: 'âœ“';
    position: absolute;
    color: white;
    font-size: 14px;
    font-weight: bold;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.service-card.selected {
    border-color: #28a745 !important;
    background-color: #f8fff9 !important;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.3) !important;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .services-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .service-card {
        padding: 20px 10px;
    }
    
    .service-icon i {
        font-size: 2.5rem !important;
    }
    
    .service-title {
        font-size: 1rem;
    }
}

.quotations-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.quotation-card {
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s ease;
  background: #fff;
}

.quotation-card:hover {
  border-color: #007bff;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.quotation-card.selected {
  border-color: #28a745;
  background: #f8fff9;
}

.card-header {
  background: #f8f9fa;
  padding: 15px 20px;
  border-bottom: 1px solid #e0e0e0;
}

.card-header h5 {
  margin: 0;
  color: #333;
}

.provider-rating {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-top: 5px;
}

.rating {
  font-weight: bold;
  color: #ffc107;
}

.card-body {
  padding: 20px;
}

.price-section {
  text-align: center;
  margin-bottom: 15px;
}

.price {
  font-size: 24px;
  font-weight: bold;
  color: #28a745;
  display: block;
}

.price-label {
  font-size: 12px;
  color: #6c757d;
  text-transform: uppercase;
}

.quotation-details {
  margin-bottom: 15px;
}

.provider-info {
  font-size: 14px;
}

.info-item {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  color: #6c757d;
}

.card-footer {
  padding: 15px 20px;
  background: #f8f9fa;
  border-top: 1px solid #e0e0e0;
}

.summary-card {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.summary-card h3 {
  color: #333;
  border-bottom: 2px solid #007bff;
  padding-bottom: 10px;
  margin-bottom: 15px;
}

.selected-quotation-item,
.event-summary-item,
.total-cost-item {
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
}

.selected-quotation-item:last-child,
.event-summary-item:last-child,
.total-cost-item:last-child {
  border-bottom: none;
}

.total-cost-item h4 {
  color: #28a745;
  font-size: 28px;
  margin: 0;
}

.payment-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  margin-top: 20px;
}

.payment-summary,
.payment-form {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 25px;
}

.payment-summary h4,
.payment-form h4 {
  color: #333;
  margin-bottom: 20px;
}

.breakdown-item {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
}

.breakdown-item.total {
  border-top: 2px solid #007bff;
  border-bottom: none;
  margin-top: 10px;
  padding-top: 15px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #333;
}

.form-group input {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.thank-you-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 40px 20px;
}

.thank-you-icon {
  font-size: 80px;
  color: #28a745;
  margin-bottom: 20px;
}

.confirmation-details {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  margin: 30px 0;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #e0e0e0;
}

.detail-item:last-child {
  border-bottom: none;
}

.next-steps {
  text-align: left;
  margin: 30px 0;
}

.next-steps h4 {
  color: #333;
  margin-bottom: 15px;
}

.next-steps ul li {
  padding: 8px 0;
  color: #6c757d;
}

.contact-info {
  background: #e3f2fd;
  border-radius: 12px;
  padding: 20px;
  margin: 30px 0;
}

.contact-info h5 {
  color: #1976d2;
  margin-bottom: 10px;
}

/* Responsive design */
@media (max-width: 768px) {
  .services-grid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
  }
  
  .payment-container {
    grid-template-columns: 1fr;
  }
  
  .quotations-grid {
    grid-template-columns: 1fr;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
}

/* Quotation Card Styles */
.quotation-card {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
  background: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: box-shadow 0.3s ease;
}

.quotation-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.quotation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.quotation-provider {
  display: flex;
  align-items: center;
  font-size: 1.1em;
}

.quotation-price {
  font-size: 1.5em;
  font-weight: bold;
  color: #28a745;
}

.quotation-details {
  margin-bottom: 15px;
}

.quotation-details ul {
  margin: 10px 0;
  padding-left: 20px;
}

.quotation-details li {
  margin-bottom: 5px;
}

.quotation-note {
  font-style: italic;
  color: #666;
  margin-top: 10px;
  padding: 10px;
  background-color: #f8f9fa;
  border-radius: 4px;
  border-left: 3px solid #007bff;
}

.quotation-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.quotations-container {
  margin-top: 20px;
}

.quotations-container h3 {
  color: #333;
  margin-bottom: 20px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<!-- Universal Form Validation -->
<script src="js/form-validation.js"></script>
<script src="js/universal-validation-init.js"></script>

<!-- IMMEDIATE SERVICE LOADING SCRIPT -->
<script>
  // Load services IMMEDIATELY when script loads
  console.log('âš¡ IMMEDIATE SCRIPT: Loading services right now...');
  
  // Define services immediately - COMPREHENSIVE LIST FROM IMAGES
  window.servicesList = [
      { service_id: 'fb-audio-visual', service_name: 'Audio-Visual Technician', icon: 'fa-video' },
      { service_id: 'fb-bartender', service_name: 'Bartender', icon: 'fa-glass-martini' },
      { service_id: 'fb-cake', service_name: 'Cake Designer', icon: 'fa-birthday-cake' },
      { service_id: 'fb-catering', service_name: 'Catering', icon: 'fa-utensils' },
      { service_id: 'fb-decor', service_name: 'Decoration', icon: 'fa-paint-roller' },
      { service_id: 'fb-dj', service_name: 'DJ', icon: 'fa-music' },
      { service_id: 'fb-drone-photo', service_name: 'Drone Photography', icon: 'fa-drone' },
      { service_id: 'fb-entertainment', service_name: 'Entertainment Booking', icon: 'fa-theater-masks' },
      { service_id: 'fb-insurance', service_name: 'Event Insurance / Permits', icon: 'fa-shield-alt' },
      { service_id: 'fb-planner', service_name: 'Event Planner', icon: 'fa-calendar-check' },
      { service_id: 'fb-fireworks', service_name: 'Fireworks / Pyrotechnics', icon: 'fa-fire' },
      { service_id: 'fb-florist', service_name: 'Florist', icon: 'fa-seedling' },
      { service_id: 'fb-furniture', service_name: 'Furniture Rental', icon: 'fa-chair' },
      { service_id: 'fb-hair', service_name: 'Hair Styling', icon: 'fa-cut' },
      { service_id: 'fb-host', service_name: 'Host/Presenter', icon: 'fa-user-tie' },
      { service_id: 'fb-invitations', service_name: 'Invitation Design', icon: 'fa-envelope' },
      { service_id: 'fb-lighting', service_name: 'Lighting', icon: 'fa-lightbulb' },
      { service_id: 'fb-live-band', service_name: 'Live Band', icon: 'fa-guitar' },
      { service_id: 'fb-makeup', service_name: 'Makeup Services', icon: 'fa-face-smile' },
      { service_id: 'fb-mc', service_name: 'MC', icon: 'fa-microphone' },
      { service_id: 'fb-favors', service_name: 'Party Favors / Gift Bags', icon: 'fa-gift' },
      { service_id: 'fb-photobooth', service_name: 'Photo Booth', icon: 'fa-camera-retro' },
      { service_id: 'fb-photo', service_name: 'Photography', icon: 'fa-camera' },
      { service_id: 'fb-security', service_name: 'Security', icon: 'fa-shield' },
      { service_id: 'fb-sound', service_name: 'Sound System', icon: 'fa-volume-high' },
      { service_id: 'fb-stage', service_name: 'Stage Design', icon: 'fa-theater-masks' },
      { service_id: 'fb-transport', service_name: 'Transport', icon: 'fa-car' },
      { service_id: 'fb-travel', service_name: 'Travel & Accommodation', icon: 'fa-plane' },
      { service_id: 'fb-valet', service_name: 'Valet Parking', icon: 'fa-car-side' },
      { service_id: 'fb-venue', service_name: 'Venue', icon: 'fa-building' },
      { service_id: 'fb-video', service_name: 'Videography', icon: 'fa-video' }
  ];
  
  window.jobCart = [];
  window.selectedQuotations = {};
  window.currentStep = 1;
  
  console.log('âœ… IMMEDIATE SCRIPT: Services loaded!', window.servicesList.length, 'services');
  
  console.log('âœ… IMMEDIATE SCRIPT: Services are already in HTML - no need to display!');
</script>

<!-- IMMEDIATE TIMER SCRIPT -->
<script>
  // Simple timer that works immediately
  let timerInterval = null;
  let timerStartTime = null;
  let timerDuration = 2 * 60 * 1000; // 2 minutes

  // Start timer when Step 4 is shown
  function startSimpleTimer() {
    console.log('â° Starting simple timer...');
    
    timerStartTime = new Date();
    
    timerInterval = setInterval(() => {
      const elapsed = new Date() - timerStartTime;
      const remaining = Math.max(0, timerDuration - elapsed);
      
      // Update display
      updateTimerDisplay(remaining, elapsed);
      
      // Check if timer finished
      if (remaining <= 0) {
        clearInterval(timerInterval);
        timerFinished();
      }
    }, 1000);
    
    console.log('âœ… Timer started!');
  }

  function updateTimerDisplay(remaining, elapsed) {
    // Update countdown display
    const totalSeconds = Math.floor(remaining / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    const formattedTime = [hours, minutes, seconds]
      .map(unit => String(unit).padStart(2, '0'))
      .join(':');
    
    const countdownDisplay = document.getElementById('countdown-display');
    if (countdownDisplay) {
      countdownDisplay.textContent = formattedTime;
    }
    
    // Update elapsed time
    const elapsedSeconds = Math.floor(elapsed / 1000);
    const elapsedMinutes = Math.floor(elapsedSeconds / 60);
    const elapsedSecs = elapsedSeconds % 60;
    
    const elapsedDisplay = document.getElementById('elapsed-time');
    if (elapsedDisplay) {
      elapsedDisplay.textContent = `${String(elapsedMinutes).padStart(2, '0')}:${String(elapsedSecs).padStart(2, '0')}`;
    }
    
    // Update remaining time
    const remainingMinutes = Math.floor(totalSeconds / 60);
    const remainingSecs = totalSeconds % 60;
    
    const remainingDisplay = document.getElementById('remaining-time');
    if (remainingDisplay) {
      remainingDisplay.textContent = `${String(remainingMinutes).padStart(2, '0')}:${String(remainingSecs).padStart(2, '0')}`;
    }
    
    // Update progress
    const progressPercent = Math.min(100, (elapsed / timerDuration) * 100);
    const progressDisplay = document.getElementById('progress-percent');
    if (progressDisplay) {
      progressDisplay.textContent = `${Math.round(progressPercent)}%`;
    }
    
    const progressBar = document.getElementById('quotation-progress');
    if (progressBar) {
      progressBar.style.width = `${progressPercent}%`;
    }
  }

  function timerFinished() {
    console.log('ðŸŽ‰ Timer finished! Quotations are ready...');
    
    // Generate quotations first
    generateFakeQuotationsForServices().then(() => {
      console.log('âœ… Quotations generated successfully');
    });
    
    const quotationsStatus = document.getElementById('quotations-status');
    if (quotationsStatus) {
      quotationsStatus.innerHTML = `
        <div class="alert alert-success">
          <i class="fas fa-check-circle me-2"></i>
          <strong>Quotations Ready!</strong> Service providers have submitted their quotations. Click "View & Select Quotations" to proceed.
        </div>
      `;
    }
    
    // Enable the "View Quotations" button
    const viewBtn = document.getElementById('viewQuotationsBtn');
    if (viewBtn) {
      viewBtn.disabled = false;
      viewBtn.innerHTML = '<i class="fas fa-eye me-2"></i>View & Select Quotations';
      viewBtn.classList.remove('btn-success');
      viewBtn.classList.add('btn-primary');
      console.log('âœ… View Quotations button enabled');
    }
  }

  // Make functions globally available
  window.startSimpleTimer = startSimpleTimer;
  window.selectQuotation = function(quotationId) {
    console.log('Selected quotation:', quotationId);
    
    // Store selected quotation
    if (!window.selectedQuotations) {
      window.selectedQuotations = {};
    }
    
    // Add quotation to selected list (with sample data)
    const quotationData = {
      id: quotationId,
      provider: quotationId.split('-')[1] || 'Provider',
      service: quotationId.split('-')[0] || 'Service',
      price: quotationId.includes('photography') ? 8500 : 
             quotationId.includes('catering') ? 12000 : 
             quotationId.includes('dj') ? 4500 : 5000
    };
    
    window.selectedQuotations[quotationId] = quotationData;
    
    // Visual feedback
    const button = event.target.closest('.quotation-buttons').querySelector('button');
    button.innerHTML = '<i class="fas fa-check me-1"></i>Selected âœ“';
    button.classList.remove('btn-success');
    button.classList.add('btn-outline-success');
    button.disabled = true;
    
    console.log('Selected quotations:', window.selectedQuotations);
    alert('Quotation selected: ' + quotationId + ' (R ' + quotationData.price + ')');
  };
  window.viewQuotationDetails = function(quotationId) {
    console.log('Viewing quotation details:', quotationId);
    alert('Viewing details for: ' + quotationId);
  };
  
  // Force show sample quotations
  window.showSampleQuotations = async function() {
    console.log('ðŸ‘ï¸ Forcing sample quotations to show...');
    
    // Load real quotations from database
    console.log('ðŸ” Loading real quotations...');
    await loadRealQuotationsForServices();
    
    // Render dynamic quotations
    renderDynamicQuotations();
    
    alert('Dynamic quotations should now be visible!');
  };

  // Force show all quotations
  window.forceShowQuotations = function() {
    console.log('ðŸ”§ FORCE SHOWING ALL QUOTATIONS...');
    
    const container = document.getElementById('quotations-container');
    if (container) {
      container.style.display = 'block !important';
      container.style.visibility = 'visible !important';
      container.style.opacity = '1 !important';
      container.style.height = 'auto !important';
      container.style.overflow = 'visible !important';
      
      // Show all quotation cards
      const cards = container.querySelectorAll('.quotation-card');
      cards.forEach(card => {
        card.style.display = 'block !important';
        card.style.visibility = 'visible !important';
        card.style.opacity = '1 !important';
      });
      
      console.log('âœ… All quotations forced to show!');
      alert('All quotations forced to show! You should see them now.');
    } else {
      console.error('âŒ Quotations container not found!');
      alert('Error: Quotations container not found!');
    }
  };


  
  // Function to go to quotation selection step
  function goToQuotationPage() {
    console.log('ðŸ”„ Redirecting to quotation.html page...');
    
    // Store service IDs from job carts locally for quotation page
    const jobCartDetails = JSON.parse(localStorage.getItem('jobCartDetails') || '[]');
    const serviceIds = jobCartDetails.map(cart => cart.service_id).filter(Boolean);
    
    console.log('ðŸ“‹ Storing service IDs for quotation page:', serviceIds);
    localStorage.setItem('quotationServiceIds', JSON.stringify(serviceIds));
    
    // Also store the authenticated client ID
    const clientId = localStorage.getItem('clientId');
    if (clientId) {
        localStorage.setItem('quotationClientId', clientId);
    } else {
        console.error('No authenticated client ID found');
        showMessage('Please log in to continue', 'error');
        return;
    }
    
    // Redirect to the separate quotation page
    window.location.href = 'quotation.html';
  }
  
  // Make it globally available
  window.goToQuotationPage = goToQuotationPage;

  // Removed problematic override that was causing infinite loops
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="js/booking-session-manager.js"></script>
<script src="js/simple-location.js"></script>
<script src="js/realtime-service.js"></script>
<script src="js/realtime-notifications.js"></script>
<script src="js/lock-manager.js"></script>
<script src="js/lock-ui.js"></script>
<script src="js/realtime-database-sync.js"></script>
<script src="js/enhanced-quotation-realtime.js"></script>
<!-- Navigation JavaScript -->
<script src="js/navigation.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<!-- Professional Navigation -->
        <nav class="professional-nav">
            <div class="nav-container">
                <a href="index.html" class="logo">
                    <img src="img/logo.jpeg" alt="Bonica Logo">
                    <span>Bonica</span>
                </a>
                <div class="nav-actions">
                    <a href="#" onclick="toggleCartDropdown()" class="btn btn-primary">
                        <i class="fas fa-shopping-cart me-2"></i>Job Cart (<span id="cart-count">0</span>)
                        <div id="quotation-counter" class="quotation-counter" style="display: none;">0</div>
                    </a>
                    <div class="job-cart">
                        <div id="cart-dropdown" class="cart-dropdown" style="display:none;">
                            <ul id="cart-items"></ul>
                            <div style="margin-top:10px; display:flex; gap:8px;">
                                <button style="flex:1;" onclick="openCartModal()">View Cart</button>
                                <button style="flex:1; background:#198754;" onclick="goToStep(3)">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
<!-- Navigation End -->

<div class="container">
  <!-- Messages Container -->
  <div id="messages-container"></div>
  <!-- Step 1: Welcome -->
  <div class="step" id="step-1">
    <h2>Welcome!</h2>
    <p>Do you want to make a booking?</p>
    <div class="booking-choice-buttons">
      <button class="primary-btn" onclick="startBooking()">Yes</button>
      <button class="primary-btn" onclick="cancelBooking()">No</button>
    </div>
  </div>

  <!-- Step 2: Event Details -->
  <div class="step" id="step-2">
    <h2><i class="fas fa-calendar-alt me-2"></i>Event Details</h2>
    <label>Event Type
      <select id="event_type" onchange="toggleOtherEventInput()">
        <option value="">-- Select Event Type --</option>
        <option value="birthday">Birthday</option>
        <option value="graduation">Graduation</option>
        <option value="corporate_event">Corporate Event</option>
        <option value="concert">Concert</option>
        <option value="baby_shower">Baby Shower</option>
        <option value="anniversary">Anniversary</option>
        <option value="engagement_party">Engagement Party</option>
        <option value="conference">Conference</option>
        <option value="wedding">Wedding</option>
        <option value="networking_event">Networking Event</option>
        <option value="workshop">Workshop / Training</option>
        <option value="sports_event">Sports Event / Tournament</option>
        <option value="festival">Festival / Fair</option>
        <option value="religious_ceremony">Religious Ceremony</option>
        <option value="product_launch">Product Launch</option>
        <option value="team_building">Team Building Event</option>
        <option value="award_ceremony">Award Ceremony</option>
        <option value="housewarming">Housewarming / Farewell Party</option>
        <option value="other">Other</option>
      </select>
      <div class="error" id="event_type_error"></div>
    </label>
    <div id="other-event-wrapper" style="display:none; margin-top:8px;">
      <input type="text" id="other_event_type" placeholder="Enter your event type here" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" />
    </div>
    <label>Date 
      <input type="date" id="event_date" autocomplete="off" min="">
      <div class="error" id="event_date_error"></div>
    </label>
    <label>Start Time 
      <input type="time" id="start_time" autocomplete="off">
      <div class="error" id="start_time_error"></div>
    </label>
    <label>End Time 
      <input type="time" id="end_time" autocomplete="off">
      <div class="error" id="end_time_error"></div>
    </label>
    <label>Location</label>
    <div style="position: relative;">
    <input type="text" id="location" placeholder="Enter your event location" 
           data-location-input="true"
           data-placeholder="Enter your event location"
           data-validation="true"
           data-autocomplete="true"
           autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off">
    </div>
    <small class="form-text text-muted" style="margin-top: 0.25rem; font-size: 0.875rem;">
      <i class="fas fa-map-marker-alt me-1"></i>
      Enter the event location to find nearby service providers
    </small>
    <div class="error" id="locationError"></div>
    <label>Special Requests (optional)
      <textarea id="special_requests" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
    </label>
    <label>Budget Range</label>
    <input type="number" id="min_price" placeholder="Minimum Price" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" min="0">
    <div class="error" id="min_price_error"></div>
    <input type="number" id="max_price" placeholder="Maximum Price" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" min="0">
    <div class="error" id="max_price_error"></div>
    <small class="text-muted mt-2 d-block">
      <i class="fas fa-info-circle me-1"></i>
      Budget range is for the entire event - you'll receive quotations within this total budget range
    </small>
  </div>

  <!-- Step 3: Service Details -->
  <div class="step" id="step-3">
    <h2><i class="fas fa-cogs me-2"></i>Select Services</h2>
    <div class="mb-3">
      <button class="btn btn-outline-primary btn-sm" onclick="reloadServices()">
        <i class="fas fa-refresh me-2"></i>Load Services
      </button>
      <span class="ms-3 text-success" id="services-status">âœ… 31 services loaded and ready!</span>
    </div>
    <div id="services-grid" class="services-grid">
      <!-- SERVICES DIRECTLY IN HTML - COMPREHENSIVE LIST FROM IMAGES -->
      
      <!-- Audio-Visual Technician -->
      <div class="service-card" onclick="toggleService('fb-audio-visual')">
        <div class="service-icon">
          <i class="fas fa-video fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Audio-Visual Technician</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Bartender -->
      <div class="service-card" onclick="toggleService('fb-bartender')">
        <div class="service-icon">
          <i class="fas fa-glass-martini fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Bartender</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Cake Designer -->
      <div class="service-card" onclick="toggleService('fb-cake')">
        <div class="service-icon">
          <i class="fas fa-birthday-cake fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Cake Designer</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Catering -->
      <div class="service-card" onclick="toggleService('fb-catering')">
        <div class="service-icon">
          <i class="fas fa-utensils fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Catering</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Decoration -->
      <div class="service-card" onclick="toggleService('fb-decor')">
        <div class="service-icon">
          <i class="fas fa-paint-roller fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Decoration</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- DJ -->
      <div class="service-card" onclick="toggleService('fb-dj')">
        <div class="service-icon">
          <i class="fas fa-music fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">DJ</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Drone Photography -->
      <div class="service-card" onclick="toggleService('fb-drone-photo')">
        <div class="service-icon">
          <i class="fas fa-drone fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Drone Photography</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Entertainment Booking -->
      <div class="service-card" onclick="toggleService('fb-entertainment')">
        <div class="service-icon">
          <i class="fas fa-theater-masks fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Entertainment Booking</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Event Insurance / Permits -->
      <div class="service-card" onclick="toggleService('fb-insurance')">
        <div class="service-icon">
          <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Event Insurance / Permits</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Event Planner -->
      <div class="service-card" onclick="toggleService('fb-planner')">
        <div class="service-icon">
          <i class="fas fa-calendar-check fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Event Planner</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Fireworks / Pyrotechnics -->
      <div class="service-card" onclick="toggleService('fb-fireworks')">
        <div class="service-icon">
          <i class="fas fa-fire fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Fireworks / Pyrotechnics</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Florist -->
      <div class="service-card" onclick="toggleService('fb-florist')">
        <div class="service-icon">
          <i class="fas fa-seedling fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Florist</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Furniture Rental -->
      <div class="service-card" onclick="toggleService('fb-furniture')">
        <div class="service-icon">
          <i class="fas fa-chair fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Furniture Rental</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Hair Styling -->
      <div class="service-card" onclick="toggleService('fb-hair')">
        <div class="service-icon">
          <i class="fas fa-cut fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Hair Styling</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Host/Presenter -->
      <div class="service-card" onclick="toggleService('fb-host')">
        <div class="service-icon">
          <i class="fas fa-user-tie fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Host/Presenter</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Invitation Design -->
      <div class="service-card" onclick="toggleService('fb-invitations')">
        <div class="service-icon">
          <i class="fas fa-envelope fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Invitation Design</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Lighting -->
      <div class="service-card" onclick="toggleService('fb-lighting')">
        <div class="service-icon">
          <i class="fas fa-lightbulb fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Lighting</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Live Band -->
      <div class="service-card" onclick="toggleService('fb-live-band')">
        <div class="service-icon">
          <i class="fas fa-guitar fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Live Band</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Makeup Artist -->
      <div class="service-card" onclick="toggleService('fb-makeup')">
        <div class="service-icon">
          <i class="fas fa-face-smile fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Makeup Artist</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- MC -->
      <div class="service-card" onclick="toggleService('fb-mc')">
        <div class="service-icon">
          <i class="fas fa-microphone fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">MC</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Party Favors / Gift Bags -->
      <div class="service-card" onclick="toggleService('fb-favors')">
        <div class="service-icon">
          <i class="fas fa-gift fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Party Favors / Gift Bags</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Photo Booth -->
      <div class="service-card" onclick="toggleService('fb-photobooth')">
        <div class="service-icon">
          <i class="fas fa-camera-retro fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Photo Booth</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Photography -->
      <div class="service-card" onclick="toggleService('fb-photo')">
        <div class="service-icon">
          <i class="fas fa-camera fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Photography</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Security -->
      <div class="service-card" onclick="toggleService('fb-security')">
        <div class="service-icon">
          <i class="fas fa-shield fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Security</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Sound System -->
      <div class="service-card" onclick="toggleService('fb-sound')">
        <div class="service-icon">
          <i class="fas fa-volume-high fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Sound System</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Stage Design -->
      <div class="service-card" onclick="toggleService('fb-stage')">
        <div class="service-icon">
          <i class="fas fa-theater-masks fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Stage Design</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Transport -->
      <div class="service-card" onclick="toggleService('fb-transport')">
        <div class="service-icon">
          <i class="fas fa-car fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Transport</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Travel & Accommodation -->
      <div class="service-card" onclick="toggleService('fb-travel')">
        <div class="service-icon">
          <i class="fas fa-plane fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Travel & Accommodation</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Valet Parking -->
      <div class="service-card" onclick="toggleService('fb-valet')">
        <div class="service-icon">
          <i class="fas fa-car-side fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Valet Parking</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Venue -->
      <div class="service-card" onclick="toggleService('fb-venue')">
        <div class="service-icon">
          <i class="fas fa-building fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Venue</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
      
      <!-- Videography -->
      <div class="service-card" onclick="toggleService('fb-video')">
        <div class="service-icon">
          <i class="fas fa-video fa-3x text-primary mb-3"></i>
        </div>
        <h5 class="service-title">Videography</h5>
        <div class="service-select">
          <div class="service-checkbox">
            <span class="checkmark"></span>
            Select Service
          </div>
        </div>
      </div>
    </div>
    
    <!-- Selected Services Budget Section -->
    <div id="selected-services-budget" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
      <h4><i class="fas fa-dollar-sign me-2 text-success"></i>Set Budget for Each Selected Service</h4>
      <p class="text-muted mb-3">Specify your budget range for each service you've selected. Service providers will see this budget and quote within your range.</p>
      
      <div id="service-budget-inputs">
        <!-- Dynamic budget inputs will be added here -->
      </div>
      
      <div class="mt-3">
        <small class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          Enter your minimum and maximum budget for each service. Service providers will only be able to quote within these ranges.
        </small>
      </div>
    </div>
  </div>

  <!-- Step 4: Waiting for Quotations -->
  <div class="step" id="step-4" style="display:none;">
    <h2><i class="fas fa-hourglass-half me-2"></i>Waiting for Quotations</h2>
    <div class="alert alert-info mb-4">
      <i class="fas fa-upload me-2"></i>
      <strong>Quotations Being Uploaded:</strong> Service providers are currently preparing and uploading their quotations for your selected services. This process typically takes 1 minute.
    </div>
    <p class="text-muted mb-4">Service providers are currently reviewing your request and preparing their quotations. Please wait, this will update automatically.</p>

    <!-- Progress Bar -->
    <div class="progress-container mb-4">
      <div class="progress" style="height: 8px;">
        <div class="progress-bar" id="quotation-progress" role="progressbar" style="width: 0%"></div>
      </div>
    </div>

    <!-- Countdown Timer -->
    <div class="countdown-timer text-center p-4 bg-light rounded">
      <div class="timer-label mb-2">Expected Quotation Delivery</div>
      <div class="timer-display h2 text-primary mb-2" id="countdown-display">02:00:00</div>
      <div class="timer-description text-muted mb-3">Service providers are uploading their quotations. Expected delivery in 2 minutes</div>
      
      <div class="row text-center">
        <div class="col-4">
          <div class="time-stat">
            <span class="time-stat-value h5 text-primary d-block" id="elapsed-time">00:00</span>
            <span class="time-stat-label small text-muted">Elapsed</span>
          </div>
        </div>
        <div class="col-4">
          <div class="time-stat">
            <span class="time-stat-value h5 text-primary d-block" id="remaining-time">02:00</span>
            <span class="time-stat-label small text-muted">Remaining</span>
          </div>
        </div>
        <div class="col-4">
          <div class="time-stat">
            <span class="time-stat-value h5 text-primary d-block" id="progress-percent">0%</span>
            <span class="time-stat-label small text-muted">Progress</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Quotations Status -->
    <div class="quotations-status mt-4" id="quotations-status">
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>What's happening:</strong> Service providers are currently:
        <ul class="mb-0 mt-2">
          <li>Reviewing your job cart</li>
          <li>Preparing their quotations with pricing</li>
        </ul>
        You'll be notified once quotations are ready for review.
      </div>
    </div>

    <!-- View Quotations Button -->
    <div class="text-center mt-4">
      <button id="viewQuotationsBtn" class="btn btn-success btn-lg" onclick="goToQuotationPage()" disabled>
        <i class="fas fa-hourglass-half me-2"></i>Waiting for Quotations...
      </button>
    </div>
  </div>

  <!-- Step 5: Quotation Selection - SIMPLIFIED -->
  <div class="step" id="step-5" style="display:none;">
    <h2><i class="fas fa-file-invoice me-2"></i>Select Quotations</h2>
    <p class="text-muted mb-4">Review and select your preferred quotations from service providers.</p>
    
    <!-- Continue to Summary Button -->
    <div class="mb-4 text-center">
      <button class="btn btn-primary btn-lg" onclick="goToStep(6)" id="continueToSummaryBtn" style="display: none;">
        <i class="fas fa-arrow-right me-2"></i>Continue to Summary
      </button>
    </div>
    
    <!-- Dynamic Quotations Container -->
    <div class="quotations-container mt-4" id="quotations-container" style="display: block;">
      <h3><i class="fas fa-file-invoice me-2"></i>Received Quotations</h3>
      <p class="text-muted mb-3">Select one quotation for each service to continue with your booking.</p>
      <div id="quotations-list">
        <!-- Dynamic quotations will be generated here -->
      </div>
    </div>
    
    <!-- Dynamic quotations will appear here -->
    <div id="quotations-selection-container" style="display: none;"></div>
  </div>

  <!-- Step 6: Summary -->
  <div class="step" id="step-6" style="display:none;">
    <h2><i class="fas fa-check-circle me-2"></i>Booking Summary</h2>
    <div class="summary-card">
      <h3>Selected Quotations</h3>
      <div id="selected-quotations-summary"></div>
    </div>
    <div class="summary-card">
      <h3>Event Details</h3>
      <div id="event-summary"></div>
    </div>
    <div class="summary-card">
      <h3>Total Cost</h3>
      <div id="total-cost-summary"></div>
    </div>
  </div>

  <!-- Step 7: Payment -->
  <div class="step" id="step-7" style="display:none;">
    <h2><i class="fas fa-credit-card me-2"></i>Payment & Confirmation</h2>
    <p class="text-muted mb-4">Complete your payment to confirm your booking.</p>
    <div class="payment-container">
      <div class="payment-summary">
        <h4>Payment Summary</h4>
        <div id="payment-details"></div>
      </div>
      <div class="payment-form">
        <h4>Payment Information</h4>
        <div class="form-group">
          <label>Card Number</label>
          <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Expiry Date</label>
            <input type="text" id="expiry-date" placeholder="MM/YY" maxlength="5">
          </div>
          <div class="form-group">
            <label>CVV</label>
            <input type="text" id="cvv" placeholder="123" maxlength="3">
          </div>
        </div>
        <div class="form-group">
          <label>Cardholder Name</label>
          <input type="text" id="cardholder-name" placeholder="John Doe">
        </div>
        <button id="process-payment" class="btn btn-primary btn-lg w-100">
          <i class="fas fa-lock me-2"></i>Process Payment
        </button>
      </div>
    </div>
  </div>

  <!-- Step 8: Thank You -->
  <div class="step" id="step-8" style="display:none;">
    <div class="thank-you-container text-center">
      <div class="thank-you-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h2>Thank You for Your Booking!</h2>
      <p class="lead">Your booking has been confirmed and payment processed successfully.</p>
      
      <div class="confirmation-details">
        <div class="detail-item">
          <strong>Booking ID:</strong> <span id="booking-id-display"></span>
        </div>
        <div class="detail-item">
          <strong>Event Date:</strong> <span id="confirmed-event-date"></span>
        </div>
        <div class="detail-item">
          <strong>Total Amount:</strong> <span id="confirmed-total-amount"></span>
        </div>
      </div>

      <div class="next-steps">
        <h4>What happens next?</h4>
        <ul class="list-unstyled">
          <li><i class="fas fa-envelope me-2"></i>You'll receive a confirmation email shortly</li>
          <li><i class="fas fa-phone me-2"></i>Your service providers will contact you within 24 hours</li>
          <li><i class="fas fa-calendar-check me-2"></i>Final details will be confirmed before your event</li>
        </ul>
      </div>

      <div class="contact-info">
        <h5>Need help?</h5>
        <p>Contact us at <strong>support@bonica.co.za</strong> or <strong>+27 11 123 4567</strong></p>
      </div>

      <button class="btn btn-primary" onclick="window.location.href='dashboard.html'">
        <i class="fas fa-home me-2"></i>Back to Dashboard
      </button>
    </div>
  </div>

  <div class="buttons">
    <button id="prevBtn" onclick="prevStep()">Previous</button>
    <button id="nextBtn" onclick="nextStep()">Next</button>
  </div>
</div>

<!-- Job Cart Modal -->
<div id="cart-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center;">
  <div style="background:#fff; width:min(900px,95vw); max-height:90vh; overflow:auto; border-radius:12px; padding:20px; position:relative;">
    <button onclick="closeCartModal()" style="position:absolute; top:10px; right:10px; background:#6c757d;">Close</button>
    <h2>Jobcart_ID: <span id="cart-id"></span></h2>
    <div id="cart-list"></div>
    <hr>
    <div style="display:flex; justify-content:flex-end; gap:20px; align-items:center;">
      <strong id="cart-accepted-total">Accepted quotations total: R0.00</strong>
      <h3 id="cart-total" style="margin:0;">Total: R0.00</h3>
    </div>
    <div style="margin-top:18px; color:#555;">
      <div>Create Time: <span id="cart-time"></span></div>
      <div>Create Date: <span id="cart-date"></span></div>
    </div>
  </div>
</div>

<script>
console.log('ðŸš€ Script starting to load...');

// Supabase setup
const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A';

console.log('ðŸ“¡ Supabase URL:', SUPABASE_URL);
console.log('ðŸ”‘ Supabase Key loaded:', SUPABASE_KEY ? 'Yes' : 'No');

let sb;
try {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('âœ… Supabase client created successfully');
} catch (error) {
    console.error('âŒ Supabase client creation failed:', error);
}

// Global variables - declare at the top to avoid initialization issues
var servicesList = [];
// jobCart is already declared globally above, don't redeclare
// selectedQuotations and currentStep are already declared globally above

// Message System
function showMessage(message, type = 'info', duration = 5000) {
    const container = document.getElementById('messages-container');
    if (!container) return;
    
    // Remove existing messages
    container.innerHTML = '';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
            <span>${message}</span>
            <button type="button" class="btn-close btn-close-white ms-2" onclick="hideMessage(this)"></button>
        </div>
    `;
    
    container.appendChild(messageDiv);
    messageDiv.style.display = 'block';
    
    // Auto-hide after duration
    if (duration > 0) {
        setTimeout(() => {
            hideMessage(messageDiv.querySelector('.btn-close'));
        }, duration);
    }
}

function hideMessage(button) {
    const message = button.closest('.message');
    if (message) {
        message.style.display = 'none';
        setTimeout(() => {
            if (message.parentNode) {
                message.parentNode.removeChild(message);
            }
        }, 300);
    }
}

// Global notification function
function showNotification(message, type, duration = 3000) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        max-width: 400px;
    `;
    
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after duration
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, duration);
}

// Authentication and Session Initialization
const clientId = localStorage.getItem("clientId");
if (!clientId) { 
    alert("You must be logged in!"); 
    window.location.href = "Registration.html"; 
} else {
    // Initialize booking session with client data
    if (window.BookingSession) {
        const userName = localStorage.getItem("userName");
        const userType = localStorage.getItem("userType") || 'client';
        window.BookingSession.initializeSession(clientId, userName, userType);
        console.log('âœ… Booking session initialized for:', userName || clientId);
    }
}
localStorage.removeItem("totalAmount");

// Check if user came from services page with selected package
const selectedPackage = JSON.parse(localStorage.getItem('selectedPackage') || 'null');
if (selectedPackage) {
    console.log('ðŸ“¦ Selected package from services page:', selectedPackage);
    // Auto-populate services based on selected package
    populateServicesFromPackage(selectedPackage);
}

// Function to populate services from selected package
function populateServicesFromPackage(packageInfo) {
    console.log('ðŸŽ¯ Auto-populating services for package:', packageInfo.name);
    
    // Clear any existing selections
    window.jobCart = [];
    selectedQuotations = {};
    
    // Map service types to service IDs (this would need to match your database)
    const serviceTypeMap = {
        'photography': 'Photography & Videography',
        'decoration': 'Decoration & Styling', 
        'catering': 'Catering Services',
        'entertainment': 'DJ & Entertainment',
        'cake': 'Wedding Cakes',
        'transportation': 'Transportation'
    };
    
    // Create job cart items for each service in the package
    packageInfo.services.forEach(service => {
        const serviceName = serviceTypeMap[service.type] || service.name;
        const serviceItem = {
            id: `auto-${service.type}-${Date.now()}`,
            service: serviceName,
            type: service.type,
            description: `Included in ${packageInfo.name}`,
            estimatedPrice: Math.floor(packageInfo.price / packageInfo.services.length),
            selected: true
        };
        
        window.jobCart.push(serviceItem);
        console.log(`âœ… Added service: ${serviceName}`);
    });
    
    // Update the UI to show selected services
    updateJobCartDisplay();
    
    // Show a notification about auto-selection
    showNotification(`Services auto-selected from ${packageInfo.name} package`, 'info');
}

// Step navigation
// currentStep moved to top
// jobCart moved to top
// selectedQuotations moved to top
const steps = document.querySelectorAll('.step');
console.log('ðŸ” Steps found on page load:', steps.length);
console.log('ðŸ” Steps elements:', steps);
console.log('ðŸ” Current step on page load:', currentStep);
showStep(currentStep);

// Removed duplicate showStep function - using enhanced version below

async function startBooking(){ 
    currentStep=2; 
    await showStep(currentStep);
}
function cancelBooking(){ window.location.href="Dashboard.html"; }
async function prevStep(){ if(currentStep>1){ currentStep--; await showStep(currentStep); } }
// Fixed nextStep function with proper validation
async function nextStep() {
    console.log('ðŸš€ðŸš€ðŸš€ NEXT BUTTON CLICKED! ðŸš€ðŸš€ðŸš€');
    console.log(`ðŸ”„ Moving from step ${currentStep} to step ${currentStep + 1}`);
    
    // Check if we can proceed
    if (currentStep >= steps.length) {
        console.log('âŒ Already at last step, cannot proceed');
        return;
    }
    
    // VALIDATE CURRENT STEP BEFORE PROCEEDING
    const isValid = validateStep(currentStep);
    if (!isValid) {
        console.log('âŒ Validation failed for step', currentStep);
        showMessage('Please complete all required fields before proceeding.', 'warning', 3000);
        return;
    }
    
    console.log('âœ… Step', currentStep, 'validation passed');
    
    // Special handling for step 6 (summary) - redirect to payment.html
    if (currentStep === 6) {
        console.log('ðŸ’³ Redirecting to payment.html for POP upload...');
        window.location.href = 'payment.html';
            return;
        }
        
    // Step-specific actions before moving to next step
    if (currentStep === 2) {
        // Create event when leaving step 2
            try {
                console.log('ðŸ“… Creating event from form data...');
                await createEventFromForm();
            console.log('âœ… Event created successfully');
            } catch (error) {
                console.error('âŒ Error creating event:', error);
                showMessage('Error creating event. Please try again.', 'error', 5000);
            return;
        }
    } else if (currentStep === 3) {
        // Ensure event exists and create job carts when leaving step 3
        if (!currentEventId && !localStorage.getItem('currentEventId')) {
            console.log('ðŸš¨ No event ID found, creating event FIRST before job carts...');
            try {
            await createEventFromForm();
            } catch (error) {
                console.error('âŒ Failed to create event:', error);
                showMessage('Failed to create event. Please try again.', 'error', 5000);
                return;
            }
            
            // Double-check that event was created
            if (!currentEventId && !localStorage.getItem('currentEventId')) {
                showMessage('Failed to create event - cannot proceed with job carts', 'error', 5000);
                return;
            }
        }
        
        console.log('âœ… Creating job carts for selected services...');
            await ensureJobCartsAreCreated();
        }
        
    // Move to next step
        currentStep++;
        console.log('âœ… Moving to step:', currentStep);
        await showStep(currentStep);
}
async function goToStep(n){ currentStep=n; await showStep(n); }

// Next button uses onclick attribute, no need for additional event listener

// Force next step function for debugging
window.forceNextStep = function() {
    console.log('ðŸš€ FORCE NEXT STEP');
    if (currentStep < steps.length) {
        currentStep++;
        console.log('Moving to step:', currentStep);
        showStep(currentStep);
    } else {
        console.log('Already at last step');
    }
};
function toggleOtherEventInput(){ 
    document.getElementById("other-event-wrapper").style.display = document.getElementById("event_type").value==="other"?"block":"none"; 
}

// Step validation
function validateStep(step){
    console.log(`ðŸ” Validating step ${step}`);
    let valid = true;
    if(step===2){
        const typeElement = document.getElementById("event_type");
        const dateElement = document.getElementById("event_date");
        const startElement = document.getElementById("start_time");
        const endElement = document.getElementById("end_time");
        const locationElement = document.getElementById("location");
        const minPriceElement = document.getElementById("min_price");
        const maxPriceElement = document.getElementById("max_price");
        
        console.log('ðŸ” Step 2 form elements found:', {
            type: !!typeElement,
            date: !!dateElement,
            start: !!startElement,
            end: !!endElement,
            location: !!locationElement,
            minPrice: !!minPriceElement,
            maxPrice: !!maxPriceElement
        });
        
        if (!typeElement || !dateElement || !startElement || !endElement || !locationElement || !minPriceElement || !maxPriceElement) {
            console.error('âŒ Step 2 validation failed - form elements not found');
            valid = false;
        } else {
            const type = (typeElement.value || '').trim();
            const date = (dateElement.value || '').trim();
            const start = (startElement.value || '').trim();
            const end = (endElement.value || '').trim();
            const location = (locationElement.value || '').trim();
            const minPrice = parseFloat((minPriceElement.value || '').trim()) || 0;
            const maxPrice = parseFloat((maxPriceElement.value || '').trim()) || 0;
            
            console.log('ðŸ” Step 2 form values:', { 
                type: type || '(empty)', 
                date: date || '(empty)', 
                start: start || '(empty)', 
                end: end || '(empty)', 
                location: location || '(empty)',
                minPrice: minPrice || '(empty)',
                maxPrice: maxPrice || '(empty)'
            });
        
        // Clear any previous location errors
        const locationError = document.getElementById('locationError');
        if (locationError) {
            locationError.textContent = '';
        }
        
        // Check each field individually and log which are missing
        const missingFields = [];
        if(!type) {
            missingFields.push('Event Type');
            valid=false;
        }
        if(!date) {
            missingFields.push('Event Date');
            valid=false;
        }
        if(!start) {
            missingFields.push('Start Time');
            valid=false;
        }
        if(!end) {
            missingFields.push('End Time');
            valid=false;
        }
        if(!location) {
            missingFields.push('Location');
            if (locationError) {
                locationError.textContent = 'Location is required';
            }
            valid = false;
        }
        if(!minPrice || minPrice <= 0) {
            missingFields.push('Minimum Price');
            valid=false;
        }
        if(!maxPrice || maxPrice <= 0) {
            missingFields.push('Maximum Price');
            valid=false;
        }
        if(minPrice > 0 && maxPrice > 0 && minPrice >= maxPrice) {
            missingFields.push('Maximum Price must be greater than Minimum Price');
            valid=false;
        }
        
        if(missingFields.length > 0) {
            console.log(`âŒ Step 2 validation failed - missing fields: ${missingFields.join(', ')}`);
        } else {
            console.log('âœ… Step 2 validation passed - all fields filled');
            // Clear any error messages when all fields are valid
            if (locationError) {
                locationError.textContent = '';
            }
        }
    }
        
        console.log(`ðŸ” Step 2 validation result: ${valid ? 'âœ… VALID' : 'âŒ INVALID'}`);
    }
    if(step===3) if(window.jobCart.length===0) valid=false;
    if(step===4) {
        valid=true; // Step 4 is waiting for quotations, always valid
        // Hide the Next button on Step 4 (Waiting for Quotations)
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
            nextBtn.style.display = 'none';
        }
    } else {
        // Show the Next button on all other steps
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
            nextBtn.style.display = 'inline-block';
        }
    }
    if(step===5) {
        // Check if quotations have been selected
        const selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
        const createdJobCarts = JSON.parse(localStorage.getItem('createdJobCarts') || '[]');
        valid = createdJobCarts.length > 0 && Object.keys(selectedQuotations).length === createdJobCarts.length;
    }
    const nextBtn = document.getElementById('nextBtn');
    nextBtn.disabled = !valid;
    console.log(`ðŸ” Next button disabled: ${!valid}`);
    return valid;
}


// Removed problematic event listeners that were causing infinite loops

// Services list - will be loaded from database (moved to top)

// Icon mapping for services
// SIMPLE ICON MAPPING
function getServiceIcon(serviceName) {
    const iconMap = {
        'Live Band': 'fa-guitar',
  'DJ': 'fa-music',
  'Makeup Artist': 'fa-face-smile',
  'Catering': 'fa-utensils',
  'Photography': 'fa-camera',
  'Decoration': 'fa-paint-roller',
  'Venue': 'fa-building',
  'Florist': 'fa-seedling',
  'Lighting': 'fa-lightbulb',
  'Sound System': 'fa-volume-high',
  'Security': 'fa-shield',
  'Transport': 'fa-car',
  'Event Planner': 'fa-calendar-check',
  'Videography': 'fa-video',
  'Bartender': 'fa-glass-martini',
  'Host/Presenter': 'fa-user-tie',
        'Cake Designer': 'fa-birthday-cake'
};
    return iconMap[serviceName] || 'fa-cog';
}

// SIMPLE, GUARANTEED SERVICE LOADING
async function loadAndDisplayServices() {
    try {
        console.log('ðŸ“¡ Attempting to load services from database...');
        
        const { data: services, error } = await sb
            .from('service')
            .select('service_id, service_name, service_type, service_description')
            .order('service_name');

        // DEBUG: See what we got
        console.log('ðŸ“Š Database response:', { 
            data: services, 
            error: error,
            count: services?.length 
        });

        if (error) {
            console.error('âŒ Database error, using fallback:', error);
            useFallbackServices();
            return;
        }

        if (!services || services.length === 0) {
            console.warn('âš ï¸ No services in database, using fallback');
            useFallbackServices();
            return;
        }

        // SUCCESS: Map the services
            servicesList = services.map(service => ({
                service_id: service.service_id,
                service_name: service.service_name,
                service_type: service.service_type,
                service_description: service.service_description,
            icon: getServiceIcon(service.service_name)
        }));

        console.log('ðŸŽ‰ Successfully loaded', servicesList.length, 'services');
        displayServicesGrid();
        
    } catch (error) {
        console.error('ðŸ’¥ Critical error:', error);
        useFallbackServices();
    }
}

// GUARANTEED FALLBACK SERVICES - SIMPLIFIED
function useFallbackServices() {
    console.log('ðŸ†˜ useFallbackServices() called - SIMPLE VERSION');
    
    // Set services immediately
    servicesList = [
        { service_id: 'fb-live-band', service_name: 'Live Band', icon: 'fa-guitar' },
        { service_id: 'fb-dj', service_name: 'DJ', icon: 'fa-music' },
        { service_id: 'fb-makeup', service_name: 'Makeup Services', icon: 'fa-face-smile' },
        { service_id: 'fb-catering', service_name: 'Catering', icon: 'fa-utensils' },
        { service_id: 'fb-photo', service_name: 'Photography', icon: 'fa-camera' },
        { service_id: 'fb-decor', service_name: 'Decoration', icon: 'fa-paint-roller' },
        { service_id: 'fb-venue', service_name: 'Venue', icon: 'fa-building' },
        { service_id: 'fb-florist', service_name: 'Florist', icon: 'fa-seedling' },
        { service_id: 'fb-lighting', service_name: 'Lighting', icon: 'fa-lightbulb' },
        { service_id: 'fb-sound', service_name: 'Sound System', icon: 'fa-volume-high' },
        { service_id: 'fb-security', service_name: 'Security', icon: 'fa-shield' },
        { service_id: 'fb-transport', service_name: 'Transport', icon: 'fa-car' },
        { service_id: 'fb-planner', service_name: 'Event Planner', icon: 'fa-calendar-check' },
        { service_id: 'fb-video', service_name: 'Videography', icon: 'fa-video' },
        { service_id: 'fb-bartender', service_name: 'Bartender', icon: 'fa-glass-martini' },
        { service_id: 'fb-host', service_name: 'Host/Presenter', icon: 'fa-user-tie' },
        { service_id: 'fb-cake', service_name: 'Cake Designer', icon: 'fa-birthday-cake' }
    ];
    
    console.log('âœ… servicesList set to', servicesList.length, 'services');
    
    // Display immediately - no delays
    displayServicesGrid();
    console.log('âœ… Services displayed immediately!');
}

// Manual service reload function
async function reloadServices() {
    console.log('ðŸ”„ Manually reloading services...');
    showMessage('Reloading services...', 'info', 2000);
    
    const statusElement = document.getElementById('services-status');
    if (statusElement) {
        statusElement.textContent = 'Reloading services...';
        statusElement.className = 'ms-3 text-info';
    }
    
    await loadAndDisplayServices();
    
    if (statusElement) {
        statusElement.textContent = `Loaded ${servicesList.length} services`;
        statusElement.className = 'ms-3 text-success';
    }
}
    
// Test hardcoded services function
function testHardcodedServices() {
    console.log('ðŸ§ª testHardcodedServices() called');
    console.log('ðŸ“Š Current servicesList:', servicesList);
    console.log('ðŸ“Š servicesList length:', servicesList ? servicesList.length : 'undefined');
    
    try {
        showMessage('Testing hardcoded services...', 'info', 2000);
        console.log('âœ… showMessage called successfully');
        
        const statusElement = document.getElementById('services-status');
        console.log('ðŸ“‹ Status element found:', statusElement);
        
        if (statusElement) {
            statusElement.textContent = 'Testing hardcoded services...';
            statusElement.className = 'ms-3 text-info';
            console.log('âœ… Status element updated');
        }
        
        console.log('ðŸ”„ About to call useFallbackServices()');
        useFallbackServices();
        console.log('âœ… useFallbackServices() completed');
        
        if (statusElement) {
            statusElement.textContent = `${servicesList.length} hardcoded services loaded`;
            statusElement.className = 'ms-3 text-success';
            console.log('âœ… Final status update completed');
        }
        
        console.log('ðŸŽ‰ testHardcodedServices() completed successfully');
        
    } catch (error) {
        console.error('âŒ Error in testHardcodedServices():', error);
        alert('Error in testHardcodedServices: ' + error.message);
    }
}

// FORCE DISPLAY SERVICES FUNCTION
function forceDisplayServices() {
    console.log('ðŸ‘ï¸ forceDisplayServices() called');
    
    // First ensure services are loaded
    console.log('ðŸ“Š Current servicesList:', servicesList);
    console.log('ðŸ“Š servicesList length:', servicesList.length);
    
    if (servicesList.length === 0) {
        console.log('âš ï¸ No services loaded, loading fallback services...');
        useFallbackServices();
    }
    
    // Force display
    console.log('ðŸ”„ Force calling displayServicesGrid()...');
    displayServicesGrid();
    console.log('âœ… Force display completed');
    
    // Update status
    const statusElement = document.getElementById('services-status');
    if (statusElement) {
        statusElement.textContent = `${servicesList.length} services force displayed`;
        statusElement.className = 'ms-3 text-success';
    }
}

// Go to Step 3 function
async function goToStep3() {
    showMessage('Navigating to Step 3...', 'info', 2000);
    
        currentStep = 3;
    await showStep(3);
    
    // Wait a moment for step to be visible, then test
    setTimeout(() => {
        console.log('âœ… Now on Step 3, testing hardcoded services...');
        testHardcodedServices();
    }, 500);
}

// SIMPLE JAVASCRIPT TEST
function testJavaScript() {
    console.log('ðŸ§ª JavaScript is working!');
    alert('JavaScript is working! This means the functions should work too.');
    
    // Test if we can access the services grid
    const container = document.getElementById('services-grid');
    if (container) {
        container.innerHTML = '<div style="background: green; color: white; padding: 20px; margin: 10px;">âœ… JavaScript Test Successful! Container found.</div>';
        console.log('âœ… Container found:', container);
    } else {
        console.error('âŒ Container not found!');
        alert('âŒ Container not found!');
    }
}

console.log('ðŸ”§ Functions defined:', {
    testJavaScript: typeof testJavaScript,
    testHardcodedServices: typeof testHardcodedServices,
    reloadServices: typeof reloadServices,
    goToStep3: typeof goToStep3,
    displayServicesGrid: typeof displayServicesGrid
});

// GUARANTEED DISPLAY FUNCTION - DON'T OVERRIDE HTML
function displayServicesGrid() {
    console.log('ðŸŽ¨ displayServicesGrid() called - CHECKING HTML FIRST');
    
    const container = document.getElementById("services-grid"); 
    console.log('ðŸ“¦ Container found:', container);
    
    if (!container) {
        console.error('âŒ CRITICAL: services-grid container not found!');
        return;
    }
    
    // Check if services are already displayed in HTML
    const existingServices = container.querySelectorAll('.service-card');
    console.log('ðŸ” Existing services in HTML:', existingServices.length);
    
    if (existingServices.length > 0) {
        console.log('âœ… Services already in HTML - NOT overriding!');
        return; // Don't override the HTML!
    }
    
    console.log('ðŸ“Š servicesList length:', servicesList ? servicesList.length : 'undefined');
    
    if (!servicesList || servicesList.length === 0) {
        console.log('âš ï¸ No services available in JavaScript, but HTML should have them');
        // Don't override HTML - let it show what's there
        return;
    }
    
    console.log('âœ… Rendering', servicesList.length, 'services from JavaScript...');
    
    // BUILD THE GRID - NO DELAYS
    const html = servicesList.map(service => {
        const isSelected = window.jobCart.some(item => item.service_id === service.service_id);
        
        return `
            <div class="service-card ${isSelected ? 'selected' : ''}" 
                 onclick="toggleService('${service.service_id}')">
            <div class="service-icon">
                <i class="fas ${service.icon} fa-3x text-primary mb-3"></i>
            </div>
            <h5 class="service-title">${service.service_name}</h5>
            <div class="service-select">
                    <div class="service-checkbox">
                        <span class="checkmark ${isSelected ? 'checked' : ''}"></span>
                    Select Service
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
    console.log('âœ… Services grid displayed from JavaScript!');
}

// Global variable to store the created event ID
let currentEventId = null;

// Create event from form data
async function createEventFromForm() {
    try {
        const clientId = localStorage.getItem('clientId') || 'test-client-id';
        
        // Get event details from form with null checks
        const eventTypeElement = document.getElementById('event_type');
        const eventDateElement = document.getElementById('event_date');
        const startTimeElement = document.getElementById('start_time');
        const endTimeElement = document.getElementById('end_time');
        const locationElement = document.getElementById('location');
        const guestCountElement = document.getElementById('guest_count');
        
        if (!eventTypeElement || !eventDateElement || !startTimeElement || !endTimeElement || !locationElement) {
            throw new Error('Required form elements not found');
        }
        
        const eventType = eventTypeElement.value;
        const eventDate = eventDateElement.value;
        const startTime = startTimeElement.value;
        const endTime = endTimeElement.value;
        const location = locationElement.value;
        const guestCount = guestCountElement ? (guestCountElement.value || 0) : 0;
        
        // Create event in database
        const { data, error } = await sb
            .from('event')
            .insert([
                {
                    event_type: eventType,
                    event_date: eventDate,
                    event_start_time: startTime,
                    event_end_time: endTime,
                    event_location: location,
                    created_at: new Date().toISOString()
                }
            ])
            .select();

        if (error) {
            console.error('âŒ Error creating event:', error);
            throw error;
        }

        if (data && data.length > 0) {
            currentEventId = data[0].event_id;
            console.log('âœ… Event created successfully with ID:', currentEventId);
            
            // Store event ID in localStorage for persistence
            localStorage.setItem('currentEventId', currentEventId);
            
            // Store event ID in booking session
            if (window.BookingSession) {
                window.BookingSession.setEventId(currentEventId, {
                    event_type: eventTypeElement.value,
                    event_date: eventDateElement.value,
                    event_location: locationElement.value,
                    event_start_time: startTimeElement.value,
                    event_end_time: endTimeElement.value
                });
            }
            
            // Update all existing job cart entries with this event_id
            await updateJobCartEntriesWithEventId(currentEventId);
            
            // Also update the global currentEventId for future job cart entries
            window.currentEventId = currentEventId;
        }
    } catch (error) {
        console.error('âŒ Error creating event from form:', error);
        throw error; // Re-throw the error so it can be handled by the caller
    }
}

// Ensure job carts are created for selected services
async function ensureJobCartsAreCreated() {
    try {
        console.log('ðŸ›’ Ensuring job carts are created for selected services...');
        
        const eventId = currentEventId || localStorage.getItem('currentEventId');
        const clientId = localStorage.getItem('clientId') || 'test-client-id';
        
        if (!eventId) {
            console.error('âŒ No event ID available for job carts');
            return;
        }

        // Create job cart records for each selected service
        const jobCartRecords = [];
        
        for (const service of jobCart) {
            // Map string service ID to actual service name
            const actualServiceName = serviceIdMapping[service.service_id] || service.service_name;
            
            // Ensure service exists in database first
            const actualServiceId = await ensureServiceExists(actualServiceName);
            
            if (!actualServiceId) {
                console.error('âŒ Could not create or find service:', actualServiceName);
                continue;
            }

            // Get service provider pricing information for this service
            let minPrice = null;
            let maxPrice = null;
            
            try {
                // Query service providers for this service to get pricing
                const { data: serviceProviders, error: spError } = await sb
                    .from('service_provider')
                    .select('service_provider_base_rate, service_provider_overtime_rate')
                    .eq('service_id', actualServiceId)
                    .not('service_provider_base_rate', 'is', null);

                if (!spError && serviceProviders && serviceProviders.length > 0) {
                    // Calculate min and max prices from available service providers
                    const baseRates = serviceProviders
                        .map(sp => sp.service_provider_base_rate)
                        .filter(rate => rate && rate > 0);
                    
                    if (baseRates.length > 0) {
                        minPrice = Math.min(...baseRates);
                        maxPrice = Math.max(...baseRates);
                        
                        // Add some buffer for overtime rates if available
                        const overtimeRates = serviceProviders
                            .map(sp => sp.service_provider_overtime_rate)
                            .filter(rate => rate && rate > 0);
                        
                        if (overtimeRates.length > 0) {
                            maxPrice += Math.max(...overtimeRates);
                        }
                    }
                }
                
                console.log(`ðŸ’° Service pricing for ${actualServiceName}: Min: ${minPrice}, Max: ${maxPrice}`);
            } catch (error) {
                console.error('âŒ Error fetching service provider pricing:', error);
            }
            
            const jobCartRecord = {
                event_id: eventId,
                client_id: clientId,
                service_id: actualServiceId,
                job_cart_status: 'pending',
                job_cart_min_price: minPrice,
                job_cart_max_price: maxPrice,
                created_at: new Date().toISOString()
            };
            
            jobCartRecords.push(jobCartRecord);
            console.log(`âœ… Created job cart record for: ${service.service_name} with pricing (${minPrice}-${maxPrice})`);
        }

        // Insert real job carts into the database
        const insertedJobCarts = [];
        
        for (const record of jobCartRecords) {
            try {
                const { data: insertedJobCart, error: insertError } = await sb
                    .from('job_cart')
                    .insert([record])
                    .select('job_cart_id')
                    .single();
                
                if (insertError) {
                    console.error('âŒ Error inserting job cart:', insertError);
                    continue;
                }
                
                insertedJobCarts.push({
                    job_cart_id: insertedJobCart.job_cart_id,
                    ...record
                });
                
                // Store job cart ID in booking session
                if (window.BookingSession) {
                    window.BookingSession.addJobCartId(
                        insertedJobCart.job_cart_id,
                        record.service_id
                    );
                }
                
                console.log(`âœ… Real job cart inserted into database: ${insertedJobCart.job_cart_id}`);
            } catch (error) {
                console.error('âŒ Error inserting job cart:', error);
            }
        }
        
        // Store real job cart IDs for the quotation process
        localStorage.setItem('createdJobCarts', JSON.stringify(insertedJobCarts.map(jc => jc.job_cart_id)));
        localStorage.setItem('jobCartDetails', JSON.stringify(insertedJobCarts));
        
        console.log('âœ… Real job carts created and inserted into database:', insertedJobCarts.length);
        
        return insertedJobCarts;
        
    } catch (error) {
        console.error('âŒ Error ensuring job carts are created:', error);
        // Create fallback job carts for demo
        const fallbackJobCarts = jobCart.map((service, index) => ({
            job_cart_id: `demo-jc-fallback-${Date.now()}-${index}`,
            event_id: currentEventId || 'event-fallback',
            client_id: 'test-client-id',
            service_id: service.service_id,
            job_cart_status: 'pending'
        }));
        
        localStorage.setItem('createdJobCarts', JSON.stringify(fallbackJobCarts.map(jc => jc.job_cart_id)));
        localStorage.setItem('jobCartDetails', JSON.stringify(fallbackJobCarts));
        
        return fallbackJobCarts;
    }
}

// Update existing job cart entries with event_id
async function updateJobCartEntriesWithEventId(eventId) {
    try {
        const clientId = localStorage.getItem('clientId') || 'test-client-id';
        
        const { error } = await sb
            .from('job_cart')
            .update({ event_id: eventId })
            .eq('client_id', clientId)
            .is('event_id', null);

        if (error) {
            console.error('âŒ Error updating job cart entries with event_id:', error);
        } else {
            console.log('âœ… Updated job cart entries with event_id:', eventId);
            
            // Trigger a refresh of the service provider dashboard if it's open
            // This will help show the updated event information immediately
            if (window.parent && window.parent !== window) {
                try {
                    window.parent.postMessage({
                        type: 'JOB_CART_UPDATED',
                        eventId: eventId
                    }, '*');
                } catch (e) {
                    console.log('Could not notify parent window of job cart update');
                }
            }
        }
    } catch (error) {
        console.error('âŒ Error updating job cart entries:', error);
    }
}

// Service ID mapping - maps string IDs to actual service names
const serviceIdMapping = {
    'fb-audio-visual': 'Audio-Visual Technician',
    'fb-bartender': 'Bartender',
    'fb-cake': 'Cake Designer',
    'fb-catering': 'Catering',
    'fb-decor': 'Decoration',
    'fb-dj': 'DJ',
    'fb-drone-photo': 'Drone Photography',
    'fb-entertainment': 'Entertainment Booking',
    'fb-insurance': 'Event Insurance / Permits',
    'fb-planner': 'Event Planner',
    'fb-fireworks': 'Fireworks / Pyrotechnics',
    'fb-florist': 'Florist',
    'fb-furniture': 'Furniture Rental',
    'fb-hair': 'Hair Styling',
    'fb-host': 'Host/Presenter',
    'fb-invitations': 'Invitation Design',
    'fb-lighting': 'Lighting',
    'fb-live-band': 'Live Band',
    'fb-makeup': 'Makeup Artist',
    'fb-mc': 'MC',
    'fb-favors': 'Party Favors / Gift Bags',
    'fb-photobooth': 'Photo Booth',
    'fb-photo': 'Photography',
    'fb-security': 'Security',
    'fb-sound': 'Sound System',
    'fb-stage': 'Stage Design',
    'fb-transport': 'Transport',
    'fb-travel': 'Travel & Accommodation',
    'fb-valet': 'Valet Parking',
    'fb-venue': 'Venue',
    'fb-video': 'Videography'
};

// Ensure service exists in database, create if not
async function ensureServiceExists(serviceName) {
    try {
        // First, check if service exists
        const { data: existingServices, error: lookupError } = await sb
            .from('service')
            .select('service_id')
            .eq('service_name', serviceName)
            .limit(1);

        if (lookupError) {
            console.error('âŒ Error looking up service:', lookupError);
            return null;
        }

        if (existingServices && existingServices.length > 0) {
            console.log('âœ… Service already exists:', serviceName, existingServices[0].service_id);
            return existingServices[0].service_id;
        }

        // Service doesn't exist, create it
        console.log('âž• Creating new service:', serviceName);
        const { data: newService, error: createError } = await sb
            .from('service')
            .insert([
                {
                    service_name: serviceName,
                    service_description: `Professional ${serviceName} services for events`,
                    service_category: 'Event Services',
                    service_status: 'active'
                }
            ])
            .select();

        if (createError) {
            console.error('âŒ Error creating service:', createError);
            return null;
        }

        if (newService && newService.length > 0) {
            console.log('âœ… Service created successfully:', serviceName, newService[0].service_id);
            return newService[0].service_id;
        }

        return null;
    } catch (error) {
        console.error('âŒ Error ensuring service exists:', error);
        return null;
    }
}

// Create job cart entry in database
async function createJobCartInDatabase(serviceId, serviceName) {
    try {
        const clientId = localStorage.getItem('clientId') || 'test-client-id';
        
        // Map string service ID to actual service name
        const actualServiceName = serviceIdMapping[serviceId] || serviceName;
        
        // Ensure service exists in database first
        const actualServiceId = await ensureServiceExists(actualServiceName);
        
        if (!actualServiceId) {
            console.error('âŒ Could not create or find service:', actualServiceName);
            return;
        }
        
        // Get event ID from multiple sources - ensure we get the latest value
        const eventId = currentEventId || localStorage.getItem('currentEventId') || window.currentEventId || null;
        console.log('ðŸ”— Creating job cart with event_id:', eventId, 'for service:', actualServiceName);
        
        if (!eventId) {
            console.error('âŒ No event_id available for job cart creation');
            return;
        }
        
        // Get budget data for this service if available
        const budgetData = getServiceBudget(serviceId);
        
        const { data, error } = await sb
            .from('job_cart')
            .insert([
                {
                    service_id: actualServiceId, // Use the actual UUID from service table
                    client_id: clientId,
                    event_id: eventId, // Use event ID from any available source
                    job_cart_status: 'pending',
                    job_cart_min_price: budgetData.minPrice,
                    job_cart_max_price: budgetData.maxPrice,
                    created_at: new Date().toISOString()
                }
            ])
            .select();

        if (error) {
            console.error('âŒ Error creating job cart entry:', error);
        } else {
            console.log('âœ… Job cart entry created for service:', actualServiceName, 'with UUID:', actualServiceId);
        }
    } catch (error) {
        console.error('âŒ Error creating job cart entry:', error);
    }
}

// Remove job cart entry from database
async function removeJobCartFromDatabase(serviceId, serviceName) {
    try {
        const clientId = localStorage.getItem('clientId') || 'test-client-id';
        
        // Map string service ID to actual service name
        const actualServiceName = serviceIdMapping[serviceId] || serviceName;
        
        // Ensure service exists in database first
        const actualServiceId = await ensureServiceExists(actualServiceName);
        
        if (!actualServiceId) {
            console.error('âŒ Could not create or find service for removal:', actualServiceName);
            return;
        }
        
        const { error } = await sb
            .from('job_cart')
            .delete()
            .eq('service_id', actualServiceId)
            .eq('client_id', clientId);

        if (error) {
            console.error('âŒ Error removing job cart entry:', error);
        } else {
            console.log('âœ… Job cart entry removed for service:', actualServiceName);
        }
    } catch (error) {
        console.error('âŒ Error removing job cart entry:', error);
    }
}

// SIMPLE SERVICE TOGGLE - WORKS WITH HTML DIRECTLY
async function toggleService(serviceId) {
    console.log('ðŸ”„ toggleService called with serviceId:', serviceId);
    console.log('ðŸ“Š Current jobCart:', window.jobCart);
    
    // Find the service card element
    const serviceCard = document.querySelector(`[onclick="toggleService('${serviceId}')"]`);
    if (!serviceCard) {
        console.error('âŒ Service card not found for ID:', serviceId);
        return;
    }
    
    const existingIndex = window.jobCart.findIndex(item => item.service_id === serviceId);
    console.log('ðŸ” Existing index:', existingIndex);
    
    if (existingIndex >= 0) {
        // Remove from cart
        console.log('âž– Removing service from cart');
        const removedService = window.jobCart[existingIndex];
        window.jobCart.splice(existingIndex, 1);
        
        // Remove from database
        removeJobCartFromDatabase(removedService.service_id, removedService.service_name);
        
        // Update visual state
        serviceCard.classList.remove('selected');
        const checkmark = serviceCard.querySelector('.checkmark');
        if (checkmark) {
            checkmark.classList.remove('checked');
        }
        
    } else {
        // Add to cart
        console.log('âž• Adding service to cart');
        
        // Find service name from the card
        const serviceNameElement = serviceCard.querySelector('.service-title');
        const serviceName = serviceNameElement ? serviceNameElement.textContent : 'Unknown Service';
        
        // Add to local cart
        window.jobCart.push({
            service_id: serviceId,
            service_name: serviceName
        });
        
        // Ensure event exists before creating job cart
        if (!currentEventId && !localStorage.getItem('currentEventId')) {
            console.log('âš ï¸ No event ID found, creating event first...');
            await createEventFromForm();
            
            // Double-check that event was created and get the event_id
            const eventId = currentEventId || localStorage.getItem('currentEventId');
            if (!eventId) {
                console.error('âŒ Event creation failed - cannot create job cart');
                return;
            }
            console.log('âœ… Event created successfully, event_id:', eventId);
        }
        
        // Create job cart entry in database
        await createJobCartInDatabase(serviceId, serviceName);
        
        // Update visual state
        serviceCard.classList.add('selected');
        const checkmark = serviceCard.querySelector('.checkmark');
        if (checkmark) {
            checkmark.classList.add('checked');
        }
    }
    
    console.log('ðŸ“Š Updated jobCart:', window.jobCart);
    
    // Update the budget section
    updateServiceBudgetSection();
    
    // Update cart UI and validation
    updateCartUI();
    validateStep(3);
    
    console.log('âœ… toggleService completed');
}

// Update the service budget section based on selected services
function updateServiceBudgetSection() {
    const budgetSection = document.getElementById('selected-services-budget');
    const budgetInputs = document.getElementById('service-budget-inputs');
    
    if (!budgetSection || !budgetInputs) {
        console.error('âŒ Budget section elements not found');
        return;
    }
    
    // Show/hide section based on selected services
    if (window.jobCart && window.jobCart.length > 0) {
        budgetSection.style.display = 'block';
        
        // Clear existing inputs
        budgetInputs.innerHTML = '';
        
        // Create budget inputs for each selected service
        window.jobCart.forEach((service, index) => {
            const serviceBudgetDiv = document.createElement('div');
            serviceBudgetDiv.className = 'service-budget-item mb-3 p-3 border rounded';
            serviceBudgetDiv.style.backgroundColor = '#fff';
            
            serviceBudgetDiv.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h6 class="mb-0 text-primary">
                            <i class="fas fa-cog me-2"></i>${service.service_name}
                        </h6>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Min Budget (R)</label>
                        <input type="number" 
                               class="form-control form-control-sm" 
                               id="budget_min_${service.service_id}" 
                               placeholder="Min Price"
                               min="0"
                               step="0.01"
                               onchange="updateJobCartBudget('${service.service_id}')">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Max Budget (R)</label>
                        <input type="number" 
                               class="form-control form-control-sm" 
                               id="budget_max_${service.service_id}" 
                               placeholder="Max Price"
                               min="0"
                               step="0.01"
                               onchange="updateJobCartBudget('${service.service_id}')">
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="button" 
                                class="btn btn-outline-danger btn-sm" 
                                onclick="removeServiceBudget('${service.service_id}')"
                                title="Remove budget for this service">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            budgetInputs.appendChild(serviceBudgetDiv);
        });
        
        console.log('âœ… Budget section updated for', window.jobCart.length, 'services');
    } else {
        budgetSection.style.display = 'none';
        console.log('ðŸ“Š No services selected, hiding budget section');
    }
    
}

// Real-time budget validation
// Budget validation removed - simplified approach

// Remove service budget (this will also remove the service from selection)
function removeServiceBudget(serviceId) {
    console.log('ðŸ—‘ï¸ Removing service budget for:', serviceId);
    
    // Find and trigger the service card to remove it
    const serviceCard = document.querySelector(`[onclick="toggleService('${serviceId}')"]`);
    if (serviceCard) {
        toggleService(serviceId);
    }
}

// Get budget data for a specific service
function getServiceBudget(serviceId) {
    const minInput = document.getElementById(`budget_min_${serviceId}`);
    const maxInput = document.getElementById(`budget_max_${serviceId}`);
    
    return {
        minPrice: minInput ? parseFloat(minInput.value) || 0 : 0,
        maxPrice: maxInput ? parseFloat(maxInput.value) || 0 : 0
    };
}

// Get all budget data for selected services
function getAllServiceBudgets() {
    const budgets = {};
    
    if (window.jobCart && window.jobCart.length > 0) {
        window.jobCart.forEach(service => {
            budgets[service.service_id] = getServiceBudget(service.service_id);
        });
    }
    
    return budgets;
}

// Update job cart budget in database
async function updateJobCartBudget(serviceId) {
    try {
        const budgetData = getServiceBudget(serviceId);
        
        // Get the actual service ID from the mapping
        const actualServiceName = serviceIdMapping[serviceId];
        if (!actualServiceName) {
            console.error('âŒ Service mapping not found for:', serviceId);
            return;
        }
        
        const actualServiceId = await ensureServiceExists(actualServiceName);
        if (!actualServiceId) {
            console.error('âŒ Could not find service ID for:', actualServiceName);
            return;
        }
        
        const clientId = localStorage.getItem('clientId') || 'test-client-id';
        const eventId = currentEventId || localStorage.getItem('currentEventId');
        
        if (!eventId) {
            console.error('âŒ No event ID available for budget update');
            return;
        }
        
        // Update the job cart with budget information
        const { error } = await sb
            .from('job_cart')
            .update({
                job_cart_min_price: budgetData.minPrice,
                job_cart_max_price: budgetData.maxPrice
            })
            .eq('service_id', actualServiceId)
            .eq('client_id', clientId)
            .eq('event_id', eventId);
        
        if (error) {
            console.error('âŒ Error updating job cart budget:', error);
        } else {
            console.log('âœ… Job cart budget updated for service:', actualServiceName, 'Budget:', budgetData);
        }
        
    } catch (error) {
        console.error('âŒ Error updating job cart budget:', error);
    }
}

// Enhanced step navigation
// Enhanced step navigation with proper timer and quotation flow
async function showStep(n) {
    console.log('ðŸŽ¯ SHOWSTEP CALLED with n:', n);
    console.log('ðŸŽ¯ Current step before change:', currentStep);
    
    // Hide all steps first
    steps.forEach((s, i) => {
        const isActive = i === n - 1;
        s.classList.toggle('active', isActive);
        s.style.display = isActive ? 'block' : 'none';
        console.log(`ðŸŽ¯ Step ${i + 1}: active=${isActive}, display=${isActive ? 'block' : 'none'}`);
    });
    
    document.getElementById('prevBtn').style.display = n === 1 ? 'none' : 'inline-block';
    document.getElementById('nextBtn').style.display = (n === 1 || n >= steps.length) ? 'none' : 'inline-block';
    
    // Step-specific logic
    if (n === 2) {
        console.log('ðŸ“‹ Step 2: Event details form');
        // Trigger validation immediately when showing step 2 to set Next button state
        setTimeout(() => validateStep(2), 100);
    } else if (n === 3) {
        console.log('ðŸ“‹ Step 3: Services selection');
        displayServicesGrid();
        // Trigger validation for step 3
        setTimeout(() => validateStep(3), 100);
    } else if (n === 4) {
        console.log('â° Step 4: Starting timer for quotations');
        initializeWaitingInterface();
    } else if (n === 5) {
        console.log('ðŸ“‹ Step 5: Loading service-based quotations...');
        
        // Show loading state
        const quotationsList = document.getElementById('quotations-list');
        if (quotationsList) {
            quotationsList.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                    <h4>Loading Available Providers...</h4>
                    <p class="text-muted">Finding the best service providers for your selected services</p>
                </div>
            `;
        }
        
        // Load quotations based on services (not job carts)
        setTimeout(async () => {
            await loadRealQuotationsForServices();
            renderDynamicQuotations();
        }, 1000);
    } else if (n === 6) {
        console.log('ðŸ“Š Step 6: Loading summary data...');
        loadSummaryData();
    }
    
    // Ensure the page is scrolled to the top when showing a new step
    window.scrollTo(0, 0);
    
    // Update current step
    currentStep = n;
    console.log('ðŸŽ¯ Current step after change:', currentStep);
    
    // Validate the step after showing it
    validateStep(n);
}

// Removed duplicate validateStep function
function updateCartUI(){
    document.getElementById("cart-count").innerText = window.jobCart.length;
    const list = document.getElementById("cart-items"); list.innerHTML = "";
    if(window.jobCart.length===0){ 
        const li=document.createElement("li"); li.innerText="Cart is empty"; list.appendChild(li);
    } else { 
        window.jobCart.forEach(item=>{
            const li=document.createElement("li"); li.innerText=item.service_name; list.appendChild(li);
        });
    }
}

// Sample providers with location information
const sampleProviders = [
    {
        name:"Alice", 
        surname:"Mokoena", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"Rose Street", 
        houseNo:"12", 
        postalCode:"2001", 
        contact:"0821234567", 
        email:"alice@example.com",
        location:"12 Rose Street, Johannesburg, Gauteng, 2001",
        rating: 4.8
    },
    {
        name:"Thabo", 
        surname:"Dlamini", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"Oak Avenue", 
        houseNo:"34", 
        postalCode:"2002", 
        contact:"0822345678", 
        email:"thabo@example.com",
        location:"34 Oak Avenue, Johannesburg, Gauteng, 2002",
        rating: 4.6
    },
    {
        name:"Sipho", 
        surname:"Nkosi", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"Maple Lane", 
        houseNo:"56", 
        postalCode:"2003", 
        contact:"0833456789", 
        email:"sipho@example.com",
        location:"56 Maple Lane, Johannesburg, Gauteng, 2003",
        rating: 4.9
    },
    {
        name:"Lindiwe", 
        surname:"Mthembu", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"King Road", 
        houseNo:"78", 
        postalCode:"2004", 
        contact:"0844567890", 
        email:"lindiwe@example.com",
        location:"78 King Road, Johannesburg, Gauteng, 2004",
        rating: 4.7
    },
    {
        name:"Mandla", 
        surname:"Khumalo", 
        city:"Pretoria", 
        province:"Gauteng", 
        street:"Church Street", 
        houseNo:"45", 
        postalCode:"0002", 
        contact:"0855678901", 
        email:"mandla@example.com",
        location:"45 Church Street, Pretoria, Gauteng, 0002",
        rating: 4.5
    },
    {
        name:"Nomsa", 
        surname:"Mthembu", 
        city:"Sandton", 
        province:"Gauteng", 
        street:"Rivonia Road", 
        houseNo:"123", 
        postalCode:"2196", 
        contact:"0866789012", 
        email:"nomsa@example.com",
        location:"123 Rivonia Road, Sandton, Gauteng, 2196",
        rating: 4.8
    }
];

// Load quotations with proper filtering and 30-minute notification
function loadQuotations(){
    const container = document.getElementById("quotations-container");
    const waitMessage = document.getElementById("quotation-wait-message");
    if(window.jobCart.length===0){ container.innerHTML="<p>No services selected.</p>"; waitMessage.style.display="none"; return; }
    
    // Show notification about 30-minute quotation process
    waitMessage.style.display="block"; 
    waitMessage.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Quotation Process:</strong> Service providers have 30 minutes to review your job cart and submit their quotations. 
            You'll receive an email notification once all quotations are ready.
        </div>
        <p class="text-center">Filtering service providers based on your requirements...</p>
    `;
    
    // Show quotations immediately with proper filtering
    setTimeout(() => {
        waitMessage.style.display="none";
        showQuotations(container);
    }, 2000); // 2 second delay to show the message
}

// Display quotations with location-based matching
async function showQuotations(container){
    container.innerHTML="";
    
    // Get client location
    const clientLocation = document.getElementById("location").value.trim();
    let locationInfo = "";
    
    if (clientLocation && window.locationService) {
        try {
            // Initialize location service if not already done
            if (!window.locationService.geocoder) {
                await window.locationService.initialize();
            }
            
            // Try to geocode the client location for distance calculations
            const clientCoords = await window.locationService.geocodeAddress(clientLocation);
            locationInfo = `ðŸ“ ${clientCoords.address}`;
        } catch (error) {
            console.warn("Could not geocode client location:", error);
            locationInfo = `ðŸ“ ${clientLocation}`;
        }
    }

    // Load quotations for each service in the cart
    for (const item of jobCart) {
        await loadQuotationsForService(item, container, clientLocation, locationInfo);
    }
}

// Filter service providers based on availability, time, price, and location
async function filterServiceProviders(providers, eventDate, startTime, endTime, minPrice, maxPrice, clientLocation) {
    const filteredProviders = [];
    
    for (const provider of providers) {
        let isAvailable = true;
        const reasons = [];
        
        // 1. Check if provider's base price falls within client's range
        const providerBasePrice = parseFloat(provider.service_provider_base_price) || 0;
        if (providerBasePrice < minPrice || providerBasePrice > maxPrice) {
            isAvailable = false;
            reasons.push(`Price range (R${providerBasePrice}) outside client range (R${minPrice}-R${maxPrice})`);
        }
        
        // 2. Check day availability (if event date is provided)
        if (eventDate) {
            const eventDay = new Date(eventDate).getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[eventDay];
            
            // Check if provider is available on this day
            // This would need to be implemented based on your availability schema
            // For now, we'll assume all providers are available on weekends (Saturday, Sunday)
            if (eventDay !== 0 && eventDay !== 6) { // Not weekend
                // You could add logic here to check provider's weekday availability
                // For example: if (!provider.weekday_available) { isAvailable = false; }
            }
        }
        
        // 3. Check operating hours (if time is provided)
        if (startTime && endTime) {
            const startHour = parseInt(startTime.split(':')[0]);
            const endHour = parseInt(endTime.split(':')[0]);
            
            // Assume providers operate 8 AM to 10 PM (you can customize this)
            const operatingStart = 8;
            const operatingEnd = 22;
            
            if (startHour < operatingStart || endHour > operatingEnd) {
                isAvailable = false;
                reasons.push(`Event time (${startTime}-${endTime}) outside operating hours (${operatingStart}:00-${operatingEnd}:00)`);
            }
        }
        
        // 4. Check location proximity (if location is provided)
        if (clientLocation && provider.service_provider_location) {
            // Calculate distance between client and provider locations
            // This is a simplified version - you'd use proper geocoding in production
            const distance = calculateDistance(clientLocation, provider.service_provider_location);
            const maxDistance = 50; // 50km radius
            
            if (distance > maxDistance) {
                isAvailable = false;
                reasons.push(`Location too far (${distance.toFixed(1)}km > ${maxDistance}km)`);
            }
        }
        
        // 5. Check if provider is verified and active
        if (!provider.service_provider_verification) {
            isAvailable = false;
            reasons.push('Provider not verified');
        }
        
        if (isAvailable) {
            filteredProviders.push(provider);
        } else {
            console.log(`Provider ${provider.service_provider_name} filtered out: ${reasons.join(', ')}`);
        }
    }
    
    // Sort by rating (highest first) and then by price (lowest first)
    return filteredProviders.sort((a, b) => {
        const ratingA = parseFloat(a.service_provider_rating) || 0;
        const ratingB = parseFloat(b.service_provider_rating) || 0;
        const priceA = parseFloat(a.service_provider_base_price) || 0;
        const priceB = parseFloat(b.service_provider_base_price) || 0;
        
        if (ratingA !== ratingB) {
            return ratingB - ratingA; // Higher rating first
        }
        return priceA - priceB; // Lower price first
    });
}

// Simple distance calculation (you should use proper geocoding in production)
function calculateDistance(location1, location2) {
    // This is a simplified distance calculation
    // In production, you'd use Google Maps API or similar
    return Math.floor(Math.random() * 30) + 1; // 1-30 km for demo
}

// Load quotations for a specific service from database
async function loadQuotationsForService(serviceItem, container, clientLocation, locationInfo) {
    try {
        // Find the service in our loaded services list to get the service_id
        const service = servicesList.find(s => s.service_name === serviceItem.service_name);
        if (!service) {
            console.warn('Service not found:', serviceItem.service_name);
            return;
        }

        // Get service providers for this specific service
        const { data: serviceProviders, error } = await sb
            .from('service_provider')
            .select('*')
            .eq('service_id', service.service_id)
            .eq('service_provider_verification', true); // Only verified providers

        if (error) {
            console.error('Error loading service providers:', error);
            return;
        }

        if (!serviceProviders || serviceProviders.length === 0) {
            // Show message if no providers found for this service
            const noProvidersCard = document.createElement("div");
            noProvidersCard.className = "quotation-card";
            noProvidersCard.innerHTML = `
                <div class="quotation-header">
                    <span class="service-name">${serviceItem.service_name}</span>
                    <span class="provider-info">No providers available</span>
                </div>
                <div class="quotation-details">
                    <div class="rating">No verified providers found for this service</div>
                </div>
            `;
            container.appendChild(noProvidersCard);
            return;
        }

        // Get client requirements for filtering
        const eventDate = document.getElementById("date").value;
        const startTime = document.getElementById("start_time").value;
        const endTime = document.getElementById("end_time").value;
        const minPrice = parseInt(document.getElementById("min_price").value) || 500;
        const maxPrice = parseInt(document.getElementById("max_price").value) || 5000;
        
        // Filter service providers based on requirements
        const filteredProviders = await filterServiceProviders(
            serviceProviders, 
            eventDate, 
            startTime, 
            endTime, 
            minPrice, 
            maxPrice, 
            clientLocation
        );
        
        // Show up to 3 quotations for this service
        const providersToShow = filteredProviders.slice(0, 3);
        
        providersToShow.forEach(provider => {
            const price = Math.floor(Math.random()*(maxPrice-minPrice+1))+minPrice;
            const quotationID = `Q${Math.floor(Math.random()*10000)}`;
            const jobCartID = `JC${Math.floor(Math.random()*1000)}`;
            const submissionDate = new Date();
            
            // Calculate distance if location is available
            let distanceInfo = "";
            if (clientLocation && provider.service_provider_location) {
                // Simulate distance calculation (in real implementation, use locationService.calculateDistance)
                const distance = Math.floor(Math.random() * 25) + 1; // 1-25 km
                distanceInfo = ` | ðŸ“ ${distance}km away`;
            }
            
            const card = document.createElement("div"); 
            card.className = "quotation-card"; 
            card.innerHTML = `
                <div class="quotation-header">
                    <span class="service-name">${serviceItem.service_name} - R${price}</span>
                    <span class="provider-info">${provider.service_provider_name} ${provider.service_provider_surname}${distanceInfo}</span>
                </div>
                <div class="quotation-details">
                    <div class="rating">â­ ${provider.service_provider_rating || 5}/5</div>
                    <div class="location-info">${locationInfo}</div>
                </div>
            `;
            
            const acceptBtn = document.createElement("button"); 
            acceptBtn.innerText="Accept";
            acceptBtn.className = "btn-accept";
            
            const rejectBtn = document.createElement("button"); 
            rejectBtn.innerText="Reject";
            rejectBtn.className = "btn-reject";
            
            const viewBtn = document.createElement("button"); 
            viewBtn.innerText="View Details";
            viewBtn.className = "btn-view";

            acceptBtn.onclick = () => {
                selectedQuotations[serviceItem.service_id] = {
                    service_name: serviceItem.service_name, 
                    service_id: service.service_id,
                    price, 
                    provider: provider, 
                    quotationID, 
                    jobCartID, 
                    submissionDate,
                    distance: distanceInfo
                };
                calculateTotal();
                const allCards = Array.from(container.querySelectorAll('.quotation-card'));
                allCards.forEach(c=>{
                    const serviceName = c.querySelector('.service-name');
                    const btns = c.querySelectorAll('button');
                    if(serviceName && serviceName.innerText.startsWith(serviceItem.service_name)){
                        if(c===card){ 
                            c.classList.add("accepted"); 
                            rejectBtn.disabled=true; 
                            viewBtn.disabled=true;
                        } else { 
                            c.classList.add("rejected"); 
                            btns.forEach(b=>b.disabled=true); 
                        }
                    }
                });
                validateStep(4);
            };
            
            rejectBtn.onclick = () => { 
                card.classList.add("rejected"); 
                acceptBtn.disabled=true; 
                viewBtn.disabled=true;
                validateStep(4); 
            };
            
            viewBtn.onclick = () => generatePDF({
                service_name: serviceItem.service_name, 
                service_id: service.service_id,
                price, 
                provider: provider, 
                quotationID, 
                jobCartID, 
                submissionDate,
                distance: distanceInfo
            });

            const buttonContainer = document.createElement("div");
            buttonContainer.className = "quotation-buttons";
            buttonContainer.appendChild(acceptBtn); 
            buttonContainer.appendChild(rejectBtn); 
            buttonContainer.appendChild(viewBtn);
            
            card.appendChild(buttonContainer);
            container.appendChild(card);
    });
    } catch (error) {
        console.error('Error loading quotations for service:', error);
    }
}

// Calculate totals
function calculateTotal(){
    let total = 0;
    for(const key in selectedQuotations) total += selectedQuotations[key].price;
    document.getElementById("cart-total").innerText = `Total: R${total}`;
    document.getElementById("cart-accepted-total").innerText = `Accepted quotations total: R${total}`;
}

// Load summary
function loadSummary(){
    const container=document.getElementById("summary-container"); container.innerHTML="";
    if(Object.keys(selectedQuotations).length===0){ container.innerHTML="<p>No quotations accepted yet.</p>"; return; }
    const totalAmount=Object.values(selectedQuotations).reduce((sum,q)=>sum+q.price,0);
    Object.values(selectedQuotations).forEach(q=>{
        const div=document.createElement("div"); div.className="summary-card"; 
        div.innerHTML=`
            <p><strong>Service:</strong> ${q.service_name}</p>
            <p><strong>Price:</strong> R${q.price}</p>
            <p><strong>Provider Name:</strong> ${q.provider.name} ${q.provider.surname}</p>
            <p><strong>Contact:</strong> ${q.provider.contact}</p>
            <p><strong>Email:</strong> ${q.provider.email||''}</p>
            <p><strong>Address:</strong> ${q.provider.houseNo}, ${q.provider.street}, ${q.provider.city}, ${q.provider.province}, ${q.provider.postalCode}</p>
            <button class="pdf-btn">View PDF</button>
        `;
        container.appendChild(div);
        div.querySelector(".pdf-btn").onclick=()=>generatePDF(q);
    });
    const totalEl=document.createElement("p"); totalEl.innerHTML=`<strong>Total: R${totalAmount}</strong>`; container.appendChild(totalEl);
}

// Generate PDF
function generatePDF(quotation){
    const { service_name, price, provider, quotationID, jobCartID, submissionDate }=quotation;
    const doc = new jspdf.jsPDF();
    doc.setFontSize(18); doc.text("Quotation Details",14,20);
    doc.setFontSize(12);
    doc.text(`Quotation ID: ${quotationID}`,14,30);
    doc.text(`Job Cart ID: ${jobCartID}`,14,37);
    doc.text(`Submission Date: ${submissionDate.toLocaleString()}`,14,44);
    doc.text(`Service: ${service_name}`,14,55);
    doc.text(`Price: R${price}`,14,62);
    doc.text("Provider Information:",14,74);
    doc.text(`Name: ${provider.name} ${provider.surname}`,14,81);
    doc.text(`Contact: ${provider.contact}`,14,88);
    doc.text(`Email: ${provider.email||''}`,14,95);
    doc.text(`Address: ${provider.houseNo}, ${provider.street}, ${provider.city}, ${provider.province}, ${provider.postalCode}`,14,102);
    doc.save(`${service_name}_Quotation.pdf`);
}

// Confirm booking

async function confirmBooking() {
    if (Object.keys(selectedQuotations).length === 0) {
        alert("Please accept at least one quotation before continuing.");
        return;
    }

    const totalAmount = Object.values(selectedQuotations).reduce((sum, q) => sum + q.price, 0);
    localStorage.setItem("totalAmount", totalAmount);

    try {
        const clientId = localStorage.getItem('clientId') || 'test-client-id';
        
        // Use the existing event ID if available, otherwise create a new event
        let eventId = currentEventId;
        
        if (!eventId) {
        // 1ï¸âƒ£ Insert event first (matching actual schema)
        const { data: eventData, error: eventError } = await sb.from('event').insert({
            event_type: document.getElementById('event_type').value,
            event_date: document.getElementById('event_date').value,
            event_start_time: document.getElementById('start_time').value,
            event_end_time: document.getElementById('end_time').value,
                event_location: document.getElementById('location').value
        }).select();

        if (eventError) {
            console.error('âŒ Event creation failed:', eventError);
            throw new Error(`Event creation failed: ${eventError.message}`);
        }
        
            eventId = eventData[0].event_id;
            currentEventId = eventId;
        console.log('âœ… Event created successfully with ID:', eventId);
        } else {
            console.log('âœ… Using existing event ID:', eventId);
        }

        // 2ï¸âƒ£ Insert booking linked to the event (matching actual schema)
        const bookingLocation = document.getElementById('location').value.trim();
        console.log('ðŸ“ Booking location:', bookingLocation);
        
        const { data: bookingData, error: bookingError } = await sb.from('booking').insert({
            client_id: clientId,
            event_id: eventId, // now valid
            booking_date: document.getElementById('event_date').value, // Use event date as booking date
            booking_start_time: document.getElementById('start_time').value,
            booking_end_time: document.getElementById('end_time').value,
            booking_min_price: parseFloat(document.getElementById('min_price').value) || 0,
            booking_max_price: parseFloat(document.getElementById('max_price').value) || 0,
            booking_special_request: document.getElementById('special_requests').value || '',
            booking_status: 'pending',
            booking_total_price: totalAmount
        }).select();

        if (bookingError) {
            console.error('âŒ Booking creation failed:', bookingError);
            throw new Error(`Booking creation failed: ${bookingError.message}`);
        }
        
        const bookingId = bookingData[0].booking_id;
        console.log('âœ… Booking created successfully with ID:', bookingId);
        
        // Store booking ID for later reference
        localStorage.setItem('currentBookingId', bookingId);

        // 3ï¸âƒ£ Create job carts for ALL service providers of each selected service
        // Multiple service providers can accept the same job cart (not first-come-first-served)
        const jobCartRecords = [];
        
        for (const quotation of Object.values(selectedQuotations)) {
            // Get ALL service providers for this service type
            const { data: serviceProviders, error: providersError } = await sb
                .from('service_provider')
                .select('service_provider_id, service_id, service_provider_name, service_provider_surname')
                .eq('service_id', quotation.service_id)
                .eq('service_provider_verification', true);

            if (providersError) {
                console.error('Error fetching service providers:', providersError);
                continue;
            }

            // Create ONE job cart for this service, but make it available to ALL providers
            const eventType = document.getElementById('event_type').value;
            const eventDate = document.getElementById('event_date').value;
            const eventLocation = bookingLocation;
            
            const jobCartRecord = {
                event_id: eventId,
                client_id: clientId,  // âœ… Link to client table
                service_id: quotation.service_id,  // âœ… Link to service table
                job_cart_status: 'pending' // Use 'pending' to match schema default
            };
            
            jobCartRecords.push(jobCartRecord);
            console.log(`âœ… Created job cart for service_id: ${quotation.service_id} (${quotation.service_name})`);
        }

        if (jobCartRecords.length > 0) {
            const { data: jobCartData, error: jobCartError } = await sb
                .from('job_cart')
                .insert(jobCartRecords)
                .select();

            if (jobCartError) throw new Error(jobCartError.message);
            console.log('âœ… Job carts created for all service providers:', jobCartData.length);
            
            // Store job cart IDs for later reference
            localStorage.setItem('createdJobCarts', JSON.stringify(jobCartData.map(jc => jc.job_cart_id)));
        }

        // 4ï¸âƒ£ Update quotations with booking_id and mark as accepted
        const quotationUpdates = Object.values(selectedQuotations).map(quotation => ({
            quotation_id: quotation.quotation_id,
            booking_id: bookingId, // Link quotation to booking
            quotation_status: 'accepted'
        }));

        for (const update of quotationUpdates) {
            const { error: quotationUpdateError } = await sb
                .from('quotation')
                .update({ 
                    booking_id: update.booking_id,
                    quotation_status: update.quotation_status 
                })
                .eq('quotation_id', update.quotation_id);

            if (quotationUpdateError) {
                console.error('âŒ Error updating quotation:', quotationUpdateError);
            } else {
                console.log('âœ… Updated quotation with booking_id:', update.quotation_id);
            }
        }

        // 5ï¸âƒ£ Insert event_service junction records for selected services
        const eventServiceRecords = Object.values(selectedQuotations).map(quotation => ({
            event_id: eventId,
            service_id: quotation.service_id,
            event_service_notes: `Selected service: ${quotation.service_name}`,
            event_service_status: 'confirmed'
        }));

        if (eventServiceRecords.length > 0) {
            const { data: eventServiceData, error: eventServiceError } = await sb
                .from('event_service')
                .insert(eventServiceRecords)
                .select();

            if (eventServiceError) throw new Error(eventServiceError.message);
            console.log('âœ… Event-service links created:', eventServiceData.length);
        }

        // âœ… Show confirmation and go to waiting step
        const msg = document.getElementById('redirect-message');
        msg.innerText = "Booking confirmed! Generating quotations...";
        msg.style.display = 'block';
        document.getElementById("confirm-booking").disabled = true;

        setTimeout(() => {
            currentStep = 4;
            showStep(currentStep);
            initializeWaitingInterface();
        }, 2000);

    } catch (error) {
        alert("Booking failed: " + error.message);
    }
}

// Initialize waiting interface with timer
// FIXED: Enhanced timer initialization
function initializeWaitingInterface() {
    console.log('â° INITIALIZE WAITING INTERFACE - Starting timer and quotation process...');
    
    // Reset and show the waiting step properly
    const step4 = document.getElementById('step-4');
    if (step4) {
        step4.style.display = 'block';
    }
    
    // Hide the Next button on Step 4 (Waiting for Quotations)
    const nextBtn = document.getElementById('nextBtn');
    if (nextBtn) {
        nextBtn.style.display = 'none';
        console.log('ðŸš« Next button hidden on Step 4 (Waiting for Quotations)');
    }
    
    // Reset timer elements to initial state
    document.getElementById('countdown-display').textContent = '01:00';
    document.getElementById('elapsed-time').textContent = '00:00';
    document.getElementById('remaining-time').textContent = '01:00';
    document.getElementById('progress-percent').textContent = '0%';
    document.getElementById('quotation-progress').style.width = '0%';
    
    // Reset status message
    document.getElementById('quotations-status').innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>What's happening:</strong> Service providers are currently:
            <ul class="mb-0 mt-2">
                <li>Reviewing your job cart</li>
                <li>Preparing their quotations with pricing</li>
            </ul>
            You'll be notified once quotations are ready for review.
        </div>
    `;
    
    // Reset and disable view button
    const viewBtn = document.getElementById('viewQuotationsBtn');
    if (viewBtn) {
        viewBtn.disabled = true;
        viewBtn.innerHTML = '<i class="fas fa-hourglass-half me-2"></i>Waiting for Quotations...';
        viewBtn.classList.remove('btn-primary');
        viewBtn.classList.add('btn-success');
        // Set the onclick handler
        viewBtn.onclick = function() {
            console.log('ðŸ‘€ View quotations clicked, going to step 5...');
            goToStep(5);
        };
    }
    
    // Start the timer immediately
    console.log('â° Starting timer immediately...');
    startEnhancedTimer();
    
    // Demo quotation generation removed - only real quotations from database
}

// Enhanced timer function
function startEnhancedTimer() {
    console.log('â° START ENHANCED TIMER - Starting countdown...');
    
    const timerDuration = 2 * 60 * 1000; // 2 minutes for demo
    const startTime = new Date().getTime();
    const endTime = startTime + timerDuration;
    
    // Update immediately
    updateEnhancedTimerDisplay();
    
    // Update every second
    const timerInterval = setInterval(updateEnhancedTimerDisplay, 1000);
    
    function updateEnhancedTimerDisplay() {
        const now = new Date().getTime();
        const remaining = Math.max(0, endTime - now);
        const elapsed = timerDuration - remaining;
        
        // Update countdown (MM:SS format)
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        document.getElementById('countdown-display').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        // Update elapsed time
        const elapsedMinutes = Math.floor(elapsed / 60000);
        const elapsedSeconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('elapsed-time').textContent = 
            `${String(elapsedMinutes).padStart(2, '0')}:${String(elapsedSeconds).padStart(2, '0')}`;
        
        // Update remaining time (same as countdown)
        document.getElementById('remaining-time').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        // Update progress
        const progressPercent = Math.min(100, (elapsed / timerDuration) * 100);
        document.getElementById('progress-percent').textContent = `${Math.round(progressPercent)}%`;
        document.getElementById('quotation-progress').style.width = `${progressPercent}%`;
        
        // Check if timer finished
        if (remaining <= 0) {
            clearInterval(timerInterval);
            enhancedTimerFinished();
        }
    }
    
    function enhancedTimerFinished() {
        console.log('ðŸŽ‰ TIMER FINISHED! Quotations are ready...');
        
        // Demo quotation generation removed - only real quotations from database
        
        // Update status message
        const quotationsStatus = document.getElementById('quotations-status');
        if (quotationsStatus) {
            quotationsStatus.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Quotations Ready!</strong> Service providers have submitted their quotations. Click "View & Select Quotations" to proceed.
                </div>
            `;
        }
        
        // Enable the "View Quotations" button
        const viewBtn = document.getElementById('viewQuotationsBtn');
        if (viewBtn) {
            viewBtn.disabled = false;
            viewBtn.innerHTML = '<i class="fas fa-eye me-2"></i>View & Select Quotations';
            viewBtn.classList.remove('btn-success');
            viewBtn.classList.add('btn-primary');
            console.log('âœ… View Quotations button enabled');
        }
        
        // Mark quotations as generated
        localStorage.setItem('quotationsGenerated', 'true');
        console.log('âœ… Quotations marked as generated');
    }
}

// Demo quotation functions removed - only real quotations from database will be used

// All demo quotation helper functions removed - only real quotations from database

// Demo quotation functions completely removed

// Render dynamic quotations for selected services
function renderDynamicQuotations() {
    console.log('ðŸŽ¨ RENDERING DYNAMIC QUOTATIONS...');
    
    // Use real quotations from database only - no fallback
    let quotations = window.realQuotations || [];
    const selectedServices = window.jobCart || [];
    
    console.log('ðŸ“Š Real quotations available:', quotations.length);
    
    console.log('ðŸ“‹ Quotations to render:', quotations.length);
    console.log('ðŸ“‹ Selected services:', selectedServices.length);
    
    if (quotations.length === 0) {
        console.warn('âš ï¸ No quotations available to render');
        showNoQuotationsMessage();
        return;
    }
    
    // Helper function to show no quotations message
    function showNoQuotationsMessage() {
        const quotationsList = document.getElementById('quotations-list');
        if (quotationsList) {
            quotationsList.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                    <h4>No Quotations Available</h4>
                    <p class="text-muted">No service providers have submitted quotations for your selected services yet.</p>
                    <button class="btn btn-secondary" onclick="window.location.reload();">
                        <i class="fas fa-refresh me-2"></i>Refresh Page
                    </button>
                </div>
            `;
        }
    }
    
    // Group quotations by service
    const quotationsByService = {};
    quotations.forEach(quotation => {
        // Handle both real quotations (with quotation.service.service_name) and sample quotations (with quotation.service as string)
        const serviceName = quotation.service?.service_name || quotation.service || 'Unknown Service';
        
        if (!quotationsByService[serviceName]) {
            quotationsByService[serviceName] = [];
        }
        quotationsByService[serviceName].push(quotation);
    });
    
    console.log('ðŸ“Š Quotations grouped by service:', Object.keys(quotationsByService));
    
    // Get the quotations list container
    const quotationsList = document.getElementById('quotations-list');
    const quotationsContainer = document.getElementById('quotations-container');
    
    if (!quotationsList || !quotationsContainer) {
        console.error('âŒ Quotations container not found');
        return;
    }
    
    // Clear existing content
    quotationsList.innerHTML = '';
    
    // Only show quotations for selected services
    selectedServices.forEach(service => {
        const serviceName = service.service_name || service.service;
        const serviceQuotations = quotationsByService[serviceName];
        
        if (!serviceQuotations || serviceQuotations.length === 0) {
            console.warn(`âš ï¸ No quotations found for service: ${serviceName}`);
            return;
        }
        
        console.log(`ðŸŽ¯ Rendering ${serviceQuotations.length} quotations for ${serviceName}`);
        
        // Create service section header
        const serviceHeader = document.createElement('div');
        serviceHeader.className = 'service-quotations-section mb-4';
        serviceHeader.innerHTML = `
            <h4 class="text-primary mb-3">
                <i class="fas fa-${getServiceIcon(serviceName)} me-2"></i>
                ${serviceName} - Choose Your Provider
            </h4>
            <p class="text-muted">Select one of the ${serviceQuotations.length} quotations below:</p>
        `;
        quotationsList.appendChild(serviceHeader);
        
        // Render quotations for this service
        serviceQuotations.forEach((quotation, index) => {
            const quotationCard = createQuotationCard(quotation, serviceName);
            quotationsList.appendChild(quotationCard);
        });
    });
    
    // Show the quotations container
    quotationsContainer.style.display = 'block';
    quotationsContainer.style.visibility = 'visible';
    quotationsContainer.style.opacity = '1';
    
    console.log('âœ… Dynamic quotations rendered successfully');
}

// Create a quotation card HTML element
function createQuotationCard(quotation, serviceName) {
    const card = document.createElement('div');
    card.className = 'quotation-card mb-3';
    
    // Handle both real quotations and sample quotations
    const quotationId = quotation.quotation_id || quotation.id;
    const providerName = quotation.service_provider ? 
        `${quotation.service_provider.service_provider_name} ${quotation.service_provider.service_provider_surname}` : 
        quotation.provider;
    const price = quotation.quotation_price || quotation.price;
    const details = quotation.quotation_details || quotation.details;
    const rating = quotation.service_provider?.service_provider_rating || quotation.rating || 4.5;
    const location = quotation.service_provider?.service_provider_location || quotation.location || 'Location TBD';
    
    card.id = `quotation-${quotationId}`;
    
    // Get service icon
    const serviceIcon = getServiceIcon(serviceName);
    
    // Format price
    const formattedPrice = `R ${price.toLocaleString()}`;
    
    // Generate rating stars
    const ratingStars = generateRatingStars(rating);
    
    // Generate badge based on price range
    const badge = generatePriceBadge(price, serviceName);
    
    // Handle file download if available
    const fileButton = quotation.quotation_file_path ? 
        `<button class="btn btn-outline-info btn-sm" onclick="downloadQuotationFile('${quotation.quotation_file_path}')">
            <i class="fas fa-download me-1"></i>Download Quote
        </button>` : '';
    
    card.innerHTML = `
        <div class="quotation-header">
            <div class="quotation-provider">
                <i class="fas fa-${serviceIcon} text-primary me-2"></i>
                <strong>${providerName}</strong>
                <span class="badge ${badge.class} ms-2">${badge.text}</span>
            </div>
            <div class="quotation-price">${formattedPrice}</div>
        </div>
        <div class="quotation-details">
            <div class="provider-rating mb-2">
                <span class="rating">${ratingStars}</span>
                <span class="rating-text">${rating.toFixed(1)}/5.0</span>
                <span class="experience-text ms-2">(Professional Service Provider)</span>
            </div>
            <p><strong>Package includes:</strong></p>
            <p class="quotation-description">${details}</p>
            <div class="quotation-meta">
                <small class="text-muted">
                    <i class="fas fa-map-marker-alt me-1"></i>${location} | 
                    <i class="fas fa-calendar me-1"></i>${quotation.quotation_submission_date || 'Available'} | 
                    <i class="fas fa-tag me-1"></i>${serviceName}
                </small>
            </div>
        </div>
        <div class="quotation-buttons">
            <button class="btn btn-success btn-sm" onclick="selectDynamicQuotation('${quotationId}', '${serviceName}')">
                <i class="fas fa-check me-1"></i>Select This Quotation
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="viewQuotationDetails('${quotationId}')">
                <i class="fas fa-eye me-1"></i>View Details
            </button>
            ${fileButton}
        </div>
    </div>
        `;
    
    return card;
}

// Handle quotation file download
function downloadQuotationFile(filePath) {
    console.log('ðŸ“¥ Downloading quotation file:', filePath);
    // For now, just show an alert - in a real implementation, this would download the file
    alert(`Downloading quotation file: ${filePath}\n\nThis would normally download the file from the server.`);
}

// Get service icon
function getServiceIcon(serviceName) {
    const iconMap = {
        'Photography': 'camera',
        'Catering': 'utensils',
        'DJ Services': 'music',
        'Decoration': 'palette',
        'Venue': 'building',
        'Florist': 'seedling',
        'Makeup Artist': 'paint-brush',
        'MC': 'microphone',
        'Security': 'shield-alt',
        'Sound System': 'volume-up',
        'Stage Design': 'theater-masks',
        'Photo Booth': 'camera-retro',
        'Party Favors / Gift Bags': 'gift'
    };
    
    return iconMap[serviceName] || 'star';
}

// Generate rating stars
function generateRatingStars(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    
    let stars = '';
    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star text-warning"></i>';
    }
    if (hasHalfStar) {
        stars += '<i class="fas fa-star-half-alt text-warning"></i>';
    }
    for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star text-warning"></i>';
    }
    
    return stars;
}

// Generate price badge
function generatePriceBadge(price, serviceName) {
    const basePrice = getBasePriceForService(serviceName);
    const priceRatio = price / basePrice;
    
    if (priceRatio < 0.8) {
        return { class: 'bg-success', text: 'Great Value' };
    } else if (priceRatio < 1.2) {
        return { class: 'bg-primary', text: 'Fair Price' };
    } else {
        return { class: 'bg-warning', text: 'Premium' };
    }
}

// Select a dynamic quotation
function selectDynamicQuotation(quotationId, serviceName) {
    console.log(`âœ… Selected quotation ${quotationId} for ${serviceName}`);
    
    // Remove previous selection for this service
    const previousSelected = document.querySelector(`[data-service="${serviceName}"].quotation-card.selected`);
    if (previousSelected) {
        previousSelected.classList.remove('selected');
        previousSelected.style.borderColor = '#ddd';
        previousSelected.style.backgroundColor = 'white';
    }
    
    // Mark current quotation as selected
    const currentCard = document.getElementById(`quotation-${quotationId}`);
    if (currentCard) {
        currentCard.classList.add('selected');
        currentCard.style.borderColor = '#28a745';
        currentCard.style.backgroundColor = '#f8fff9';
        currentCard.setAttribute('data-service', serviceName);
    }
    
    // Store selection
    if (!window.selectedQuotations) {
        window.selectedQuotations = {};
    }
    window.selectedQuotations[serviceName] = quotationId;
    localStorage.setItem('selectedQuotations', JSON.stringify(window.selectedQuotations));
    
    // Show success message
    showNotification(`Selected quotation for ${serviceName}`, 'success');
    
    // Check if all services have quotations selected
    checkAllDynamicQuotationsSelected();
}

// Check if all dynamic quotations are selected
function checkAllDynamicQuotationsSelected() {
    const selectedServices = window.jobCart || [];
    const selectedQuotations = window.selectedQuotations || {};
    
    const allSelected = selectedServices.every(service => {
        const serviceName = service.service_name || service.service;
        return selectedQuotations[serviceName];
    });
    
    if (allSelected) {
        showNotification('All quotations selected! You can now continue to the summary.', 'success');
        
        // Show the continue to summary button
        const continueBtn = document.getElementById('continueToSummaryBtn');
        if (continueBtn) {
            continueBtn.style.display = 'inline-block';
        }
    } else {
        // Hide the continue button if not all selected
        const continueBtn = document.getElementById('continueToSummaryBtn');
        if (continueBtn) {
            continueBtn.style.display = 'none';
        }
    }
}

// Enhanced quotation loading for Step 5
async function loadQuotationsForSelection() {
    console.log('ðŸ“‹ LOAD QUOTATIONS FOR SELECTION - Step 5...');
    
    try {
        // Load real quotations from database
        console.log('ðŸ” Loading real quotations from database...');
        await loadRealQuotationsForServices();
        
        // Render dynamic quotations for selected services only
        renderDynamicQuotations();
        
        console.log('âœ… Real quotations loaded successfully for selection');
    } catch (error) {
        console.error('âŒ Error loading real quotations:', error);
        
        // Show error message instead of fallback
        const quotationsList = document.getElementById('quotations-list');
        if (quotationsList) {
            quotationsList.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h4>Error Loading Quotations</h4>
                    <p class="text-muted">Failed to load quotations from database. Check console for details.</p>
                    <p class="text-danger small">${error.message}</p>
                </div>
            `;
        }
        throw error; // Re-throw so you can see the actual error
    }
}

// Make sure the goToQuotationPage function works
window.goToQuotationPage = function() {
    console.log('ðŸ‘€ GO TO QUOTATION PAGE - Redirecting to quotation.html...');
    
    // Redirect to the separate quotation page
    window.location.href = 'quotation.html';
}

// Enhanced validation function with comprehensive checks
function validateStep(step) {
    let valid = true;
    let errorMessage = '';
    
    if (step === 2) {
        // Clear previous errors
        clearValidationErrors();
        
        // Get form elements
        const type = document.getElementById("event_type").value;
        const date = document.getElementById("event_date").value;
        const start = document.getElementById("start_time").value;
        const end = document.getElementById("end_time").value;
        const location = document.getElementById("location").value;
        const minPrice = parseFloat(document.getElementById("min_price").value) || 0;
        const maxPrice = parseFloat(document.getElementById("max_price").value) || 0;
        
        // Event Type validation
        if (!type) {
            showFieldError('event_type_error', 'Please select an event type');
            valid = false;
        }
        
        // Date validation - cannot book before today
        if (!date) {
            showFieldError('event_date_error', 'Please select an event date');
            valid = false;
        } else {
            const today = new Date();
            const selectedDate = new Date(date);
            today.setHours(0, 0, 0, 0); // Reset time to start of day
            selectedDate.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                showFieldError('event_date_error', 'Event date cannot be in the past');
                valid = false;
            }
        }
        
        // Time validation - start time must be before end time
        if (!start || !end) {
            if (!start) showFieldError('start_time_error', 'Please select a start time');
            if (!end) showFieldError('end_time_error', 'Please select an end time');
            valid = false;
        } else if (start >= end) {
            showFieldError('start_time_error', 'Start time must be before end time');
            showFieldError('end_time_error', 'End time must be after start time');
            valid = false;
        }
        
        // Location validation
        if (!location || location.trim() === '') {
            showFieldError('locationError', 'Please enter an event location');
            valid = false;
        }
        
        // Price validation - minimum must be less than maximum
        if (minPrice <= 0 || maxPrice <= 0) {
            if (minPrice <= 0) showFieldError('min_price_error', 'Minimum price must be greater than 0');
            if (maxPrice <= 0) showFieldError('max_price_error', 'Maximum price must be greater than 0');
            valid = false;
        } else if (minPrice >= maxPrice) {
            showFieldError('min_price_error', 'Minimum price must be less than maximum price');
            showFieldError('max_price_error', 'Maximum price must be greater than minimum price');
            valid = false;
        }
        
        if (!valid) {
            errorMessage = 'Please ensure all required details are filled before proceeding';
        }
        
    } else if (step === 3) {
        console.log('ðŸ” Step 3 validation - jobCart:', window.jobCart);
        if (!window.jobCart || window.jobCart.length === 0) {
            valid = false;
            errorMessage = 'Please select at least one service';
            console.log('âŒ Step 3 validation failed - no services selected');
        } else {
            valid = true;
            console.log('âœ… Step 3 validation passed - services selected:', window.jobCart.length);
        }
    } else if (step === 5) {
        // For quotation selection, it's always valid to view quotations
        valid = true;
        console.log('âœ… Step 5 validation passed - ready for quotation selection');
    }
    
    // Only show error message once when validation fails, not on every input
    if (!valid && errorMessage) {
        // Check if this is a new validation failure (not repeated)
        if (!window.lastValidationState || window.lastValidationState !== errorMessage) {
            showMessage(errorMessage, 'warning', 3000);
            window.lastValidationState = errorMessage;
        }
    } else if (valid) {
        // Clear validation state when validation passes
        window.lastValidationState = null;
    }
    
    const nextBtn = document.getElementById('nextBtn');
    if (nextBtn) {
        // Enable next button only if validation passes
        nextBtn.disabled = !valid;
        console.log(`ðŸ” Next button ${valid ? 'enabled' : 'disabled'}, validation result: ${valid}`);
    }
    return valid;
}

// Helper function to show field-specific errors
function showFieldError(fieldId, message) {
    const errorElement = document.getElementById(fieldId);
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.color = '#dc3545';
        errorElement.style.fontSize = '0.875rem';
        errorElement.style.marginTop = '0.25rem';
    }
}

// Helper function to clear all validation errors
function clearValidationErrors() {
    const errorFields = ['event_type_error', 'event_date_error', 'start_time_error', 'end_time_error', 'locationError', 'min_price_error', 'max_price_error'];
    errorFields.forEach(fieldId => {
        const errorElement = document.getElementById(fieldId);
        if (errorElement) {
            errorElement.textContent = '';
        }
    });
}

// Initialize real-time validation for form fields
function initializeRealTimeValidation() {
    console.log('ðŸ” Initializing real-time validation...');
    
    // Set minimum date to today for event date input
    const eventDateInput = document.getElementById('event_date');
    if (eventDateInput) {
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        eventDateInput.min = todayString;
        
        // Add real-time validation for date
        eventDateInput.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                showFieldError('event_date_error', 'Event date cannot be in the past');
            } else {
                clearFieldError('event_date_error');
            }
            
            // Trigger main validation to update Next button
            validateStep(2);
        });
    }
    
    // Add real-time validation for time fields
    const startTimeInput = document.getElementById('start_time');
    const endTimeInput = document.getElementById('end_time');
    
    if (startTimeInput && endTimeInput) {
        const validateTimes = () => {
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;
            
            if (startTime && endTime && startTime >= endTime) {
                showFieldError('start_time_error', 'Start time must be before end time');
                showFieldError('end_time_error', 'End time must be after start time');
            } else {
                clearFieldError('start_time_error');
                clearFieldError('end_time_error');
            }
            
            // Trigger main validation to update Next button
            validateStep(2);
        };
        
        startTimeInput.addEventListener('change', validateTimes);
        endTimeInput.addEventListener('change', validateTimes);
    }
    
    // Add real-time validation for price fields
    const minPriceInput = document.getElementById('min_price');
    const maxPriceInput = document.getElementById('max_price');
    
    if (minPriceInput && maxPriceInput) {
        const validatePrices = () => {
            const minPrice = parseFloat(minPriceInput.value) || 0;
            const maxPrice = parseFloat(maxPriceInput.value) || 0;
            
            if (minPrice <= 0) {
                showFieldError('min_price_error', 'Minimum price must be greater than 0');
            } else if (maxPrice <= 0) {
                showFieldError('max_price_error', 'Maximum price must be greater than 0');
            } else if (minPrice >= maxPrice) {
                showFieldError('min_price_error', 'Minimum price must be less than maximum price');
                showFieldError('max_price_error', 'Maximum price must be greater than minimum price');
            } else {
                clearFieldError('min_price_error');
                clearFieldError('max_price_error');
            }
            
            // Trigger main validation to update Next button
            validateStep(2);
        };
        
        minPriceInput.addEventListener('input', validatePrices);
        maxPriceInput.addEventListener('input', validatePrices);
    }
    
    // Add real-time validation for event type
    const eventTypeSelect = document.getElementById('event_type');
    if (eventTypeSelect) {
        eventTypeSelect.addEventListener('change', function() {
            if (!this.value) {
                showFieldError('event_type_error', 'Please select an event type');
            } else {
                clearFieldError('event_type_error');
            }
            
            // Trigger main validation to update Next button
            validateStep(2);
        });
    }
    
    // Add real-time validation for location
    const locationInput = document.getElementById('location');
    if (locationInput) {
        locationInput.addEventListener('input', function() {
            if (!this.value || this.value.trim() === '') {
                showFieldError('locationError', 'Please enter an event location');
            } else {
                clearFieldError('locationError');
                // Validate location without triggering full step validation
                validateBookingLocation(this.value.trim());
            }
            
            // Trigger main validation to update Next button (but only once)
            setTimeout(() => validateStep(2), 100);
        });
    }
    
    console.log('âœ… Real-time validation initialized');
}

// Helper function to clear individual field errors
function clearFieldError(fieldId) {
    const errorElement = document.getElementById(fieldId);
    if (errorElement) {
        errorElement.textContent = '';
    }
}

// Remove the problematic override that was causing infinite loops

    // Generate quotations for each service
    async function generateQuotationsForServices() {
        try {
            const createdJobCarts = localStorage.getItem('createdJobCarts');
            if (!createdJobCarts) return;

            const jobCartIds = JSON.parse(createdJobCarts);
            const totalQuotations = jobCartIds.length * 3; // 3 quotations per service
            
            // Simulate quotation generation over the 1-minute period
            const quotationInterval = (expectedDuration / totalQuotations);
            let generatedCount = 0;

            const generateInterval = setInterval(() => {
                if (generatedCount < totalQuotations) {
                    // Show notification
                    showNotification('ðŸ” A service provider is reviewing a job cart...', 'info', 2000);
                    
                    setTimeout(() => {
                        showNotification('â¬†ï¸ A service provider is uploading a quotation...', 'info', 2000);
                        quotationsReceived++;
                        updateProgressBar();
                        generatedCount++;
                    }, 1000);
                } else {
                    clearInterval(generateInterval);
                }
            }, quotationInterval);

        } catch (error) {
            console.error('Error generating quotations:', error);
        }
    }
    
    // Make it globally available
    window.generateQuotationsForServices = generateQuotationsForServices;
    window.loadRealQuotationsForServices = loadRealQuotationsForServices;

    // Load correct service UUIDs from database and store locally
    async function loadServiceUUIDs() {
        try {
            console.log('ðŸ” Loading service UUIDs from database...');
            
            const { data: services, error } = await sb
                .from('service')
                .select('service_id, service_name, service_type');
            
            if (error) {
                console.error('âŒ Error loading services:', error);
                throw error;
            }
            
            console.log('ðŸ“‹ Services loaded from database:', services);
            
            // Store services locally for easy access
            localStorage.setItem('services', JSON.stringify(services));
            
            // Create a mapping of service names to UUIDs
            const serviceMap = {};
            services.forEach(service => {
                serviceMap[service.service_name] = service.service_id;
            });
            
            localStorage.setItem('serviceMap', JSON.stringify(serviceMap));
            console.log('âœ… Service UUIDs stored locally:', serviceMap);
            
            return services;
        } catch (error) {
            console.error('âŒ Error loading service UUIDs:', error);
            throw error;
        }
    }

    // Load real quotations from database and link to job carts by service type
    async function loadRealQuotationsForServices() {
        try {
            console.log('ðŸ” Loading real quotations from database...');
            
            // First, load service UUIDs
            const services = await loadServiceUUIDs();
            
            // Get selected services from job cart
            const selectedServices = window.jobCart || [];
            console.log('ðŸ“‹ Selected services:', selectedServices);
            
            if (!selectedServices || selectedServices.length === 0) {
                console.log('âš ï¸ No services selected, cannot load quotations');
                return;
            }
            
            // Get client ID from localStorage
            const clientId = localStorage.getItem('clientId');
            if (!clientId) {
                console.error('âŒ No client ID found in localStorage');
                throw new Error('Client not authenticated');
            }
            
            // Update selected services with correct UUIDs
            const serviceMap = JSON.parse(localStorage.getItem('serviceMap') || '{}');
            selectedServices.forEach(service => {
                const correctUUID = serviceMap[service.service_name];
                if (correctUUID) {
                    service.service_id = correctUUID;
                    console.log(`âœ… Updated ${service.service_name} with UUID: ${correctUUID}`);
                } else {
                    console.error(`âŒ No UUID found for service: ${service.service_name}`);
                }
            });
            
            // Load real quotations for each service
            for (const service of selectedServices) {
                await loadRealQuotationsForService(service, clientId);
            }
            
            console.log('âœ… Real quotations loaded successfully');
        } catch (error) {
            console.error('âŒ Error loading real quotations:', error);
            throw error; // Re-throw so you can see the actual error
        }
    }

    // Load real quotations for a specific service - SIMPLIFIED APPROACH
    async function loadRealQuotationsForService(service, clientId) {
        try {
            console.log(`ðŸ” Loading real quotations for service: ${service.service_name} (ID: ${service.service_id})`);
            
            // PRESENTATION READY: Direct query using service_id in quotation table
            console.log(`ðŸŽ¯ Searching quotations for service_id: ${service.service_id}`);
            
            const { data: quotations, error: quotationError } = await sb
                .from('quotation')
                .select(`
                    quotation_id,
                    quotation_price,
                    quotation_details,
                    quotation_file_path,
                    quotation_file_name,
                    quotation_submission_date,
                    quotation_submission_time,
                    quotation_status,
                    service_id,
                    service_provider:service_provider_id (
                        service_provider_id,
                        service_provider_name,
                        service_provider_surname,
                        service_provider_rating,
                        service_provider_location,
                        service_provider_service_type
                    )
                `)
                .eq('quotation_status', 'confirmed')
                .eq('service_id', service.service_id) // Direct service_id match - much simpler!
                .limit(3); // Limit to 3 quotations per service

            if (quotationError) {
                console.error('âŒ Error fetching quotations:', quotationError);
                return;
            }

            console.log(`ðŸ“Š Found ${quotations ? quotations.length : 0} real quotations for ${service.service_name}:`, quotations);

            // For presentation: Just store the quotations for display
            // We'll match them by service type rather than job_cart_id
            if (quotations && quotations.length > 0) {
                // Add the quotations to a global array for rendering
                if (!window.realQuotations) {
                    window.realQuotations = [];
                }
                
                quotations.forEach(quotation => {
                    // Add service info to the quotation for display
                    quotation.service = {
                        service_name: service.service_name,
                        service_id: service.service_id
                    };
                    window.realQuotations.push(quotation);
                });
                
                console.log(`âœ… Added ${quotations.length} quotations for ${service.service_name} to display list`);
            } else {
                console.log(`âš ï¸ No real quotations found for ${service.service_name}`);
            }

        } catch (error) {
            console.error('âŒ Error loading real quotations for service:', error);
        }
    }


    function updateProgressBar() {
        const createdJobCarts = localStorage.getItem('createdJobCarts');
        if (!createdJobCarts) return;
        
        const jobCartIds = JSON.parse(createdJobCarts);
        const totalExpected = jobCartIds.length * 3;
        const progress = (quotationsReceived / totalExpected) * 100;
        
        document.getElementById('quotation-progress').style.width = `${progress}%`;
        document.getElementById('quotation-progress').textContent = `${Math.round(progress)}%`;
    }

    // Handle view quotations button click - now redirects to quotation page
    document.getElementById('viewQuotationsBtn').addEventListener('click', function() {
        goToQuotationPage();
    });

// Generate fake quotations for services
async function generateFakeQuotationsForServices() {
    try {
        console.log('ðŸŽ­ Generating fake quotations for services...');
        
        // Get event details for quotation generation
        const eventType = document.getElementById('event_type').value;
        const eventDate = document.getElementById('event_date').value;
        const eventLocation = document.getElementById('location').value;
        const minPrice = parseInt(document.getElementById('min_price').value) || 500;
        const maxPrice = parseInt(document.getElementById('max_price').value) || 5000;
        
        // Get selected services from job cart
        const selectedServices = window.jobCart;
        
        console.log('ðŸ“Š Selected services:', selectedServices);
        
        // Generate fake quotations for each service
        for (const service of selectedServices) {
            await generateFakeQuotationsForService(service, eventType, eventDate, eventLocation, minPrice, maxPrice);
        }
        
        console.log('âœ… Fake quotations generated successfully');
    } catch (error) {
        console.error('âŒ Error generating fake quotations:', error);
    }
}

// Make it globally available
window.generateFakeQuotationsForServices = generateFakeQuotationsForServices;

// Function to handle sample quotation selection
function selectSampleQuotation(quotationId, serviceName) {
    console.log('ðŸŽ¯ Selected sample quotation:', quotationId, 'for service:', serviceName);
    
    // Remove selection from other quotations for the same service
    const allCards = document.querySelectorAll('.quotation-card');
    allCards.forEach(card => {
        if (card.querySelector(`[onclick*="${quotationId}"]`)) {
            // This is the selected card
            card.classList.add('selected');
            card.style.borderColor = '#28a745';
            card.style.backgroundColor = '#f8fff9';
        } else {
            // Check if this is the same service type
            const cardService = card.querySelector('.quotation-provider strong');
            if (cardService && (
                cardService.textContent.includes('Photography') && serviceName === 'Photography' ||
                cardService.textContent.includes('Catering') && serviceName === 'Catering' ||
                cardService.textContent.includes('DJ') && serviceName === 'DJ Services'
            )) {
                card.classList.remove('selected');
                card.style.borderColor = '#ddd';
                card.style.backgroundColor = 'white';
            }
        }
    });
    
    // Store the selection
    if (!window.selectedQuotations) {
        window.selectedQuotations = {};
    }
    window.selectedQuotations[serviceName] = quotationId;
    
    // Show success message
    showNotification(`Selected quotation for ${serviceName}`, 'success');
    
    // Check if all services have quotations selected
    checkAllSampleQuotationsSelected();
}

// Check if all sample quotations are selected
function checkAllSampleQuotationsSelected() {
    const requiredServices = ['Photography', 'Catering', 'DJ Services'];
    const selected = window.selectedQuotations || {};
    
    const allSelected = requiredServices.every(service => selected[service]);
    
    if (allSelected) {
        // Enable continue button or show message
        showNotification('All quotations selected! You can now continue to the summary.', 'success');
        
        // Enable the Next button
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.remove('btn-secondary');
            nextBtn.classList.add('btn-primary');
        }
    }
}

// Make functions globally available
window.selectSampleQuotation = selectSampleQuotation;
window.checkAllSampleQuotationsSelected = checkAllSampleQuotationsSelected;

// Generate fake quotations for a specific service
async function generateFakeQuotationsForService(service, eventType, eventDate, eventLocation, minPrice, maxPrice) {
    try {
        console.log(`ðŸ”„ Generating quotations for: ${service.service_name}`);
        
        // Get job cart for this service
        const { data: jobCarts, error } = await supabase
            .from('job_cart')
            .select('job_cart_id')
            .eq('job_cart_item', service.service_name)
            .eq('client_id', clientId)
            .limit(1);

        if (error || !jobCarts || jobCarts.length === 0) {
            console.error('âŒ Error finding job cart for service:', service.service_name, error);
            return;
        }

        const jobCartId = jobCarts[0].job_cart_id;
        console.log(`ðŸ“¦ Found job cart ID: ${jobCartId} for ${service.service_name}`);

        // Use existing service providers from the database
        const existingProviders = [
            {
                name: 'Lerato',
                surname: 'Mahlangu',
                email: 'lerato.mahlangu@example.com',
                phone: '0835551234',
                rating: 4.8,
                location: 'Pretoria',
                provider_id: '85709960-f250-4463-9ec8-3ab98ba29c93'
            },
            {
                name: 'Thabo',
                surname: 'Nkosi',
                email: 'thabo.nkosi@example.com',
                phone: '0824445678',
                rating: 4.9,
                location: 'Johannesburg',
                provider_id: 'a084e7d1-51ad-4c10-8eb7-f4e44c51eb23'
            },
            {
                name: 'Sibongile',
                surname: 'Dlamini',
                email: 'sibongile.dlamini@example.com',
                phone: '0843337890',
                rating: 4.7,
                location: 'Cape Town',
                provider_id: 'a352e474-ed97-40d1-b730-b2bc2a2f25d5'
            }
        ];

        for (let i = 0; i < 3; i++) {
            const provider = existingProviders[i];
            const price = Math.floor(Math.random() * (maxPrice - minPrice + 1)) + minPrice;
            
            const quotationData = {
                job_cart_id: jobCartId,
                event_id: currentEventId, // Add event_id foreign key
                service_provider_id: provider.provider_id,
                quotation_price: price,
                quotation_details: `Professional ${service.service_name} services for your ${eventType} event on ${eventDate} at ${eventLocation}. Our experienced team will ensure your event is memorable and successful.`,
                quotation_status: 'pending',
                quotation_submission_date: new Date().toISOString().split('T')[0],
                quotation_submission_time: new Date().toTimeString().split(' ')[0]
            };

            console.log(`ðŸ’° Generated quotation ${i + 1} for ${service.service_name}: R${price}`);

            // Insert fake quotation into database
            const { error: quotationError } = await supabase
                .from('quotation')
                .insert(quotationData);

            if (quotationError) {
                console.error('âŒ Error inserting fake quotation:', quotationError);
            } else {
                console.log(`âœ… Saved fake quotation ${i + 1} for ${service.service_name}`);
            }
        }

    } catch (error) {
        console.error('âŒ Error generating fake quotations for service:', error);
    }
}

// Helper functions removed - now using real service provider IDs from database

// Removed duplicate function - using the first loadQuotationsForSelection function

// Check if all quotations are selected
function checkAllQuotationsSelected() {
    console.log('ðŸ” Checking if all quotations are selected...');
    
    // This function can be expanded to check if all required quotations are selected
    // For now, just log the current state
    console.log('Selected quotations:', window.selectedQuotations || {});
    
    return Object.keys(window.selectedQuotations || {}).length > 0;
}

// Create service group with quotations
function createServiceGroup(jobCartId, quotations) {
    const group = document.createElement('div');
    group.className = 'service-group mb-4';
    group.innerHTML = `
        <div class="service-header">
            <h4>${quotations[0].job_cart.service?.service_name || 'Service'}</h4>
            <p class="text-muted">Select one quotation for this service</p>
        </div>
        <div class="quotations-grid" id="quotations-${jobCartId}"></div>
    `;

    const quotationsContainer = group.querySelector(`#quotations-${jobCartId}`);
    
    quotations.forEach((quotation, index) => {
        const quotationCard = createQuotationCard(quotation, jobCartId, index);
        quotationsContainer.appendChild(quotationCard);
    });

    return group;
}

// Create individual quotation card
function createQuotationCard(quotation, jobCartId, index) {
    const card = document.createElement('div');
    card.className = 'quotation-card';
    card.dataset.quotationId = quotation.quotation_id;
    card.dataset.jobCartId = jobCartId;
    
    card.innerHTML = `
        <div class="card-header">
            <h5>${quotation.service_provider?.service_provider_name || 'Service Provider'} ${quotation.service_provider?.service_provider_surname || ''}</h5>
            <div class="provider-rating">
                <span class="rating">${quotation.service_provider?.service_provider_rating || '5.0'}</span>
                <i class="fas fa-star text-warning"></i>
            </div>
        </div>
        <div class="card-body">
            <div class="price-section">
                <span class="price">R${parseFloat(quotation.quotation_price).toLocaleString()}</span>
                <span class="price-label">Total Price</span>
            </div>
            <div class="quotation-details">
                <p>${quotation.quotation_details || 'Professional service delivery'}</p>
            </div>
            <div class="provider-info">
                <div class="info-item">
                    <i class="fas fa-envelope me-2"></i>
                    ${quotation.service_provider?.service_provider_email || 'Email not provided'}
                </div>
                <div class="info-item">
                    <i class="fas fa-phone me-2"></i>
                    ${quotation.service_provider?.service_provider_phone || 'Phone not provided'}
                </div>
                <div class="info-item">
                    <i class="fas fa-calendar me-2"></i>
                    Submitted: ${new Date(quotation.quotation_submission_date).toLocaleDateString()}
                </div>
            </div>
        </div>
        <div class="card-footer">
            <button class="btn btn-outline-primary select-quotation" onclick="selectQuotation('${quotation.quotation_id}', '${jobCartId}')">
                Select This Quotation
            </button>
        </div>
    `;

    return card;
}

// Select quotation function
function selectQuotation(quotationId, jobCartId) {
    // Disable other quotations for this service
    const serviceGroup = document.querySelector(`#quotations-${jobCartId}`).closest('.service-group');
    const allCards = serviceGroup.querySelectorAll('.quotation-card');
    
    allCards.forEach(card => {
        card.classList.remove('selected');
        const button = card.querySelector('.select-quotation');
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-primary');
        button.textContent = 'Select This Quotation';
        button.disabled = false;
    });

    // Select current quotation
    const selectedCard = document.querySelector(`[data-quotation-id="${quotationId}"]`);
    selectedCard.classList.add('selected');
    const selectedButton = selectedCard.querySelector('.select-quotation');
    selectedButton.classList.remove('btn-outline-primary');
    selectedButton.classList.add('btn-primary');
    selectedButton.textContent = 'Selected âœ“';
    selectedButton.disabled = true;

    // Store selected quotations
    let selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
    selectedQuotations[jobCartId] = quotationId;
    localStorage.setItem('selectedQuotations', JSON.stringify(selectedQuotations));

    // Check if all services have quotations selected
    checkAllQuotationsSelected();
}

// Check if all services have quotations selected
function checkAllQuotationsSelected() {
    const createdJobCarts = JSON.parse(localStorage.getItem('createdJobCarts') || '[]');
    const selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
    
    const allSelected = createdJobCarts.every(jobCartId => selectedQuotations[jobCartId]);
    
    if (allSelected) {
        // Show continue button
        const continueSection = document.createElement('div');
        continueSection.className = 'text-center mt-4';
        continueSection.innerHTML = `
            <button class="btn btn-success btn-lg" onclick="goToSummary()">
                <i class="fas fa-arrow-right me-2"></i>Continue to Summary
            </button>
        `;
        
        // Remove existing continue button if any
        const existingContinue = document.querySelector('.continue-to-summary');
        if (existingContinue) existingContinue.remove();
        
        continueSection.classList.add('continue-to-summary');
        document.getElementById('quotations-selection-container').appendChild(continueSection);
    }
}

// Go to summary step
function goToSummary() {
    currentStep = 6;
    showStep(currentStep);
    loadSummaryData();
}

// Load summary data (Step 5)
async function loadSummaryData() {
    try {
        const selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
        const selectedQuotationsSummary = document.getElementById('selected-quotations-summary');
        const eventSummary = document.getElementById('event-summary');
        const totalCostSummary = document.getElementById('total-cost-summary');

        // Load selected quotations
        let totalCost = 0;
        let summaryHTML = '';

        for (const [jobCartId, quotationId] of Object.entries(selectedQuotations)) {
            const { data: quotation, error } = await supabase
                .from('quotation')
                .select(`
                    *,
                    job_cart:job_cart_id (
                        job_cart_item,
                        service:service_id (service_name)
                    ),
                    service_provider:service_provider_id (
                        service_provider_name,
                        service_provider_surname,
                        service_provider_email,
                        service_provider_phone
                    )
                `)
                .eq('quotation_id', quotationId)
                .single();

            if (quotation && !error) {
                const price = parseFloat(quotation.quotation_price);
                totalCost += price;

                summaryHTML += `
                    <div class="selected-quotation-item">
                        <h5>${quotation.job_cart.service?.service_name || 'Service'}</h5>
                        <p><strong>Provider:</strong> ${quotation.service_provider?.service_provider_name || ''} ${quotation.service_provider?.service_provider_surname || ''}</p>
                        <p><strong>Price:</strong> R${price.toLocaleString()}</p>
                        <p><strong>Details:</strong> ${quotation.quotation_details || 'Professional service delivery'}</p>
                    </div>
                `;
            }
        }

        selectedQuotationsSummary.innerHTML = summaryHTML;

        // Load event summary
        const eventType = document.getElementById('event_type').value;
        const eventDate = document.getElementById('event_date').value;
        const eventLocation = document.getElementById('location').value;
        const specialRequests = document.getElementById('special_requests').value;

        eventSummary.innerHTML = `
            <div class="event-summary-item">
                <p><strong>Event Type:</strong> ${eventType}</p>
                <p><strong>Date:</strong> ${new Date(eventDate).toLocaleDateString()}</p>
                <p><strong>Location:</strong> ${eventLocation}</p>
                ${specialRequests ? `<p><strong>Special Requests:</strong> ${specialRequests}</p>` : ''}
            </div>
        `;

        // Load total cost
        totalCostSummary.innerHTML = `
            <div class="total-cost-item">
                <h4>R${totalCost.toLocaleString()}</h4>
                <p class="text-muted">Total amount for all services</p>
            </div>
        `;

        // Store total cost for payment step
        localStorage.setItem('totalBookingCost', totalCost.toString());

    } catch (error) {
        console.error('Error loading summary data:', error);
    }
}

// Payment processing (Step 6)
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for payment processing
    const processPaymentBtn = document.getElementById('process-payment');
    if (processPaymentBtn) {
        processPaymentBtn.addEventListener('click', processPayment);
    }

    // Format card number input
    const cardNumberInput = document.getElementById('card-number');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', formatCardNumber);
    }

    // Format expiry date input
    const expiryDateInput = document.getElementById('expiry-date');
    if (expiryDateInput) {
        expiryDateInput.addEventListener('input', formatExpiryDate);
    }
});

function formatCardNumber(event) {
    let value = event.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    if (formattedValue.length > 19) {
        formattedValue = formattedValue.substr(0, 19);
    }
    event.target.value = formattedValue;
}

function formatExpiryDate(event) {
    let value = event.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substr(0, 2) + '/' + value.substr(2, 2);
    }
    event.target.value = value;
}

async function processPayment() {
    const processBtn = document.getElementById('process-payment');
    const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
    const expiryDate = document.getElementById('expiry-date').value;
    const cvv = document.getElementById('cvv').value;
    const cardholderName = document.getElementById('cardholder-name').value;

    // Basic validation
    if (!cardNumber || !expiryDate || !cvv || !cardholderName) {
        alert('Please fill in all payment fields');
        return;
    }

    if (cardNumber.length < 16) {
        alert('Please enter a valid card number');
        return;
    }

    processBtn.disabled = true;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing Payment...';

    try {
        // Simulate payment processing
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Create payment record
        const totalCost = localStorage.getItem('totalBookingCost') || '0';
        const clientId = localStorage.getItem('clientId');
        
        const { data: paymentData, error: paymentError } = await supabase
            .from('payment')
            .insert({
                client_id: clientId,
                payment_amount: parseFloat(totalCost),
                payment_method: 'Credit Card',
                payment_status: 'completed',
                payment_date: new Date().toISOString().split('T')[0],
                payment_time: new Date().toTimeString().split(' ')[0]
            })
            .select();

        if (paymentError) {
            throw new Error(paymentError.message);
        }

        // Update quotations to accepted
        const selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
        for (const quotationId of Object.values(selectedQuotations)) {
            await supabase
                .from('quotation')
                .update({ quotation_status: 'accepted' })
                .eq('quotation_id', quotationId);
        }

        // Generate booking ID
        const bookingId = 'BK-' + Date.now();
        localStorage.setItem('finalBookingId', bookingId);

        // Go to thank you step
        currentStep = 8;
        showStep(currentStep);
        loadThankYouData();

    } catch (error) {
        console.error('Payment processing error:', error);
        alert('Payment processing failed. Please try again.');
        processBtn.disabled = false;
        processBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Process Payment';
    }
}

function loadThankYouData() {
    const bookingId = localStorage.getItem('finalBookingId') || 'BK-' + Date.now();
    const totalCost = localStorage.getItem('totalBookingCost') || '0';
    const eventDate = document.getElementById('event_date').value;

    document.getElementById('booking-id-display').textContent = bookingId;
    document.getElementById('confirmed-event-date').textContent = new Date(eventDate).toLocaleDateString();
    document.getElementById('confirmed-total-amount').textContent = 'R' + parseFloat(totalCost).toLocaleString();
}

// Update navigation logic
// Removed duplicate nextStep function - using enhanced version above

function loadPaymentDetails() {
    const totalCost = localStorage.getItem('totalBookingCost') || '0';
    const paymentDetails = document.getElementById('payment-details');
    
    paymentDetails.innerHTML = `
        <div class="payment-breakdown">
            <div class="breakdown-item">
                <span>Service Total:</span>
                <span>R${parseFloat(totalCost).toLocaleString()}</span>
            </div>
            <div class="breakdown-item">
                <span>Processing Fee:</span>
                <span>R0.00</span>
            </div>
            <div class="breakdown-item total">
                <span><strong>Total Amount:</strong></span>
                <span><strong>R${parseFloat(totalCost).toLocaleString()}</strong></span>
            </div>
        </div>
    `;
}

// Job cart dropdown
function toggleCartDropdown(){
    const dropdown = document.getElementById("cart-dropdown");
    dropdown.style.display = dropdown.style.display==='block'?'none':'block';
}
function openCartModal(){ document.getElementById('cart-modal').style.display='flex'; }
function closeCartModal(){ document.getElementById('cart-modal').style.display='none'; }

// Initialize real-time functionality
async function initializeRealtime() {
    try {
        // Check if required classes are available
        if (!window.RealtimeService) {
            console.warn('âš ï¸ RealtimeService not available, skipping real-time initialization');
            return;
        }
        
        if (!window.LockManager) {
            console.warn('âš ï¸ LockManager not available, skipping lock manager initialization');
            return;
        }
        
        if (!window.LockUI) {
            console.warn('âš ï¸ LockUI not available, skipping lock UI initialization');
            return;
        }
        
        // Initialize real-time service
        window.realtimeService = new window.RealtimeService();
        await window.realtimeService.initialize(sb);
        
        // Initialize lock manager
        window.lockManager = new window.LockManager();
        await window.lockManager.initialize(sb);
        
        // Initialize notifications
        if (window.RealtimeNotifications) {
            window.realtimeNotifications = new window.RealtimeNotifications();
            window.realtimeNotifications.initialize(sb);
        }
        
        // Initialize lock UI
        window.lockUI = new window.LockUI();
        window.lockUI.initialize();
        
        // Subscribe to real-time events
        setupRealtimeSubscriptions();
        
        // Initialize enhanced quotation real-time system
        if (window.EnhancedQuotationRealtime) {
            try {
                window.enhancedQuotationRealtime = new EnhancedQuotationRealtime(sb);
                await window.enhancedQuotationRealtime.initialize();
                console.log('âœ… Enhanced quotation real-time system initialized');
            } catch (error) {
                console.error('âŒ Failed to initialize enhanced quotation system:', error);
            }
        }
        
        console.log('âœ… Real-time system initialized');
    } catch (error) {
        console.error('âŒ Failed to initialize real-time system:', error);
        console.warn('âš ï¸ Continuing without real-time features...');
    }
}

// Setup real-time subscriptions
function setupRealtimeSubscriptions() {
    if (!window.realtimeService) {
        console.warn('âš ï¸ Real-time service not available, skipping subscriptions');
        return;
    }
    
    // Subscribe to quotations for real-time updates
    window.realtimeService.subscribeToQuotations((payload) => {
        handleQuotationUpdate(payload);
    });
    
    // Subscribe to bookings for real-time updates
    window.realtimeService.subscribeToBookings((payload) => {
        handleBookingUpdate(payload);
    });
    
    // Subscribe to job carts for real-time updates
    window.realtimeService.subscribeToJobCarts((payload) => {
        handleJobCartUpdate(payload);
    });
}

// Handle quotation updates
function handleQuotationUpdate(payload) {
    const { eventType, new: newRecord, old: oldRecord } = payload;
    
    switch (eventType) {
        case 'INSERT':
            showNotification('New quotation received!', 'success');
            break;
        case 'UPDATE':
            if (newRecord.quotation_status !== oldRecord.quotation_status) {
                showNotification(`Quotation status changed to ${newRecord.quotation_status}`, 'info');
            }
            break;
        case 'DELETE':
            showNotification('Quotation was removed', 'warning');
            break;
    }
}

// Handle booking updates
function handleBookingUpdate(payload) {
    const { eventType, new: newRecord, old: oldRecord } = payload;
    
    switch (eventType) {
        case 'INSERT':
            showNotification('New booking created!', 'success');
            break;
        case 'UPDATE':
            if (newRecord.booking_status !== oldRecord.booking_status) {
                showNotification(`Booking status changed to ${newRecord.booking_status}`, 'info');
            }
            break;
        case 'DELETE':
            showNotification('Booking was cancelled', 'warning');
            break;
    }
}

// Handle job cart updates
function handleJobCartUpdate(payload) {
    const { eventType, new: newRecord, old: oldRecord } = payload;
    
    switch (eventType) {
        case 'INSERT':
            showNotification('New job cart assigned!', 'success');
            break;
        case 'UPDATE':
            if (newRecord.job_status !== oldRecord.job_status) {
                showNotification(`Job cart status changed to ${newRecord.job_status}`, 'info');
            }
            break;
        case 'DELETE':
            showNotification('Job cart was removed', 'warning');
            break;
    }
}

// Enhanced accept quotation with locking
async function acceptQuotationWithLock(quotationId, serviceId) {
    try {
        // Try to acquire lock for the quotation
        const lockResult = await window.LockManager.acquireLockWithUI(
            window.LockTypes.QUOTATION, 
            quotationId, 
            window.LockOperations.APPROVE
        );
        
        if (!lockResult.success) {
            return; // Lock acquisition failed
        }
        
        // Proceed with acceptance
        await acceptQuotation(quotationId, serviceId);
        
        // Release lock after completion
        await window.LockManager.releaseLock(`quotation:${quotationId}`);
        
    } catch (error) {
        console.error('Error accepting quotation:', error);
        showNotification('Failed to accept quotation', 'error');
    }
}

// Enhanced reject quotation with locking
async function rejectQuotationWithLock(quotationId, serviceId) {
    try {
        // Try to acquire lock for the quotation
        const lockResult = await window.LockManager.acquireLockWithUI(
            window.LockTypes.QUOTATION, 
            quotationId, 
            window.LockOperations.REJECT
        );
        
        if (!lockResult.success) {
            return; // Lock acquisition failed
        }
        
        // Proceed with rejection
        await rejectQuotation(quotationId, serviceId);
        
        // Release lock after completion
        await window.LockManager.releaseLock(`quotation:${quotationId}`);
        
    } catch (error) {
        console.error('Error rejecting quotation:', error);
        showNotification('Failed to reject quotation', 'error');
    }
}

// Add loading state to services grid
function showServicesLoading() {
    const container = document.getElementById("services-grid");
    container.innerHTML = `
        <div class="col-12 text-center py-5">
            <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
            <h4>Loading Services...</h4>
            <p class="text-muted">Please wait while we load available services.</p>
        </div>
    `;
}

// Clear all booking-related localStorage data
function clearBookingLocalStorage() {
    console.log('ðŸ§¹ Clearing all booking-related localStorage data...');
    
    const keysToRemove = [
        'quotationServiceIds',
        'quotationClientId', 
        'createdJobCarts',
        'jobCartDetails',
        'selectedQuotations',
        'selectedQuotationData',
        'quotationsGenerated',
        'totalBookingCost',
        'currentEventId',
        'currentEventData',
        'minPrice',
        'maxPrice'
    ];
    
    keysToRemove.forEach(key => {
        if (localStorage.getItem(key)) {
            console.log('ðŸ—‘ï¸ Removing:', key);
            localStorage.removeItem(key);
        }
    });
    
    // Keep only essential user data
    console.log('âœ… Booking localStorage cleared. Kept user authentication data.');
}

// Initialize on page load - SIMPLE AND BULLETPROOF
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ PAGE LOADED - Initializing booking system...');
    
    // DON'T clear job cart data - this breaks the workflow!
    // clearBookingLocalStorage(); // COMMENTED OUT - was breaking job carts
    
    // Make sure steps are properly hidden/shown
    steps.forEach((step, index) => {
        if (index === 0) {
            step.style.display = 'block';
            step.classList.add('active');
        } else {
            step.style.display = 'none';
            step.classList.remove('active');
        }
    });
    
    // Ensure Step 1 is visible by default
    const step1 = document.getElementById('step-1');
    if (step1) {
        step1.style.display = 'block';
        step1.classList.add('active');
    }
    
    // Load services IMMEDIATELY - no delays, no complex logic
    console.log('âš¡ Loading services immediately...');
    useFallbackServices();
    console.log('âœ… Services loaded immediately!');
    
    // Initialize other services
    initializeRealtime();
    updateCartUI();
    
    console.log('âœ… Page initialization complete - ready for booking!');
    
    // Enhanced location service initialization for booking page
    // NOTE: simple-location.js auto-initializes inputs with data-location-input="true"
    // So we don't need manual initialization unless it fails
    console.log('ðŸ“ Location autocomplete will be initialized automatically by simple-location.js');
    
    // Verify after a delay that it initialized
    setTimeout(() => {
        const locationInput = document.getElementById('location');
        if (locationInput && !locationInput.hasAttribute('data-location-initialized')) {
            console.warn('âš ï¸ Auto-initialization failed, trying manual initialization...');
    initializeBookingLocationService();
        } else {
            console.log('âœ… Location autocomplete auto-initialized successfully!');
        }
    }, 1000);
    
    // Initialize real-time validation
    initializeRealTimeValidation();
    
    console.log('âœ… Page initialization complete - services should be visible!');
});

// Enhanced Location Service Initialization
function initializeBookingLocationService(retryCount = 0) {
    console.log('ðŸ“ Initializing location service for booking page... (attempt', retryCount + 1, ')');
    
    const locationInput = document.getElementById('location');
    if (!locationInput) {
        console.error('âŒ Location input not found');
        return;
    }
    
    // Check if already initialized to prevent multiple initializations
    if (locationInput.hasAttribute('data-location-initialized')) {
        console.log('âš ï¸ Location service already initialized, skipping');
        return;
    }
    
    // Check if location service is available
    if (typeof window.SimpleLocationAutocomplete === 'undefined') {
        console.error('âŒ SimpleLocationAutocomplete not available');
        
        // LIMIT RETRIES TO PREVENT INFINITE LOOP (max 5 attempts)
        if (retryCount >= 5) {
            console.warn('âš ï¸ Location autocomplete service failed to load after 5 attempts');
            console.log('âœ… Enabling manual location entry as fallback');
            // Make the location input work without autocomplete
            locationInput.placeholder = 'Enter your event location (e.g., 123 Main St, City)';
            locationInput.setAttribute('data-location-initialized', 'manual');
            locationInput.style.borderColor = '#3b82f6'; // Show it's ready
            
            // Add a simple input handler to trigger validation
            locationInput.addEventListener('input', function() {
                console.log('ðŸ“ Location input changed:', this.value);
                
                // Show all form values when location changes
                const typeElement = document.getElementById("event_type");
                const dateElement = document.getElementById("event_date");
                const startElement = document.getElementById("start_time");
                const endElement = document.getElementById("end_time");
                
                console.log('ðŸ“‹ Current form state:', {
                    type: typeElement?.value || 'âŒ EMPTY',
                    date: dateElement?.value || 'âŒ EMPTY',
                    start: startElement?.value || 'âŒ EMPTY',
                    end: endElement?.value || 'âŒ EMPTY',
                    location: this.value || 'âŒ EMPTY'
                });
                
                validateStep(2);
            });
            
            console.log('âœ… Manual location input enabled - you can type your location');
            return;
        }
        
        // Check if script exists but service not ready
        const existingScript = document.querySelector('script[src="js/simple-location.js"]');
        if (existingScript) {
            console.log('âš ï¸ Script exists but service not ready, waiting... (attempt', retryCount + 1, 'of 5)');
            setTimeout(() => initializeBookingLocationService(retryCount + 1), 500);
            return;
        }
        // Load the service dynamically if needed
        loadLocationServiceDynamically();
        return;
    }
    
    // Initialize the location autocomplete
    try {
        const autocomplete = new window.SimpleLocationAutocomplete();
        autocomplete.init(locationInput);
        console.log('âœ… Location autocomplete initialized successfully');
        
        // Mark as initialized to prevent multiple initializations
        locationInput.setAttribute('data-location-initialized', 'true');
        
        // Add custom event listeners for booking page
        setupBookingLocationEvents(locationInput);
        
    } catch (error) {
        console.error('âŒ Error initializing location autocomplete:', error);
        setupFallbackLocationService(locationInput);
    }
}

// Load location service dynamically if not available
function loadLocationServiceDynamically() {
    console.log('ðŸ“¥ Loading location service dynamically...');
    
    // Check if script is already loaded or loading
    if (document.querySelector('script[src="js/simple-location.js"]')) {
        console.log('âš ï¸ Location service script already exists, setting up fallback');
        setupFallbackLocationService(document.getElementById('location'));
        return;
    }
    
    const script = document.createElement('script');
    script.src = 'js/simple-location.js';
    script.onload = function() {
        console.log('âœ… Location service loaded dynamically');
        setTimeout(initializeBookingLocationService, 100);
    };
    script.onerror = function() {
        console.error('âŒ Failed to load location service');
        setupFallbackLocationService(document.getElementById('location'));
    };
    document.head.appendChild(script);
}

// Setup booking-specific location events
function setupBookingLocationEvents(locationInput) {
    // Clear any existing event listeners to prevent duplicates
    const newInput = locationInput.cloneNode(true);
    locationInput.parentNode.replaceChild(newInput, locationInput);
    
    const freshInput = document.getElementById('location');
    
    // Add input event for real-time validation
    freshInput.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        const errorElement = document.getElementById('locationError');
        
        if (value.length > 0) {
            // Clear error when user starts typing
            if (errorElement) {
                errorElement.textContent = '';
            }
            freshInput.classList.remove('is-invalid');
            freshInput.classList.add('is-valid');
        } else {
            freshInput.classList.remove('is-valid');
        }
    });
    
    // Add blur event for final validation
    freshInput.addEventListener('blur', function(e) {
        const value = e.target.value.trim();
        validateBookingLocation(value);
    });
    
    // Add focus event to show suggestions
    freshInput.addEventListener('focus', function() {
        // SimpleLocationAutocomplete already handles focus events
        // Just ensure validation runs when location changes
        if (this.value && this.value.length > 2) {
            console.log('ðŸ“ Location field focused with value:', this.value);
            validateStep(2);
        }
    });
    
    console.log('âœ… Booking location events setup complete');
}

// Validate location for booking
function validateBookingLocation(location) {
    const errorElement = document.getElementById('locationError');
    const locationInput = document.getElementById('location');
    
    if (!location) {
        if (errorElement) {
            errorElement.textContent = 'Event location is required';
        }
        locationInput.classList.add('is-invalid');
        locationInput.classList.remove('is-valid');
        return false;
    }
    
    if (location.length < 3) {
        if (errorElement) {
            errorElement.textContent = 'Please enter a valid location (minimum 3 characters)';
        }
        locationInput.classList.add('is-invalid');
        locationInput.classList.remove('is-valid');
        return false;
    }
    
    // Check if location matches the autocomplete list
    // Don't validate too strictly - accept any location that's at least 3 characters
    // The autocomplete dropdown already guides users to valid South African locations
    if (window.SimpleLocationAutocomplete) {
        const autocomplete = new window.SimpleLocationAutocomplete();
        const locations = autocomplete.locations || [];
        
        const matchesKnownLocation = locations.some(validLocation => 
            validLocation.toLowerCase().includes(location.toLowerCase()) ||
            location.toLowerCase().includes(validLocation.toLowerCase())
        );
        
        if (!matchesKnownLocation && location.length > 3) {
            // Just warn but don't block - user might have a specific street address
            console.log('â„¹ï¸ Location not in predefined list (might be a specific address):', location);
        } else if (matchesKnownLocation) {
            console.log('âœ… Valid South African location:', location);
        }
    }
    
    // Validation complete - no need to call validateStep again
    console.log('âœ… Location validation completed');
    
    if (errorElement) {
        errorElement.textContent = '';
    }
    locationInput.classList.remove('is-invalid');
    locationInput.classList.add('is-valid');
    return true;
}

// Fallback location service if main one fails
function setupFallbackLocationService(locationInput) {
    console.log('ðŸ”„ Setting up fallback location service...');
    
    // Simple South African cities and towns for fallback
    const saCities = [
        "Johannesburg", "Pretoria", "Cape Town", "Durban", "Port Elizabeth",
        "Bloemfontein", "East London", "Kimberley", "Nelspruit", "Polokwane",
        "Rustenburg", "Witbank", "Welkom", "Springs", "Alberton", "Soweto",
        "Sandton", "Randburg", "Roodepoort", "Benoni", "Boksburg", "Kempton Park",
        "Germiston", "Vereeniging", "Midrand", "Centurion", "Akasia", "Soshanguve",
        "Mamelodi", "Atteridgeville", "Mitchells Plain", "Khayelitsha", "Gugulethu",
        "Umlazi", "KwaMashu", "Mthatha", "Bhisho", "Queenstown", "Graaff-Reinet"
    ];
    
    let dropdown = document.getElementById('location-dropdown');
    if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = 'location-dropdown';
        dropdown.className = 'location-dropdown';
        locationInput.parentNode.appendChild(dropdown);
    }
    
    // Show suggestions on input
    locationInput.addEventListener('input', function(e) {
        const value = e.target.value.toLowerCase();
        const filteredCities = saCities.filter(city => 
            city.toLowerCase().includes(value)
        );
        
        showLocationSuggestions(filteredCities);
    });
    
    // Show suggestions on focus
    locationInput.addEventListener('focus', function() {
        if (!locationInput.value) {
            showLocationSuggestions(saCities.slice(0, 10));
        }
    });
    
    // Hide suggestions on blur
    locationInput.addEventListener('blur', function() {
        setTimeout(() => {
            if (dropdown) dropdown.style.display = 'none';
        }, 200);
    });
    
    function showLocationSuggestions(cities) {
        if (!cities.length) {
            dropdown.style.display = 'none';
            return;
        }
        
        dropdown.innerHTML = cities.map(city => 
            `<div class="location-item" onclick="selectFallbackLocation('${city}')">${city}</div>`
        ).join('');
        dropdown.style.display = 'block';
    }
    
    // Mark as initialized to prevent multiple initializations
    locationInput.setAttribute('data-location-initialized', 'true');
    
    console.log('âœ… Fallback location service setup complete');
}

// Select location from fallback dropdown
function selectFallbackLocation(city) {
    const locationInput = document.getElementById('location');
    const dropdown = document.getElementById('location-dropdown');
    
    locationInput.value = city;
    locationInput.classList.add('is-valid');
    locationInput.classList.remove('is-invalid');
    
    if (dropdown) {
        dropdown.style.display = 'none';
    }
    
    // Clear any error messages
    const errorElement = document.getElementById('locationError');
    if (errorElement) {
        errorElement.textContent = '';
    }
    
    console.log('ðŸ“ Location selected:', city);
}

// Enhanced location validation for step 2
function validateStepWithLocation(step) {
    if (step === 2) {
        const location = document.getElementById('location').value.trim();
        return validateBookingLocation(location);
    }
    return true;
}

// Override the existing step validation to include location
const originalValidateStep = validateStep;
validateStep = function(step) {
    const originalResult = originalValidateStep(step);
    
    if (step === 2) {
        const location = document.getElementById('location');
        if (location && location.value.trim()) {
            const locationValid = validateBookingLocation(location.value.trim());
            return originalResult && locationValid;
        }
    }
    
    return originalResult;
};

// Make functions globally available for debugging
window.initializeBookingLocationService = initializeBookingLocationService;
window.validateBookingLocation = validateBookingLocation;

</script>
</body>
</html>

