<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bonica Event Booking</title>
<link rel="stylesheet" href="css/bookings.css">
<!-- Professional Theme CSS -->
<link href="css/professional-theme.css" rel="stylesheet">
<style>
/* Enhanced Quotation Cards */
.quotation-card {
  background: white;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  transition: var(--transition-fast);
  box-shadow: var(--shadow-md);
}

.quotation-card:hover {
  border-color: var(--primary-blue);
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Responsive Bookings Styles */
@media (max-width: 768px) {
  .quotation-card {
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    border-radius: var(--radius-md);
  }
  
  .quotation-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .service-name {
    font-size: var(--font-size-mobile);
    font-weight: 600;
  }
  
  .provider-info {
    font-size: var(--font-size-mobile);
  }
  
  .quotation-details {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .rating {
    font-size: var(--font-size-mobile);
  }
  
  .location-info {
    font-size: var(--font-size-mobile);
  }
  
  .quotation-buttons {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    width: 100%;
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-mobile);
  }
  
  .container {
    padding: var(--spacing-sm);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-mobile);
    padding: var(--spacing-sm);
  }
  
  .btn {
    font-size: var(--font-size-mobile);
    padding: var(--spacing-sm) var(--spacing-md);
  }
  
  h1 {
    font-size: var(--heading-size-mobile);
  }
  
  h2 {
    font-size: var(--heading-size-mobile);
  }
  
  .form-group {
    margin-bottom: var(--spacing-md);
  }
}

@media (min-width: 768px) and (max-width: 1024px) {
  .quotation-card {
    padding: var(--spacing-lg);
  }
  
  .service-name {
    font-size: var(--font-size-tablet);
  }
  
  .provider-info {
    font-size: var(--font-size-tablet);
  }
  
  .rating,
  .location-info {
    font-size: var(--font-size-tablet);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    font-size: var(--font-size-tablet);
    padding: var(--spacing-sm) var(--spacing-md);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-tablet);
  }
  
  .btn {
    font-size: var(--font-size-tablet);
  }
  
  h1 {
    font-size: var(--heading-size-tablet);
  }
  
  h2 {
    font-size: var(--heading-size-tablet);
  }
}

@media (min-width: 1024px) {
  .quotation-card {
    padding: var(--spacing-xl);
  }
  
  .service-name {
    font-size: var(--font-size-desktop);
  }
  
  .provider-info {
    font-size: var(--font-size-desktop);
  }
  
  .rating,
  .location-info {
    font-size: var(--font-size-desktop);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    font-size: var(--font-size-desktop);
    padding: var(--spacing-md) var(--spacing-lg);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-desktop);
  }
  
  .btn {
    font-size: var(--font-size-desktop);
  }
  
  h1 {
    font-size: var(--heading-size-desktop);
  }
  
  h2 {
    font-size: var(--heading-size-desktop);
  }
}

@media (min-width: 1920px) {
  .quotation-card {
    padding: var(--spacing-tv);
    margin-bottom: var(--spacing-xl);
    border-radius: var(--radius-xl);
  }
  
  .quotation-header {
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }
  
  .service-name {
    font-size: var(--font-size-tv);
  }
  
  .provider-info {
    font-size: var(--font-size-tv);
  }
  
  .quotation-details {
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }
  
  .rating,
  .location-info {
    font-size: var(--font-size-tv);
  }
  
  .quotation-buttons {
    gap: var(--spacing-lg);
  }
  
  .btn-accept,
  .btn-reject,
  .btn-view {
    font-size: var(--font-size-tv);
    padding: var(--spacing-lg) var(--spacing-xl);
  }
  
  .container {
    max-width: var(--container-tv);
    padding: var(--spacing-xl);
  }
  
  .form-control,
  .form-select {
    font-size: var(--font-size-tv);
    padding: var(--spacing-lg);
  }
  
  .btn {
    font-size: var(--font-size-tv);
    padding: var(--spacing-lg) var(--spacing-xl);
  }
  
  h1 {
    font-size: var(--heading-size-tv);
    margin-bottom: var(--spacing-xl);
  }
  
  h2 {
    font-size: var(--heading-size-tv);
    margin-bottom: var(--spacing-lg);
  }
  
  .form-group {
    margin-bottom: var(--spacing-xl);
  }
}

.quotation-card.accepted {
  border-color: #10b981;
  background: #f0fdf4;
}

.quotation-card.rejected {
  border-color: #ef4444;
  background: #fef2f2;
  opacity: 0.7;
}

.quotation-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.service-name {
  font-weight: 600;
  font-size: 1.1rem;
  color: #1f2937;
}

.provider-info {
  font-size: 0.9rem;
  color: #6b7280;
  font-weight: 500;
}

.quotation-details {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.rating {
  font-size: 0.9rem;
  color: #f59e0b;
  font-weight: 500;
}

.location-info {
  font-size: 0.85rem;
  color: #6b7280;
}

.quotation-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.quotation-buttons button {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.btn-accept {
  background: #10b981;
  color: white;
}

.btn-accept:hover:not(:disabled) {
  background: #059669;
  transform: translateY(-1px);
}

.btn-reject {
  background: #ef4444;
  color: white;
}

.btn-reject:hover:not(:disabled) {
  background: #dc2626;
  transform: translateY(-1px);
}

.btn-view {
  background: #3b82f6;
  color: white;
}

.btn-view:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
}

.quotation-buttons button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

@media (max-width: 768px) {
  .quotation-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .quotation-details {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .quotation-buttons {
    width: 100%;
  }
  
  .quotation-buttons button {
    flex: 1;
    min-width: 80px;
  }
}

/* Professional Navigation Styling */
.professional-nav {
  background: var(--background-primary);
  box-shadow: var(--shadow-sm);
  padding: var(--spacing-md);
}

.nav-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 1200px;
  margin: 0 auto;
}

.professional-nav .logo {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  text-decoration: none;
  color: var(--text-primary);
  font-weight: 700;
  font-size: var(--font-size-lg);
}

.professional-nav .logo img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.professional-nav .nav-links {
  display: flex;
  list-style: none;
  margin: 0;
  padding: 0;
  gap: var(--spacing-lg);
}

.professional-nav .nav-links li a {
  color: var(--text-secondary);
  text-decoration: none;
  font-weight: 500;
  transition: var(--transition-fast);
  padding: var(--spacing-sm) var(--spacing-md);
}

.professional-nav .nav-links li a:hover {
  color: var(--primary-blue);
  transform: translateY(-2px);
}

.nav-actions {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
}

.job-cart {
  position: relative;
}

.cart-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: var(--radius-md);
  padding: var(--spacing-md);
  min-width: 250px;
  box-shadow: var(--shadow-lg);
  z-index: 1000;
}

.cart-dropdown ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.cart-dropdown li {
  padding: var(--spacing-xs) 0;
  border-bottom: 1px solid #eee;
}

/* Location dropdown styling */
.location-dropdown {
  position: absolute !important;
  top: 100% !important;
  left: 0 !important;
  right: 0 !important;
  background: white !important;
  border: 1px solid #ddd !important;
  border-top: none !important;
  border-radius: 0 0 4px 4px !important;
  max-height: 200px !important;
  overflow-y: auto !important;
  z-index: 9999 !important;
  display: none !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

.location-item {
  padding: 12px 16px !important;
  cursor: pointer !important;
  border-bottom: 1px solid #eee !important;
  transition: background-color 0.2s !important;
  font-size: 0.9rem !important;
}

.location-item:hover {
  background-color: #f5f5f5 !important;
}

.location-item.selected {
  background-color: #e3f2fd !important;
  color: #1976d2 !important;
}

/* New step styling */
.service-group {
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  background: #fff;
}

.service-header {
  border-bottom: 1px solid #e0e0e0;
  padding-bottom: 15px;
  margin-bottom: 20px;
}

.service-header h4 {
  color: #333;
  margin: 0;
}

/* Enhanced Service Cards Styling */
.services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.service-card {
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 25px 15px;
    text-align: center;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.service-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 123, 255, 0.15);
}

.service-card.selected {
    border-color: #28a745;
    background: #f8fff9;
}

.service-icon {
    margin-bottom: 15px;
    color: #007bff;
}

.service-title {
    margin: 15px 0;
    color: #333;
    font-weight: 600;
    font-size: 1.1rem;
}

.service-select {
    margin-top: 15px;
}

.service-checkbox {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #007bff;
    font-weight: 500;
    gap: 8px;
}

.service-checkbox input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #007bff;
    border-radius: 4px;
    display: inline-block;
    position: relative;
    transition: all 0.3s ease;
}

.service-checkbox input[type="checkbox"]:checked + .checkmark {
    background-color: #007bff;
    border-color: #007bff;
}

.service-checkbox input[type="checkbox"]:checked + .checkmark::after {
    content: '✓';
    position: absolute;
    color: white;
    font-size: 14px;
    font-weight: bold;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .services-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .service-card {
        padding: 20px 10px;
    }
    
    .service-icon i {
        font-size: 2.5rem !important;
    }
    
    .service-title {
        font-size: 1rem;
    }
}

.quotations-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.quotation-card {
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s ease;
  background: #fff;
}

.quotation-card:hover {
  border-color: #007bff;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.quotation-card.selected {
  border-color: #28a745;
  background: #f8fff9;
}

.card-header {
  background: #f8f9fa;
  padding: 15px 20px;
  border-bottom: 1px solid #e0e0e0;
}

.card-header h5 {
  margin: 0;
  color: #333;
}

.provider-rating {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-top: 5px;
}

.rating {
  font-weight: bold;
  color: #ffc107;
}

.card-body {
  padding: 20px;
}

.price-section {
  text-align: center;
  margin-bottom: 15px;
}

.price {
  font-size: 24px;
  font-weight: bold;
  color: #28a745;
  display: block;
}

.price-label {
  font-size: 12px;
  color: #6c757d;
  text-transform: uppercase;
}

.quotation-details {
  margin-bottom: 15px;
}

.provider-info {
  font-size: 14px;
}

.info-item {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  color: #6c757d;
}

.card-footer {
  padding: 15px 20px;
  background: #f8f9fa;
  border-top: 1px solid #e0e0e0;
}

.summary-card {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.summary-card h3 {
  color: #333;
  border-bottom: 2px solid #007bff;
  padding-bottom: 10px;
  margin-bottom: 15px;
}

.selected-quotation-item,
.event-summary-item,
.total-cost-item {
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
}

.selected-quotation-item:last-child,
.event-summary-item:last-child,
.total-cost-item:last-child {
  border-bottom: none;
}

.total-cost-item h4 {
  color: #28a745;
  font-size: 28px;
  margin: 0;
}

.payment-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  margin-top: 20px;
}

.payment-summary,
.payment-form {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 25px;
}

.payment-summary h4,
.payment-form h4 {
  color: #333;
  margin-bottom: 20px;
}

.payment-breakdown {
  space-y: 10px;
}

.breakdown-item {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
}

.breakdown-item.total {
  border-top: 2px solid #007bff;
  border-bottom: none;
  margin-top: 10px;
  padding-top: 15px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #333;
}

.form-group input {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.thank-you-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 40px 20px;
}

.thank-you-icon {
  font-size: 80px;
  color: #28a745;
  margin-bottom: 20px;
}

.confirmation-details {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  margin: 30px 0;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #e0e0e0;
}

.detail-item:last-child {
  border-bottom: none;
}

.next-steps {
  text-align: left;
  margin: 30px 0;
}

.next-steps h4 {
  color: #333;
  margin-bottom: 15px;
}

.next-steps ul li {
  padding: 8px 0;
  color: #6c757d;
}

.contact-info {
  background: #e3f2fd;
  border-radius: 12px;
  padding: 20px;
  margin: 30px 0;
}

.contact-info h5 {
  color: #1976d2;
  margin-bottom: 10px;
}

/* Responsive design */
@media (max-width: 768px) {
  .services-grid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
  }
  
  .payment-container {
    grid-template-columns: 1fr;
  }
  
  .quotations-grid {
    grid-template-columns: 1fr;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="js/location-service.js"></script>
<script src="js/simple-location.js"></script>
<script src="js/realtime-service.js"></script>
<script src="js/realtime-notifications.js"></script>
<script src="js/lock-manager.js"></script>
<script src="js/lock-ui.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<!-- Professional Navigation -->
<nav class="professional-nav">
  <div class="nav-container">
  <a href="index.html" class="logo">
      <img src="img/logo.jpeg" alt="Bonica Logo">
      <span>Bonica</span>
    </a>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="#about">About</a></li>
      <li><a href="#services">Services</a></li>
      <li><a href="#contact">Contact</a></li>
    </ul>
    <div class="nav-actions">
    <div class="job-cart">
        <button onclick="toggleCartDropdown()" class="btn btn-warning">
          <i class="fas fa-shopping-cart me-2"></i>Job Cart (<span id="cart-count">0</span>)
        </button>
      <div id="cart-dropdown" class="cart-dropdown" style="display:none;">
        <ul id="cart-items"></ul>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button style="flex:1;" onclick="openCartModal()">View Cart</button>
          <button style="flex:1; background:#198754;" onclick="goToStep(3)">Edit</button>
          </div>
        </div>
        </div>
      </div>
    </div>
  </nav>

<div class="container">
  <!-- Step 1: Welcome -->
  <div class="step active" id="step-1">
    <h2>Welcome!</h2>
    <p>Do you want to make a booking?</p>
    <div class="booking-choice-buttons">
      <button class="primary-btn" onclick="startBooking()">Yes</button>
      <button class="primary-btn" onclick="cancelBooking()">No</button>
    </div>
  </div>

  <!-- Step 2: Event Details -->
  <div class="step" id="step-2">
    <h2><i class="fas fa-calendar-alt me-2"></i>Event Details</h2>
    <label>Event Type
      <select id="event_type" onchange="toggleOtherEventInput()">
        <option value="">-- Select Event Type --</option>
        <option value="birthday">Birthday</option>
        <option value="graduation">Graduation</option>
        <option value="corporate_event">Corporate Event</option>
        <option value="concert">Concert</option>
        <option value="baby_shower">Baby Shower</option>
        <option value="anniversary">Anniversary</option>
        <option value="engagement_party">Engagement Party</option>
        <option value="conference">Conference</option>
        <option value="other">Other</option>
      </select>
    </label>
    <div id="other-event-wrapper" style="display:none; margin-top:8px;">
      <input type="text" id="other_event_type" placeholder="Enter your event type here" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" />
    </div>
    <label>Date <input type="date" id="event_date" autocomplete="off"></label>
    <label>Start Time <input type="time" id="start_time" autocomplete="off"></label>
    <label>End Time <input type="time" id="end_time" autocomplete="off"></label>
    <label>Location</label>
    <div style="position: relative;">
    <input type="text" id="location" placeholder="Enter your event address" 
           data-location-input="true"
           data-placeholder="Enter your event address"
           data-validation="true"
           data-autocomplete="true"
           autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off">
    </div>
    <small class="form-text text-muted" style="margin-top: 0.25rem; font-size: 0.875rem;">
      <i class="fas fa-map-marker-alt me-1"></i>
      Enter the event location to find nearby service providers
    </small>
    <div class="error" id="locationError"></div>
    <label>Special Requests (optional)
      <textarea id="special_requests" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
    </label>
    <label>Budget Range</label>
    <input type="number" id="min_price" placeholder="Minimum Price" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off">
    <input type="number" id="max_price" placeholder="Maximum Price" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off">
  </div>

  <!-- Step 3: Service Details -->
  <div class="step" id="step-3">
    <h2><i class="fas fa-cogs me-2"></i>Select Services</h2>
    <div id="services-grid" class="services-grid"></div>
  </div>

  <!-- Step 4: Waiting for Quotations -->
  <div class="step" id="step-4" style="display:none;">
    <h2><i class="fas fa-hourglass-half me-2"></i>Waiting for Quotations</h2>
    <p class="text-muted mb-4">Service providers are currently reviewing your request and preparing their quotations. Please wait, this will update automatically.</p>

    <!-- Progress Bar -->
    <div class="progress-container mb-4">
      <div class="progress" style="height: 8px;">
        <div class="progress-bar" id="quotation-progress" role="progressbar" style="width: 0%">0%</div>
      </div>
    </div>

    <!-- Countdown Timer -->
    <div class="countdown-timer text-center p-4 bg-light rounded">
      <div class="timer-label mb-2">Expected Quotation Delivery</div>
      <div class="timer-display h2 text-primary mb-2" id="countdown-display">01:00:00</div>
      <div class="timer-description text-muted mb-3">Service providers typically respond within 1 minute (demo mode)</div>
      
      <div class="row text-center">
        <div class="col-4">
          <div class="time-stat">
            <span class="time-stat-value h5 text-primary d-block" id="elapsed-time">00:00</span>
            <span class="time-stat-label small text-muted">Elapsed</span>
          </div>
        </div>
        <div class="col-4">
          <div class="time-stat">
            <span class="time-stat-value h5 text-primary d-block" id="remaining-time">01:00</span>
            <span class="time-stat-label small text-muted">Remaining</span>
          </div>
        </div>
        <div class="col-4">
          <div class="time-stat">
            <span class="time-stat-value h5 text-primary d-block" id="progress-percent">0%</span>
            <span class="time-stat-label small text-muted">Progress</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Quotations Status -->
    <div class="quotations-status mt-4" id="quotations-status">
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>What's happening:</strong> Service providers are currently:
        <ul class="mb-0 mt-2">
          <li>Reviewing your job cart</li>
          <li>Preparing their quotations with pricing</li>
        </ul>
        You'll be notified once quotations are ready for review.
      </div>
    </div>

    <!-- View Quotations Button (hidden initially) -->
    <div class="text-center mt-4" id="view-quotations-section" style="display:none;">
      <button id="viewQuotationsBtn" class="btn btn-success btn-lg">
        <i class="fas fa-eye me-2"></i>View & Select Quotations
      </button>
    </div>
  </div>

  <!-- Step 5: Quotation Selection -->
  <div class="step" id="step-5" style="display:none;">
    <h2><i class="fas fa-file-invoice me-2"></i>Select Quotations</h2>
    <p class="text-muted mb-4">Review and select your preferred quotations from service providers.</p>
    <div id="quotations-selection-container"></div>
  </div>

  <!-- Step 6: Summary -->
  <div class="step" id="step-6" style="display:none;">
    <h2><i class="fas fa-check-circle me-2"></i>Booking Summary</h2>
    <div class="summary-card">
      <h3>Selected Quotations</h3>
      <div id="selected-quotations-summary"></div>
    </div>
    <div class="summary-card">
      <h3>Event Details</h3>
      <div id="event-summary"></div>
    </div>
    <div class="summary-card">
      <h3>Total Cost</h3>
      <div id="total-cost-summary"></div>
    </div>
  </div>

  <!-- Step 7: Payment -->
  <div class="step" id="step-7" style="display:none;">
    <h2><i class="fas fa-credit-card me-2"></i>Payment & Confirmation</h2>
    <p class="text-muted mb-4">Complete your payment to confirm your booking.</p>
    <div class="payment-container">
      <div class="payment-summary">
        <h4>Payment Summary</h4>
        <div id="payment-details"></div>
      </div>
      <div class="payment-form">
        <h4>Payment Information</h4>
        <div class="form-group">
          <label>Card Number</label>
          <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Expiry Date</label>
            <input type="text" id="expiry-date" placeholder="MM/YY" maxlength="5">
          </div>
          <div class="form-group">
            <label>CVV</label>
            <input type="text" id="cvv" placeholder="123" maxlength="3">
          </div>
        </div>
        <div class="form-group">
          <label>Cardholder Name</label>
          <input type="text" id="cardholder-name" placeholder="John Doe">
        </div>
        <button id="process-payment" class="btn btn-primary btn-lg w-100">
          <i class="fas fa-lock me-2"></i>Process Payment
        </button>
      </div>
    </div>
  </div>

  <!-- Step 8: Thank You -->
  <div class="step" id="step-8" style="display:none;">
    <div class="thank-you-container text-center">
      <div class="thank-you-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h2>Thank You for Your Booking!</h2>
      <p class="lead">Your booking has been confirmed and payment processed successfully.</p>
      
      <div class="confirmation-details">
        <div class="detail-item">
          <strong>Booking ID:</strong> <span id="booking-id-display"></span>
        </div>
        <div class="detail-item">
          <strong>Event Date:</strong> <span id="confirmed-event-date"></span>
        </div>
        <div class="detail-item">
          <strong>Total Amount:</strong> <span id="confirmed-total-amount"></span>
        </div>
      </div>

      <div class="next-steps">
        <h4>What happens next?</h4>
        <ul class="list-unstyled">
          <li><i class="fas fa-envelope me-2"></i>You'll receive a confirmation email shortly</li>
          <li><i class="fas fa-phone me-2"></i>Your service providers will contact you within 24 hours</li>
          <li><i class="fas fa-calendar-check me-2"></i>Final details will be confirmed before your event</li>
        </ul>
      </div>

      <div class="contact-info">
        <h5>Need help?</h5>
        <p>Contact us at <strong>support@bonica.co.za</strong> or <strong>+27 11 123 4567</strong></p>
      </div>

      <button class="btn btn-primary" onclick="window.location.href='dashboard.html'">
        <i class="fas fa-home me-2"></i>Back to Dashboard
      </button>
    </div>
  </div>

  <div class="buttons">
    <button id="prevBtn" onclick="prevStep()">Previous</button>
    <button id="nextBtn" onclick="nextStep()">Next</button>
  </div>
</div>

<!-- Job Cart Modal -->
<div id="cart-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center;">
  <div style="background:#fff; width:min(900px,95vw); max-height:90vh; overflow:auto; border-radius:12px; padding:20px; position:relative;">
    <button onclick="closeCartModal()" style="position:absolute; top:10px; right:10px; background:#6c757d;">Close</button>
    <h2>Jobcart_ID: <span id="cart-id"></span></h2>
    <div id="cart-list"></div>
    <hr>
    <div style="display:flex; justify-content:flex-end; gap:20px; align-items:center;">
      <strong id="cart-accepted-total">Accepted quotations total: R0.00</strong>
      <h3 id="cart-total" style="margin:0;">Total: R0.00</h3>
    </div>
    <div style="margin-top:18px; color:#555;">
      <div>Create Time: <span id="cart-time"></span></div>
      <div>Create Date: <span id="cart-date"></span></div>
    </div>
  </div>
</div>

<script>
// Supabase setup
const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Authentication
const clientId = localStorage.getItem("clientId");
if (!clientId) { 
    alert("You must be logged in!"); 
    window.location.href = "login.html"; 
}
localStorage.removeItem("totalAmount");

// Step navigation
let currentStep = 1;
let jobCart = [];
let selectedQuotations = {};
const steps = document.querySelectorAll('.step');
showStep(currentStep);

function showStep(n){
    steps.forEach((s,i)=>s.classList.toggle('active', i===n-1));
    document.getElementById('prevBtn').style.display = n===1?'none':'inline-block';
    document.getElementById('nextBtn').style.display = n>=steps.length?'none':'inline-block';
    
    if(n===3) {
        console.log('Loading services for step 3, current servicesList length:', servicesList.length);
        if (servicesList.length === 0) {
            console.log('No services loaded, loading from database...');
            loadServicesFromDatabase();
        } else {
            loadServicesGrid();
        }
    }
    if(n===4) {
        // Step 4: Waiting for quotations - start timer and generate fake quotations
        initializeWaitingInterface();
    }
    if(n===5) loadQuotationsForSelection();
    if(n===6) loadSummaryData();
    validateStep(n);
}

function startBooking(){ 
    currentStep=2; 
    showStep(currentStep);
}
function cancelBooking(){ window.location.href="index.html"; }
function prevStep(){ if(currentStep>1){ currentStep--; showStep(currentStep); } }
function nextStep(){ if(validateStep(currentStep)){ currentStep++; showStep(currentStep); } }
function goToStep(n){ currentStep=n; showStep(n); }
function toggleOtherEventInput(){ 
    document.getElementById("other-event-wrapper").style.display = document.getElementById("event_type").value==="other"?"block":"none"; 
}

// Step validation
function validateStep(step){
    let valid = true;
    if(step===2){
        const type=document.getElementById("event_type").value,
              date=document.getElementById("event_date").value,
              start=document.getElementById("start_time").value,
              end=document.getElementById("end_time").value,
              location=document.getElementById("location").value;
        
        // Clear any previous location errors
        const locationError = document.getElementById('locationError');
        if (locationError) {
            locationError.textContent = '';
        }
        
        if(!type||!date||!start||!end||!location) {
            valid=false;
        }
        
        // Basic location validation - just check if it's not empty
        if(location && location.trim().length === 0) {
            if (locationError) {
                locationError.textContent = 'Location is required';
            }
            valid = false;
        } else if (location && location.trim().length > 0) {
            // Clear any error messages when location has content
            if (locationError) {
                locationError.textContent = '';
            }
        }
    }
    if(step===3) if(jobCart.length===0) valid=false;
    if(step===4) valid=true; // Step 4 is waiting for quotations, always valid
    if(step===5) {
        // Check if quotations have been selected
        const selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
        const createdJobCarts = JSON.parse(localStorage.getItem('createdJobCarts') || '[]');
        valid = createdJobCarts.length > 0 && Object.keys(selectedQuotations).length === createdJobCarts.length;
    }
    document.getElementById('nextBtn').disabled = !valid;
    return valid;
}
document.querySelectorAll('#step-2 input, #step-2 select').forEach(el=>el.addEventListener('input', ()=>validateStep(2)));
document.getElementById('services-grid').addEventListener('change', ()=>validateStep(3));
document.getElementById('quotations-container').addEventListener('click', ()=>validateStep(4));

// Services list - will be loaded from database
let servicesList = [];

// Icon mapping for services
const serviceIconMap = {
  'MC': 'fa-microphone',
  'DJ': 'fa-music',
  'Makeup Artist': 'fa-face-smile',
  'Catering': 'fa-utensils',
  'Photography': 'fa-camera',
  'Decoration': 'fa-paint-roller',
  'Live Band': 'fa-guitar',
  'Venue': 'fa-building',
  'Florist': 'fa-seedling',
  'Lighting': 'fa-lightbulb',
  'Sound System': 'fa-volume-high',
  'Security': 'fa-shield',
  'Transport': 'fa-car',
  'Event Planner': 'fa-calendar-check',
  'Videography': 'fa-video',
  'Bartender': 'fa-glass-martini',
  'Host/Presenter': 'fa-user-tie',
  'Cake Designer': 'fa-birthday-cake',
  'Invitation Design': 'fa-envelope',
  'Furniture Rental': 'fa-couch'
};

// Enhanced service loading with fallback data
async function loadServicesFromDatabase() {
    try {
        console.log('🔄 Loading services from database...');
        
        const { data: services, error } = await sb
            .from('service')
            .select('service_id, service_name, service_type, service_description')
            .order('service_name');

        if (error) {
            console.error('❌ Database error:', error);
            // Fallback to sample services if database fails
            servicesList = getSampleServices();
            console.log('✅ Using sample services as fallback');
        } else if (services && services.length > 0) {
            // Map services with icons
            servicesList = services.map(service => ({
                service_id: service.service_id,
                service_name: service.service_name,
                service_type: service.service_type,
                service_description: service.service_description,
                icon: serviceIconMap[service.service_name] || 'fa-cog'
            }));
            console.log('✅ Services loaded from database:', servicesList.length);
        } else {
            // If no services in database, use sample data
            servicesList = getSampleServices();
            console.log('✅ Using sample services (empty database)');
        }
        
        // Always refresh the grid when services are loaded
        loadServicesGrid();
        
    } catch (error) {
        console.error('❌ Error loading services:', error);
        servicesList = getSampleServices();
        loadServicesGrid();
    }
}

// Sample services as fallback
function getSampleServices() {
  return [
    { service_id: 1, service_name: 'MC', icon: 'fa-microphone' },
    { service_id: 2, service_name: 'DJ', icon: 'fa-music' },
    { service_id: 3, service_name: 'Makeup Artist', icon: 'fa-face-smile' },
    { service_id: 4, service_name: 'Catering', icon: 'fa-utensils' },
    { service_id: 5, service_name: 'Photography', icon: 'fa-camera' },
    { service_id: 6, service_name: 'Decoration', icon: 'fa-paint-roller' },
    { service_id: 7, service_name: 'Live Band', icon: 'fa-guitar' },
    { service_id: 8, service_name: 'Venue', icon: 'fa-building' },
    { service_id: 9, service_name: 'Florist', icon: 'fa-seedling' },
    { service_id: 10, service_name: 'Lighting', icon: 'fa-lightbulb' },
    { service_id: 11, service_name: 'Sound System', icon: 'fa-volume-high' },
    { service_id: 12, service_name: 'Security', icon: 'fa-shield' },
    { service_id: 13, service_name: 'Transport', icon: 'fa-car' },
    { service_id: 14, service_name: 'Event Planner', icon: 'fa-calendar-check' },
    { service_id: 15, service_name: 'Videography', icon: 'fa-video' },
    { service_id: 16, service_name: 'Bartender', icon: 'fa-glass-martini' },
    { service_id: 17, service_name: 'Host/Presenter', icon: 'fa-user-tie' },
    { service_id: 18, service_name: 'Cake Designer', icon: 'fa-birthday-cake' },
    { service_id: 19, service_name: 'Invitation Design', icon: 'fa-envelope' },
    { service_id: 20, service_name: 'Furniture Rental', icon: 'fa-couch' }
  ];
}

// Render services grid
function loadServicesGrid(){ 
    renderServicesGrid(servicesList); 
}

// Manual test function - run this in browser console if services don't show
function testServicesLoad() {
    console.log('🧪 Testing services load...');
    console.log('Current servicesList:', servicesList);
    console.log('Current step:', currentStep);
    
    if (servicesList.length === 0) {
        console.log('No services in memory, loading...');
        loadServicesFromDatabase();
    } else {
        console.log('Services already loaded, rendering...');
        loadServicesGrid();
    }
    
    // Force show step 3 for testing
    if (currentStep !== 3) {
        console.log('Switching to step 3 for testing...');
        currentStep = 3;
        showStep(3);
    }
}
// Enhanced service grid rendering
function renderServicesGrid(list) {
    const container = document.getElementById("services-grid"); 
    container.innerHTML = "";
    
    if (!list || list.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h4>No Services Available</h4>
                <p class="text-muted">Please try refreshing the page or contact support.</p>
            </div>
        `;
        return;
    }
    
    list.forEach(service => {
        const isSelected = jobCart.some(item => item.service_id === service.service_id);
        
        const card = document.createElement("div"); 
        card.className = `service-card text-center ${isSelected ? 'selected' : ''}`;
        card.onclick = () => toggleServiceSelection(service.service_id, card);
        
        card.innerHTML = `
            <div class="service-icon">
                <i class="fas ${service.icon} fa-3x text-primary mb-3"></i>
            </div>
            <h5 class="service-title">${service.service_name}</h5>
            <div class="service-select">
                <label class="service-checkbox">
                    <input type="checkbox" value="${service.service_id}" 
                           ${isSelected ? 'checked' : ''} 
                           onchange="previewCart()">
                    <span class="checkmark"></span>
                    Select Service
                </label>
            </div>
        `;
        container.appendChild(card);
    });
    
    console.log('✅ Services grid rendered with', list.length, 'services');
}

// Toggle service selection when card is clicked
function toggleServiceSelection(serviceId, card) {
    const checkbox = card.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        card.classList.add('selected');
    } else {
        card.classList.remove('selected');
    }
    
    // Trigger cart preview update
    previewCart();
}

// Enhanced service selection
function toggleServiceSelection(serviceId, card) {
    const checkbox = card.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    checkbox.dispatchEvent(new Event('change'));
}

function previewCart() {
    const checkedBoxes = document.querySelectorAll('#services-grid input[type="checkbox"]:checked');
    const checkedIds = new Set(Array.from(checkedBoxes).map(cb => cb.value));
    
    // Add new services to cart
    servicesList.forEach(service => {
        if (checkedIds.has(service.service_id.toString()) && 
            !jobCart.find(item => item.service_id.toString() === service.service_id.toString())) {
            jobCart.push({
                service_id: service.service_id,
                service_name: service.service_name
            });
        }
    });
    
    // Remove unchecked services
    jobCart = jobCart.filter(item => checkedIds.has(item.service_id.toString()));
    
    // Update UI
    updateCartUI();
    updateCardSelectionStates();
    validateStep(3);
}

function updateCardSelectionStates() {
    const cards = document.querySelectorAll('.service-card');
    cards.forEach(card => {
        const checkbox = card.querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });
}
function updateCartUI(){
    document.getElementById("cart-count").innerText = jobCart.length;
    const list = document.getElementById("cart-items"); list.innerHTML = "";
    if(jobCart.length===0){ 
        const li=document.createElement("li"); li.innerText="Cart is empty"; list.appendChild(li);
    } else { 
        jobCart.forEach(item=>{
            const li=document.createElement("li"); li.innerText=item.service_name; list.appendChild(li);
        });
    }
}

// Sample providers with location information
const sampleProviders = [
    {
        name:"Alice", 
        surname:"Mokoena", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"Rose Street", 
        houseNo:"12", 
        postalCode:"2001", 
        contact:"0821234567", 
        email:"alice@example.com",
        location:"12 Rose Street, Johannesburg, Gauteng, 2001",
        rating: 4.8
    },
    {
        name:"Thabo", 
        surname:"Dlamini", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"Oak Avenue", 
        houseNo:"34", 
        postalCode:"2002", 
        contact:"0822345678", 
        email:"thabo@example.com",
        location:"34 Oak Avenue, Johannesburg, Gauteng, 2002",
        rating: 4.6
    },
    {
        name:"Sipho", 
        surname:"Nkosi", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"Maple Lane", 
        houseNo:"56", 
        postalCode:"2003", 
        contact:"0833456789", 
        email:"sipho@example.com",
        location:"56 Maple Lane, Johannesburg, Gauteng, 2003",
        rating: 4.9
    },
    {
        name:"Lindiwe", 
        surname:"Mthembu", 
        city:"Johannesburg", 
        province:"Gauteng", 
        street:"King Road", 
        houseNo:"78", 
        postalCode:"2004", 
        contact:"0844567890", 
        email:"lindiwe@example.com",
        location:"78 King Road, Johannesburg, Gauteng, 2004",
        rating: 4.7
    },
    {
        name:"Mandla", 
        surname:"Khumalo", 
        city:"Pretoria", 
        province:"Gauteng", 
        street:"Church Street", 
        houseNo:"45", 
        postalCode:"0002", 
        contact:"0855678901", 
        email:"mandla@example.com",
        location:"45 Church Street, Pretoria, Gauteng, 0002",
        rating: 4.5
    },
    {
        name:"Nomsa", 
        surname:"Mthembu", 
        city:"Sandton", 
        province:"Gauteng", 
        street:"Rivonia Road", 
        houseNo:"123", 
        postalCode:"2196", 
        contact:"0866789012", 
        email:"nomsa@example.com",
        location:"123 Rivonia Road, Sandton, Gauteng, 2196",
        rating: 4.8
    }
];

// Load quotations with proper filtering and 30-minute notification
function loadQuotations(){
    const container = document.getElementById("quotations-container");
    const waitMessage = document.getElementById("quotation-wait-message");
    if(jobCart.length===0){ container.innerHTML="<p>No services selected.</p>"; waitMessage.style.display="none"; return; }
    
    // Show notification about 30-minute quotation process
    waitMessage.style.display="block"; 
    waitMessage.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Quotation Process:</strong> Service providers have 30 minutes to review your job cart and submit their quotations. 
            You'll receive an email notification once all quotations are ready.
        </div>
        <p class="text-center">Filtering service providers based on your requirements...</p>
    `;
    
    // Show quotations immediately with proper filtering
    setTimeout(() => {
        waitMessage.style.display="none";
        showQuotations(container);
    }, 2000); // 2 second delay to show the message
}

// Display quotations with location-based matching
async function showQuotations(container){
    container.innerHTML="";
    
    // Get client location
    const clientLocation = document.getElementById("location").value.trim();
    let locationInfo = "";
    
    if (clientLocation && window.locationService) {
        try {
            // Initialize location service if not already done
            if (!window.locationService.geocoder) {
                await window.locationService.initialize();
            }
            
            // Try to geocode the client location for distance calculations
            const clientCoords = await window.locationService.geocodeAddress(clientLocation);
            locationInfo = `📍 ${clientCoords.address}`;
        } catch (error) {
            console.warn("Could not geocode client location:", error);
            locationInfo = `📍 ${clientLocation}`;
        }
    }

    // Load quotations for each service in the cart
    for (const item of jobCart) {
        await loadQuotationsForService(item, container, clientLocation, locationInfo);
    }
}

// Filter service providers based on availability, time, price, and location
async function filterServiceProviders(providers, eventDate, startTime, endTime, minPrice, maxPrice, clientLocation) {
    const filteredProviders = [];
    
    for (const provider of providers) {
        let isAvailable = true;
        const reasons = [];
        
        // 1. Check if provider's base price falls within client's range
        const providerBasePrice = parseFloat(provider.service_provider_base_price) || 0;
        if (providerBasePrice < minPrice || providerBasePrice > maxPrice) {
            isAvailable = false;
            reasons.push(`Price range (R${providerBasePrice}) outside client range (R${minPrice}-R${maxPrice})`);
        }
        
        // 2. Check day availability (if event date is provided)
        if (eventDate) {
            const eventDay = new Date(eventDate).getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[eventDay];
            
            // Check if provider is available on this day
            // This would need to be implemented based on your availability schema
            // For now, we'll assume all providers are available on weekends (Saturday, Sunday)
            if (eventDay !== 0 && eventDay !== 6) { // Not weekend
                // You could add logic here to check provider's weekday availability
                // For example: if (!provider.weekday_available) { isAvailable = false; }
            }
        }
        
        // 3. Check operating hours (if time is provided)
        if (startTime && endTime) {
            const startHour = parseInt(startTime.split(':')[0]);
            const endHour = parseInt(endTime.split(':')[0]);
            
            // Assume providers operate 8 AM to 10 PM (you can customize this)
            const operatingStart = 8;
            const operatingEnd = 22;
            
            if (startHour < operatingStart || endHour > operatingEnd) {
                isAvailable = false;
                reasons.push(`Event time (${startTime}-${endTime}) outside operating hours (${operatingStart}:00-${operatingEnd}:00)`);
            }
        }
        
        // 4. Check location proximity (if location is provided)
        if (clientLocation && provider.service_provider_location) {
            // Calculate distance between client and provider locations
            // This is a simplified version - you'd use proper geocoding in production
            const distance = calculateDistance(clientLocation, provider.service_provider_location);
            const maxDistance = 50; // 50km radius
            
            if (distance > maxDistance) {
                isAvailable = false;
                reasons.push(`Location too far (${distance.toFixed(1)}km > ${maxDistance}km)`);
            }
        }
        
        // 5. Check if provider is verified and active
        if (!provider.service_provider_verification) {
            isAvailable = false;
            reasons.push('Provider not verified');
        }
        
        if (isAvailable) {
            filteredProviders.push(provider);
        } else {
            console.log(`Provider ${provider.service_provider_name} filtered out: ${reasons.join(', ')}`);
        }
    }
    
    // Sort by rating (highest first) and then by price (lowest first)
    return filteredProviders.sort((a, b) => {
        const ratingA = parseFloat(a.service_provider_rating) || 0;
        const ratingB = parseFloat(b.service_provider_rating) || 0;
        const priceA = parseFloat(a.service_provider_base_price) || 0;
        const priceB = parseFloat(b.service_provider_base_price) || 0;
        
        if (ratingA !== ratingB) {
            return ratingB - ratingA; // Higher rating first
        }
        return priceA - priceB; // Lower price first
    });
}

// Simple distance calculation (you should use proper geocoding in production)
function calculateDistance(location1, location2) {
    // This is a simplified distance calculation
    // In production, you'd use Google Maps API or similar
    return Math.floor(Math.random() * 30) + 1; // 1-30 km for demo
}

// Load quotations for a specific service from database
async function loadQuotationsForService(serviceItem, container, clientLocation, locationInfo) {
    try {
        // Find the service in our loaded services list to get the service_id
        const service = servicesList.find(s => s.service_name === serviceItem.service_name);
        if (!service) {
            console.warn('Service not found:', serviceItem.service_name);
            return;
        }

        // Get service providers for this specific service
        const { data: serviceProviders, error } = await sb
            .from('service_provider')
            .select('*')
            .eq('service_id', service.service_id)
            .eq('service_provider_verification', true); // Only verified providers

        if (error) {
            console.error('Error loading service providers:', error);
            return;
        }

        if (!serviceProviders || serviceProviders.length === 0) {
            // Show message if no providers found for this service
            const noProvidersCard = document.createElement("div");
            noProvidersCard.className = "quotation-card";
            noProvidersCard.innerHTML = `
                <div class="quotation-header">
                    <span class="service-name">${serviceItem.service_name}</span>
                    <span class="provider-info">No providers available</span>
                </div>
                <div class="quotation-details">
                    <div class="rating">No verified providers found for this service</div>
                </div>
            `;
            container.appendChild(noProvidersCard);
            return;
        }

        // Get client requirements for filtering
        const eventDate = document.getElementById("date").value;
        const startTime = document.getElementById("start_time").value;
        const endTime = document.getElementById("end_time").value;
        const minPrice = parseInt(document.getElementById("min_price").value) || 500;
        const maxPrice = parseInt(document.getElementById("max_price").value) || 5000;
        
        // Filter service providers based on requirements
        const filteredProviders = await filterServiceProviders(
            serviceProviders, 
            eventDate, 
            startTime, 
            endTime, 
            minPrice, 
            maxPrice, 
            clientLocation
        );
        
        // Show up to 3 quotations for this service
        const providersToShow = filteredProviders.slice(0, 3);
        
        providersToShow.forEach(provider => {
            const price = Math.floor(Math.random()*(maxPrice-minPrice+1))+minPrice;
            const quotationID = `Q${Math.floor(Math.random()*10000)}`;
            const jobCartID = `JC${Math.floor(Math.random()*1000)}`;
            const submissionDate = new Date();
            
            // Calculate distance if location is available
            let distanceInfo = "";
            if (clientLocation && provider.service_provider_location) {
                // Simulate distance calculation (in real implementation, use locationService.calculateDistance)
                const distance = Math.floor(Math.random() * 25) + 1; // 1-25 km
                distanceInfo = ` | 📍 ${distance}km away`;
            }
            
            const card = document.createElement("div"); 
            card.className = "quotation-card"; 
            card.innerHTML = `
                <div class="quotation-header">
                    <span class="service-name">${serviceItem.service_name} - R${price}</span>
                    <span class="provider-info">${provider.service_provider_name} ${provider.service_provider_surname}${distanceInfo}</span>
                </div>
                <div class="quotation-details">
                    <div class="rating">⭐ ${provider.service_provider_rating || 5}/5</div>
                    <div class="location-info">${locationInfo}</div>
                </div>
            `;
            
            const acceptBtn = document.createElement("button"); 
            acceptBtn.innerText="Accept";
            acceptBtn.className = "btn-accept";
            
            const rejectBtn = document.createElement("button"); 
            rejectBtn.innerText="Reject";
            rejectBtn.className = "btn-reject";
            
            const viewBtn = document.createElement("button"); 
            viewBtn.innerText="View Details";
            viewBtn.className = "btn-view";

            acceptBtn.onclick = () => {
                selectedQuotations[serviceItem.service_id] = {
                    service_name: serviceItem.service_name, 
                    service_id: service.service_id,
                    price, 
                    provider: provider, 
                    quotationID, 
                    jobCartID, 
                    submissionDate,
                    distance: distanceInfo
                };
                calculateTotal();
                const allCards = Array.from(container.querySelectorAll('.quotation-card'));
                allCards.forEach(c=>{
                    const serviceName = c.querySelector('.service-name');
                    const btns = c.querySelectorAll('button');
                    if(serviceName && serviceName.innerText.startsWith(serviceItem.service_name)){
                        if(c===card){ 
                            c.classList.add("accepted"); 
                            rejectBtn.disabled=true; 
                            viewBtn.disabled=true;
                        } else { 
                            c.classList.add("rejected"); 
                            btns.forEach(b=>b.disabled=true); 
                        }
                    }
                });
                validateStep(4);
            };
            
            rejectBtn.onclick = () => { 
                card.classList.add("rejected"); 
                acceptBtn.disabled=true; 
                viewBtn.disabled=true;
                validateStep(4); 
            };
            
            viewBtn.onclick = () => generatePDF({
                service_name: serviceItem.service_name, 
                service_id: service.service_id,
                price, 
                provider: provider, 
                quotationID, 
                jobCartID, 
                submissionDate,
                distance: distanceInfo
            });

            const buttonContainer = document.createElement("div");
            buttonContainer.className = "quotation-buttons";
            buttonContainer.appendChild(acceptBtn); 
            buttonContainer.appendChild(rejectBtn); 
            buttonContainer.appendChild(viewBtn);
            
            card.appendChild(buttonContainer);
            container.appendChild(card);
    });
    } catch (error) {
        console.error('Error loading quotations for service:', error);
    }
}

// Calculate totals
function calculateTotal(){
    let total = 0;
    for(const key in selectedQuotations) total += selectedQuotations[key].price;
    document.getElementById("cart-total").innerText = `Total: R${total}`;
    document.getElementById("cart-accepted-total").innerText = `Accepted quotations total: R${total}`;
}

// Load summary
function loadSummary(){
    const container=document.getElementById("summary-container"); container.innerHTML="";
    if(Object.keys(selectedQuotations).length===0){ container.innerHTML="<p>No quotations accepted yet.</p>"; return; }
    const totalAmount=Object.values(selectedQuotations).reduce((sum,q)=>sum+q.price,0);
    Object.values(selectedQuotations).forEach(q=>{
        const div=document.createElement("div"); div.className="summary-card"; 
        div.innerHTML=`
            <p><strong>Service:</strong> ${q.service_name}</p>
            <p><strong>Price:</strong> R${q.price}</p>
            <p><strong>Provider Name:</strong> ${q.provider.name} ${q.provider.surname}</p>
            <p><strong>Contact:</strong> ${q.provider.contact}</p>
            <p><strong>Email:</strong> ${q.provider.email||''}</p>
            <p><strong>Address:</strong> ${q.provider.houseNo}, ${q.provider.street}, ${q.provider.city}, ${q.provider.province}, ${q.provider.postalCode}</p>
            <button class="pdf-btn">View PDF</button>
        `;
        container.appendChild(div);
        div.querySelector(".pdf-btn").onclick=()=>generatePDF(q);
    });
    const totalEl=document.createElement("p"); totalEl.innerHTML=`<strong>Total: R${totalAmount}</strong>`; container.appendChild(totalEl);
}

// Generate PDF
function generatePDF(quotation){
    const { service_name, price, provider, quotationID, jobCartID, submissionDate }=quotation;
    const doc = new jspdf.jsPDF();
    doc.setFontSize(18); doc.text("Quotation Details",14,20);
    doc.setFontSize(12);
    doc.text(`Quotation ID: ${quotationID}`,14,30);
    doc.text(`Job Cart ID: ${jobCartID}`,14,37);
    doc.text(`Submission Date: ${submissionDate.toLocaleString()}`,14,44);
    doc.text(`Service: ${service_name}`,14,55);
    doc.text(`Price: R${price}`,14,62);
    doc.text("Provider Information:",14,74);
    doc.text(`Name: ${provider.name} ${provider.surname}`,14,81);
    doc.text(`Contact: ${provider.contact}`,14,88);
    doc.text(`Email: ${provider.email||''}`,14,95);
    doc.text(`Address: ${provider.houseNo}, ${provider.street}, ${provider.city}, ${provider.province}, ${provider.postalCode}`,14,102);
    doc.save(`${service_name}_Quotation.pdf`);
}

// Confirm booking

async function confirmBooking() {
    if (Object.keys(selectedQuotations).length === 0) {
        alert("Please accept at least one quotation before continuing.");
        return;
    }

    const totalAmount = Object.values(selectedQuotations).reduce((sum, q) => sum + q.price, 0);
    localStorage.setItem("totalAmount", totalAmount);

    try {
        // 1️⃣ Insert event first (matching actual schema)
        const { data: eventData, error: eventError } = await sb.from('event').insert({
            event_type: document.getElementById('event_type').value,
            event_date: document.getElementById('event_date').value,
            event_start_time: document.getElementById('start_time').value,
            event_end_time: document.getElementById('end_time').value,
            event_location: document.getElementById('location').value
        }).select();

        if (eventError) {
            console.error('❌ Event creation failed:', eventError);
            throw new Error(`Event creation failed: ${eventError.message}`);
        }
        
        const eventId = eventData[0].event_id;
        console.log('✅ Event created successfully with ID:', eventId);

        // 2️⃣ Insert booking linked to the event (matching actual schema)
        const bookingLocation = document.getElementById('location').value.trim();
        console.log('📍 Booking location:', bookingLocation);
        
        const { data: bookingData, error: bookingError } = await sb.from('booking').insert({
            client_id: clientId,
            event_id: eventId, // now valid
            booking_date: document.getElementById('event_date').value, // Use event date as booking date
            booking_min_price: parseFloat(document.getElementById('min_price').value) || 0,
            booking_max_price: parseFloat(document.getElementById('max_price').value) || 0,
            booking_special_requests: document.getElementById('special_requests').value,
            booking_location: bookingLocation, // ✅ Store location in booking table
            booking_status: 'pending'
        }).select();

        if (bookingError) {
            console.error('❌ Booking creation failed:', bookingError);
            throw new Error(`Booking creation failed: ${bookingError.message}`);
        }
        
        console.log('✅ Booking created successfully with ID:', bookingData[0].booking_id);

        // 3️⃣ Create job carts for ALL service providers of each selected service
        // Multiple service providers can accept the same job cart (not first-come-first-served)
        const jobCartRecords = [];
        
        for (const quotation of Object.values(selectedQuotations)) {
            // Get ALL service providers for this service type
            const { data: serviceProviders, error: providersError } = await sb
                .from('service_provider')
                .select('service_provider_id, service_id, service_provider_name, service_provider_surname')
                .eq('service_id', quotation.service_id)
                .eq('service_provider_verification', true);

            if (providersError) {
                console.error('Error fetching service providers:', providersError);
                continue;
            }

            // Create ONE job cart for this service, but make it available to ALL providers
            const eventType = document.getElementById('event_type').value;
            const eventDate = document.getElementById('event_date').value;
            const eventLocation = bookingLocation;
            
            const jobCartRecord = {
                event_id: eventId,
                client_id: clientId,  // ✅ Link to client table
                service_id: quotation.service_id,  // ✅ Link to service table
                job_cart_item: quotation.service_name,
                job_cart_details: `Service: ${quotation.service_name} for ${eventType} event on ${eventDate} at ${eventLocation}. Available to all ${serviceProviders.length} verified ${quotation.service_name} providers.`,
                job_cart_created_date: new Date().toISOString().split('T')[0],
                job_cart_created_time: new Date().toTimeString().split(' ')[0],
                job_cart_status: 'pending' // Use 'pending' to match schema default
            };
            
            jobCartRecords.push(jobCartRecord);
            console.log(`✅ Created job cart for service_id: ${quotation.service_id} (${quotation.service_name})`);
        }

        if (jobCartRecords.length > 0) {
            const { data: jobCartData, error: jobCartError } = await sb
                .from('job_cart')
                .insert(jobCartRecords)
                .select();

            if (jobCartError) throw new Error(jobCartError.message);
            console.log('✅ Job carts created for all service providers:', jobCartData.length);
            
            // Store job cart IDs for later reference
            localStorage.setItem('createdJobCarts', JSON.stringify(jobCartData.map(jc => jc.job_cart_id)));
        }

        // 4️⃣ Insert event_service junction records for selected services
        const eventServiceRecords = Object.values(selectedQuotations).map(quotation => ({
            event_id: eventId,
            service_id: quotation.service_id,
            event_service_notes: `Selected service: ${quotation.service_name}`,
            event_service_status: 'confirmed'
        }));

        if (eventServiceRecords.length > 0) {
            const { data: eventServiceData, error: eventServiceError } = await sb
                .from('event_service')
                .insert(eventServiceRecords)
                .select();

            if (eventServiceError) throw new Error(eventServiceError.message);
            console.log('✅ Event-service links created:', eventServiceData.length);
        }

        // ✅ Show confirmation and go to waiting step
        const msg = document.getElementById('redirect-message');
        msg.innerText = "Booking confirmed! Generating quotations...";
        msg.style.display = 'block';
        document.getElementById("confirm-booking").disabled = true;

        setTimeout(() => {
            currentStep = 4;
            showStep(currentStep);
            initializeWaitingInterface();
        }, 2000);

    } catch (error) {
        alert("Booking failed: " + error.message);
    }
}

// Initialize waiting interface with timer
function initializeWaitingInterface() {
    // Timer variables
    let timerInterval = null;
    let startTime = null;
    let expectedDuration = 1 * 60 * 1000; // 1 minute in milliseconds for demo
    let quotationsReceived = 0;

    // Start the timer
    startTime = new Date();
    startTimer();
    
    // Generate fake quotations for services
    generateFakeQuotationsForServices();

    function startTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // Call immediately to avoid 1-second delay
    }

    function updateTimer() {
        const currentTime = new Date();
        const elapsedMs = currentTime - startTime;
        const remainingMs = Math.max(0, expectedDuration - elapsedMs);

        updateCountdownDisplay(remainingMs);
        updateElapsedTime(elapsedMs);
        updateTimerProgress(elapsedMs);

        if (remainingMs === 0) {
            handleTimeExpired();
        }
    }

    function updateCountdownDisplay(remainingMs) {
        const totalSeconds = Math.floor(remainingMs / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const formattedTime = [hours, minutes, seconds]
            .map(unit => String(unit).padStart(2, '0'))
            .join(':');

        document.getElementById('countdown-display').textContent = formattedTime;
    }

    function updateElapsedTime(elapsedMs) {
        const totalSeconds = Math.floor(elapsedMs / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        document.getElementById('elapsed-time').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function updateTimerProgress(elapsedMs) {
        const progressPercent = Math.min(100, (elapsedMs / expectedDuration) * 100);
        document.getElementById('progress-percent').textContent = `${Math.round(progressPercent)}%`;
        document.getElementById('quotation-progress').style.width = `${progressPercent}%`;
    }

    function handleTimeExpired() {
        clearInterval(timerInterval);
        document.getElementById('countdown-display').textContent = '00:00:00';
        document.getElementById('view-quotations-section').style.display = 'block';
        
        // Update status message
        document.getElementById('quotations-status').innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Quotations Ready!</strong> All quotations have been generated. Click below to view and select your preferred service providers.
            </div>
        `;
    }

    // Generate quotations for each service
    async function generateQuotationsForServices() {
        try {
            const createdJobCarts = localStorage.getItem('createdJobCarts');
            if (!createdJobCarts) return;

            const jobCartIds = JSON.parse(createdJobCarts);
            const totalQuotations = jobCartIds.length * 3; // 3 quotations per service
            
            // Simulate quotation generation over the 1-minute period
            const quotationInterval = (expectedDuration / totalQuotations);
            let generatedCount = 0;

            const generateInterval = setInterval(() => {
                if (generatedCount < totalQuotations) {
                    // Show notification
                    showNotification('🔍 A service provider is reviewing a job cart...', 'info', 2000);
                    
                    setTimeout(() => {
                        showNotification('⬆️ A service provider is uploading a quotation...', 'info', 2000);
                        quotationsReceived++;
                        updateProgressBar();
                        generatedCount++;
                    }, 1000);
                } else {
                    clearInterval(generateInterval);
                }
            }, quotationInterval);

        } catch (error) {
            console.error('Error generating quotations:', error);
        }
    }

    // Generate fake quotations for services (simpler version)
    async function generateFakeQuotationsForServices() {
        try {
            console.log('🎭 Generating fake quotations for services...');
            
            // Get event details for quotation generation
            const eventType = document.getElementById('event_type').value;
            const eventDate = document.getElementById('event_date').value;
            const eventLocation = document.getElementById('location').value;
            const minPrice = parseInt(document.getElementById('min_price').value) || 500;
            const maxPrice = parseInt(document.getElementById('max_price').value) || 5000;
            
            // Get selected services from job cart
            const selectedServices = jobCart;
            
            // Generate fake quotations for each service
            for (const service of selectedServices) {
                await generateFakeQuotationsForService(service, eventType, eventDate, eventLocation, minPrice, maxPrice);
            }
            
            console.log('✅ Fake quotations generated successfully');
        } catch (error) {
            console.error('❌ Error generating fake quotations:', error);
        }
    }

    // Generate fake quotations for a specific service
    async function generateFakeQuotationsForService(service, eventType, eventDate, eventLocation, minPrice, maxPrice) {
        try {
            // Get job cart for this service
            const { data: jobCarts, error } = await supabase
                .from('job_cart')
                .select('job_cart_id')
                .eq('job_cart_item', service.service_name)
                .eq('client_id', clientId)
                .limit(1);

            if (error || !jobCarts || jobCarts.length === 0) {
                console.error('Error finding job cart for service:', service.service_name);
                return;
            }

            const jobCartId = jobCarts[0].job_cart_id;

            // Generate 3 fake quotations for this service
            const fakeProviders = [
                {
                    name: 'Sarah',
                    surname: 'Johnson',
                    email: 'sarah.johnson@email.com',
                    phone: '0821234567',
                    rating: 4.8,
                    location: 'Sandton, Johannesburg'
                },
                {
                    name: 'Michael',
                    surname: 'Brown',
                    email: 'michael.brown@email.com',
                    phone: '0832345678',
                    rating: 4.6,
                    location: 'Rosebank, Johannesburg'
                },
                {
                    name: 'Emma',
                    surname: 'Davis',
                    email: 'emma.davis@email.com',
                    phone: '0843456789',
                    rating: 4.9,
                    location: 'Melville, Johannesburg'
                }
            ];

            for (let i = 0; i < 3; i++) {
                const provider = fakeProviders[i];
                const price = Math.floor(Math.random() * (maxPrice - minPrice + 1)) + minPrice;
                
                const quotationData = {
                    job_cart_id: jobCartId,
                    service_provider_id: `fake-provider-${i + 1}`,
                    quotation_price: price,
                    quotation_details: `Professional ${service.service_name} services for your ${eventType} event on ${eventDate} at ${eventLocation}. Our experienced team will ensure your event is memorable and successful.`,
                    quotation_status: 'pending',
                    quotation_submission_date: new Date().toISOString().split('T')[0],
                    quotation_submission_time: new Date().toTimeString().split(' ')[0]
                };

                // Insert fake quotation into database
                const { error: quotationError } = await supabase
                    .from('quotation')
                    .insert(quotationData);

                if (quotationError) {
                    console.error('Error inserting fake quotation:', quotationError);
                } else {
                    console.log(`✅ Generated fake quotation ${i + 1} for ${service.service_name} - R${price}`);
                }
            }

        } catch (error) {
            console.error('Error generating fake quotations for service:', error);
        }
    }

    // Helper functions for fake provider data
    function getFakeProviderName(providerId) {
        const providers = ['Sarah', 'Michael', 'Emma'];
        const index = parseInt(providerId.split('-')[2]) - 1;
        return providers[index] || 'Provider';
    }

    function getFakeProviderSurname(providerId) {
        const surnames = ['Johnson', 'Brown', 'Davis'];
        const index = parseInt(providerId.split('-')[2]) - 1;
        return surnames[index] || 'Smith';
    }

    function getFakeProviderEmail(providerId) {
        const emails = ['sarah.johnson@email.com', 'michael.brown@email.com', 'emma.davis@email.com'];
        const index = parseInt(providerId.split('-')[2]) - 1;
        return emails[index] || 'provider@email.com';
    }

    function getFakeProviderPhone(providerId) {
        const phones = ['0821234567', '0832345678', '0843456789'];
        const index = parseInt(providerId.split('-')[2]) - 1;
        return phones[index] || '0800000000';
    }

    function getFakeProviderRating(providerId) {
        const ratings = [4.8, 4.6, 4.9];
        const index = parseInt(providerId.split('-')[2]) - 1;
        return ratings[index] || 5.0;
    }

    function updateProgressBar() {
        const createdJobCarts = localStorage.getItem('createdJobCarts');
        if (!createdJobCarts) return;
        
        const jobCartIds = JSON.parse(createdJobCarts);
        const totalExpected = jobCartIds.length * 3;
        const progress = (quotationsReceived / totalExpected) * 100;
        
        document.getElementById('quotation-progress').style.width = `${progress}%`;
        document.getElementById('quotation-progress').textContent = `${Math.round(progress)}%`;
    }

    // Handle view quotations button click
    document.getElementById('viewQuotationsBtn').addEventListener('click', function() {
        currentStep = 5;
        showStep(currentStep);
        loadQuotationsForSelection();
    });

    function showNotification(message, type, duration = 3000) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 400px;
        `;
        
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after duration
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, duration);
    }
}

// Load quotations for selection (Step 4)
async function loadQuotationsForSelection() {
    try {
        const createdJobCarts = localStorage.getItem('createdJobCarts');
        if (!createdJobCarts) {
            document.getElementById('quotations-selection-container').innerHTML = 
                '<div class="alert alert-warning">No job carts found. Please start over.</div>';
            return;
        }

        const jobCartIds = JSON.parse(createdJobCarts);
        const container = document.getElementById('quotations-selection-container');
        container.innerHTML = '';

        // Generate fake quotations for each selected service
        await generateFakeQuotationsForServices();

        // Load and display quotations
        for (const jobCartId of jobCartIds) {
            const { data: quotations, error } = await supabase
                .from('quotation')
                .select(`
                    *,
                    job_cart:job_cart_id (
                        job_cart_item
                    )
                `)
                .eq('job_cart_id', jobCartId)
                .eq('quotation_status', 'pending');

            if (error) {
                console.error('Error loading quotations:', error);
                continue;
            }

            if (quotations && quotations.length > 0) {
                // Add fake provider data to quotations since we're using fake providers
                const quotationsWithProviders = quotations.map(quotation => ({
                    ...quotation,
                    service_provider: {
                        service_provider_name: getFakeProviderName(quotation.service_provider_id),
                        service_provider_surname: getFakeProviderSurname(quotation.service_provider_id),
                        service_provider_email: getFakeProviderEmail(quotation.service_provider_id),
                        service_provider_phone: getFakeProviderPhone(quotation.service_provider_id),
                        service_provider_rating: getFakeProviderRating(quotation.service_provider_id)
                    }
                }));
                
                const serviceGroup = createServiceGroup(jobCartId, quotationsWithProviders);
                container.appendChild(serviceGroup);
            }
        }

        if (container.children.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No quotations available yet. Please wait for service providers to submit their quotations.</div>';
        }

    } catch (error) {
        console.error('Error loading quotations for selection:', error);
        document.getElementById('quotations-selection-container').innerHTML = 
            '<div class="alert alert-danger">Error loading quotations. Please try again.</div>';
    }
}

// Create service group with quotations
function createServiceGroup(jobCartId, quotations) {
    const group = document.createElement('div');
    group.className = 'service-group mb-4';
    group.innerHTML = `
        <div class="service-header">
            <h4>${quotations[0].job_cart.service?.service_name || 'Service'}</h4>
            <p class="text-muted">Select one quotation for this service</p>
        </div>
        <div class="quotations-grid" id="quotations-${jobCartId}"></div>
    `;

    const quotationsContainer = group.querySelector(`#quotations-${jobCartId}`);
    
    quotations.forEach((quotation, index) => {
        const quotationCard = createQuotationCard(quotation, jobCartId, index);
        quotationsContainer.appendChild(quotationCard);
    });

    return group;
}

// Create individual quotation card
function createQuotationCard(quotation, jobCartId, index) {
    const card = document.createElement('div');
    card.className = 'quotation-card';
    card.dataset.quotationId = quotation.quotation_id;
    card.dataset.jobCartId = jobCartId;
    
    card.innerHTML = `
        <div class="card-header">
            <h5>${quotation.service_provider?.service_provider_name || 'Service Provider'} ${quotation.service_provider?.service_provider_surname || ''}</h5>
            <div class="provider-rating">
                <span class="rating">${quotation.service_provider?.service_provider_rating || '5.0'}</span>
                <i class="fas fa-star text-warning"></i>
            </div>
        </div>
        <div class="card-body">
            <div class="price-section">
                <span class="price">R${parseFloat(quotation.quotation_price).toLocaleString()}</span>
                <span class="price-label">Total Price</span>
            </div>
            <div class="quotation-details">
                <p>${quotation.quotation_details || 'Professional service delivery'}</p>
            </div>
            <div class="provider-info">
                <div class="info-item">
                    <i class="fas fa-envelope me-2"></i>
                    ${quotation.service_provider?.service_provider_email || 'Email not provided'}
                </div>
                <div class="info-item">
                    <i class="fas fa-phone me-2"></i>
                    ${quotation.service_provider?.service_provider_phone || 'Phone not provided'}
                </div>
                <div class="info-item">
                    <i class="fas fa-calendar me-2"></i>
                    Submitted: ${new Date(quotation.quotation_submission_date).toLocaleDateString()}
                </div>
            </div>
        </div>
        <div class="card-footer">
            <button class="btn btn-outline-primary select-quotation" onclick="selectQuotation('${quotation.quotation_id}', '${jobCartId}')">
                Select This Quotation
            </button>
        </div>
    `;

    return card;
}

// Select quotation function
function selectQuotation(quotationId, jobCartId) {
    // Disable other quotations for this service
    const serviceGroup = document.querySelector(`#quotations-${jobCartId}`).closest('.service-group');
    const allCards = serviceGroup.querySelectorAll('.quotation-card');
    
    allCards.forEach(card => {
        card.classList.remove('selected');
        const button = card.querySelector('.select-quotation');
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-primary');
        button.textContent = 'Select This Quotation';
        button.disabled = false;
    });

    // Select current quotation
    const selectedCard = document.querySelector(`[data-quotation-id="${quotationId}"]`);
    selectedCard.classList.add('selected');
    const selectedButton = selectedCard.querySelector('.select-quotation');
    selectedButton.classList.remove('btn-outline-primary');
    selectedButton.classList.add('btn-primary');
    selectedButton.textContent = 'Selected ✓';
    selectedButton.disabled = true;

    // Store selected quotations
    let selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
    selectedQuotations[jobCartId] = quotationId;
    localStorage.setItem('selectedQuotations', JSON.stringify(selectedQuotations));

    // Check if all services have quotations selected
    checkAllQuotationsSelected();
}

// Check if all services have quotations selected
function checkAllQuotationsSelected() {
    const createdJobCarts = JSON.parse(localStorage.getItem('createdJobCarts') || '[]');
    const selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
    
    const allSelected = createdJobCarts.every(jobCartId => selectedQuotations[jobCartId]);
    
    if (allSelected) {
        // Show continue button
        const continueSection = document.createElement('div');
        continueSection.className = 'text-center mt-4';
        continueSection.innerHTML = `
            <button class="btn btn-success btn-lg" onclick="goToSummary()">
                <i class="fas fa-arrow-right me-2"></i>Continue to Summary
            </button>
        `;
        
        // Remove existing continue button if any
        const existingContinue = document.querySelector('.continue-to-summary');
        if (existingContinue) existingContinue.remove();
        
        continueSection.classList.add('continue-to-summary');
        document.getElementById('quotations-selection-container').appendChild(continueSection);
    }
}

// Go to summary step
function goToSummary() {
    currentStep = 6;
    showStep(currentStep);
    loadSummaryData();
}

// Load summary data (Step 5)
async function loadSummaryData() {
    try {
        const selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
        const selectedQuotationsSummary = document.getElementById('selected-quotations-summary');
        const eventSummary = document.getElementById('event-summary');
        const totalCostSummary = document.getElementById('total-cost-summary');

        // Load selected quotations
        let totalCost = 0;
        let summaryHTML = '';

        for (const [jobCartId, quotationId] of Object.entries(selectedQuotations)) {
            const { data: quotation, error } = await supabase
                .from('quotation')
                .select(`
                    *,
                    job_cart:job_cart_id (
                        job_cart_item,
                        service:service_id (service_name)
                    ),
                    service_provider:service_provider_id (
                        service_provider_name,
                        service_provider_surname,
                        service_provider_email,
                        service_provider_phone
                    )
                `)
                .eq('quotation_id', quotationId)
                .single();

            if (quotation && !error) {
                const price = parseFloat(quotation.quotation_price);
                totalCost += price;

                summaryHTML += `
                    <div class="selected-quotation-item">
                        <h5>${quotation.job_cart.service?.service_name || 'Service'}</h5>
                        <p><strong>Provider:</strong> ${quotation.service_provider?.service_provider_name || ''} ${quotation.service_provider?.service_provider_surname || ''}</p>
                        <p><strong>Price:</strong> R${price.toLocaleString()}</p>
                        <p><strong>Details:</strong> ${quotation.quotation_details || 'Professional service delivery'}</p>
                    </div>
                `;
            }
        }

        selectedQuotationsSummary.innerHTML = summaryHTML;

        // Load event summary
        const eventType = document.getElementById('event_type').value;
        const eventDate = document.getElementById('event_date').value;
        const eventLocation = document.getElementById('location').value;
        const specialRequests = document.getElementById('special_requests').value;

        eventSummary.innerHTML = `
            <div class="event-summary-item">
                <p><strong>Event Type:</strong> ${eventType}</p>
                <p><strong>Date:</strong> ${new Date(eventDate).toLocaleDateString()}</p>
                <p><strong>Location:</strong> ${eventLocation}</p>
                ${specialRequests ? `<p><strong>Special Requests:</strong> ${specialRequests}</p>` : ''}
            </div>
        `;

        // Load total cost
        totalCostSummary.innerHTML = `
            <div class="total-cost-item">
                <h4>R${totalCost.toLocaleString()}</h4>
                <p class="text-muted">Total amount for all services</p>
            </div>
        `;

        // Store total cost for payment step
        localStorage.setItem('totalBookingCost', totalCost.toString());

    } catch (error) {
        console.error('Error loading summary data:', error);
    }
}

// Payment processing (Step 6)
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for payment processing
    const processPaymentBtn = document.getElementById('process-payment');
    if (processPaymentBtn) {
        processPaymentBtn.addEventListener('click', processPayment);
    }

    // Format card number input
    const cardNumberInput = document.getElementById('card-number');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', formatCardNumber);
    }

    // Format expiry date input
    const expiryDateInput = document.getElementById('expiry-date');
    if (expiryDateInput) {
        expiryDateInput.addEventListener('input', formatExpiryDate);
    }
});

function formatCardNumber(event) {
    let value = event.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    if (formattedValue.length > 19) {
        formattedValue = formattedValue.substr(0, 19);
    }
    event.target.value = formattedValue;
}

function formatExpiryDate(event) {
    let value = event.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substr(0, 2) + '/' + value.substr(2, 2);
    }
    event.target.value = value;
}

async function processPayment() {
    const processBtn = document.getElementById('process-payment');
    const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
    const expiryDate = document.getElementById('expiry-date').value;
    const cvv = document.getElementById('cvv').value;
    const cardholderName = document.getElementById('cardholder-name').value;

    // Basic validation
    if (!cardNumber || !expiryDate || !cvv || !cardholderName) {
        alert('Please fill in all payment fields');
        return;
    }

    if (cardNumber.length < 16) {
        alert('Please enter a valid card number');
        return;
    }

    processBtn.disabled = true;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing Payment...';

    try {
        // Simulate payment processing
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Create payment record
        const totalCost = localStorage.getItem('totalBookingCost') || '0';
        const clientId = localStorage.getItem('clientId');
        
        const { data: paymentData, error: paymentError } = await supabase
            .from('payment')
            .insert({
                client_id: clientId,
                payment_amount: parseFloat(totalCost),
                payment_method: 'Credit Card',
                payment_status: 'completed',
                payment_date: new Date().toISOString().split('T')[0],
                payment_time: new Date().toTimeString().split(' ')[0]
            })
            .select();

        if (paymentError) {
            throw new Error(paymentError.message);
        }

        // Update quotations to accepted
        const selectedQuotations = JSON.parse(localStorage.getItem('selectedQuotations') || '{}');
        for (const quotationId of Object.values(selectedQuotations)) {
            await supabase
                .from('quotation')
                .update({ quotation_status: 'accepted' })
                .eq('quotation_id', quotationId);
        }

        // Generate booking ID
        const bookingId = 'BK-' + Date.now();
        localStorage.setItem('finalBookingId', bookingId);

        // Go to thank you step
        currentStep = 8;
        showStep(currentStep);
        loadThankYouData();

    } catch (error) {
        console.error('Payment processing error:', error);
        alert('Payment processing failed. Please try again.');
        processBtn.disabled = false;
        processBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Process Payment';
    }
}

function loadThankYouData() {
    const bookingId = localStorage.getItem('finalBookingId') || 'BK-' + Date.now();
    const totalCost = localStorage.getItem('totalBookingCost') || '0';
    const eventDate = document.getElementById('event_date').value;

    document.getElementById('booking-id-display').textContent = bookingId;
    document.getElementById('confirmed-event-date').textContent = new Date(eventDate).toLocaleDateString();
    document.getElementById('confirmed-total-amount').textContent = 'R' + parseFloat(totalCost).toLocaleString();
}

// Update navigation logic
function nextStep() {
    if (currentStep < 8) {
        currentStep++;
        showStep(currentStep);
        
        // Handle specific step logic
        if (currentStep === 4) {
            // Step 4: Waiting for quotations
            initializeWaitingInterface();
        } else if (currentStep === 5) {
            // Step 5: Quotation selection
            loadQuotationsForSelection();
        } else if (currentStep === 6) {
            // Step 6: Summary
            loadSummaryData();
        } else if (currentStep === 7) {
            // Step 7: Payment - load payment details
            loadPaymentDetails();
        }
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
}

function loadPaymentDetails() {
    const totalCost = localStorage.getItem('totalBookingCost') || '0';
    const paymentDetails = document.getElementById('payment-details');
    
    paymentDetails.innerHTML = `
        <div class="payment-breakdown">
            <div class="breakdown-item">
                <span>Service Total:</span>
                <span>R${parseFloat(totalCost).toLocaleString()}</span>
            </div>
            <div class="breakdown-item">
                <span>Processing Fee:</span>
                <span>R0.00</span>
            </div>
            <div class="breakdown-item total">
                <span><strong>Total Amount:</strong></span>
                <span><strong>R${parseFloat(totalCost).toLocaleString()}</strong></span>
            </div>
        </div>
    `;
}

// Job cart dropdown
function toggleCartDropdown(){
    const dropdown = document.getElementById("cart-dropdown");
    dropdown.style.display = dropdown.style.display==='block'?'none':'block';
}
function openCartModal(){ document.getElementById('cart-modal').style.display='flex'; }
function closeCartModal(){ document.getElementById('cart-modal').style.display='none'; }

// Initialize real-time functionality
async function initializeRealtime() {
    try {
        // Initialize real-time service
        await window.RealtimeService.initialize(supabase);
        
        // Initialize lock manager
        await window.LockManager.initialize(supabase);
        
        // Initialize notifications
        window.RealtimeNotifications.initialize();
        
        // Initialize lock UI
        window.LockUI.initialize();
        
        // Subscribe to real-time events
        setupRealtimeSubscriptions();
        
        console.log('✅ Real-time system initialized');
    } catch (error) {
        console.error('❌ Failed to initialize real-time system:', error);
    }
}

// Setup real-time subscriptions
function setupRealtimeSubscriptions() {
    // Subscribe to quotations for real-time updates
    window.RealtimeService.subscribeToQuotations((payload) => {
        handleQuotationUpdate(payload);
    });
    
    // Subscribe to bookings for real-time updates
    window.RealtimeService.subscribeToBookings((payload) => {
        handleBookingUpdate(payload);
    });
    
    // Subscribe to job carts for real-time updates
    window.RealtimeService.subscribeToJobCarts((payload) => {
        handleJobCartUpdate(payload);
    });
}

// Handle quotation updates
function handleQuotationUpdate(payload) {
    const { eventType, new: newRecord, old: oldRecord } = payload;
    
    switch (eventType) {
        case 'INSERT':
            showNotification('New quotation received!', 'success');
            break;
        case 'UPDATE':
            if (newRecord.quotation_status !== oldRecord.quotation_status) {
                showNotification(`Quotation status changed to ${newRecord.quotation_status}`, 'info');
            }
            break;
        case 'DELETE':
            showNotification('Quotation was removed', 'warning');
            break;
    }
}

// Handle booking updates
function handleBookingUpdate(payload) {
    const { eventType, new: newRecord, old: oldRecord } = payload;
    
    switch (eventType) {
        case 'INSERT':
            showNotification('New booking created!', 'success');
            break;
        case 'UPDATE':
            if (newRecord.booking_status !== oldRecord.booking_status) {
                showNotification(`Booking status changed to ${newRecord.booking_status}`, 'info');
            }
            break;
        case 'DELETE':
            showNotification('Booking was cancelled', 'warning');
            break;
    }
}

// Handle job cart updates
function handleJobCartUpdate(payload) {
    const { eventType, new: newRecord, old: oldRecord } = payload;
    
    switch (eventType) {
        case 'INSERT':
            showNotification('New job cart assigned!', 'success');
            break;
        case 'UPDATE':
            if (newRecord.job_status !== oldRecord.job_status) {
                showNotification(`Job cart status changed to ${newRecord.job_status}`, 'info');
            }
            break;
        case 'DELETE':
            showNotification('Job cart was removed', 'warning');
            break;
    }
}

// Enhanced accept quotation with locking
async function acceptQuotationWithLock(quotationId, serviceId) {
    try {
        // Try to acquire lock for the quotation
        const lockResult = await window.LockManager.acquireLockWithUI(
            window.LockTypes.QUOTATION, 
            quotationId, 
            window.LockOperations.APPROVE
        );
        
        if (!lockResult.success) {
            return; // Lock acquisition failed
        }
        
        // Proceed with acceptance
        await acceptQuotation(quotationId, serviceId);
        
        // Release lock after completion
        await window.LockManager.releaseLock(`quotation:${quotationId}`);
        
    } catch (error) {
        console.error('Error accepting quotation:', error);
        showNotification('Failed to accept quotation', 'error');
    }
}

// Enhanced reject quotation with locking
async function rejectQuotationWithLock(quotationId, serviceId) {
    try {
        // Try to acquire lock for the quotation
        const lockResult = await window.LockManager.acquireLockWithUI(
            window.LockTypes.QUOTATION, 
            quotationId, 
            window.LockOperations.REJECT
        );
        
        if (!lockResult.success) {
            return; // Lock acquisition failed
        }
        
        // Proceed with rejection
        await rejectQuotation(quotationId, serviceId);
        
        // Release lock after completion
        await window.LockManager.releaseLock(`quotation:${quotationId}`);
        
    } catch (error) {
        console.error('Error rejecting quotation:', error);
        showNotification('Failed to reject quotation', 'error');
    }
}

// Add loading state to services grid
function showServicesLoading() {
    const container = document.getElementById("services-grid");
    container.innerHTML = `
        <div class="col-12 text-center py-5">
            <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
            <h4>Loading Services...</h4>
            <p class="text-muted">Please wait while we load available services.</p>
        </div>
    `;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async function() {
    console.log('🚀 Initializing booking page...');
    
    // Load services immediately
    await loadServicesFromDatabase();
    
    // Initialize other services
    initializeRealtime();
    
    // Update cart UI
    updateCartUI();
    
    // Ensure location autocomplete is working
    const locationInput = document.getElementById('location');
    if (locationInput && !locationInput.hasAttribute('data-simple-location-initialized')) {
        console.log('Initializing simple location autocomplete for bookings');
        locationInput.setAttribute('data-simple-location-initialized', 'true');
    }
    
    console.log('✅ Page initialization complete');
});

</script>
</body>
</html>
