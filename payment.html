<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bonica Payment Page</title>
<link rel="stylesheet" href="css/professional-theme.css">
<link rel="stylesheet" href="css/payment.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* === Payment Page Tweaks === */
#payment-sections .card-body p strong { color: #0d6efd; font-weight:600; }
#payment-sections .card-body p:last-child { font-style:italic; color:#6c757d; }
#proof-form .form-label { font-weight:500; }
#message { margin-top:1rem; font-size:0.95rem; }
#continueBtn { margin-top:1.5rem; padding:14px 28px; font-size:1.25rem; border-radius:10px; font-weight:600; transition:all 0.3s ease; }
#continueBtn:disabled { opacity:0.6; cursor:not-allowed; }
#booking-confirmation-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); color:#fff; font-family:'Poppins',sans-serif; align-items:center; justify-content:center; z-index:9999; text-align:center; flex-direction:column; }
#booking-confirmation-modal h1 { color:#0d6efd; font-weight:700; font-size:4rem; margin-bottom:20px; }
#booking-confirmation-modal p { max-width:600px; margin:0 auto 30px auto; line-height:1.6; font-size:1.5rem; }
#close-confirmation-btn { padding:15px 30px; font-size:1.2rem; background:#0d6efd; color:#fff; border:none; border-radius:12px; cursor:pointer; transition: all 0.3s ease; }
#close-confirmation-btn:hover { background:#084298; transform:translateY(-2px); }
</style>
</head>
<body>

<!-- Navigation -->
<nav class="professional-nav">
  <div class="nav-container">
    <a href="index.html" class="logo"><img src="img/logo.jpeg" alt="Bonica Logo"><span>Bonica</span></a>
    <ul class="nav-links" id="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="index.html#about">About</a></li>
      <li><a href="bookings.html">Bookings</a></li>
      <li><a href="index.html#contact">Contact</a></li>
    </ul>
    <div class="hamburger" id="hamburger"><div></div><div></div><div></div></div>
  </div>
</nav>

<!-- Main -->
<main class="container-fluid py-5">
  <div class="container">

    <!-- Initial Pay Button -->
    <div id="start-payment" class="text-center">
      <div class="card shadow-lg border-0">
        <div class="card-body p-5">
          <i class="fas fa-university fa-3x text-primary mb-4"></i>
          <h1 class="card-title">Payment Information</h1>
          <p class="card-text text-muted">Click below to view banking details and upload your proof of payment.</p>
          <button id="payBtn" class="btn btn-primary btn-lg"><i class="fas fa-university me-2"></i>View Payment Details</button>
        </div>
      </div>
    </div>

    <!-- Payment Sections -->
    <div id="payment-sections" style="display:none;">
      <div class="row g-4">

        <!-- Banking Details -->
        <div class="col-lg-6">
          <section class="card shadow-lg border-0 h-100" style="background-color:#fff;">
            <div class="card-header" style="background-color:#fff; border-bottom:1px solid #ddd;">
              <h2 class="card-title mb-0"><i class="fas fa-university me-2"></i>Banking Details</h2>
            </div>
            <div class="card-body">
              <p><strong>Bank:</strong> Standard Bank</p>
              <p><strong>Account Number:</strong> 123 4567 890</p>
              <p><strong>Account Name:</strong> Bonica Plc</p>
              <p><strong>Branch:</strong> Braamfontein</p>
              <p><strong>Reference:</strong> <span id="banking-reference">N/A</span></p>
              <a href="banking-details.pdf" target="_blank" class="btn btn-outline-primary mt-3"><i class="fas fa-download me-2"></i>Download</a>
            </div>
          </section>
        </div>

        <!-- Payment Summary -->
        <div class="col-lg-6">
          <section class="card shadow-lg border-0 h-100" style="background-color:#fff;">
            <div class="card-header" style="background-color:#fff; border-bottom:1px solid #ddd;">
              <h2 class="card-title mb-0"><i class="fas fa-file-invoice-dollar me-2"></i>Payment Summary</h2>
            </div>
            <div class="card-body">
              <p><strong>Booking Total:</strong> <span id="booking-total">R0.00</span></p>
              <p><strong>15% Service Fee:</strong> <span id="service-fee">R0.00</span></p>
              <p><strong>Total Amount:</strong> <span id="total-to-pay">R0.00</span></p>
              <p><strong>Status:</strong> Pending</p>
              <a href="invoice.pdf" target="_blank" class="btn btn-outline-primary mt-3"><i class="fas fa-download me-2"></i>Download Invoice</a>
            </div>
          </section>
        </div>

      </div>

      <!-- Upload Proof -->
      <div class="col-12 mt-4">
        <section class="card shadow-lg border-0">
          <div class="card-header bg-warning text-dark">
            <h2 class="card-title mb-0"><i class="fas fa-upload me-2"></i>Upload Proof of Payment</h2>
          </div>
          <div class="card-body">
            <form id="proof-form" class="mb-4">
              <div class="mb-3">
                <label for="proof-file" class="form-label">Select Payment Proof</label>
                <input type="file" id="proof-file" class="form-control" accept="image/*,.pdf" required />
                <div class="form-text">Accepted: JPG, PNG, PDF (Max 10MB)</div>
              </div>
              <button type="submit" class="btn btn-primary"><i class="fas fa-upload me-2"></i>Upload</button>
            </form>
            <div id="message" class="alert" style="display:none;"></div>
            <div class="text-center">
              <button id="continueBtn" class="btn btn-success btn-lg" disabled><i class="fas fa-check me-2"></i>Confirm Booking</button>
            </div>
          </div>
        </section>
      </div>

    </div>
  </div>
</main>

<!-- Booking Confirmed Modal -->
<div id="booking-confirmation-modal">
  <h1>ðŸŽ‰ Booking Confirmed! ðŸŽ‰</h1>
  <p>Thank you for your payment. Your booking has been confirmed and confirmation emails have been sent to:</p>
  <ul style="text-align: left; max-width: 500px; margin: 20px auto;">
    <li>âœ… You (client confirmation)</li>
    <li>âœ… All selected service providers</li>
    <li>âœ… Booking details and payment receipt</li>
  </ul>
  <p style="font-size: 1.2rem; color: #0d6efd;">We will contact you shortly with further details.</p>
  <button id="close-confirmation-btn">Close</button>
</div>

<!-- Footer -->
<footer class="professional-footer">
  <div class="footer-content">
    <div class="footer-grid">
      <div class="footer-section">
        <h3>Bonica</h3>
        <p>Your trusted partner for weddings, parties, graduations, and special events.</p>
      </div>
      <div class="footer-section">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="index.html#about">About</a></li>
          <li><a href="bookings.html">Bookings</a></li>
          <li><a href="Login.html">Login</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Contact</h3>
        <p><i class="fas fa-map-marker-alt me-2"></i> Joriseen Street, Johannesburg</p>
        <p><i class="fas fa-phone me-2"></i> +27 76 244 9990</p>
        <p><i class="fas fa-envelope me-2"></i> <a href="mailto:Bonica@gmail.com">Bonica@gmail.com</a></p>
      </div>
    </div>
    <div class="footer-bottom"><p>&copy; 2025 Bonica. All rights reserved.</p></div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Navbar toggle
const hamburger = document.getElementById("hamburger");
const navLinks = document.getElementById("nav-links");
hamburger.addEventListener("click", () => navLinks.classList.toggle("active"));

// Elements
const payBtn = document.getElementById("payBtn");
const startPayment = document.getElementById("start-payment");
const paymentSections = document.getElementById("payment-sections");
const bankingRefEl = document.getElementById("banking-reference");
const bookingTotalEl = document.getElementById("booking-total");
const serviceFeeEl = document.getElementById("service-fee");
const totalEl = document.getElementById("total-to-pay");
const proofForm = document.getElementById("proof-form");
const proofFile = document.getElementById("proof-file");
const message = document.getElementById("message");
const continueBtn = document.getElementById("continueBtn");
const modal = document.getElementById("booking-confirmation-modal");
const closeModalBtn = document.getElementById("close-confirmation-btn");

let totalAmount = 0; // Will be calculated from selected quotations

// Load booking info from selected quotations
function loadUserAndBooking() {
  try {
    // Get selected quotation data from localStorage (set by summary page)
    const selectedQuotationData = JSON.parse(localStorage.getItem('selectedQuotationData') || '[]');
    
    if (selectedQuotationData.length === 0) {
      console.warn('No selected quotation data found, using default amount');
      totalAmount = 1000; // fallback
    } else {
      // Calculate total from selected quotations
      totalAmount = 0;
      selectedQuotationData.forEach(quote => {
        // Extract price from quote (format: "R 5,000" or "R5000")
        const priceText = quote.price || '0';
        const priceValue = parseFloat(priceText.replace(/[R\s,]/g, '')) || 0;
        totalAmount += priceValue;
      });
      
      console.log('ðŸ“Š Payment calculation:');
      console.log('ðŸ“‹ Selected quotations:', selectedQuotationData.length);
      console.log('ðŸ’° Total amount from quotations:', totalAmount);
    }
    
    // Calculate service fee (15%)
    const fee = totalAmount * 0.15;
    const finalTotal = totalAmount + fee;
    
    // Update display
    bookingTotalEl.textContent = `R${totalAmount.toLocaleString()}`;
    serviceFeeEl.textContent = `R${fee.toLocaleString()}`;
    totalEl.textContent = `R${finalTotal.toLocaleString()}`;
    bankingRefEl.textContent = "BONICA-" + Date.now();
    
    console.log('ðŸ’³ Payment summary loaded:');
    console.log('   Booking Total:', `R${totalAmount.toLocaleString()}`);
    console.log('   Service Fee (15%):', `R${fee.toLocaleString()}`);
    console.log('   Final Total:', `R${finalTotal.toLocaleString()}`);
    
  } catch (error) {
    console.error('Error loading payment data:', error);
    // Fallback to default
    totalAmount = 1000;
    const fee = totalAmount * 0.15;
    const finalTotal = totalAmount + fee;
    bookingTotalEl.textContent = `R${totalAmount.toLocaleString()}`;
    serviceFeeEl.textContent = `R${fee.toLocaleString()}`;
    totalEl.textContent = `R${finalTotal.toLocaleString()}`;
    bankingRefEl.textContent = "BONICA-" + Date.now();
  }
}

// Show payment sections
payBtn.addEventListener("click", () => {
  startPayment.style.display = "none";
  paymentSections.style.display = "block";
  loadUserAndBooking();
});

// Upload proof
proofForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const file = proofFile.files[0];
  if (!file) {
    message.textContent = "âš ï¸ Please select a file.";
    message.style.display = "block";
    message.className = "alert alert-danger";
    return;
  }
  // Pretend upload
  console.log("Pretend uploading:", file.name);
  message.textContent = `âœ… Proof uploaded successfully! Amount: R${totalAmount.toFixed(2)}`;
  message.style.display = "block";
  message.className = "alert alert-success";
  continueBtn.disabled = false;
  proofForm.reset();
});

// Confirm booking
continueBtn.addEventListener("click", async () => {
  try {
    // Show loading state
    continueBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    continueBtn.disabled = true;

    // Get current user info
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    // Create payment record
    const paymentData = {
      booking_id: localStorage.getItem('currentBookingId') || 'demo-booking',
      client_id: currentUser.id || 'demo-client',
      payment_amount: totalAmount,
      payment_proof: 'uploaded-proof-file.pdf', // In real implementation, this would be the uploaded file path
      payment_status: 'confirmed',
      payment_date: new Date().toISOString().split('T')[0],
      payment_time: new Date().toTimeString().split(' ')[0],
      payment_reference: bankingRefEl.textContent
    };

    // In a real implementation, you would save to database here
    console.log('Payment data:', paymentData);

    // Send confirmation notifications (simulate email sending)
    await sendPaymentConfirmations(currentUser, paymentData);

    // Show success modal
    modal.style.display = "flex";
    continueBtn.innerHTML = "ðŸŽ‰ Booking Confirmed. Congratulations!";
    continueBtn.classList.remove("btn-success");
    continueBtn.classList.add("btn-primary");

  } catch (error) {
    console.error('Error processing payment:', error);
    continueBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error - Please try again';
    continueBtn.disabled = false;
  }
});

// Send payment confirmations to both client and service providers
async function sendPaymentConfirmations(client, paymentData) {
  try {
    // Simulate sending email to client
    console.log('ðŸ“§ Sending payment confirmation email to client:', client.email);
    
    // In a real implementation, you would:
    // 1. Get service providers who submitted quotations
    // 2. Send emails to all parties
    // 3. Update booking status to 'confirmed'
    
    // For demo purposes, we'll just log the notifications
    console.log('âœ… Payment confirmation sent to client');
    console.log('âœ… Booking confirmation sent to service providers');
    console.log('âœ… Payment processed successfully');
    
    // Update booking status to confirmed
    // In real implementation: await supabase.from('booking').update({booking_status: 'confirmed'})
    
  } catch (error) {
    console.error('Error sending payment confirmations:', error);
    throw error;
  }
}

// Close modal
closeModalBtn.addEventListener("click", () => {
  modal.style.display = "none";
});
</script>
</body>
</html>
