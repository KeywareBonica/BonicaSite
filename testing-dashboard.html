<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time System Testing Dashboard - Bonica Event Management</title>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .testing-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .testing-header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .testing-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }
        
        .panel-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100vh - 250px);
            min-height: 600px;
        }
        
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }
        
        .panel-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .panel-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
        }
        
        .panel-content {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        .panel-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            min-height: 500px;
            transform: scale(0.8);
            transform-origin: top left;
            width: 125%;
            height: 125%;
        }
        
        .control-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .control-panel h3 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-size: 1.3rem;
        }
        
        .btn-group-custom {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-custom {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            background: white;
            color: #495057;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .btn-custom:hover {
            background: #f8f9fa;
            border-color: #0d6efd;
            color: #0d6efd;
        }
        
        .btn-custom.active {
            background: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-online {
            background: #28a745;
        }
        
        .status-offline {
            background: #dc3545;
        }
        
        .log-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #6c757d;
            font-size: 0.75rem;
        }
        
        .log-message {
            color: #495057;
        }
        
        .log-error {
            color: #dc3545;
        }
        
        .log-success {
            color: #28a745;
        }
        
        .log-info {
            color: #0d6efd;
        }
        
        @media (max-width: 768px) {
            .panel-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .panel {
                height: 500px;
                min-height: 500px;
            }
            
            .panel-iframe {
                transform: scale(0.7);
                width: 143%;
                height: 143%;
            }
        }
        
        @media (max-width: 480px) {
            .panel-iframe {
                transform: scale(0.6);
                width: 167%;
                height: 167%;
            }
        }
    </style>
</head>
<body>
    <!-- Testing Header -->
    <div class="testing-header">
        <div class="container">
            <h1><i class="fas fa-flask me-2"></i>Real-Time System Testing Dashboard</h1>
            <p>Test client and service provider interactions simultaneously</p>
        </div>
    </div>

    <div class="container">
        <!-- Control Panel -->
        <div class="control-panel">
            <h3><i class="fas fa-cogs me-2"></i>Testing Controls</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="btn-group-custom">
                        <button class="btn-custom active" onclick="switchToClient()">
                            <i class="fas fa-user me-1"></i>Client View
                        </button>
                        <button class="btn-custom" onclick="switchToServiceProvider()">
                            <i class="fas fa-briefcase me-1"></i>Service Provider View
                        </button>
                        <button class="btn-custom" onclick="switchToBoth()">
                            <i class="fas fa-columns me-1"></i>Both Views
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="btn-group-custom">
                        <button class="btn-custom" onclick="refreshPanels()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                        <button class="btn-custom" onclick="clearLogs()">
                            <i class="fas fa-trash me-1"></i>Clear Logs
                        </button>
                        <button class="btn-custom" onclick="testConnection()">
                            <i class="fas fa-wifi me-1"></i>Test Connection
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Status Indicators -->
            <div class="mt-3">
                <div class="d-flex align-items-center mb-2">
                    <span class="status-indicator status-offline" id="clientStatus"></span>
                    <span>Client Panel: <span id="clientStatusText">Offline</span></span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="status-indicator status-offline" id="providerStatus"></span>
                    <span>Service Provider Panel: <span id="providerStatusText">Offline</span></span>
                </div>
            </div>
        </div>

        <!-- Main Testing Panels -->
        <div class="panel-container" id="panelContainer">
            <!-- Client Panel -->
            <div class="panel" id="clientPanel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="fas fa-user me-2"></i>Client Interface
                    </h3>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshClient()">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <iframe id="clientFrame" class="panel-iframe" src="bookings.html"></iframe>
                </div>
            </div>

            <!-- Service Provider Panel -->
            <div class="panel" id="providerPanel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="fas fa-briefcase me-2"></i>Service Provider Interface
                    </h3>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshProvider()">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <iframe id="providerFrame" class="panel-iframe" src="service-provider-dashboard.html"></iframe>
                </div>
            </div>
        </div>

        <!-- Real-time Logs -->
        <div class="control-panel">
            <h3><i class="fas fa-terminal me-2"></i>Real-Time Activity Log</h3>
            <div class="log-panel" id="logPanel">
                <div class="log-entry">
                    <span class="log-timestamp">[00:00:00]</span>
                    <span class="log-message">Testing dashboard initialized. Ready for real-time testing.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Real-time Database Sync -->
    <script src="js/realtime-database-sync.js"></script>

    <script>
        // Supabase initialization
        const SUPABASE_URL = "https://spudtrptbyvwyhvistdf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWR0cnB0Ynl2d3lodmlzdGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTk4NjgsImV4cCI6MjA3MTI3NTg2OH0.GBo-RtgbRZCmhSAZi0c5oXynMiJNeyrs0nLsk3CaV8A";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global variables
        let realtimeSync = null;
        let currentView = 'both';
        let logCount = 0;

        // Initialize testing dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeTestingDashboard();
            setupRealTimeLogging();
        });

        // Initialize the testing dashboard
        function initializeTestingDashboard() {
            logMessage('Testing dashboard initialized', 'info');
            updatePanelStatus();
        }

        // Set up real-time logging
        function setupRealTimeLogging() {
            // Monitor iframe loads
            const clientFrame = document.getElementById('clientFrame');
            const providerFrame = document.getElementById('providerFrame');

            clientFrame.onload = function() {
                updateClientStatus(true);
                logMessage('Client panel loaded successfully', 'success');
                
                // Try to ensure proper display
                setTimeout(() => {
                    try {
                        if (clientFrame.contentWindow) {
                            clientFrame.contentWindow.scrollTo(0, 0);
                        }
                    } catch (e) {
                        console.log('Cannot access client iframe content');
                    }
                }, 500);
            };

            providerFrame.onload = function() {
                updateProviderStatus(true);
                logMessage('Service provider panel loaded successfully', 'success');
                
                // Try to ensure proper display
                setTimeout(() => {
                    try {
                        if (providerFrame.contentWindow) {
                            providerFrame.contentWindow.scrollTo(0, 0);
                        }
                    } catch (e) {
                        console.log('Cannot access provider iframe content');
                    }
                }, 500);
            };

            // Monitor for errors
            clientFrame.onerror = function() {
                updateClientStatus(false);
                logMessage('Client panel failed to load', 'error');
            };

            providerFrame.onerror = function() {
                updateProviderStatus(false);
                logMessage('Service provider panel failed to load', 'error');
            };
        }

        // Switch to client view only
        function switchToClient() {
            currentView = 'client';
            document.getElementById('panelContainer').style.gridTemplateColumns = '1fr';
            document.getElementById('providerPanel').style.display = 'none';
            document.getElementById('clientPanel').style.display = 'block';
            updateButtonStates('client');
            logMessage('Switched to client view only', 'info');
        }

        // Switch to service provider view only
        function switchToServiceProvider() {
            currentView = 'provider';
            document.getElementById('panelContainer').style.gridTemplateColumns = '1fr';
            document.getElementById('clientPanel').style.display = 'none';
            document.getElementById('providerPanel').style.display = 'block';
            updateButtonStates('provider');
            logMessage('Switched to service provider view only', 'info');
        }

        // Switch to both views
        function switchToBoth() {
            currentView = 'both';
            document.getElementById('panelContainer').style.gridTemplateColumns = '1fr 1fr';
            document.getElementById('clientPanel').style.display = 'block';
            document.getElementById('providerPanel').style.display = 'block';
            updateButtonStates('both');
            logMessage('Switched to both views', 'info');
        }

        // Update button states
        function updateButtonStates(activeView) {
            const buttons = document.querySelectorAll('.btn-custom');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (activeView === 'client') {
                buttons[0].classList.add('active');
            } else if (activeView === 'provider') {
                buttons[1].classList.add('active');
            } else if (activeView === 'both') {
                buttons[2].classList.add('active');
            }
        }

        // Refresh both panels
        function refreshPanels() {
            refreshClient();
            refreshProvider();
            logMessage('Refreshed both panels', 'info');
        }

        // Refresh client panel
        function refreshClient() {
            const clientFrame = document.getElementById('clientFrame');
            clientFrame.src = clientFrame.src;
            updateClientStatus(false);
            logMessage('Refreshing client panel...', 'info');
            
            // Add a small delay to ensure proper loading
            setTimeout(() => {
                try {
                    // Try to scroll to top of iframe content
                    if (clientFrame.contentWindow) {
                        clientFrame.contentWindow.scrollTo(0, 0);
                    }
                } catch (e) {
                    // Cross-origin restrictions may prevent this
                    console.log('Cannot access iframe content due to cross-origin restrictions');
                }
            }, 1000);
        }

        // Refresh service provider panel
        function refreshProvider() {
            const providerFrame = document.getElementById('providerFrame');
            providerFrame.src = providerFrame.src;
            updateProviderStatus(false);
            logMessage('Refreshing service provider panel...', 'info');
        }

        // Update client status
        function updateClientStatus(isOnline) {
            const statusIndicator = document.getElementById('clientStatus');
            const statusText = document.getElementById('clientStatusText');
            
            if (isOnline) {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'Online';
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Offline';
            }
        }

        // Update service provider status
        function updateProviderStatus(isOnline) {
            const statusIndicator = document.getElementById('providerStatus');
            const statusText = document.getElementById('providerStatusText');
            
            if (isOnline) {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'Online';
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Offline';
            }
        }

        // Update panel status
        function updatePanelStatus() {
            // Check if frames are loaded
            const clientFrame = document.getElementById('clientFrame');
            const providerFrame = document.getElementById('providerFrame');
            
            try {
                updateClientStatus(clientFrame.contentDocument && clientFrame.contentDocument.readyState === 'complete');
                updateProviderStatus(providerFrame.contentDocument && providerFrame.contentDocument.readyState === 'complete');
            } catch (e) {
                // Cross-origin restrictions may prevent access
                updateClientStatus(true); // Assume loaded if no error
                updateProviderStatus(true);
            }
        }

        // Test database connection
        async function testConnection() {
            logMessage('Testing database connection...', 'info');
            
            try {
                const { data, error } = await supabase
                    .from('service')
                    .select('count')
                    .limit(1);

                if (error) throw error;
                
                logMessage('Database connection successful', 'success');
                
                // Test real-time connection
                const realtimeSync = new RealtimeDatabaseSync(supabase);
                await realtimeSync.initialize('client', 'test-user', 'Photography');
                logMessage('Real-time connection established', 'success');
                
            } catch (error) {
                logMessage('Database connection failed: ' + error.message, 'error');
            }
        }

        // Add log message
        function logMessage(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString();
            logCount++;
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-message">${message}</span>
            `;
            
            logPanel.appendChild(logEntry);
            
            // Keep only last 50 log entries
            if (logCount > 50) {
                logPanel.removeChild(logPanel.firstChild);
                logCount--;
            }
            
            // Auto-scroll to bottom
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // Clear logs
        function clearLogs() {
            const logPanel = document.getElementById('logPanel');
            logPanel.innerHTML = '';
            logCount = 0;
            logMessage('Logs cleared', 'info');
        }

        // Simulate real-time events for testing
        function simulateRealTimeEvent() {
            const events = [
                'New job cart created by client',
                'Service provider accepted job',
                'Quotation uploaded by service provider',
                'Client accepted quotation',
                'Booking confirmed',
                'Payment processed'
            ];
            
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            logMessage(`Simulated: ${randomEvent}`, 'info');
        }

        // Auto-refresh status every 5 seconds
        setInterval(updatePanelStatus, 5000);

        // Simulate events every 30 seconds for demo purposes
        setInterval(simulateRealTimeEvent, 30000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        switchToClient();
                        break;
                    case '2':
                        e.preventDefault();
                        switchToServiceProvider();
                        break;
                    case '3':
                        e.preventDefault();
                        switchToBoth();
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshPanels();
                        break;
                }
            }
        });

        // Expose functions globally for testing
        window.testingDashboard = {
            switchToClient,
            switchToServiceProvider,
            switchToBoth,
            refreshPanels,
            testConnection,
            simulateRealTimeEvent,
            logMessage
        };
    </script>
</body>
</html>
